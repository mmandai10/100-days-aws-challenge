<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wizardry Schema - æ”¾ç½®å‹æ¢ç´¢RPG</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
    body { font-family: 'DotGothic16', sans-serif; background-color: #0a0a0a; color: #33ff33; }
    .retro-border { border: 2px solid #33ff33; box-shadow: 0 0 10px rgba(51, 255, 51, 0.3); }
    .log-scroll::-webkit-scrollbar { width: 8px; }
    .log-scroll::-webkit-scrollbar-track { background: #1a1a1a; }
    .log-scroll::-webkit-scrollbar-thumb { background-color: #33ff33; }
    .blink { animation: blink 1s infinite; }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
    .gold-text { color: #ffd700; }
    .red-text { color: #ff4444; }
    .blue-text { color: #44aaff; }
    .purple-text { color: #aa44ff; }
    .orange-text { color: #ff8844; }
    .tab-btn { transition: all 0.2s; }
    .tab-btn:hover { background-color: #1a4a1a; }
    .tab-btn.active { background-color: #2a5a2a; border-color: #66ff66; }
    .rarity-common { color: #aaaaaa; }
    .rarity-uncommon { color: #44ff44; }
    .rarity-rare { color: #4488ff; }
    .rarity-epic { color: #aa44ff; }
    .rarity-legendary { color: #ffaa00; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100; }
    .story-text { line-height: 1.8; }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ===== ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ»ä¸–ç•Œè¦³ =====
    const WORLD_STORY = {
      prologue: `
        ã‹ã¤ã¦ã€ã“ã®åœ°ã«ã¯å‰å¤§ãªã‚‹ç‹å›½ã€Œãƒªãƒ«ã‚¬ãƒŸãƒ³ã€ãŒæ „ãˆã¦ã„ãŸã€‚
        
        ã—ã‹ã—ç™¾å¹´å‰ã€é­”è¡“å¸«ãƒ¯ãƒ¼ãƒ‰ãƒŠãŒç¦æ–­ã®é­”æ³•ã‚’è§£ãæ”¾ã¡ã€
        ç‹å›½ã®åœ°ä¸‹ã«å·¨å¤§ãªè¿·å®®ã‚’ç”Ÿã¿å‡ºã—ãŸã€‚
        
        ãƒ¯ãƒ¼ãƒ‰ãƒŠã¯å›½ç‹ãƒˆãƒ¬ãƒœãƒ¼ã‹ã‚‰ã€Œé­”é™¤ã‘ã®è­·ç¬¦ã€ã‚’å¥ªã„ã€
        è¿·å®®ã®æœ€æ·±éƒ¨ã«å§¿ã‚’æ¶ˆã—ãŸã€‚
        
        ä»¥æ¥ã€è¿·å®®ã‹ã‚‰ã¯é­”ç‰©ãŒæº¢ã‚Œå‡ºã—ã€
        å‘¨è¾ºã®æ‘ã€…ã¯ææ€–ã«æ€¯ãˆã‚‹æ—¥ã€…ã‚’é€ã£ã¦ã„ã‚‹ã€‚
        
        å†’é™ºè€…ã‚ˆã€è¿·å®®ã«æŒ‘ã¿ã€è­·ç¬¦ã‚’å–ã‚Šæˆ»ã›ã€‚
        ç‹å›½ã®å¹³å’Œã¯ã€æ±ã®æ‰‹ã«ã‹ã‹ã£ã¦ã„ã‚‹ã€‚
      `,
      gilgamesh: `
        ã“ã“ã¯å†’é™ºè€…ã‚®ãƒ«ãƒ‰ã€Œã‚®ãƒ«ã‚¬ãƒ¡ãƒƒã‚·ãƒ¥ã®é…’å ´ã€ã€‚
        è¿·å®®ã«æŒ‘ã‚€è€…ãŸã¡ãŒé›†ã„ã€ä»²é–“ã‚’å‹Ÿã‚‹å ´æ‰€ã ã€‚
        
        é…’å ´ã®ä¸»äººã‚®ãƒ«ã‚¬ãƒ¡ãƒƒã‚·ãƒ¥ã¯è¨€ã†ã€‚
        ã€Œè¿·å®®ã«ã¯æ§˜ã€…ãªå…¥ã‚Šå£ãŒã‚ã‚‹ã€‚
        ã€€ã¾ãšã¯æµ…ã„å ´æ‰€ã§è…•ã‚’ç£¨ããŒã„ã„ã€‚ã€
      `
    };

    // ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³è©³ç´°æƒ…å ±ï¼ˆã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ»ç†ç”±ä»˜ãï¼‰
    const DUNGEON_LORE = {
      slime: {
        name: 'ã‚¹ãƒ©ã‚¤ãƒ ã®ç©´',
        story: 'è¿·å®®ã®å…¥ã‚Šå£ä»˜è¿‘ã«åºƒãŒã‚‹æ´çªŸã€‚å¼±ã„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãŒæ£²ã‚€ãŸã‚ã€æ–°äººå†’é™ºè€…ã®è¨“ç·´å ´ã¨ã—ã¦çŸ¥ã‚‰ã‚Œã‚‹ã€‚',
        objective: 'å†’é™ºè€…ã¨ã—ã¦ã®ç¬¬ä¸€æ­©ã€‚åŸºæœ¬çš„ãªæˆ¦é—˜ã‚’å­¦ã¹ã€‚',
        reward: 'åˆå¿ƒè€…å‘ã‘è£…å‚™ã€å°‘é‡ã®ã‚´ãƒ¼ãƒ«ãƒ‰'
      },
      kobold: {
        name: 'ã‚³ãƒœãƒ«ãƒ‰ã®å·£',
        story: 'ã‚³ãƒœãƒ«ãƒˆæ—ãŒå æ‹ ã—ãŸå»ƒå‘é“ã€‚å½¼ã‚‰ã¯è¿·å®®ã‹ã‚‰æº¢ã‚Œå‡ºãŸé­”ç‰©ã®ä¸€æ´¾ã§ã€è¿‘éš£ã®æ‘ã‚’è¥²æ’ƒã—ã¦ã„ã‚‹ã€‚',
        objective: 'ã‚³ãƒœãƒ«ãƒˆãƒ­ãƒ¼ãƒ‰ã‚’è¨ä¼ã—ã€æ‘ã¸ã®è„…å¨ã‚’æ’é™¤ã›ã‚ˆã€‚',
        reward: 'æ‘ã‹ã‚‰ã®å ±å¥¨é‡‘ã€ã‚³ãƒœãƒ«ãƒˆã®è²¡å®'
      },
      thieves: {
        name: 'ç›—è³Šã®ã‚¢ã‚¸ãƒˆ',
        story: 'è¿·å®®ã®æ··ä¹±ã«ä¹—ã˜ã¦çµæˆã•ã‚ŒãŸç›—è³Šå›£ã®æ ¹åŸã€‚å½¼ã‚‰ã¯å†’é™ºè€…ã‚’è¥²ã„ã€è²¡å®ã‚’å¥ªã£ã¦ã„ã‚‹ã€‚',
        objective: 'ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒ•ã‚’å€’ã—ã€ç›—è³Šå›£ã‚’å£Šæ»…ã•ã›ã‚ˆã€‚',
        reward: 'ç›—è³Šå›£ãŒæºœã‚è¾¼ã‚“ã è²¡å®ã€ç›—å“ã®è£…å‚™'
      },
      sewer: {
        name: 'ã‚«ãƒªã‚°ãƒ©ãƒ¼ã‚¼ä¸‹æ°´è·¯',
        story: 'æ—§ç‹éƒ½ã®åœ°ä¸‹ã«åºƒãŒã‚‹ä¸‹æ°´é“ã€‚ãƒ¯ãƒ¼ãƒ‰ãƒŠã®é­”åŠ›ã«æ±šæŸ“ã•ã‚Œã€ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰ãŒå¾˜å¾Šã™ã‚‹æ­»ã®é ˜åŸŸã¨åŒ–ã—ãŸã€‚',
        objective: 'ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢ã‚’æ»…ã¼ã—ã€ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰ã®ç™ºç”Ÿæºã‚’æ–­ã¦ã€‚',
        reward: 'å¤ä»£ã®éºç‰©ã€æµ„åŒ–ã®å ±é…¬'
      },
      kaoka: {
        name: 'ã‚«ã‚ªã‚«ãƒ»ãƒ‘ãƒ©ãƒ¼ã‚¸éºè·¡',
        story: 'ãƒªãƒ«ã‚¬ãƒŸãƒ³å»ºå›½ä»¥å‰ã‹ã‚‰å­˜åœ¨ã™ã‚‹å¤ä»£éºè·¡ã€‚ãƒ¯ãƒ¼ãƒ‰ãƒŠã¯ã“ã“ã§ç¦æ–­ã®çŸ¥è­˜ã‚’å¾—ãŸã¨ã„ã†ã€‚',
        objective: 'ã‚°ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚’å°å°ã—ã€å¤ä»£ã®ç§˜å¯†ã‚’è§£ãæ˜ã‹ã›ã€‚',
        reward: 'å¤ä»£é­”æ³•ã®æ›¸ã€å¤±ã‚ã‚ŒãŸæŠ€è¡“ã®è£…å‚™'
      },
      deltis: {
        name: 'ãƒ‡ãƒ«ãƒ†ã‚£ã‚¹å¤§è”µå®¤',
        story: 'æ—§ç‹å›½ã®å®ç‰©åº«ã€‚ãƒ¯ãƒ¼ãƒ‰ãƒŠãŒé­”ç‰©ã‚’ç•ªäººã¨ã—ã¦é…ç½®ã—ã€è«å¤§ãªè²¡å®ã‚’å®ˆã‚‰ã›ã¦ã„ã‚‹ã€‚',
        objective: 'ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ‰ãƒ©ã‚´ãƒ³ã‚’è¨ä¼ã—ã€ç‹å›½ã®è²¡å®ã‚’å–ã‚Šæˆ»ã›ã€‚',
        reward: 'ç‹å®¶ã®å®ç‰©ã€ä¼èª¬ç´šã®è£…å‚™'
      },
      dragon: {
        name: 'é»„é¾ã®ç¥æ®¿è·¡',
        story: 'ã‹ã¤ã¦é¾ç¥ã‚’ç¥€ã£ã¦ã„ãŸè–åŸŸã€‚ãƒ¯ãƒ¼ãƒ‰ãƒŠã®å‘ªã„ã«ã‚ˆã‚Šã€ç¥æ®¿ã¯è…æ•—ã—ã€é¾ãŸã¡ã¯é‚ªæ‚ªãªå­˜åœ¨ã¨åŒ–ã—ãŸã€‚',
        objective: 'ã‚¨ãƒ³ã‚·ã‚§ãƒ³ãƒˆãƒ‰ãƒ©ã‚´ãƒ³ã‚’æµ„åŒ–ã—ã€é¾ç¥ã®æ€’ã‚Šã‚’é®ã‚ã‚ˆã€‚',
        reward: 'é¾ã®é±—ã€ç¥å™¨ç´šã®è£…å‚™'
      },
      trebor: {
        name: 'ãƒˆãƒ¬ãƒœãƒ¼ã®è©¦ç·´å ´',
        story: 'è¿·å®®ã®æœ€æ·±éƒ¨ã€‚ã“ã“ã«ãƒ¯ãƒ¼ãƒ‰ãƒŠã¯ã€Œé­”é™¤ã‘ã®è­·ç¬¦ã€ã¨å…±ã«æ½œã‚“ã§ã„ã‚‹ã€‚ç‹ã®åã‚’å† ã™ã‚‹ã“ã®å ´æ‰€ã§ã€æœ€å¾Œã®æˆ¦ã„ãŒå¾…ã£ã¦ã„ã‚‹ã€‚',
        objective: 'é­”è¡“å¸«ãƒ¯ãƒ¼ãƒ‰ãƒŠã‚’è¨ä¼ã—ã€è­·ç¬¦ã‚’å–ã‚Šæˆ»ã›ã€‚ç‹å›½ã®å‘½é‹ã‚’æ±ºã™ã‚‹æœ€çµ‚æ±ºæˆ¦ã€‚',
        reward: 'é­”é™¤ã‘ã®è­·ç¬¦ã€ä¼èª¬ã®ç§°å·ã€Œãƒªãƒ«ã‚¬ãƒŸãƒ³ã®è‹±é›„ã€'
      }
    };

    // ===== ã‚µã‚¦ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ³ (ãƒœãƒªãƒ¥ãƒ¼ãƒ èª¿æ•´å¯¾å¿œ) =====
    class SoundEngine {
      constructor() {
        this.initialized = false;
        this.bgmEnabled = true;
        this.sfxEnabled = true;
        this.bgmVolume = -12;
        this.sfxVolume = -6;
        this.bgmLoop = null;
        this.isPlaying = false;
      }

      async init() {
        if (this.initialized) return;
        await Tone.start();
        this.bgmSynth = new Tone.PolySynth(Tone.Synth, {
          oscillator: { type: 'square' },
          envelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.5 }
        }).toDestination();
        this.bgmSynth.volume.value = this.bgmVolume;
        this.sfxSynth = new Tone.Synth({
          oscillator: { type: 'triangle' },
          envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 }
        }).toDestination();
        this.sfxSynth.volume.value = this.sfxVolume;
        this.noiseSynth = new Tone.NoiseSynth({
          noise: { type: 'white' },
          envelope: { attack: 0.005, decay: 0.1, sustain: 0 }
        }).toDestination();
        this.noiseSynth.volume.value = -20;
        this.initialized = true;
      }

      setBgmVolume(vol) {
        this.bgmVolume = vol;
        if (this.bgmSynth) this.bgmSynth.volume.value = vol;
      }

      setSfxVolume(vol) {
        this.sfxVolume = vol;
        if (this.sfxSynth) this.sfxSynth.volume.value = vol;
        if (this.noiseSynth) this.noiseSynth.volume.value = vol - 14;
      }

      startBGM() {
        if (!this.initialized || !this.bgmEnabled || this.isPlaying) return;
        const melody = [
          ['E4', '8n'], ['G4', '8n'], ['A4', '8n'], ['B4', '8n'],
          ['A4', '8n'], ['G4', '8n'], ['E4', '4n'],
          ['D4', '8n'], ['E4', '8n'], ['G4', '8n'], ['A4', '8n'],
          ['G4', '8n'], ['E4', '8n'], ['D4', '4n'],
          ['E4', '8n'], ['D4', '8n'], ['C4', '8n'], ['D4', '8n'],
          ['E4', '4n'], ['G4', '4n'],
          ['A4', '8n'], ['G4', '8n'], ['E4', '8n'], ['D4', '8n'],
          ['E4', '2n']
        ];
        let index = 0;
        this.bgmLoop = new Tone.Loop((time) => {
          if (!this.bgmEnabled) return;
          const [note, duration] = melody[index % melody.length];
          this.bgmSynth.triggerAttackRelease(note, duration, time);
          index++;
        }, '8n').start(0);
        Tone.Transport.bpm.value = 100;
        Tone.Transport.start();
        this.isPlaying = true;
      }

      stopBGM() {
        if (this.bgmLoop) { this.bgmLoop.stop(); Tone.Transport.stop(); this.isPlaying = false; }
      }

      toggleBGM(enabled) {
        this.bgmEnabled = enabled;
        if (enabled && this.initialized) this.startBGM();
        else this.stopBGM();
      }

      playAttack() { if (this.initialized && this.sfxEnabled) { this.sfxSynth.triggerAttackRelease('C5', '16n'); setTimeout(() => this.sfxSynth.triggerAttackRelease('E5', '16n'), 50); } }
      playHit() { if (this.initialized && this.sfxEnabled) this.noiseSynth.triggerAttackRelease('16n'); }
      playLevelUp() { if (this.initialized && this.sfxEnabled) { ['C5', 'E5', 'G5', 'C6'].forEach((note, i) => setTimeout(() => this.sfxSynth.triggerAttackRelease(note, '8n'), i * 100)); } }
      playHeal() { if (this.initialized && this.sfxEnabled) { this.sfxSynth.triggerAttackRelease('G5', '4n'); setTimeout(() => this.sfxSynth.triggerAttackRelease('B5', '4n'), 150); } }
      playGold() { if (this.initialized && this.sfxEnabled) { this.sfxSynth.triggerAttackRelease('E6', '16n'); setTimeout(() => this.sfxSynth.triggerAttackRelease('G6', '16n'), 80); } }
      playDeath() { if (this.initialized && this.sfxEnabled) { ['E4', 'D4', 'C4', 'B3'].forEach((note, i) => setTimeout(() => this.sfxSynth.triggerAttackRelease(note, '8n'), i * 200)); } }
      playBossAppear() { if (this.initialized && this.sfxEnabled) { ['C3', 'C3', 'G3', 'C3', 'G3', 'C4'].forEach((note, i) => setTimeout(() => this.sfxSynth.triggerAttackRelease(note, '8n'), i * 150)); } }
      playJobChange() { if (this.initialized && this.sfxEnabled) { ['C5', 'D5', 'E5', 'F5', 'G5', 'A5', 'B5', 'C6'].forEach((note, i) => setTimeout(() => this.sfxSynth.triggerAttackRelease(note, '16n'), i * 80)); } }
    }

    const soundEngine = new SoundEngine();

    // ===== åå‰ç”Ÿæˆ =====
    const NAME_PARTS = {
      human: { prefix: ['ã‚¢ãƒ«', 'ãƒ™ãƒ«', 'ã‚«ã‚¤', 'ãƒ€ãƒ³', 'ã‚¨ãƒ«', 'ãƒ•ã‚£ãƒ³', 'ã‚¬ãƒ«', 'ãƒãƒ«', 'ã‚¤ãƒ«', 'ã‚¸ã‚§', 'ã‚±ã‚¤', 'ãƒ¬ã‚ª', 'ãƒãƒ«', 'ãƒã‚¨', 'ã‚ªãƒ«', 'ãƒ‘ãƒ«', 'ã‚¯ã‚¨', 'ãƒ¬ã‚¤', 'ã‚»ãƒ«', 'ã‚¿ãƒ«'], suffix: ['ã‚¹', 'ãƒ³', 'ãƒ‰', 'ã‚¯', 'ãƒˆ', 'ãƒ«', 'ãƒ ', 'ãƒ•', 'ãƒªã‚¢', 'ãƒŠ', 'ã‚·ã‚¢', 'ãƒ†ã‚£', 'ãƒ´ã‚£', 'ã‚¦ã‚¹', 'ã‚ªãƒ³', 'ã‚¢ã‚¹', 'ã‚¨ãƒ«', 'ã‚¤ãƒ³', 'ã‚¦ãƒ ', 'ã‚¢'] },
      elf: { prefix: ['ã‚¨ã‚¢', 'ã‚»ãƒ¬', 'ã‚¬ãƒ©', 'ãƒ¬ã‚´', 'ã‚¢ãƒ©', 'ã‚¨ãƒ«', 'ãƒ•ã‚§ã‚¢', 'ã‚®ãƒ«', 'ãƒªãƒ³', 'ãƒ«ãƒ¼', 'ãƒŸã‚¹', 'ãƒ‹ãƒ ', 'ã‚ªãƒ­', 'ã‚µãƒ«', 'ã‚·ãƒ«', 'ã‚¿ã‚¦', 'ã‚¦ãƒ³', 'ãƒ´ã‚¡', 'ã‚¤ãƒ‰', 'ã‚»ã‚¢'], suffix: ['ã‚¦ã‚§ãƒ³', 'ãƒ‡ã‚£ãƒ«', 'ãƒ‰ãƒªã‚¨ãƒ«', 'ãƒ©ã‚¹', 'ãƒŸã‚¢', 'ãƒãƒ¼ãƒ«', 'ãƒªã‚ªãƒ³', 'ã‚¦ã‚£ãƒ³', 'ãƒŠã‚¹', 'ãƒ­ã‚¹', 'ãƒŸãƒ«', 'ãƒ‰ãƒ¼ãƒ«', 'ãƒ•ã‚£ãƒ³', 'ãƒªã‚¢', 'ãƒ‡ã‚£ã‚¢', 'ã‚¨ãƒ«', 'ã‚·ãƒ«', 'ãƒ‹ã‚¨ãƒ«', 'ãƒ´ã‚§ãƒ«', 'ã‚¦ã‚£ãƒ«'] },
      dwarf: { prefix: ['ãƒ‰ã‚¥', 'ãƒãƒ«', 'ã‚®ãƒ ', 'ãƒˆãƒ¼', 'ãƒ–ãƒ­', 'ãƒ€ã‚¤', 'ãƒ•ã‚¡', 'ã‚°ãƒ­', 'ã‚«ã‚¶', 'ãƒ¢ãƒ¼', 'ãƒŠãƒ¼', 'ã‚ªãƒ¼', 'ã‚¹ãƒ', 'ã‚¦ãƒ«', 'ãƒ´ã‚¡ãƒ«', 'ãƒ‰ãƒ¯', 'ãƒœãƒ«', 'ã‚°ãƒ©', 'ãƒãƒ«', 'ãƒ ãƒ«'], suffix: ['ãƒªãƒ³', 'ã‚¤ãƒ³', 'ãƒª', 'ãƒ«', 'ãƒ ', 'ãƒ‰', 'ã‚°', 'ã‚¯', 'ãƒ³', 'ãƒ•', 'ãƒœãƒ«', 'ãƒ€ãƒ«', 'ã‚¬ãƒ«', 'ãƒŠãƒ«', 'ãƒãƒ«', 'ã‚«ãƒ«', 'ã‚¶ãƒ«', 'ãƒˆãƒ«', 'ãƒ´ãƒ«', 'ã‚ªãƒ«'] },
      gnome: { prefix: ['ãƒ•ã‚£', 'ã‚¸ãƒ³', 'ãƒœãƒœ', 'ãƒ‹ãƒ ', 'ã‚¬ãƒ¼', 'ãƒ”ãƒƒ', 'ãƒ†ã‚£ãƒ³', 'ã‚¦ã‚£', 'ã‚¶ãƒ³', 'ãƒªãƒª', 'ãƒ¡ãƒª', 'ãƒãƒ', 'ã‚­ã‚­', 'ãƒ«ãƒ«', 'ãƒŸãƒŸ', 'ãƒãƒ', 'ã‚¿ã‚¿', 'ãƒ“ãƒ“', 'ã‚³ã‚³', 'ãƒ‡ã‚£ãƒ‡ã‚£'], suffix: ['ãƒƒã‚¯', 'ã‚¹', 'ãƒ–ãƒ«', 'ãƒ‰ãƒ«', 'ãƒªãƒƒã‚¯', 'ãƒã‚¹', 'ãƒˆãƒ³', 'ã‚ºãƒ«', 'ã‚²ãƒ«', 'ã‚¯ãƒ«', 'ãƒ³ã‚¯', 'ãƒƒãƒ—', 'ãƒƒãƒˆ', 'ãƒ³ã‚¹', 'ãƒ ã‚¹', 'ãƒ«ã‚¹', 'ãƒ³ãƒ—', 'ãƒ«ã‚¯', 'ãƒ«ãƒ‰', 'ãƒ³ãƒ‰'] },
      porkul: { prefix: ['ãƒ‘ãƒƒ', 'ãƒ”ãƒƒ', 'ãƒ—ãƒ«', 'ãƒšã‚³', 'ãƒãƒ³', 'ãƒ›ãƒ“', 'ãƒ­ãƒ¼', 'ã‚µãƒ ', 'ãƒ•ãƒ­', 'ãƒ¡ãƒª', 'ãƒ“ãƒ«', 'ãƒœãƒ–', 'ãƒ€ãƒ‰', 'ãƒ•ã‚¡', 'ã‚¬ãƒ ', 'ãƒãƒ ', 'ãƒˆãƒ ', 'ã‚¦ã‚£ãƒ«', 'ãƒãƒ³', 'ã‚¿ãƒ³'], suffix: ['ãƒ‰', 'ãƒˆ', 'ãƒ³', 'ãƒ«', 'ã‚¹', 'ãƒœ', 'ã‚´', 'ãƒ­', 'ã‚¸ãƒ¼', 'ã‚·ãƒ¼', 'ãƒ”ãƒ³', 'ã‚­ãƒ³', 'ãƒªãƒ³', 'ãƒŸãƒ³', 'ãƒ†ã‚£ãƒ³', 'ã‚¦ã‚£ãƒ³', 'ãƒ‡ã‚£ãƒ³', 'ãƒ•ã‚£ãƒ³', 'ã‚¸ãƒ³', 'ãƒ“ãƒ³'] }
    };
    const generateName = (race) => { const parts = NAME_PARTS[race] || NAME_PARTS.human; return parts.prefix[Math.floor(Math.random() * parts.prefix.length)] + parts.suffix[Math.floor(Math.random() * parts.suffix.length)]; };

    // ===== ã‚²ãƒ¼ãƒ å®šæ•° =====
    const RACES = {
      human: { name: 'äººé–“', str: 8, int: 8, pie: 5, vit: 8, agi: 8, luk: 9, desc: 'ä¸‡èƒ½å‹' },
      elf: { name: 'ã‚¨ãƒ«ãƒ•', str: 7, int: 10, pie: 10, vit: 6, agi: 9, luk: 6, desc: 'é­”æ³•ç³»å‘ã' },
      dwarf: { name: 'ãƒ‰ãƒ¯ãƒ¼ãƒ•', str: 10, int: 7, pie: 10, vit: 10, agi: 5, luk: 6, desc: 'å‰è¡›å‘ã' },
      gnome: { name: 'ãƒãƒ¼ãƒ ', str: 7, int: 7, pie: 10, vit: 8, agi: 10, luk: 7, desc: 'åƒ§ä¾¶å‘ã' },
      porkul: { name: 'ãƒãƒ¼ã‚¯ãƒ«', str: 5, int: 7, pie: 7, vit: 6, agi: 10, luk: 15, desc: 'ç›—è³Šå‘ã' }
    };

    const ALIGNMENTS = {
      lawful: { name: 'ç§©åº(L)', color: 'text-blue-400' },
      neutral: { name: 'ä¸­ç«‹(N)', color: 'text-gray-400' },
      chaotic: { name: 'æ··æ²Œ(C)', color: 'text-red-400' }
    };

    const JOBS = {
      fighter: { name: 'æˆ¦å£«', hpMod: 1.5, mpMod: 0.2, atkMod: 1.4, defMod: 1.3, align: ['lawful', 'neutral', 'chaotic'], spellType: null, tier: 1, requirements: {} },
      mage: { name: 'é­”è¡“å¸«', hpMod: 0.6, mpMod: 1.8, atkMod: 0.6, defMod: 0.5, align: ['lawful', 'neutral', 'chaotic'], spellType: 'mage', tier: 1, requirements: {} },
      priest: { name: 'åƒ§ä¾¶', hpMod: 0.9, mpMod: 1.4, atkMod: 0.8, defMod: 0.9, align: ['lawful', 'chaotic'], spellType: 'priest', tier: 1, requirements: {} },
      thief: { name: 'ç›—è³Š', hpMod: 0.8, mpMod: 0.5, atkMod: 1.0, defMod: 0.7, align: ['neutral', 'chaotic'], spellType: null, tier: 1, requirements: {} },
      bishop: { name: 'å¸æ•™', hpMod: 0.7, mpMod: 1.6, atkMod: 0.7, defMod: 0.6, align: ['lawful', 'chaotic'], spellType: 'both', tier: 2, requirements: { int: 12, pie: 12 } },
      samurai: { name: 'ä¾', hpMod: 1.3, mpMod: 0.8, atkMod: 1.3, defMod: 1.1, align: ['lawful', 'neutral'], spellType: 'mage', tier: 2, requirements: { str: 15, int: 11, vit: 14, agi: 10 } },
      lord: { name: 'å›ä¸»', hpMod: 1.4, mpMod: 1.0, atkMod: 1.2, defMod: 1.2, align: ['lawful'], spellType: 'priest', tier: 2, requirements: { str: 15, int: 12, pie: 12, vit: 15, agi: 14, luk: 15 } },
      ninja: { name: 'å¿è€…', hpMod: 1.0, mpMod: 0.6, atkMod: 1.5, defMod: 0.8, align: ['chaotic'], spellType: null, tier: 2, requirements: { str: 15, int: 17, pie: 15, vit: 16, agi: 15, luk: 16 } }
    };

    const SPELLS = {
      mage: [
        { name: 'ãƒãƒªãƒˆ', level: 1, mp: 2, effect: 'damage', power: 15, desc: 'å°ç‚ã‚’æ”¾ã¤' },
        { name: 'ãƒ¢ã‚°ãƒ¬ãƒ•', level: 1, mp: 2, effect: 'buff_def', power: 3, desc: 'é˜²å¾¡åŠ›ä¸Šæ˜‡' },
        { name: 'ã‚«ãƒ†ã‚£ãƒ', level: 2, mp: 3, effect: 'sleep', power: 40, desc: 'æ•µã‚’çœ ã‚‰ã›ã‚‹' },
        { name: 'ãƒãƒãƒªãƒˆ', level: 3, mp: 5, effect: 'damage_all', power: 25, desc: 'ç«ç‚çƒã‚’æ”¾ã¤' },
        { name: 'ãƒ©ãƒãƒªãƒˆ', level: 4, mp: 6, effect: 'damage', power: 40, desc: 'å¤§ç«ç‚' },
        { name: 'ãƒ€ãƒ«ãƒˆ', level: 5, mp: 7, effect: 'damage', power: 55, desc: 'å†·æ°—ã®çŸ¢' },
        { name: 'ãƒªãƒˆã‚«ãƒ³', level: 5, mp: 7, effect: 'damage_all', power: 40, desc: 'ç‚ã®åµ' },
        { name: 'ãƒãƒ€ãƒ«ãƒˆ', level: 6, mp: 10, effect: 'damage_all', power: 60, desc: 'æ°·çµã®åµ' },
        { name: 'ãƒ†ã‚£ãƒ«ãƒˆã‚¦ã‚§ã‚¤ãƒˆ', level: 7, mp: 15, effect: 'damage_all', power: 80, desc: 'æ ¸çˆ†ç™ºç´šã®ç ´å£Šå‘ªæ–‡' }
      ],
      priest: [
        { name: 'ãƒ‡ã‚£ã‚ªã‚¹', level: 1, mp: 2, effect: 'heal', power: 20, desc: 'HPå°å›å¾©' },
        { name: 'ãƒãƒ‡ã‚£ã‚ªã‚¹', level: 1, mp: 2, effect: 'damage', power: 12, desc: 'ç¥è–ãªãƒ€ãƒ¡ãƒ¼ã‚¸' },
        { name: 'ãƒŸãƒ«ãƒ¯', level: 1, mp: 2, effect: 'light', power: 0, desc: 'æ¢ç´¢åŠ¹ç‡ä¸Šæ˜‡' },
        { name: 'ãƒãƒ‡ã‚£', level: 3, mp: 5, effect: 'heal', power: 50, desc: 'HPä¸­å›å¾©' },
        { name: 'ãƒ‡ã‚£ã‚¢ãƒ«', level: 4, mp: 6, effect: 'heal_all', power: 30, desc: 'å…¨ä½“HPå›å¾©' },
        { name: 'ãƒãƒãƒ‡ã‚£', level: 5, mp: 8, effect: 'heal', power: 80, desc: 'HPå¤§å›å¾©' },
        { name: 'ãƒãƒ‡ã‚£ã‚¢ãƒ«', level: 6, mp: 12, effect: 'heal_all', power: 60, desc: 'å…¨ä½“å¤§å›å¾©' },
        { name: 'ã‚«ãƒ‰ãƒ«ãƒˆ', level: 7, mp: 15, effect: 'resurrect', power: 50, desc: 'è˜‡ç”Ÿ' }
      ]
    };

    const ITEM_RARITY = { common: { name: 'ã‚³ãƒ¢ãƒ³', color: 'rarity-common', dropRate: 0.6 }, uncommon: { name: 'ã‚¢ãƒ³ã‚³ãƒ¢ãƒ³', color: 'rarity-uncommon', dropRate: 0.25 }, rare: { name: 'ãƒ¬ã‚¢', color: 'rarity-rare', dropRate: 0.1 }, epic: { name: 'ã‚¨ãƒ”ãƒƒã‚¯', color: 'rarity-epic', dropRate: 0.04 }, legendary: { name: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼', color: 'rarity-legendary', dropRate: 0.01 } };

    const ITEMS = {
      weapons: [
        { id: 'w001', name: 'ã‚·ãƒ§ãƒ¼ãƒˆã‚½ãƒ¼ãƒ‰', atk: 3, price: 50, minLv: 1, rarity: 'common', desc: 'åˆå¿ƒè€…ç”¨ã®å‰£' },
        { id: 'w002', name: 'ãƒ­ãƒ³ã‚°ã‚½ãƒ¼ãƒ‰', atk: 6, price: 150, minLv: 1, rarity: 'common', desc: 'æ¨™æº–çš„ãªé•·å‰£' },
        { id: 'w003', name: 'ãƒ€ã‚¬ãƒ¼', atk: 2, price: 30, minLv: 1, rarity: 'common', desc: 'çŸ­åˆ€' },
        { id: 'w004', name: 'ãƒ¡ã‚¤ã‚¹', atk: 5, price: 100, minLv: 1, rarity: 'common', jobs: ['priest', 'lord', 'bishop'], desc: 'åƒ§ä¾¶ã®æ­¦å™¨' },
        { id: 'w005', name: 'æ–', atk: 2, price: 40, minLv: 1, rarity: 'common', jobs: ['mage', 'bishop'], desc: 'é­”è¡“å¸«ã®æ–' },
        { id: 'w101', name: 'ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚½ãƒ¼ãƒ‰', atk: 10, price: 400, minLv: 3, rarity: 'uncommon', desc: 'å¹…åºƒã®å‰£' },
        { id: 'w102', name: 'ãƒãƒˆãƒ«ã‚¢ã‚¯ã‚¹', atk: 12, price: 500, minLv: 4, rarity: 'uncommon', desc: 'æˆ¦æ–§' },
        { id: 'w104', name: 'æ‰“åˆ€', atk: 11, price: 450, minLv: 4, rarity: 'uncommon', jobs: ['samurai', 'ninja'], desc: 'æ—¥æœ¬åˆ€' },
        { id: 'w201', name: 'ãƒ•ãƒ¬ã‚¤ãƒ ã‚½ãƒ¼ãƒ‰', atk: 20, price: 2000, minLv: 8, rarity: 'rare', desc: 'ç‚ã‚’çºã†å‰£' },
        { id: 'w202', name: 'ã‚¢ã‚¤ã‚¹ãƒ–ãƒ©ãƒ³ãƒ‰', atk: 18, price: 1800, minLv: 8, rarity: 'rare', desc: 'æ°·ã®å‰£' },
        { id: 'w204', name: 'å¤ªåˆ€', atk: 22, price: 2500, minLv: 10, rarity: 'rare', jobs: ['samurai', 'ninja'], desc: 'ä¸Šè³ªãªæ—¥æœ¬åˆ€' },
        { id: 'w208', name: 'ãƒ‰ãƒ©ã‚´ãƒ³ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼', atk: 25, price: 3500, minLv: 12, rarity: 'rare', desc: 'ãƒ‰ãƒ©ã‚´ãƒ³ç‰¹åŠ¹' },
        { id: 'w301', name: 'æ‘æ­£', atk: 35, price: 8000, minLv: 15, rarity: 'epic', jobs: ['samurai', 'ninja'], desc: 'å¦–åˆ€' },
        { id: 'w302', name: 'ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼', atk: 40, price: 15000, minLv: 18, rarity: 'epic', jobs: ['lord'], desc: 'è–å‰£' },
        { id: 'w303', name: 'ãƒŸãƒ§ãƒ«ãƒ‹ãƒ«', atk: 38, price: 12000, minLv: 17, rarity: 'epic', desc: 'é›·ç¥ã®æ§Œ' },
        { id: 'w401', name: 'å¦–åˆ€ãƒ ãƒ©ãƒã‚µ', atk: 55, price: 50000, minLv: 23, rarity: 'legendary', jobs: ['samurai', 'ninja'], desc: 'å‘ªã‚ã‚ŒãŸæœ€å¼·ã®åˆ€' },
        { id: 'w402', name: 'ãƒ­ãƒ³ã‚®ãƒŒã‚¹ã®æ§', atk: 50, price: 45000, minLv: 22, rarity: 'legendary', desc: 'è–æ§' },
        { id: 'w403', name: 'ãƒ©ã‚°ãƒŠãƒ­ã‚¯', atk: 60, price: 60000, minLv: 25, rarity: 'legendary', desc: 'çµ‚ç„‰ã®å‰£' }
      ],
      armors: [
        { id: 'a001', name: 'å¸ƒã®æœ', def: 2, price: 30, minLv: 1, rarity: 'common', desc: 'æ™®é€šã®æœ' },
        { id: 'a002', name: 'é©é§', def: 4, price: 100, minLv: 1, rarity: 'common', desc: 'é©è£½ã®é§' },
        { id: 'a003', name: 'ãƒ­ãƒ¼ãƒ–', def: 2, price: 50, minLv: 1, rarity: 'common', jobs: ['mage', 'bishop', 'priest'], desc: 'é­”è¡“å¸«ã®ãƒ­ãƒ¼ãƒ–' },
        { id: 'a101', name: 'ãƒã‚§ã‚¤ãƒ³ãƒ¡ã‚¤ãƒ«', def: 8, price: 400, minLv: 3, rarity: 'uncommon', jobs: ['fighter', 'lord', 'samurai'], desc: 'é–å¸·å­' },
        { id: 'a103', name: 'å¿ã³è£…æŸ', def: 5, price: 350, minLv: 3, rarity: 'uncommon', jobs: ['ninja', 'thief'], desc: 'ä¿Šæ•+3' },
        { id: 'a201', name: 'ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¡ã‚¤ãƒ«', def: 18, price: 2000, minLv: 8, rarity: 'rare', jobs: ['fighter', 'lord'], desc: 'æ¿é‡‘é§' },
        { id: 'a203', name: 'å¤§é§', def: 16, price: 2200, minLv: 8, rarity: 'rare', jobs: ['samurai'], desc: 'ä¾ã®é§' },
        { id: 'a301', name: 'ãƒ‰ãƒ©ã‚´ãƒ³ãƒ¡ã‚¤ãƒ«', def: 28, price: 8000, minLv: 15, rarity: 'epic', desc: 'ãƒ‰ãƒ©ã‚´ãƒ³ã®é±—é§' },
        { id: 'a303', name: 'ç¥å¨ã®å¤§é§', def: 30, price: 12000, minLv: 18, rarity: 'epic', jobs: ['samurai'], desc: 'ç¥ã®åŠ è­·ã‚’å—ã‘ãŸå¤§é§' },
        { id: 'a401', name: 'ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³ã‚¢ãƒ¼ãƒãƒ¼', def: 40, price: 50000, minLv: 23, rarity: 'legendary', desc: 'å®ˆè­·è€…ã®é§' },
        { id: 'a403', name: 'å¤©ç…§ã®å¤§é§', def: 45, price: 60000, minLv: 25, rarity: 'legendary', jobs: ['samurai', 'lord'], desc: 'å¤ªé™½ç¥ã®é§' }
      ],
      accessories: [
        { id: 'c001', name: 'éŠ…ã®æŒ‡è¼ª', atk: 1, price: 50, minLv: 1, rarity: 'common', desc: 'éŠ…è£½ã®æŒ‡è¼ª' },
        { id: 'c101', name: 'åŠ›ã®æŒ‡è¼ª', price: 300, minLv: 3, rarity: 'uncommon', effect: { str: 3 }, desc: 'ç­‹åŠ›+3' },
        { id: 'c102', name: 'å®ˆã‚Šã®æŒ‡è¼ª', price: 300, minLv: 3, rarity: 'uncommon', effect: { def: 3 }, desc: 'é˜²å¾¡+3' },
        { id: 'c106', name: 'å¹¸é‹ã®ã‚³ã‚¤ãƒ³', price: 400, minLv: 5, rarity: 'uncommon', effect: { luk: 5 }, desc: 'å¹¸é‹+5' },
        { id: 'c201', name: 'æˆ¦å£«ã®è…•è¼ª', price: 1500, minLv: 8, rarity: 'rare', effect: { str: 5, atk: 5 }, desc: 'ç­‹åŠ›+5, æ”»æ’ƒ+5' },
        { id: 'c203', name: 'å†ç”Ÿã®æŒ‡è¼ª', price: 2000, minLv: 10, rarity: 'rare', effect: { regen: 3 }, desc: 'HPè‡ªå‹•å›å¾©+3' },
        { id: 'c301', name: 'ãƒ‰ãƒ©ã‚´ãƒ³ãƒªãƒ³ã‚°', price: 8000, minLv: 15, rarity: 'epic', effect: { str: 8, vit: 8 }, desc: 'é¾ã®æŒ‡è¼ª' },
        { id: 'c304', name: 'ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹ãƒšãƒ³ãƒ€ãƒ³ãƒˆ', price: 15000, minLv: 20, rarity: 'epic', effect: { revive: 1 }, desc: 'æˆ¦é—˜ä¸èƒ½æ™‚1å›å¾©æ´»' },
        { id: 'c401', name: 'ç‹ã®è¨¼', price: 50000, minLv: 23, rarity: 'legendary', effect: { allStats: 10 }, desc: 'å…¨èƒ½åŠ›+10' },
        { id: 'c403', name: 'ã‚¤ãƒ³ãƒ•ã‚£ãƒ‹ãƒ†ã‚£ã‚¬ãƒ³ãƒˆãƒ¬ãƒƒãƒˆ', price: 100000, minLv: 30, rarity: 'legendary', effect: { allStats: 15 }, desc: 'ç©¶æ¥µã®ç¯­æ‰‹' }
      ],
      consumables: [
        { id: 'p001', name: 'ãƒãƒ¼ã‚·ãƒ§ãƒ³', price: 50, rarity: 'common', effect: { heal: 30 }, desc: 'HP30å›å¾©' },
        { id: 'p002', name: 'ãƒã‚¤ãƒãƒ¼ã‚·ãƒ§ãƒ³', price: 200, rarity: 'uncommon', effect: { heal: 100 }, desc: 'HP100å›å¾©' },
        { id: 'p003', name: 'ã‚¨ãƒ¼ãƒ†ãƒ«', price: 100, rarity: 'uncommon', effect: { mpHeal: 20 }, desc: 'MP20å›å¾©' },
        { id: 'p005', name: 'ã‚¨ãƒªã‚¯ã‚µãƒ¼', price: 2000, rarity: 'epic', effect: { fullHeal: true }, desc: 'HP/MPå…¨å›å¾©' },
        { id: 'p008', name: 'ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹ã®å°¾', price: 3000, rarity: 'epic', effect: { revive: true }, desc: 'æˆ¦é—˜ä¸èƒ½ã‹ã‚‰å¾©æ´»' }
      ]
    };

    const QUESTS = [
      { id: 'q1', name: 'ã¯ã˜ã‚ã¦ã®å†’é™º', desc: 'ã‚¹ãƒ©ã‚¤ãƒ ã®ç©´ã‚’B5Fã¾ã§è¸ç ´', condition: { dungeon: 'slime', floor: 5 }, reward: { gold: 500, exp: 200 } },
      { id: 'q2', name: 'ã‚³ãƒœãƒ«ãƒˆé€€æ²»', desc: 'ã‚³ãƒœãƒ«ãƒˆãƒ­ãƒ¼ãƒ‰ã‚’è¨ä¼', condition: { boss: 'ã‚³ãƒœãƒ«ãƒˆãƒ­ãƒ¼ãƒ‰' }, reward: { gold: 1000, exp: 500 } },
      { id: 'q3', name: 'ç›—è³Šå›£å£Šæ»…', desc: 'ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒ•ã‚’è¨ä¼', condition: { boss: 'ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒ•' }, reward: { gold: 2000, exp: 1000 } },
      { id: 'q4', name: 'ä¸‹æ°´é“ã®ææ€–', desc: 'ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢ã‚’è¨ä¼', condition: { boss: 'ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢' }, reward: { gold: 5000, exp: 2500 } },
      { id: 'q5', name: 'éºè·¡ã®ç§˜å¯†', desc: 'ã‚°ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚’è¨ä¼', condition: { boss: 'ã‚°ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ãƒ¢ãƒ³' }, reward: { gold: 8000, exp: 4000 } },
      { id: 'q6', name: 'ç‹å›½ã‚’æ•‘ãˆ', desc: 'ãƒ¯ãƒ¼ãƒ‰ãƒŠã‚’è¨ä¼ã—ã€é­”é™¤ã‘ã®è­·ç¬¦ã‚’å–ã‚Šæˆ»ã›', condition: { boss: 'ãƒ¯ãƒ¼ãƒ‰ãƒŠ' }, reward: { gold: 50000, exp: 30000 } },
      { id: 'q7', name: 'è»¢è·ã¸ã®é“', desc: 'ä¸Šç´šè·ã«è»¢è·ã™ã‚‹', condition: { jobChange: true }, reward: { gold: 3000, exp: 1500 } },
      { id: 'q8', name: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ãƒãƒ³ã‚¿ãƒ¼', desc: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã‚’å…¥æ‰‹', condition: { legendary: true }, reward: { gold: 20000, exp: 10000 } }
    ];

    const DUNGEONS = [
      { id: 'slime', name: 'ã‚¹ãƒ©ã‚¤ãƒ ã®ç©´', floors: 5, minLv: 1 },
      { id: 'kobold', name: 'ã‚³ãƒœãƒ«ãƒ‰ã®å·£', floors: 8, minLv: 3 },
      { id: 'thieves', name: 'ç›—è³Šã®ã‚¢ã‚¸ãƒˆ', floors: 10, minLv: 5 },
      { id: 'sewer', name: 'ã‚«ãƒªã‚°ãƒ©ãƒ¼ã‚¼ä¸‹æ°´è·¯', floors: 12, minLv: 8 },
      { id: 'kaoka', name: 'ã‚«ã‚ªã‚«ãƒ»ãƒ‘ãƒ©ãƒ¼ã‚¸éºè·¡', floors: 15, minLv: 12 },
      { id: 'deltis', name: 'ãƒ‡ãƒ«ãƒ†ã‚£ã‚¹å¤§è”µå®¤', floors: 18, minLv: 16 },
      { id: 'dragon', name: 'é»„é¾ã®ç¥æ®¿è·¡', floors: 20, minLv: 20 },
      { id: 'trebor', name: 'ãƒˆãƒ¬ãƒœãƒ¼ã®è©¦ç·´å ´', floors: 25, minLv: 25 }
    ];

    const MONSTERS = [
      { name: 'ãƒãƒ–ãƒªãƒ¼ã‚¹ãƒ©ã‚¤ãƒ ', hp: 12, atk: 4, def: 1, exp: 8, gold: 3, dungeon: 'slime', floor: 1 },
      { name: 'ã‚³ãƒœãƒ«ãƒˆ', hp: 18, atk: 6, def: 2, exp: 12, gold: 5, dungeon: 'slime', floor: 2 },
      { name: 'ã‚ªãƒ¼ã‚¯ãƒ™ãƒ“ãƒ¼', hp: 25, atk: 8, def: 3, exp: 18, gold: 8, dungeon: 'slime', floor: 3 },
      { name: 'ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ãƒƒãƒˆ', hp: 20, atk: 10, def: 2, exp: 22, gold: 10, dungeon: 'slime', floor: 4 },
      { name: 'ã‚¹ãƒ©ã‚¤ãƒ ã‚­ãƒ³ã‚°', hp: 50, atk: 15, def: 5, exp: 50, gold: 30, dungeon: 'slime', floor: 5, boss: true },
      { name: 'ã‚³ãƒœãƒ«ãƒˆã‚¦ã‚©ãƒ¼ãƒªã‚¢', hp: 30, atk: 12, def: 5, exp: 25, gold: 12, dungeon: 'kobold', floor: 1 },
      { name: 'ã‚³ãƒœãƒ«ãƒˆãƒ¡ã‚¤ã‚¸', hp: 22, atk: 18, def: 3, exp: 35, gold: 18, dungeon: 'kobold', floor: 3 },
      { name: 'ã‚ªãƒ¼ã‚¯', hp: 40, atk: 15, def: 6, exp: 40, gold: 20, dungeon: 'kobold', floor: 5 },
      { name: 'ã‚³ãƒœãƒ«ãƒˆãƒ­ãƒ¼ãƒ‰', hp: 80, atk: 25, def: 10, exp: 100, gold: 60, dungeon: 'kobold', floor: 8, boss: true },
      { name: 'ã‚·ãƒ¼ãƒ•', hp: 35, atk: 20, def: 6, exp: 40, gold: 25, dungeon: 'thieves', floor: 1 },
      { name: 'ã‚¢ã‚µã‚·ãƒ³', hp: 45, atk: 30, def: 8, exp: 60, gold: 40, dungeon: 'thieves', floor: 5 },
      { name: 'ãƒ€ãƒ¼ã‚¯ã‚¨ãƒ«ãƒ•', hp: 55, atk: 35, def: 10, exp: 80, gold: 50, dungeon: 'thieves', floor: 7 },
      { name: 'ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒ•', hp: 120, atk: 40, def: 15, exp: 150, gold: 100, dungeon: 'thieves', floor: 10, boss: true },
      { name: 'ã‚¾ãƒ³ãƒ“', hp: 55, atk: 15, def: 5, exp: 45, gold: 20, dungeon: 'sewer', floor: 1 },
      { name: 'ã‚¹ã‚±ãƒ«ãƒˆãƒ³', hp: 45, atk: 20, def: 8, exp: 50, gold: 25, dungeon: 'sewer', floor: 3 },
      { name: 'ã‚°ãƒ¼ãƒ«', hp: 65, atk: 25, def: 10, exp: 70, gold: 35, dungeon: 'sewer', floor: 5 },
      { name: 'ãƒ¯ã‚¤ãƒˆ', hp: 75, atk: 35, def: 12, exp: 90, gold: 50, dungeon: 'sewer', floor: 9 },
      { name: 'ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢', hp: 200, atk: 50, def: 20, exp: 250, gold: 150, dungeon: 'sewer', floor: 12, boss: true },
      { name: 'ã‚¹ãƒˆãƒ¼ãƒ³ã‚´ãƒ¼ãƒ¬ãƒ ', hp: 100, atk: 40, def: 25, exp: 120, gold: 60, dungeon: 'kaoka', floor: 1 },
      { name: 'ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«', hp: 90, atk: 50, def: 20, exp: 150, gold: 80, dungeon: 'kaoka', floor: 8 },
      { name: 'ã‚°ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ãƒ¢ãƒ³', hp: 300, atk: 70, def: 30, exp: 400, gold: 250, dungeon: 'kaoka', floor: 15, boss: true },
      { name: 'ãƒŸãƒŸãƒƒã‚¯', hp: 80, atk: 45, def: 15, exp: 100, gold: 200, dungeon: 'deltis', floor: 1 },
      { name: 'ãƒãƒ³ãƒ†ã‚£ã‚³ã‚¢', hp: 150, atk: 60, def: 25, exp: 200, gold: 150, dungeon: 'deltis', floor: 10 },
      { name: 'ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ‰ãƒ©ã‚´ãƒ³', hp: 400, atk: 80, def: 40, exp: 600, gold: 500, dungeon: 'deltis', floor: 18, boss: true },
      { name: 'ãƒ‰ãƒ©ã‚´ãƒ³ã‚¾ãƒ³ãƒ“', hp: 150, atk: 60, def: 20, exp: 200, gold: 100, dungeon: 'dragon', floor: 1 },
      { name: 'ãƒã‚¤ã‚ºãƒ³ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆ', hp: 180, atk: 70, def: 25, exp: 280, gold: 140, dungeon: 'dragon', floor: 10 },
      { name: 'ã‚¨ãƒ³ã‚·ã‚§ãƒ³ãƒˆãƒ‰ãƒ©ã‚´ãƒ³', hp: 600, atk: 100, def: 50, exp: 1000, gold: 800, dungeon: 'dragon', floor: 20, boss: true },
      { name: 'ãƒˆãƒ¬ãƒœãƒ¼è¦ªè¡›éšŠ', hp: 200, atk: 80, def: 35, exp: 300, gold: 150, dungeon: 'trebor', floor: 1 },
      { name: 'ãƒ€ãƒ¼ã‚¯ãƒŠã‚¤ãƒˆ', hp: 250, atk: 90, def: 40, exp: 400, gold: 200, dungeon: 'trebor', floor: 15 },
      { name: 'ãƒ¯ãƒ¼ãƒ‰ãƒŠ', hp: 999, atk: 150, def: 60, exp: 5000, gold: 3000, dungeon: 'trebor', floor: 25, boss: true }
    ];

    const TRAPS = [
      { name: 'ãƒã‚¤ã‚ºãƒ³ãƒ‹ãƒ¼ãƒ‰ãƒ«', effect: 'poison', damage: 0.1 },
      { name: 'ã‚¯ãƒ­ã‚¹ãƒœã‚¦ãƒœãƒ«ãƒˆ', effect: 'damage', damage: 0.15 },
      { name: 'çˆ†ç™ºã™ã‚‹ç®±', effect: 'damage_all', damage: 0.2 },
      { name: 'ã‚¬ã‚¹ãƒœãƒ ', effect: 'poison_all', damage: 0.05 },
      { name: 'ãƒ†ãƒ¬ãƒãƒ¼ã‚¿ãƒ¼', effect: 'teleport', damage: 0 },
      { name: 'ã‚¢ãƒ©ãƒ¼ãƒ ', effect: 'summon', damage: 0 }
    ];

    const WIZ_PHRASES = [
      'ã•ã•ã‚„ãï¼ã„ã®ã‚Šï¼ãˆã„ã—ã‚‡ã†ï¼ã­ã‚“ã˜ã‚ï¼', 'ãƒ‘ãƒ¼ãƒ†ã‚£ã¯æ…é‡ã«é€²ã‚“ã ...', 'å®ç®±ã‚’ç™ºè¦‹ã—ãŸï¼',
      'ç½ ã ï¼æ°—ã‚’ã¤ã‘ã‚ï¼', 'éšæ®µã‚’ç™ºè¦‹ã—ãŸ...', 'ãƒ‘ãƒ¼ãƒ†ã‚£ã¯ä¼‘æ¯ã‚’ã¨ã£ãŸ', 'æ³‰ã‚’ç™ºè¦‹ï¼ç¥ç§˜ã®æ°´ãŒæ¹§ã„ã¦ã„ã‚‹',
      'å£ã«ä½•ã‹æ›¸ã„ã¦ã‚ã‚‹..."TREBOR SUX"', 'ãƒœãƒ«ã‚¿ãƒƒã‚¯å•†åº—ã®å•†äººã¨ã™ã‚Œé•ã£ãŸ', 'ã‚«ãƒ³ãƒˆå¯ºé™¢ã®åƒ§ä¾¶ã®ç¥ˆã‚ŠãŒèã“ãˆã‚‹...'
    ];

    // ===== ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª =====
    function App() {
      const [screen, setScreen] = useState('title');
      const [party, setParty] = useState([]);
      const [gold, setGold] = useState(100);
      const [logs, setLogs] = useState([]);
      const [exploring, setExploring] = useState(false);
      const [currentDungeon, setCurrentDungeon] = useState(null);
      const [currentFloor, setCurrentFloor] = useState(1);
      const [maxFloors, setMaxFloors] = useState({});
      const [retreatCondition, setRetreatCondition] = useState({ type: 'hp', value: 30 });
      const [activeTab, setActiveTab] = useState('party');
      const [settings, setSettings] = useState({ bgm: true, sfx: true, bgmVol: 50, sfxVol: 70 });
      const [bestiary, setBestiary] = useState({});
      const [completedQuests, setCompletedQuests] = useState([]);
      const [defeatedBosses, setDefeatedBosses] = useState([]);
      const [inventory, setInventory] = useState([]);
      const [showSettings, setShowSettings] = useState(false);
      const [showJobChange, setShowJobChange] = useState(null);
      const [showStory, setShowStory] = useState(false);
      const [showDungeonInfo, setShowDungeonInfo] = useState(null);
      const [shopCategory, setShopCategory] = useState('weapons');
      const [selectedChar, setSelectedChar] = useState(null);
      const [seenPrologue, setSeenPrologue] = useState(false);
      const logRef = useRef(null);

      const initSound = async () => { await soundEngine.init(); if (settings.bgm) soundEngine.startBGM(); };

      // ã‚»ãƒ¼ãƒ–/ãƒ­ãƒ¼ãƒ‰
      useEffect(() => {
        const saved = localStorage.getItem('wizardrySchemaV5');
        if (saved) {
          const data = JSON.parse(saved);
          setParty(data.party || []);
          setGold(data.gold || 100);
          setMaxFloors(data.maxFloors || {});
          setSettings(data.settings || { bgm: true, sfx: true, bgmVol: 50, sfxVol: 70 });
          setBestiary(data.bestiary || {});
          setCompletedQuests(data.completedQuests || []);
          setDefeatedBosses(data.defeatedBosses || []);
          setInventory(data.inventory || []);
          setSeenPrologue(data.seenPrologue || false);
        }
      }, []);

      useEffect(() => {
        if (party.length > 0 || Object.keys(bestiary).length > 0) {
          localStorage.setItem('wizardrySchemaV5', JSON.stringify({ party, gold, maxFloors, settings, bestiary, completedQuests, defeatedBosses, inventory, seenPrologue }));
        }
      }, [party, gold, maxFloors, settings, bestiary, completedQuests, defeatedBosses, inventory, seenPrologue]);

      useEffect(() => { if (logRef.current) logRef.current.scrollTop = logRef.current.scrollHeight; }, [logs]);
      useEffect(() => { soundEngine.toggleBGM(settings.bgm); }, [settings.bgm]);
      useEffect(() => { soundEngine.setBgmVolume(-30 + (settings.bgmVol * 0.3)); }, [settings.bgmVol]);
      useEffect(() => { soundEngine.setSfxVolume(-20 + (settings.sfxVol * 0.2)); }, [settings.sfxVol]);

      const addLog = (message, type = 'normal') => {
        const colors = { normal: 'text-green-400', battle: 'text-yellow-400', damage: 'text-red-400', heal: 'text-blue-400', item: 'text-purple-400', level: 'text-cyan-400', special: 'text-pink-400', spell: 'text-orange-400' };
        setLogs(prev => [...prev.slice(-150), { message, color: colors[type], time: Date.now() }]);
      };

      // è»¢è·
      const canChangeJob = (char, jobKey) => {
        const job = JOBS[jobKey];
        if (!job.align.includes(char.alignKey)) return { can: false, reason: 'å±æ€§ä¸ä¸€è‡´' };
        if (char.level < 10) return { can: false, reason: 'Lv.10å¿…è¦' };
        for (const [stat, req] of Object.entries(job.requirements)) {
          if ((char[stat] || 0) < req) return { can: false, reason: `${stat}${req}å¿…è¦` };
        }
        return { can: true };
      };

      const changeJob = (charId, newJobKey) => {
        setParty(prev => prev.map(char => {
          if (char.id !== charId) return char;
          const newJob = JOBS[newJobKey];
          const baseHp = Math.floor((char.vit * 3 + 20) * newJob.hpMod);
          const baseMp = Math.floor((char.int * 2 + 10) * newJob.mpMod);
          soundEngine.playJobChange();
          addLog(`â˜… ${char.name}ã¯${newJob.name}ã«è»¢è·ã—ãŸï¼`, 'level');
          return { ...char, job: newJob.name, jobKey: newJobKey, level: 1, exp: 0, maxHp: baseHp + Math.floor(char.maxHp * 0.3), currentHp: baseHp + Math.floor(char.maxHp * 0.3), maxMp: baseMp + Math.floor(char.maxMp * 0.2), currentMp: baseMp + Math.floor(char.maxMp * 0.2), atk: Math.floor((char.str * 1.5 + 5) * newJob.atkMod), def: Math.floor((char.vit * 1.2 + 3) * newJob.defMod), previousJobs: [...(char.previousJobs || []), char.jobKey] };
        }));
        setShowJobChange(null);
        if (!completedQuests.includes('q7')) { setCompletedQuests(prev => [...prev, 'q7']); setGold(prev => prev + 3000); addLog('ã€ã‚¯ã‚¨ã‚¹ãƒˆé”æˆã€‘è»¢è·ã¸ã®é“ï¼å ±é…¬: 3000G', 'level'); }
      };

      // ã‚¢ã‚¤ãƒ†ãƒ ãƒ‰ãƒ­ãƒƒãƒ—
      const getRandomDrop = (floor) => {
        const rand = Math.random();
        let rarity = 'common';
        if (rand < 0.01 && floor >= 20) rarity = 'legendary';
        else if (rand < 0.05 && floor >= 12) rarity = 'epic';
        else if (rand < 0.15 && floor >= 6) rarity = 'rare';
        else if (rand < 0.40) rarity = 'uncommon';
        const allItems = [...ITEMS.weapons, ...ITEMS.armors, ...ITEMS.accessories, ...ITEMS.consumables];
        const available = allItems.filter(item => item.rarity === rarity && (!item.minLv || item.minLv <= Math.floor(floor / 2) + 3));
        if (available.length === 0) return null;
        return { ...available[Math.floor(Math.random() * available.length)], id: Date.now() + Math.random() };
      };

      // ã‚¯ã‚¨ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯
      const checkQuests = useCallback((dungeon, floor, bossName = null, item = null) => {
        QUESTS.forEach(quest => {
          if (completedQuests.includes(quest.id)) return;
          let completed = false;
          if (quest.condition.dungeon && quest.condition.floor && dungeon === quest.condition.dungeon && floor >= quest.condition.floor) completed = true;
          if (quest.condition.boss && bossName === quest.condition.boss) completed = true;
          if (quest.condition.legendary && item?.rarity === 'legendary') completed = true;
          if (completed) {
            setCompletedQuests(prev => [...prev, quest.id]);
            setGold(prev => prev + quest.reward.gold);
            addLog(`ã€ã‚¯ã‚¨ã‚¹ãƒˆé”æˆã€‘${quest.name}ï¼`, 'level');
            soundEngine.playLevelUp();
            setParty(prev => prev.map(char => ({ ...char, exp: char.exp + Math.floor(quest.reward.exp / prev.length) })));
          }
        });
      }, [completedQuests]);

      // æ¢ç´¢ãƒ«ãƒ¼ãƒ—
      useEffect(() => {
        if (!exploring || party.length === 0 || !currentDungeon) return;
        const interval = setInterval(() => {
          const aliveParty = party.filter(c => c.currentHp > 0);
          const shouldRetreat = aliveParty.some(c => (c.currentHp / c.maxHp) * 100 <= retreatCondition.value);
          if (aliveParty.length === 0) { addLog('ã€å…¨æ»…ã€‘' + WIZ_PHRASES[0], 'damage'); soundEngine.playDeath(); setExploring(false); setCurrentFloor(1); setParty(prev => prev.map(c => ({ ...c, currentHp: Math.floor(c.maxHp * 0.5) }))); return; }
          if (shouldRetreat) { addLog(`ã€é›¢è„±ã€‘HP${retreatCondition.value}%ä»¥ä¸‹`, 'special'); setExploring(false); setCurrentFloor(1); setParty(prev => prev.map(c => ({ ...c, currentHp: c.maxHp, currentMp: c.maxMp }))); return; }

          const event = Math.random();
          const dungeon = DUNGEONS.find(d => d.id === currentDungeon);

          if (event < 0.55) {
            const availableMonsters = MONSTERS.filter(m => m.dungeon === currentDungeon && m.floor <= currentFloor);
            if (availableMonsters.length === 0) { addLog(`B${currentFloor}F: ${WIZ_PHRASES[1]}`, 'normal'); return; }
            const monster = { ...availableMonsters[Math.floor(Math.random() * availableMonsters.length)] };
            const isBoss = monster.boss && currentFloor === monster.floor;
            if (isBoss) soundEngine.playBossAppear();
            addLog(`B${currentFloor}F: ${monster.name}${isBoss ? 'ã€BOSSã€‘' : ''}ãŒç¾ã‚ŒãŸï¼`, 'battle');
            setBestiary(prev => ({ ...prev, [monster.name]: { ...monster, encountered: (prev[monster.name]?.encountered || 0) + 1 } }));

            setTimeout(() => {
              let monsterHp = monster.hp;
              let battleLogs = [];
              aliveParty.forEach(char => {
                if (monsterHp <= 0) return;
                const job = JOBS[char.jobKey];
                if (job.spellType && char.currentMp >= 2 && Math.random() < 0.3) {
                  const spellList = job.spellType === 'both' ? [...SPELLS.mage, ...SPELLS.priest] : SPELLS[job.spellType] || [];
                  const attackSpells = spellList.filter(s => (s.effect === 'damage' || s.effect === 'damage_all') && s.mp <= char.currentMp && s.level <= Math.floor(char.level / 2) + 1);
                  if (attackSpells.length > 0) {
                    const spell = attackSpells[Math.floor(Math.random() * attackSpells.length)];
                    const damage = spell.power + Math.floor(char.int * 0.5);
                    monsterHp -= damage;
                    setParty(prev => prev.map(c => c.id === char.id ? { ...c, currentMp: c.currentMp - spell.mp } : c));
                    battleLogs.push({ msg: `${char.name}ã¯${spell.name}ï¼${damage}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, type: 'spell' });
                    soundEngine.playAttack();
                    return;
                  }
                }
                const damage = Math.max(1, char.atk - monster.def + Math.floor(Math.random() * 10));
                monsterHp -= damage;
                battleLogs.push({ msg: `${char.name}ã®æ”»æ’ƒï¼${damage}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, type: 'battle' });
                soundEngine.playAttack();
              });

              if (monsterHp <= 0) {
                battleLogs.push({ msg: `${monster.name}ã‚’å€’ã—ãŸï¼${monster.exp}EXP, ${monster.gold}G`, type: 'item' });
                soundEngine.playGold();
                setGold(prev => prev + monster.gold);
                if (isBoss) {
                  setDefeatedBosses(prev => [...new Set([...prev, monster.name])]);
                  checkQuests(currentDungeon, currentFloor, monster.name);
                  const drop = getRandomDrop(currentFloor + 5);
                  if (drop) { setInventory(prev => [...prev, drop]); battleLogs.push({ msg: `ã€ãƒ‰ãƒ­ãƒƒãƒ—ã€‘${drop.name}`, type: 'item' }); checkQuests(null, null, null, drop); }
                }
                setParty(prev => prev.map(char => {
                  if (char.currentHp <= 0) return char;
                  const expGain = Math.floor(monster.exp / aliveParty.length);
                  const newExp = char.exp + expGain;
                  const expNeeded = char.level * 100;
                  if (newExp >= expNeeded) {
                    battleLogs.push({ msg: `â˜… ${char.name}ãŒLv.${char.level + 1}ã«ï¼`, type: 'level' });
                    soundEngine.playLevelUp();
                    return { ...char, exp: newExp - expNeeded, level: char.level + 1, maxHp: char.maxHp + 5 + Math.floor(char.vit * 0.5), currentHp: char.maxHp + 5 + Math.floor(char.vit * 0.5), maxMp: char.maxMp + 3 + Math.floor(char.int * 0.3), currentMp: char.maxMp + 3 + Math.floor(char.int * 0.3), atk: char.atk + 2, def: char.def + 1 };
                  }
                  return { ...char, exp: newExp };
                }));
              } else {
                soundEngine.playHit();
                const target = aliveParty[Math.floor(Math.random() * aliveParty.length)];
                const dmg = Math.max(1, monster.atk - target.def + Math.floor(Math.random() * 8));
                setParty(prev => prev.map(char => {
                  if (char.id === target.id) {
                    const newHp = Math.max(0, char.currentHp - dmg);
                    battleLogs.push({ msg: `${monster.name}ã®åæ’ƒï¼${char.name}ã«${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`, type: 'damage' });
                    if (newHp === 0) { battleLogs.push({ msg: `${char.name}ã¯å€’ã‚ŒãŸ...`, type: 'damage' }); soundEngine.playDeath(); }
                    return { ...char, currentHp: newHp };
                  }
                  return char;
                }));
              }
              battleLogs.forEach((log, i) => setTimeout(() => addLog(log.msg, log.type), i * 200));
            }, 400);
          } else if (event < 0.72) {
            if (currentFloor < dungeon.floors) {
              const newFloor = currentFloor + 1;
              setCurrentFloor(newFloor);
              setMaxFloors(prev => ({ ...prev, [currentDungeon]: Math.max(prev[currentDungeon] || 0, newFloor) }));
              addLog(`${WIZ_PHRASES[4]} B${newFloor}Fã¸...`, 'item');
              checkQuests(currentDungeon, newFloor);
            }
          } else if (event < 0.85) {
            const goldFound = Math.floor(Math.random() * 50 * currentFloor) + 10;
            addLog(`${WIZ_PHRASES[2]}`, 'item');
            const hasThief = aliveParty.some(c => c.jobKey === 'thief' || c.jobKey === 'ninja');
            if (Math.random() < (hasThief ? 0.1 : 0.25)) {
              const trap = TRAPS[Math.floor(Math.random() * TRAPS.length)];
              addLog(`${WIZ_PHRASES[3]} ${trap.name}ï¼`, 'damage');
              soundEngine.playHit();
              if (trap.damage > 0) {
                setParty(prev => prev.map(c => ({ ...c, currentHp: Math.max(1, c.currentHp - Math.floor(c.maxHp * trap.damage)) })));
              }
            } else {
              setGold(prev => prev + goldFound);
              addLog(`${goldFound}Gã‚’ç™ºè¦‹ï¼`, 'item');
              soundEngine.playGold();
              if (Math.random() < 0.15) {
                const drop = getRandomDrop(currentFloor);
                if (drop) { setInventory(prev => [...prev, drop]); addLog(`${drop.name}ã‚’ç™ºè¦‹ï¼`, 'item'); checkQuests(null, null, null, drop); }
              }
            }
          } else if (event < 0.92) {
            addLog(WIZ_PHRASES[6], 'heal');
            soundEngine.playHeal();
            setParty(prev => prev.map(c => ({ ...c, currentHp: Math.min(c.maxHp, c.currentHp + Math.floor(c.maxHp * 0.25)), currentMp: Math.min(c.maxMp, c.currentMp + Math.floor(c.maxMp * 0.25)) })));
          } else {
            addLog(`B${currentFloor}F: ${WIZ_PHRASES[Math.floor(Math.random() * WIZ_PHRASES.length)]}`, 'special');
          }
        }, 1800);
        return () => clearInterval(interval);
      }, [exploring, party, currentFloor, currentDungeon, retreatCondition, checkQuests]);

      // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      const exportSave = () => { const blob = new Blob([JSON.stringify({ party, gold, maxFloors, settings, bestiary, completedQuests, defeatedBosses, inventory, seenPrologue })], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `wizardry-schema-${Date.now()}.json`; a.click(); };
      const importSave = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); setParty(data.party || []); setGold(data.gold || 100); setMaxFloors(data.maxFloors || {}); setSettings(data.settings || { bgm: true, sfx: true, bgmVol: 50, sfxVol: 70 }); setBestiary(data.bestiary || {}); setCompletedQuests(data.completedQuests || []); setDefeatedBosses(data.defeatedBosses || []); setInventory(data.inventory || []); setSeenPrologue(data.seenPrologue || false); alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†'); } catch { alert('å¤±æ•—'); } }; reader.readAsText(file); };

      // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«
      const StoryModal = ({ onClose }) => (
        <div className="modal-overlay" onClick={onClose}>
          <div className="retro-border bg-black p-6 max-w-lg max-h-[80vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <h2 className="text-xl gold-text mb-4 text-center">ğŸ“œ ãƒªãƒ«ã‚¬ãƒŸãƒ³ã®ä¼èª¬</h2>
            <div className="story-text text-sm text-gray-300 whitespace-pre-line mb-4">{WORLD_STORY.prologue}</div>
            <hr className="border-green-800 my-4" />
            <div className="story-text text-sm text-gray-300 whitespace-pre-line">{WORLD_STORY.gilgamesh}</div>
            <button onClick={() => { onClose(); setSeenPrologue(true); }} className="mt-6 w-full retro-border py-2 hover:bg-green-900">å†’é™ºã‚’å§‹ã‚ã‚‹</button>
          </div>
        </div>
      );

      // ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ«
      const DungeonInfoModal = ({ dungeonId, onClose, onEnter }) => {
        const lore = DUNGEON_LORE[dungeonId];
        const dungeon = DUNGEONS.find(d => d.id === dungeonId);
        if (!lore) return null;
        return (
          <div className="modal-overlay" onClick={onClose}>
            <div className="retro-border bg-black p-4 max-w-md" onClick={e => e.stopPropagation()}>
              <h3 className="text-lg gold-text mb-2">ğŸ° {lore.name}</h3>
              <p className="text-xs text-gray-500 mb-3">å…¨{dungeon.floors}éšå±¤ | æ¨å¥¨Lv.{dungeon.minLv}+</p>
              <div className="bg-gray-900 p-3 mb-3">
                <h4 className="text-sm text-green-400 mb-1">ã€èƒŒæ™¯ã€‘</h4>
                <p className="text-xs text-gray-300 story-text">{lore.story}</p>
              </div>
              <div className="bg-gray-900 p-3 mb-3">
                <h4 className="text-sm text-yellow-400 mb-1">ã€ç›®çš„ã€‘</h4>
                <p className="text-xs text-gray-300">{lore.objective}</p>
              </div>
              <div className="bg-gray-900 p-3 mb-3">
                <h4 className="text-sm text-purple-400 mb-1">ã€å ±é…¬ã€‘</h4>
                <p className="text-xs text-gray-300">{lore.reward}</p>
              </div>
              <div className="flex gap-2">
                <button onClick={() => { onEnter(); onClose(); }} className="flex-1 retro-border py-2 hover:bg-green-900">æ¢ç´¢é–‹å§‹</button>
                <button onClick={onClose} className="flex-1 retro-border py-2 hover:bg-red-900 text-red-400">æˆ»ã‚‹</button>
              </div>
            </div>
          </div>
        );
      };

      // è»¢è·ãƒ¢ãƒ¼ãƒ€ãƒ«
      const JobChangeModal = ({ char, onClose }) => {
        if (!char) return null;
        return (
          <div className="modal-overlay" onClick={onClose}>
            <div className="retro-border bg-black p-4 max-w-md max-h-96 overflow-y-auto" onClick={e => e.stopPropagation()}>
              <h3 className="text-lg gold-text mb-3">ğŸ”„ è»¢è· - {char.name}</h3>
              <p className="text-xs text-gray-400 mb-3">ç¾åœ¨: Lv.{char.level} {char.job}</p>
              <div className="space-y-2">
                {Object.entries(JOBS).map(([key, job]) => {
                  if (key === char.jobKey) return null;
                  const check = canChangeJob(char, key);
                  return (
                    <div key={key} className={`p-2 bg-gray-900 ${check.can ? 'cursor-pointer hover:bg-green-900' : 'opacity-50'}`} onClick={() => check.can && changeJob(char.id, key)}>
                      <div className="flex justify-between">
                        <span className={job.tier === 2 ? 'gold-text' : ''}>{job.name} {job.tier === 2 ? 'â˜…' : ''}</span>
                        <span className="text-xs">{check.can ? 'å¯èƒ½' : check.reason}</span>
                      </div>
                    </div>
                  );
                })}
              </div>
              <button onClick={onClose} className="mt-4 w-full retro-border py-1 hover:bg-red-900 text-red-400">é–‰ã˜ã‚‹</button>
            </div>
          </div>
        );
      };

      // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢
      if (screen === 'title') {
        return (
          <div className="min-h-screen flex flex-col items-center justify-center p-4">
            <div className="retro-border p-8 bg-black text-center max-w-md">
              <h1 className="text-3xl mb-2 gold-text">âš”ï¸ WIZARDRY SCHEMA âš”ï¸</h1>
              <p className="text-sm mb-1 text-gray-400">ã€œ ãƒªãƒ«ã‚¬ãƒŸãƒ³ã®è¿·å®® ã€œ</p>
              <p className="text-xs mb-1 text-gray-500">v5.0 - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼†ãƒœãƒªãƒ¥ãƒ¼ãƒ èª¿æ•´</p>
              <p className="text-xs mb-6 text-gray-600">ã•ã•ã‚„ãï¼ã„ã®ã‚Šï¼ãˆã„ã—ã‚‡ã†ï¼ã­ã‚“ã˜ã‚ï¼</p>
              <div className="space-y-3">
                <button onClick={() => { setScreen('main'); initSound(); if (!seenPrologue && party.length === 0) setShowStory(true); }} className="block w-full retro-border px-6 py-2 hover:bg-green-900">{party.length > 0 ? 'â–¶ CONTINUE' : 'â–¶ NEW GAME'}</button>
                {party.length > 0 && (
                  <>
                    <button onClick={exportSave} className="block w-full retro-border px-6 py-2 hover:bg-blue-900 text-blue-400">ğŸ“¤ EXPORT</button>
                    <button onClick={() => { if(confirm('å‰Šé™¤ï¼Ÿ')) { localStorage.removeItem('wizardrySchemaV5'); setParty([]); setGold(100); setMaxFloors({}); setBestiary({}); setCompletedQuests([]); setDefeatedBosses([]); setInventory([]); setSeenPrologue(false); } }} className="block w-full retro-border px-6 py-2 hover:bg-red-900 text-red-400">ğŸ—‘ï¸ DELETE</button>
                  </>
                )}
                <label className="block w-full retro-border px-6 py-2 hover:bg-purple-900 text-purple-400 cursor-pointer">ğŸ“¥ IMPORT<input type="file" accept=".json" onChange={importSave} className="hidden" /></label>
              </div>
              <p className="mt-6 text-xs text-gray-600">Â© 2026 Claude RPG Engine</p>
            </div>
          </div>
        );
      }

      // ã‚­ãƒ£ãƒ©ä½œæˆ
      const createRandomCharacter = () => {
        if (party.length >= 6) return;
        const raceKeys = Object.keys(RACES);
        const raceKey = raceKeys[Math.floor(Math.random() * raceKeys.length)];
        const race = RACES[raceKey];
        const alignKeys = Object.keys(ALIGNMENTS);
        const alignKey = alignKeys[Math.floor(Math.random() * alignKeys.length)];
        const availableJobs = Object.entries(JOBS).filter(([_, job]) => job.align.includes(alignKey) && job.tier === 1);
        const [jobKey, job] = availableJobs[Math.floor(Math.random() * availableJobs.length)];
        const bonusPoints = Math.floor(Math.random() * 15) + 5;
        const vit = race.vit + Math.floor(bonusPoints * 0.4);
        const int = race.int + Math.floor(bonusPoints * 0.2);
        const newChar = { id: Date.now(), name: generateName(raceKey), race: race.name, raceKey, alignment: ALIGNMENTS[alignKey].name, alignKey, job: job.name, jobKey, level: 1, exp: 0, maxHp: Math.floor((vit * 3 + 20) * job.hpMod), currentHp: Math.floor((vit * 3 + 20) * job.hpMod), maxMp: Math.floor((int * 2 + 10) * job.mpMod), currentMp: Math.floor((int * 2 + 10) * job.mpMod), atk: Math.floor((race.str * 1.5 + 5) * job.atkMod), def: Math.floor((vit * 1.2 + 3) * job.defMod), str: race.str, int: int, pie: race.pie, vit: vit, agi: race.agi, luk: race.luk, equipment: { weapon: null, armor: null, accessory: null }, previousJobs: [] };
        setParty(prev => [...prev, newChar]);
        addLog(`${newChar.name}ï¼ˆ${race.name}ã®${job.name}ï¼‰ãŒç™»éŒ²ã•ã‚ŒãŸï¼`, 'level');
      };

      // è£…å‚™
      const equipItem = (charId, item) => {
        let slot = item.slot || (ITEMS.weapons.find(i => i.id === item.id) ? 'weapon' : ITEMS.armors.find(i => i.id === item.id) ? 'armor' : 'accessory');
        setParty(prev => prev.map(char => {
          if (char.id !== charId) return char;
          const oldItem = char.equipment[slot];
          let newAtk = char.atk, newDef = char.def;
          if (oldItem) { if (oldItem.atk) newAtk -= oldItem.atk; if (oldItem.def) newDef -= oldItem.def; setInventory(prev => [...prev, oldItem]); }
          if (item.atk) newAtk += item.atk; if (item.def) newDef += item.def;
          setInventory(prev => prev.filter(i => i.id !== item.id));
          return { ...char, atk: newAtk, def: newDef, equipment: { ...char.equipment, [slot]: item } };
        }));
        addLog(`è£…å‚™: ${item.name}`, 'item');
      };

      // ãƒ¡ã‚¤ãƒ³ç”»é¢
      return (
        <div className="min-h-screen p-2">
          {showStory && <StoryModal onClose={() => setShowStory(false)} />}
          {showJobChange && <JobChangeModal char={showJobChange} onClose={() => setShowJobChange(null)} />}
          {showDungeonInfo && <DungeonInfoModal dungeonId={showDungeonInfo} onClose={() => setShowDungeonInfo(null)} onEnter={() => { setExploring(true); setCurrentFloor(1); setLogs([]); addLog(`ã€${DUNGEON_LORE[showDungeonInfo].name}ã€‘ã¸å‡ºç™ºï¼`, 'level'); setCurrentDungeon(showDungeonInfo); }} />}
          
          <div className="max-w-6xl mx-auto">
            {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
            <div className="retro-border p-3 mb-3 flex justify-between items-center flex-wrap gap-2">
              <div className="flex items-center gap-3">
                <h1 className="text-lg gold-text">âš”ï¸ WIZARDRY SCHEMA</h1>
                <button onClick={() => setShowStory(true)} className="text-xs text-gray-500 hover:text-green-400">ğŸ“œ ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</button>
              </div>
              <div className="flex gap-4 text-sm items-center">
                <span className="gold-text">ğŸ’° {gold.toLocaleString()} G</span>
                <span className="purple-text">ğŸ“¦ {inventory.length}</span>
                <button onClick={() => setShowSettings(!showSettings)} className="text-gray-400 hover:text-white">âš™ï¸</button>
              </div>
            </div>

            {/* è¨­å®šãƒ‘ãƒãƒ« */}
            {showSettings && (
              <div className="retro-border p-3 mb-3 bg-gray-900">
                <div className="grid md:grid-cols-2 gap-4 text-xs">
                  <div>
                    <label className="flex items-center gap-2 mb-2"><input type="checkbox" checked={settings.bgm} onChange={(e) => setSettings(prev => ({ ...prev, bgm: e.target.checked }))} /> BGM</label>
                    <div className="flex items-center gap-2">
                      <span className="w-16">éŸ³é‡:</span>
                      <input type="range" min="0" max="100" value={settings.bgmVol} onChange={(e) => setSettings(prev => ({ ...prev, bgmVol: parseInt(e.target.value) }))} className="flex-1" />
                      <span className="w-8">{settings.bgmVol}%</span>
                    </div>
                  </div>
                  <div>
                    <label className="flex items-center gap-2 mb-2"><input type="checkbox" checked={settings.sfx} onChange={(e) => { setSettings(prev => ({ ...prev, sfx: e.target.checked })); soundEngine.sfxEnabled = e.target.checked; }} /> åŠ¹æœéŸ³</label>
                    <div className="flex items-center gap-2">
                      <span className="w-16">éŸ³é‡:</span>
                      <input type="range" min="0" max="100" value={settings.sfxVol} onChange={(e) => setSettings(prev => ({ ...prev, sfxVol: parseInt(e.target.value) }))} className="flex-1" />
                      <span className="w-8">{settings.sfxVol}%</span>
                    </div>
                  </div>
                </div>
                <div className="mt-3 flex gap-2">
                  <button onClick={exportSave} className="text-blue-400 hover:underline text-xs">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                </div>
              </div>
            )}

            {/* ã‚¿ãƒ– */}
            <div className="flex gap-1 mb-3 flex-wrap">
              {['party', 'dungeon', 'shop', 'inventory', 'quest', 'bestiary'].map(tab => (
                <button key={tab} onClick={() => setActiveTab(tab)} className={`retro-border px-3 py-1 text-xs tab-btn ${activeTab === tab ? 'active' : ''}`}>
                  {{ party: 'ğŸ‘¥ ãƒ‘ãƒ¼ãƒ†ã‚£', dungeon: 'ğŸ° ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³', shop: 'ğŸ›’ ã‚·ãƒ§ãƒƒãƒ—', inventory: 'ğŸ“¦ æ‰€æŒå“', quest: 'ğŸ“œ ã‚¯ã‚¨ã‚¹ãƒˆ', bestiary: 'ğŸ“– å›³é‘‘' }[tab]}
                </button>
              ))}
            </div>

            <div className="grid lg:grid-cols-3 gap-3">
              <div className="lg:col-span-2 retro-border p-3">
                {/* ãƒ‘ãƒ¼ãƒ†ã‚£ */}
                {activeTab === 'party' && (
                  <>
                    <h2 className="text-base mb-2 border-b border-green-800 pb-1">ã€ ã‚®ãƒ«ã‚¬ãƒ¡ãƒƒã‚·ãƒ¥ã®é…’å ´ ã€‘({party.length}/6)</h2>
                    <div className="grid md:grid-cols-2 gap-2 max-h-96 overflow-y-auto">
                      {party.map(char => (
                        <div key={char.id} className={`p-2 bg-gray-900 text-xs ${char.currentHp === 0 ? 'opacity-50' : ''}`}>
                          <div className="flex justify-between"><span className="font-bold">{char.name}</span><span className={ALIGNMENTS[char.alignKey]?.color}>{char.alignment}</span></div>
                          <div className="text-gray-400">Lv.{char.level} {char.race} {char.job}</div>
                          {char.previousJobs?.length > 0 && <div className="text-gray-600 text-[10px]">å‰è·: {char.previousJobs.map(j => JOBS[j]?.name).join('â†’')}</div>}
                          <div className="mt-1 grid grid-cols-2 gap-1"><span className="red-text">HP:{char.currentHp}/{char.maxHp}</span><span className="blue-text">MP:{char.currentMp}/{char.maxMp}</span><span>ATK:{char.atk}</span><span>DEF:{char.def}</span></div>
                          <div className="w-full bg-gray-700 h-1 mt-1"><div className="bg-red-500 h-1" style={{ width: `${(char.currentHp / char.maxHp) * 100}%` }}/></div>
                          <div className="mt-2 text-gray-500 text-[10px]">âš”ï¸{char.equipment?.weapon?.name || '-'} ğŸ›¡ï¸{char.equipment?.armor?.name || '-'} ğŸ’{char.equipment?.accessory?.name || '-'}</div>
                          {!exploring && char.level >= 10 && <button onClick={() => setShowJobChange(char)} className="mt-2 text-[10px] text-cyan-400 hover:underline">ğŸ”„ è»¢è·</button>}
                        </div>
                      ))}
                    </div>
                    {!exploring && <div className="mt-3 flex gap-2"><button onClick={createRandomCharacter} disabled={party.length >= 6} className="retro-border px-4 py-2 text-sm hover:bg-green-900 disabled:opacity-50">ï¼‹ å†’é™ºè€…ç™»éŒ²</button>{party.length > 0 && <button onClick={() => setParty(prev => prev.slice(0, -1))} className="text-xs text-red-400 hover:underline">è§£é›‡</button>}</div>}
                  </>
                )}

                {/* ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ */}
                {activeTab === 'dungeon' && (
                  <>
                    <h2 className="text-base mb-2 border-b border-green-800 pb-1">ã€ è¿·å®®å…¥å£ ã€‘</h2>
                    {!exploring ? (
                      <>
                        <div className="grid md:grid-cols-2 gap-2 mb-3">
                          {DUNGEONS.map(d => {
                            const avgLv = party.length > 0 ? Math.floor(party.reduce((a, c) => a + c.level, 0) / party.length) : 0;
                            const canEnter = avgLv >= d.minLv;
                            const lore = DUNGEON_LORE[d.id];
                            return (
                              <button key={d.id} onClick={() => canEnter && party.length > 0 && setShowDungeonInfo(d.id)} disabled={!canEnter || party.length === 0}
                                className={`text-left p-2 text-xs bg-gray-900 ${canEnter && party.length > 0 ? 'hover:bg-green-800 cursor-pointer' : 'opacity-50'}`}>
                                <div className="flex justify-between"><span className="font-bold">{d.name}</span><span className="text-gray-500">B{d.floors}F</span></div>
                                <div className="text-gray-500">æ¨å¥¨Lv.{d.minLv}+ {maxFloors[d.id] ? `(æœ€æ·±:B${maxFloors[d.id]}F)` : ''}</div>
                                <div className="text-gray-600 text-[10px] mt-1 truncate">{lore?.story.substring(0, 30)}...</div>
                              </button>
                            );
                          })}
                        </div>
                        <div className="p-2 bg-gray-900 text-xs">
                          <p className="mb-1">é›¢è„±æ¡ä»¶: HP {retreatCondition.value}% ä»¥ä¸‹</p>
                          <input type="range" min="10" max="50" value={retreatCondition.value} onChange={(e) => setRetreatCondition({ ...retreatCondition, value: parseInt(e.target.value) })} className="w-full" />
                        </div>
                      </>
                    ) : (
                      <div className="text-center py-8">
                        <p className="text-2xl mb-2 blink gold-text">æ¢ç´¢ä¸­...</p>
                        <p className="text-4xl mb-2">ğŸ° B{currentFloor}F</p>
                        <p className="text-sm text-gray-400 mb-4">{DUNGEON_LORE[currentDungeon]?.name}</p>
                        <button onClick={() => { setExploring(false); setCurrentFloor(1); setParty(prev => prev.map(c => ({ ...c, currentHp: c.maxHp, currentMp: c.maxMp }))); addLog('å¸°é‚„ã—ãŸ', 'heal'); }} className="retro-border px-8 py-2 hover:bg-red-900 text-red-400">â–  å¸°é‚„</button>
                      </div>
                    )}
                  </>
                )}

                {/* ã‚·ãƒ§ãƒƒãƒ— */}
                {activeTab === 'shop' && (
                  <>
                    <h2 className="text-base mb-2 border-b border-green-800 pb-1">ã€ ãƒœãƒ«ã‚¿ãƒƒã‚¯å•†åº— ã€‘</h2>
                    <div className="flex gap-1 mb-2">{['weapons', 'armors', 'accessories', 'consumables'].map(cat => (<button key={cat} onClick={() => setShopCategory(cat)} className={`px-2 py-1 text-xs ${shopCategory === cat ? 'bg-green-900 retro-border' : 'bg-gray-900'}`}>{{ weapons: 'âš”ï¸æ­¦å™¨', armors: 'ğŸ›¡ï¸é˜²å…·', accessories: 'ğŸ’è£…é£¾', consumables: 'ğŸ§ªæ¶ˆè€—' }[cat]}</button>))}</div>
                    <div className="space-y-1 max-h-64 overflow-y-auto">{ITEMS[shopCategory].map((item, i) => { const canBuy = gold >= item.price; return (<div key={i} className={`p-1 text-xs flex justify-between ${canBuy ? 'bg-gray-900' : 'bg-gray-900 opacity-50'}`}><div><span className={ITEM_RARITY[item.rarity].color}>{item.name}</span><span className="text-gray-500 ml-2">{item.atk ? `ATK+${item.atk}` : ''}{item.def ? `DEF+${item.def}` : ''}</span></div><button onClick={() => { if (!canBuy) return; setGold(prev => prev - item.price); setInventory(prev => [...prev, { ...item, id: Date.now() }]); soundEngine.playGold(); }} disabled={!canBuy} className="gold-text hover:underline disabled:opacity-50">{item.price}G</button></div>); })}</div>
                  </>
                )}

                {/* æ‰€æŒå“ */}
                {activeTab === 'inventory' && (
                  <>
                    <h2 className="text-base mb-2 border-b border-green-800 pb-1">ã€ æ‰€æŒå“ ã€‘({inventory.length})</h2>
                    <div className="mb-2"><span className="text-xs text-gray-400">è£…å‚™å…ˆ: </span>{party.map(char => (<button key={char.id} onClick={() => setSelectedChar(char.id)} className={`px-2 py-1 text-xs mx-1 ${selectedChar === char.id ? 'bg-green-900 retro-border' : 'bg-gray-900'}`}>{char.name}</button>))}</div>
                    <div className="space-y-1 max-h-64 overflow-y-auto">{inventory.map(item => (<div key={item.id} className="p-1 text-xs bg-gray-900 flex justify-between"><div><span className={ITEM_RARITY[item.rarity]?.color}>{item.name}</span><span className="text-gray-500 ml-2">{item.atk ? `ATK+${item.atk}` : ''}{item.def ? `DEF+${item.def}` : ''}</span></div><div className="flex gap-2">{selectedChar && !ITEMS.consumables.find(c => c.id === item.id) && <button onClick={() => equipItem(selectedChar, item)} className="text-blue-400 hover:underline">è£…å‚™</button>}<button onClick={() => { setGold(prev => prev + Math.floor((item.price || 10) / 2)); setInventory(prev => prev.filter(i => i.id !== item.id)); }} className="text-yellow-400 hover:underline">å£²å´</button></div></div>))}{inventory.length === 0 && <p className="text-gray-600 text-center py-4">ã‚¢ã‚¤ãƒ†ãƒ ãªã—</p>}</div>
                  </>
                )}

                {/* ã‚¯ã‚¨ã‚¹ãƒˆ */}
                {activeTab === 'quest' && (
                  <>
                    <h2 className="text-base mb-2 border-b border-green-800 pb-1">ã€ ä¾é ¼æ›¸ ã€‘</h2>
                    <div className="space-y-2 max-h-80 overflow-y-auto">{QUESTS.map(quest => { const completed = completedQuests.includes(quest.id); return (<div key={quest.id} className={`p-2 text-xs ${completed ? 'bg-green-900 opacity-75' : 'bg-gray-900'}`}><div className="flex justify-between"><span className="font-bold">{completed ? 'âœ“ ' : ''}{quest.name}</span><span className="gold-text">{quest.reward.gold}G</span></div><p className="text-gray-400 mt-1">{quest.desc}</p></div>); })}</div>
                    <p className="mt-2 text-xs text-gray-500">é”æˆ: {completedQuests.length}/{QUESTS.length}</p>
                  </>
                )}

                {/* å›³é‘‘ */}
                {activeTab === 'bestiary' && (
                  <>
                    <h2 className="text-base mb-2 border-b border-green-800 pb-1">ã€ ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å›³é‘‘ ã€‘</h2>
                    <div className="grid md:grid-cols-2 gap-2 max-h-80 overflow-y-auto">{Object.entries(bestiary).map(([name, data]) => (<div key={name} className="p-2 bg-gray-900 text-xs"><div className="flex justify-between"><span className="font-bold">{data.boss ? 'ğŸ‘‘ ' : ''}{name}</span><span className="text-gray-500">Ã—{data.encountered}</span></div><div className="text-gray-400 mt-1">HP:{data.hp} ATK:{data.atk} EXP:{data.exp}</div></div>))}</div>
                    <p className="mt-2 text-xs text-gray-500">ç™ºè¦‹: {Object.keys(bestiary).length}/{MONSTERS.length}ç¨®</p>
                  </>
                )}
              </div>

              {/* ãƒ­ã‚° */}
              <div className="retro-border p-3">
                <h2 className="text-base mb-2 border-b border-green-800 pb-1">ã€ å†’é™ºè¨˜éŒ² ã€‘</h2>
                <div ref={logRef} className="h-80 overflow-y-auto bg-black p-2 text-xs log-scroll">{logs.length === 0 ? <p className="text-gray-600">ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</p> : logs.map((log, i) => <p key={i} className={`${log.color} mb-1`}>&gt; {log.message}</p>)}</div>
              </div>
            </div>

            <div className="text-center mt-3 text-xs text-gray-600">
              <button onClick={() => setScreen('title')} className="hover:text-green-400">ã‚¿ã‚¤ãƒˆãƒ«</button>
              <span className="mx-2">|</span>
              <span>v5.0 - Story & Volume Control</span>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
