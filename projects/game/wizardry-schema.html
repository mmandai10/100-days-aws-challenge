<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wizardry Schema v15.0 - æ”¾ç½®å‹æ¢ç´¢RPG</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap');
    /* v14.2: Nildaé¢¨ãƒ€ãƒ¼ã‚¯ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼UI */
    body { font-family: 'Noto Serif JP', serif; background: linear-gradient(180deg, #1a1410 0%, #0d0a08 100%); color: #d4c4a8; min-height: 100vh; }
    .retro-border { border: 1px solid #5a4a3a; box-shadow: 0 2px 8px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05); background: rgba(30,25,20,0.9); }
    .log-scroll::-webkit-scrollbar { width: 6px; }
    .log-scroll::-webkit-scrollbar-track { background: #1a1510; }
    .log-scroll::-webkit-scrollbar-thumb { background-color: #5a4a3a; border-radius: 3px; }
    .blink { animation: blink 1.5s infinite; }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }
    .gold-text { color: #ffd700; text-shadow: 0 0 4px rgba(255,215,0,0.3); }
    .red-text { color: #e85555; }
    .blue-text { color: #6ab0ff; }
    .purple-text { color: #b088ff; }
    .tab-btn { transition: all 0.2s; }
    .tab-btn:hover { background-color: #2a2520; }
    .tab-btn.active { background-color: #3a3025; border-color: #8a7a5a; }
    .rarity-common { color: #888888; }
    .rarity-uncommon { color: #5cb85c; }
    .rarity-rare { color: #5bc0de; }
    .rarity-epic { color: #9b59b6; }
    .rarity-legendary { color: #f0ad4e; text-shadow: 0 0 8px #f0ad4e; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 100; }
    /* v14.2: Nildaé¢¨æ–½è¨­ã‚«ãƒ¼ãƒ‰ */
    .facility-card { 
      transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden;
      background: linear-gradient(180deg, #2d2520 0%, #1a1512 100%);
      border: 1px solid #4a3a2a; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    .facility-card:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 6px 20px rgba(200,150,80,0.2);
      border-color: #9a7a4a;
    }
    .facility-card::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,220,150,0.08), transparent); transition: left 0.5s; }
    .facility-card:hover::before { left: 100%; }
    /* å‡ºç™ºã‚²ãƒ¼ãƒˆç‰¹åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« */
    .gate-card {
      background: linear-gradient(180deg, #3d2a1a 0%, #2a1a0a 50%, #1a0a00 100%);
      border: 2px solid #a07030;
      box-shadow: 0 0 25px rgba(180,120,40,0.25), inset 0 0 40px rgba(0,0,0,0.4);
    }
    .gate-card:hover {
      border-color: #d4a040;
      box-shadow: 0 0 35px rgba(220,160,60,0.35), inset 0 0 40px rgba(0,0,0,0.4);
      transform: translateY(-4px);
    }
    .back-btn { position: fixed; bottom: 20px; right: 20px; z-index: 50; }
    /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    button { font-family: 'Noto Serif JP', serif; }
    .btn-fantasy { background: linear-gradient(180deg, #3d3025 0%, #2a2015 100%); border: 1px solid #5a4a3a; color: #d4c4a8; border-radius: 4px; }
    .btn-fantasy:hover { background: linear-gradient(180deg, #4d4035 0%, #3a3025 100%); border-color: #8a7a5a; }
    .btn-danger { background: linear-gradient(180deg, #4a2520 0%, #3a1510 100%); border: 1px solid #6a4540; color: #e8a0a0; border-radius: 4px; }
    .btn-danger:hover { background: linear-gradient(180deg, #5a3530 0%, #4a2520 100%); }
    /* ã‚­ãƒ£ãƒ©ã‚«ãƒ¼ãƒ‰ */
    .char-card { background: linear-gradient(180deg, #252018 0%, #1a1510 100%); border: 1px solid #3a3020; border-radius: 6px; }
    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒˆãƒ« */
    .section-title { color: #a08060; font-weight: 700; letter-spacing: 0.05em; }
    /* v14.4: ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°æ¼”å‡º */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slowScroll { from { transform: translateY(100%); } to { transform: translateY(-100%); } }
    @keyframes textGlow { 0%, 100% { text-shadow: 0 0 10px rgba(200,160,96,0.5); } 50% { text-shadow: 0 0 20px rgba(200,160,96,0.8), 0 0 40px rgba(200,160,96,0.4); } }
    .opening-container { position: fixed; inset: 0; background: linear-gradient(180deg, #0a0806 0%, #1a1410 50%, #0a0806 100%); overflow: hidden; }
    .opening-text { animation: slowScroll 45s linear forwards; }
    .opening-title { animation: fadeIn 3s ease-out, textGlow 4s ease-in-out infinite; }
    .skip-btn { position: fixed; bottom: 30px; right: 30px; opacity: 0.6; transition: opacity 0.3s; }
    .skip-btn:hover { opacity: 1; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ===== v14.4: ãƒãƒ­ãƒƒã‚¯èª¿ã‚¢ãƒ³ãƒ“ã‚¨ãƒ³ãƒˆBGM =====
    class SoundEngine {
      constructor() { 
        this.initialized = false; 
        this.bgmEnabled = true; 
        this.sfxEnabled = true; 
        this.bgmVolume = -16; 
        this.sfxVolume = -12; 
        this.isPlaying = false;
        this.currentTheme = 'town';
        this.chordIdx = 0;
        this.measureCount = 0;
      }
      
      // ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³åˆ¥ãƒ†ãƒ¼ãƒï¼ˆãƒãƒ­ãƒƒã‚¯èª¿ã‚³ãƒ¼ãƒ‰é€²è¡Œï¼‰
      themes = {
        town: { // è¡— - ç©ã‚„ã‹ãªãƒãƒ­ãƒƒã‚¯
          chords: [['D3','F3','A3'],['G2','B2','D3'],['C3','E3','G3'],['A2','C3','E3'],['D3','F3','A3'],['G2','B2','D3'],['E2','G2','B2'],['A2','C3','E3']],
          special: [['F3','A3','C4'],['G3','B3','D4'],['A3','C4','E4']], // å¤‰åŒ–çƒ
          tempo: 3500
        },
        slime: { // ã‚¹ãƒ©ã‚¤ãƒ  - æ˜ã‚‹ã„æ¢ç´¢
          chords: [['C3','E3','G3'],['F2','A2','C3'],['G2','B2','D3'],['C3','E3','G3'],['A2','C3','E3'],['D3','F3','A3'],['G2','B2','D3'],['C3','E3','G3']],
          special: [['E3','G3','B3'],['F3','A3','C4']],
          tempo: 3200
        },
        kobold: { // ã‚³ãƒœãƒ«ãƒ‰ - ç·Šå¼µæ„Ÿ
          chords: [['D3','F3','A3'],['A2','C3','E3'],['Bb2','D3','F3'],['A2','C3','E3'],['D3','F3','A3'],['G2','Bb2','D3'],['A2','C3','E3'],['D3','F3','A3']],
          special: [['E3','G#3','B3'],['F3','A3','C4']],
          tempo: 3000
        },
        thieves: { // ç›—è³Š - ç¥ç§˜çš„
          chords: [['E2','G2','B2'],['A2','C3','E3'],['D3','F3','A3'],['G2','B2','D3'],['C3','E3','G3'],['F2','A2','C3'],['B2','D3','F3'],['E2','G2','B2']],
          special: [['Ab2','C3','Eb3'],['Bb2','D3','F3']],
          tempo: 3800
        },
        sewer: { // ä¸‹æ°´é“ - ä¸æ°—å‘³
          chords: [['A2','C3','E3'],['E2','G2','B2'],['F2','A2','C3'],['D2','F2','A2'],['A2','C3','E3'],['G2','Bb2','D3'],['F2','A2','C3'],['E2','G2','B2']],
          special: [['Eb2','Gb2','Bb2'],['Ab2','C3','Eb3']],
          tempo: 4200
        },
        kaoka: { // éºè·¡ - å¤ä»£ã®ç¥ç§˜
          chords: [['D3','F#3','A3'],['G2','B2','D3'],['E3','G3','B3'],['A2','C#3','E3'],['D3','F#3','A3'],['B2','D3','F#3'],['E3','G3','B3'],['A2','C#3','E3']],
          special: [['F#3','A3','C#4'],['B3','D4','F#4']],
          tempo: 4000
        },
        deltis: { // å¤§è”µå®¤ - è±ªè¯
          chords: [['G3','B3','D4'],['D3','F#3','A3'],['E3','G3','B3'],['A2','C#3','E3'],['G3','B3','D4'],['C3','E3','G3'],['D3','F#3','A3'],['G2','B2','D3']],
          special: [['E3','G#3','B3'],['A3','C#4','E4'],['D4','F#4','A4']],
          tempo: 3500
        },
        dragon: { // ç«œã®ç¥æ®¿ - è˜å³
          chords: [['C3','Eb3','G3'],['Ab2','C3','Eb3'],['Bb2','D3','F3'],['G2','Bb2','D3'],['C3','Eb3','G3'],['F2','Ab2','C3'],['G2','Bb2','D3'],['C3','Eb3','G3']],
          special: [['Db3','F3','Ab3'],['Eb3','G3','Bb3'],['F3','A3','C4']],
          tempo: 4500
        },
        trebor: { // æœ€çµ‚ - çµ¶æœ›ã¨å¸Œæœ›
          chords: [['D3','F3','A3'],['Bb2','D3','F3'],['G2','Bb2','D3'],['A2','C#3','E3'],['D3','F3','A3'],['C3','E3','G3'],['Bb2','D3','F3'],['A2','C#3','E3']],
          special: [['E3','G#3','B3'],['F3','A3','C4'],['G3','B3','D4']],
          tempo: 5000
        }
      };
      
      async init() {
        if (this.initialized) return;
        await Tone.start();
        // ãƒãƒ­ãƒƒã‚¯èª¿ã‚ªãƒ«ã‚¬ãƒ³é¢¨ã‚·ãƒ³ã‚»
        this.padSynth = new Tone.PolySynth(Tone.Synth, {
          oscillator: { type: 'sine' },
          envelope: { attack: 1.5, decay: 0.8, sustain: 0.7, release: 2.5 }
        }).toDestination();
        this.padSynth.volume.value = this.bgmVolume;
        // é«˜éŸ³ãƒ¡ãƒ­ãƒ‡ã‚£ç”¨ï¼ˆå¤‰åŒ–çƒï¼‰
        this.melodySynth = new Tone.Synth({
          oscillator: { type: 'triangle' },
          envelope: { attack: 0.5, decay: 0.3, sustain: 0.4, release: 1.5 }
        }).toDestination();
        this.melodySynth.volume.value = this.bgmVolume - 6;
        // SEç”¨ã‚·ãƒ³ã‚»
        this.sfxSynth = new Tone.Synth({
          oscillator: { type: 'sine' },
          envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.5 }
        }).toDestination();
        this.sfxSynth.volume.value = this.sfxVolume;
        this.initialized = true;
      }
      
      setBgmVolume(v) { 
        this.bgmVolume = v; 
        if (this.padSynth) this.padSynth.volume.value = v; 
        if (this.melodySynth) this.melodySynth.volume.value = v - 6;
      }
      setSfxVolume(v) { this.sfxVolume = v; if (this.sfxSynth) this.sfxSynth.volume.value = v; }
      
      startBGM(theme = 'town') {
        if (!this.initialized || !this.bgmEnabled) return;
        if (this.isPlaying) this.stopBGM();
        
        this.currentTheme = theme;
        const t = this.themes[theme] || this.themes.town;
        this.chordIdx = 0;
        this.measureCount = 0;
        
        // æœ€åˆã®ã‚³ãƒ¼ãƒ‰ã‚’å³åº§ã«å†ç”Ÿ
        this.padSynth.triggerAttackRelease(t.chords[0], '2n');
        this.chordIdx = 1;
        
        this.bgmInterval = setInterval(() => {
          if (!this.bgmEnabled) return;
          this.measureCount++;
          
          // 12å›ã«1å›å¤‰åŒ–çƒï¼ˆç‰¹æ®Šã‚³ãƒ¼ãƒ‰ï¼‰
          if (this.measureCount % 12 === 0 && t.special && Math.random() < 0.5) {
            const special = t.special[Math.floor(Math.random() * t.special.length)];
            this.padSynth.triggerAttackRelease(special, '2n');
            // ãƒ¡ãƒ­ãƒ‡ã‚£éŸ³ã‚‚è¿½åŠ 
            setTimeout(() => {
              if (this.bgmEnabled) this.melodySynth.triggerAttackRelease(special[2], '4n');
            }, 800);
          } else {
            const chord = t.chords[this.chordIdx % t.chords.length];
            this.padSynth.triggerAttackRelease(chord, '2n');
            this.chordIdx++;
          }
        }, t.tempo);
        
        this.isPlaying = true;
      }
      
      changeBGM(theme) {
        if (this.currentTheme === theme) return;
        this.startBGM(theme);
      }
      
      stopBGM() { 
        if (this.bgmInterval) { clearInterval(this.bgmInterval); this.bgmInterval = null; } 
        this.isPlaying = false; 
      }
      toggleBGM(e) { this.bgmEnabled = e; if (e && this.initialized) this.startBGM(this.currentTheme); else this.stopBGM(); }
      
      // SE
      playClick() { if (this.initialized && this.sfxEnabled) this.sfxSynth.triggerAttackRelease('E5','32n'); }
      playLevelUp() { if (this.initialized && this.sfxEnabled) { this.sfxSynth.triggerAttackRelease('C5','8n'); setTimeout(() => this.sfxSynth.triggerAttackRelease('E5','8n'), 150); setTimeout(() => this.sfxSynth.triggerAttackRelease('G5','4n'), 300); } }
      playBossClear() { if (this.initialized && this.sfxEnabled) { ['C4','E4','G4','C5'].forEach((n,i) => setTimeout(() => this.sfxSynth.triggerAttackRelease(n,'4n'), i*200)); } }
      // äº’æ›æ€§ç”¨ç©ºé–¢æ•°
      playAttack() {}
      playHit() {}
      playHeal() {}
      playGold() {}
      playDeath() {}
      playBoss() {}
      playClear() { this.playBossClear(); }
      playCritical() {}
    }
    const soundEngine = new SoundEngine();

    // ===== åå‰ç”Ÿæˆ =====
    const NAME_PARTS = {
      human: { prefix: ['ã‚¢ãƒ«','ãƒ™ãƒ«','ã‚«ã‚¤','ãƒ€ãƒ³','ã‚¨ãƒ«','ãƒ•ã‚£ãƒ³','ã‚¬ãƒ«','ãƒãƒ«','ã‚¤ãƒ«','ã‚¸ã‚§','ã‚±ã‚¤','ãƒ¬ã‚ª'], suffix: ['ã‚¹','ãƒ³','ãƒ‰','ã‚¯','ãƒˆ','ãƒ«','ãƒªã‚¢','ãƒŠ','ãƒ´ã‚£','ã‚¦ã‚¹','ã‚ªãƒ³'] },
      elf: { prefix: ['ã‚¨ã‚¢','ã‚»ãƒ¬','ã‚¬ãƒ©','ãƒ¬ã‚´','ã‚¢ãƒ©','ã‚¨ãƒ«','ãƒ•ã‚§ã‚¢','ã‚®ãƒ«','ãƒªãƒ³','ãƒ«ãƒ¼'], suffix: ['ã‚¦ã‚§ãƒ³','ãƒ‡ã‚£ãƒ«','ãƒ©ã‚¹','ãƒŸã‚¢','ãƒãƒ¼ãƒ«','ãƒªã‚ªãƒ³','ã‚¦ã‚£ãƒ³','ãƒ­ã‚¹','ãƒ•ã‚£ãƒ³'] },
      dwarf: { prefix: ['ãƒ‰ã‚¥','ãƒãƒ«','ã‚®ãƒ ','ãƒˆãƒ¼','ãƒ–ãƒ­','ãƒ€ã‚¤','ãƒ•ã‚¡','ã‚°ãƒ­','ã‚«ã‚¶','ãƒ¢ãƒ¼'], suffix: ['ãƒªãƒ³','ã‚¤ãƒ³','ãƒª','ãƒ«','ãƒ ','ãƒ‰','ã‚°','ã‚¯','ãƒœãƒ«','ãƒ€ãƒ«'] },
      gnome: { prefix: ['ãƒ•ã‚£','ã‚¸ãƒ³','ãƒœãƒœ','ãƒ‹ãƒ ','ã‚¬ãƒ¼','ãƒ”ãƒƒ','ãƒ†ã‚£ãƒ³','ã‚¦ã‚£','ã‚¶ãƒ³','ãƒªãƒª'], suffix: ['ãƒƒã‚¯','ã‚¹','ãƒ–ãƒ«','ãƒ‰ãƒ«','ãƒªãƒƒã‚¯','ãƒã‚¹','ãƒˆãƒ³','ã‚ºãƒ«','ãƒ³ã‚¯'] },
      porkul: { prefix: ['ãƒ‘ãƒƒ','ãƒ”ãƒƒ','ãƒ—ãƒ«','ãƒšã‚³','ãƒãƒ³','ãƒ›ãƒ“','ãƒ­ãƒ¼','ã‚µãƒ ','ãƒ•ãƒ­','ãƒ¡ãƒª'], suffix: ['ãƒ‰','ãƒˆ','ãƒ³','ãƒ«','ã‚¹','ãƒœ','ã‚´','ãƒ­','ã‚¸ãƒ¼','ã‚·ãƒ¼'] }
    };
    const genName = (race) => { const p = NAME_PARTS[race] || NAME_PARTS.human; return p.prefix[Math.floor(Math.random()*p.prefix.length)] + p.suffix[Math.floor(Math.random()*p.suffix.length)]; };

    // ===== ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ =====
    // v13.3: ç¨®æ—ãƒ‡ãƒ¼ã‚¿ã‚’Wikiæœ¬å®¶(wiz.gamerch.com)ã«æº–æ‹ 
    const RACES = {
      human: { name: 'äººé–“', str: 8, vit: 7, int: 8, pie: 6, agi: 6, luk: 7, trait: { expBonus: 0.3, desc: 'EXP+30%' } },
      elf: { name: 'ã‚¨ãƒ«ãƒ•', str: 6, vit: 5, int: 10, pie: 8, agi: 8, luk: 6, trait: { magicBonus: 0.2, desc: 'é­”æ³•æ”»æ’ƒ+20%' } },
      dwarf: { name: 'ãƒ‰ãƒ¯ãƒ¼ãƒ•', str: 10, vit: 9, int: 6, pie: 9, agi: 4, luk: 6, trait: { atkBonus: 0.15, defBonus: 0.1, desc: 'ATK+15% DEF+10%' } },
      gnome: { name: 'ãƒãƒ¼ãƒ ', str: 7, vit: 8, int: 7, pie: 10, agi: 7, luk: 7, trait: { healBonus: 0.2, magicResist: 0.1, desc: 'å›å¾©é­”æ³•+20%' } },
      porkul: { name: 'ãƒãƒ¼ã‚¯ãƒ«', str: 5, vit: 4, int: 5, pie: 6, agi: 9, luk: 8, trait: { critBonus: 0.1, desc: 'ä¼šå¿ƒç‡+10%' } }
    };
    const ALIGNMENTS = { lawful: { name: 'ç§©åº', color: 'text-blue-400' }, neutral: { name: 'ä¸­ç«‹', color: 'text-gray-400' }, chaotic: { name: 'æ··æ²Œ', color: 'text-red-400' } };
    const JOBS = {
      fighter: { name: 'æˆ¦å£«', hpMod: 1.5, mpMod: 0.2, atkMod: 1.4, defMod: 1.3, align: ['lawful','neutral','chaotic'], spell: null, tier: 1, req: {} },
      mage: { name: 'é­”è¡“å¸«', hpMod: 0.6, mpMod: 1.8, atkMod: 0.6, defMod: 0.5, align: ['lawful','neutral','chaotic'], spell: 'mage', tier: 1, req: {} },
      priest: { name: 'åƒ§ä¾¶', hpMod: 0.9, mpMod: 1.4, atkMod: 0.8, defMod: 0.9, align: ['lawful','chaotic'], spell: 'priest', tier: 1, req: {} },
      thief: { name: 'ç›—è³Š', hpMod: 0.8, mpMod: 0.5, atkMod: 1.0, defMod: 0.7, align: ['neutral','chaotic'], spell: null, tier: 1, req: {} },
      bishop: { name: 'å¸æ•™', hpMod: 0.7, mpMod: 1.6, atkMod: 0.7, defMod: 0.6, align: ['lawful','chaotic'], spell: 'both', tier: 2, req: { int: 12, pie: 12 } },
      samurai: { name: 'ä¾', hpMod: 1.3, mpMod: 0.8, atkMod: 1.3, defMod: 1.1, align: ['lawful','neutral'], spell: 'mage', tier: 2, req: { str: 15, int: 11, vit: 14 } },
      lord: { name: 'å›ä¸»', hpMod: 1.4, mpMod: 1.0, atkMod: 1.2, defMod: 1.2, align: ['lawful'], spell: 'priest', tier: 2, req: { str: 15, pie: 12, vit: 15 } },
      ninja: { name: 'å¿è€…', hpMod: 1.0, mpMod: 0.6, atkMod: 1.5, defMod: 0.8, align: ['chaotic'], spell: null, tier: 2, req: { str: 15, int: 17, agi: 15 } }
    };
    const SPELLS = {
      mage: [{name:'ãƒãƒªãƒˆ',lv:1,mp:2,pow:15},{name:'ãƒ¢ã‚°ãƒ¬ãƒ•',lv:2,mp:3,pow:0,buff:'def'},{name:'ãƒãƒãƒªãƒˆ',lv:3,mp:5,pow:25},{name:'ãƒ©ãƒãƒªãƒˆ',lv:5,mp:7,pow:40},{name:'ãƒ€ãƒ«ãƒˆ',lv:6,mp:8,pow:50},{name:'ãƒãƒ€ãƒ«ãƒˆ',lv:7,mp:12,pow:65},{name:'ãƒ†ã‚£ãƒ«ãƒˆã‚¦ã‚§ã‚¤ãƒˆ',lv:8,mp:15,pow:80}],
      priest: [{name:'ãƒ‡ã‚£ã‚ªã‚¹',lv:1,mp:2,pow:0,heal:25},{name:'ãƒãƒ‡ã‚£ã‚ªã‚¹',lv:1,mp:2,pow:12},{name:'ãƒã‚¦ã‚¸',lv:2,mp:3,pow:0,buff:'atk'},{name:'ãƒ‡ã‚£ã‚¢ãƒ«',lv:3,mp:4,pow:0,heal:40},{name:'ãƒãƒ‡ã‚£ã‚¢ãƒ«',lv:4,mp:5,pow:25},{name:'ãƒãƒ‡ã‚£',lv:5,mp:8,pow:0,heal:80},{name:'ãƒãƒãƒ‡ã‚£',lv:6,mp:10,pow:45},{name:'ãƒãƒ‡ã‚£ã‚¢ãƒ«',lv:7,mp:15,pow:0,healAll:50}]
    };

    // ===== ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³é¢¨æ™¯æå†™ =====
    const DUNGEON_ATMOSPHERE = {
      slime: { name: 'ã‚¹ãƒ©ã‚¤ãƒ ã®ç©´', rooms: ['ç‹­ã„åœŸã®æ¨ªç©´','æ¹¿ã£ãŸæ´çªŸ','ç²˜æ¶²ã§è¦†ã‚ã‚ŒãŸå°éƒ¨å±‹'], floors: { 1: { desc: 'å…¥å£ä»˜è¿‘ã€‚åœŸã®åŒ‚ã„ãŒé¼»ã‚’çªãã€‚' }, 5: { desc: 'ã€ãƒœã‚¹éšå±¤ã€‘ã‚¹ãƒ©ã‚¤ãƒ ã‚­ãƒ³ã‚°ã®ç‰åº§ã®é–“ã€‚' } } },
      kobold: { name: 'ã‚³ãƒœãƒ«ãƒ‰ã®å·£', rooms: ['æ˜ã‚ŠæŠœã‹ã‚ŒãŸå°éƒ¨å±‹','æ­¦å™¨åº«','è¦‹å¼µã‚Šå°'], floors: { 1: { desc: 'å·£ã®å…¥å£ã€‚è­¦æˆ’ã®æ°—é…ãŒã‚ã‚‹ã€‚' }, 8: { desc: 'ã€ãƒœã‚¹éšå±¤ã€‘ã‚³ãƒœãƒ«ãƒˆãƒ­ãƒ¼ãƒ‰ã®è¬è¦‹ã®é–“ã€‚' } } },
      thieves: { name: 'ç›—è³Šã®ã‚¢ã‚¸ãƒˆ', rooms: ['éš ã—éƒ¨å±‹','å®ç‰©åº«','é…’å ´'], floors: { 1: { desc: 'å½è£…ã•ã‚ŒãŸå…¥å£ã€‚ç½ ã«æ³¨æ„ã€‚' }, 10: { desc: 'ã€ãƒœã‚¹éšå±¤ã€‘ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒ•ã®éš ã‚Œå®¶ã€‚' } } },
      sewer: { name: 'ã‚«ãƒªã‚°ãƒ©ãƒ¼ã‚¼ä¸‹æ°´è·¯', rooms: ['æ±šæ°´è·¯','æµ„åŒ–æ§½','ç®¡ç†å®¤'], floors: { 1: { desc: 'ä¸‹æ°´ã®å…¥å£ã€‚æ‚ªè‡­ãŒé¼»ã‚’çªãã€‚' }, 12: { desc: 'ã€ãƒœã‚¹éšå±¤ã€‘ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢ã®ç‰åº§ã®é–“ã€‚' } } },
      kaoka: { name: 'ã‚«ã‚ªã‚«ãƒ»ãƒ‘ãƒ©ãƒ¼ã‚¸éºè·¡', rooms: ['å´©ã‚ŒãŸç¥æ®¿','å®ç‰©åº«','ç¥­å¸ã®é–“'], floors: { 1: { desc: 'éºè·¡ã®å…¥å£ã€‚å¤ä»£ã®å¨å³ã‚’æ„Ÿã˜ã‚‹ã€‚' }, 15: { desc: 'ã€ãƒœã‚¹éšå±¤ã€‘ã‚°ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ãƒ¢ãƒ³ã®å°å°ã®é–“ã€‚' } } },
      deltis: { name: 'ãƒ‡ãƒ«ãƒ‡ã‚£ã‚¹å¤§è”µå®¤', rooms: ['é‡‘è²¨ã®å±±','å®çŸ³ã®é–“','ç‹å† ã®éƒ¨å±‹'], floors: { 1: { desc: 'å¤§è”µå®¤ã®å…¥å£ã€‚é»„é‡‘ã®è¼ããŒè¦‹ãˆã‚‹ã€‚' }, 18: { desc: 'ã€ãƒœã‚¹éšå±¤ã€‘ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ‰ãƒ©ã‚´ãƒ³ã®å®ç‰©åº«ã€‚' } } },
      dragon: { name: 'é»„é¾ã®ç¥æ®¿è·¡', rooms: ['ç«œéª¨ã®å›å»Š','ç‚ã®è©¦ç·´å ´','æ°·ã®é–“'], floors: { 1: { desc: 'ç¥æ®¿ã®å…¥å£ã€‚ç«œã®å¨å³ãŒæ¼‚ã†ã€‚' }, 20: { desc: 'ã€ãƒœã‚¹éšå±¤ã€‘ã‚¨ãƒ³ã‚·ã‚§ãƒ³ãƒˆãƒ‰ãƒ©ã‚´ãƒ³ã®è–åŸŸã€‚' } } },
      trebor: { name: 'ãƒˆãƒ¬ãƒœãƒ¼ã®è©¦ç·´å ´', rooms: ['è¦ªè¡›éšŠã®è©°æ‰€','é­”æ³•ã®è¿·è·¯','æ­»ã®å›å»Š'], floors: { 1: { desc: 'è©¦ç·´å ´ã®å…¥å£ã€‚æœ€å¼·ã®æˆ¦å£«ãŸã¡ãŒå¾…ã¤ã€‚' }, 25: { desc: 'ã€æœ€çµ‚ãƒœã‚¹éšå±¤ã€‘ãƒ¯ãƒ¼ãƒ‰ãƒŠã®ç‰åº§ã®é–“ã€‚' } } }
    };

    const getFloorDesc = (dng, floor) => {
      const d = DUNGEON_ATMOSPHERE[dng];
      if (!d) return '';
      const floorData = d.floors[floor] || d.floors[Object.keys(d.floors).reduce((a,b) => Math.abs(b-floor) < Math.abs(a-floor) ? b : a)];
      return floorData?.desc || '';
    };

    // ===== è£…å‚™å“ =====
    const ITEMS = {
      weapons: [
        {id:'w001',name:'æŸ³ã®æ£’',atk:1,price:8,rarity:'common'},{id:'w016',name:'æ¨«ã®æ£’',atk:5,price:60,rarity:'common'},
        {id:'w025',name:'ä¸–ç•Œæ¨¹ã®æ–',atk:32,price:15000,rarity:'epic',jobs:['mage','bishop','priest']},
        {id:'w046',name:'ç«œéª¨ã®å‰£',atk:26,price:4000,rarity:'rare'},{id:'w053',name:'ç¥ç£éª¨ã®å‰£',atk:55,price:60000,rarity:'legendary'},
        {id:'w074',name:'ç²¾éŠ…ã®å‰£',atk:6,price:90,rarity:'common'},{id:'w091',name:'é’éŠ…ã®å‰£',atk:11,price:320,rarity:'uncommon'},
        {id:'w103',name:'éŒ¬é‰„ã®å‰£',atk:14,price:500,rarity:'uncommon'},{id:'w114',name:'ç‰é‹¼ã®æ‰“åˆ€',atk:24,price:2800,rarity:'rare',jobs:['samurai','ninja']},
        {id:'w117',name:'ãƒ€ãƒã‚¹ã‚«ã‚¹é‹¼ã®å‰£',atk:26,price:4500,rarity:'rare'},{id:'w121',name:'éš•é‰„ã®å‰£',atk:34,price:9000,rarity:'epic'},
        {id:'w150',name:'ãƒŸã‚¹ãƒªãƒ«ã‚½ãƒ¼ãƒ‰',atk:35,price:8000,rarity:'epic'},{id:'w160',name:'ã‚ªãƒªãƒãƒ«ã‚³ãƒ³ã‚½ãƒ¼ãƒ‰',atk:48,price:25000,rarity:'epic'},
        {id:'w172',name:'ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼',atk:60,price:60000,rarity:'epic',jobs:['lord']},{id:'w186',name:'ç¥æ®ºã—ã®å‰£',atk:99,price:999999,rarity:'legendary'}
      ],
      armors: [
        {id:'a001',name:'å¸ƒã®æœ',def:1,price:15,rarity:'common'},{id:'a007',name:'é©é§',def:4,price:100,rarity:'common'},
        {id:'a014',name:'æ¨«ã®ç›¾',def:4,price:80,rarity:'common'},{id:'a025',name:'ç«œéª¨ã®é§',def:24,price:5500,rarity:'rare'},
        {id:'a047',name:'é’éŠ…ã®é§',def:10,price:480,rarity:'uncommon'},{id:'a056',name:'ãƒã‚§ã‚¤ãƒ³ãƒ¡ã‚¤ãƒ«',def:12,price:600,rarity:'uncommon'},
        {id:'a062',name:'éš•é‰„ã®é§',def:35,price:16000,rarity:'epic'},{id:'a080',name:'ãƒŸã‚¹ãƒªãƒ«ãƒ¡ã‚¤ãƒ«',def:32,price:10000,rarity:'epic'},
        {id:'a085',name:'ã‚ªãƒªãƒãƒ«ã‚³ãƒ³ã‚¢ãƒ¼ãƒãƒ¼',def:48,price:35000,rarity:'epic'},{id:'a097',name:'ç¥ã€…ã®é§',def:75,price:300000,rarity:'legendary'}
      ],
      accessories: [
        {id:'c001',name:'æŸ³ã®ãŠå®ˆã‚Š',def:1,price:20,rarity:'common'},{id:'c010',name:'éŠ…ã®æŒ‡è¼ª',atk:1,price:40,rarity:'common'},
        {id:'c016',name:'éŠ€ã®æŒ‡è¼ª',atk:5,def:5,price:800,rarity:'rare'},{id:'c018',name:'ãƒŸã‚¹ãƒªãƒ«ãƒªãƒ³ã‚°',atk:10,def:10,price:8000,rarity:'epic'},
        {id:'c030',name:'ãƒ‰ãƒ©ã‚´ãƒ³ãƒªãƒ³ã‚°',atk:12,def:12,price:15000,rarity:'epic'},{id:'c041',name:'ã‚¤ãƒ³ãƒ•ã‚£ãƒ‹ãƒ†ã‚£ã‚¬ãƒ³ãƒˆãƒ¬ãƒƒãƒˆ',atk:30,def:30,price:400000,rarity:'legendary'}
      ],
      consumables: [
        {id:'p001',name:'ãƒãƒ¼ã‚·ãƒ§ãƒ³',price:50,rarity:'common',heal:30},
        {id:'p002',name:'ãƒã‚¤ãƒãƒ¼ã‚·ãƒ§ãƒ³',price:200,rarity:'uncommon',heal:100},
        {id:'p003',name:'ã‚¨ãƒªã‚¯ã‚µãƒ¼',price:500,rarity:'rare',heal:9999}
      ]
    };

    const BOSS_DROPS = {
      'ã‚¹ãƒ©ã‚¤ãƒ ã‚­ãƒ³ã‚°': [{id:'bd01',name:'ã‚¹ãƒ©ã‚¤ãƒ ã®ç‹å† ',atk:3,def:3,price:500,rarity:'uncommon'}],
      'ã‚³ãƒœãƒ«ãƒˆãƒ­ãƒ¼ãƒ‰': [{id:'bd03',name:'ã‚³ãƒœãƒ«ãƒˆã®å®ç ',atk:5,def:2,price:800,rarity:'uncommon'}],
      'ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒ•': [{id:'bd06',name:'å½±ã®ãƒãƒ³ãƒˆ',def:10,price:1800,rarity:'rare',jobs:['thief','ninja']}],
      'ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢': [{id:'bd09',name:'å¸è¡€é¬¼ã®ç‰™',atk:18,price:2800,rarity:'rare'}],
      'ã‚°ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ãƒ¢ãƒ³': [{id:'bd12',name:'æ‚ªé­”ã®è§’',atk:22,def:8,price:5000,rarity:'epic'}],
      'ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ‰ãƒ©ã‚´ãƒ³': [{id:'bd15',name:'é»„é‡‘ã®é±—',def:25,price:10000,rarity:'epic'}],
      'ã‚¨ãƒ³ã‚·ã‚§ãƒ³ãƒˆãƒ‰ãƒ©ã‚´ãƒ³': [{id:'bd20',name:'æ™‚ã®é±—',atk:25,def:25,price:25000,rarity:'legendary'}],
      'ãƒ¯ãƒ¼ãƒ‰ãƒŠ': [{id:'bd21',name:'é­”é™¤ã‘ã®è­·ç¬¦',atk:30,def:30,price:60000,rarity:'legendary'}]
    };

    const DUNGEONS = [
      {id:'slime',name:'ã‚¹ãƒ©ã‚¤ãƒ ã®ç©´',floors:5,minLv:1},
      {id:'kobold',name:'ã‚³ãƒœãƒ«ãƒ‰ã®å·£',floors:8,minLv:3},
      {id:'thieves',name:'ç›—è³Šã®ã‚¢ã‚¸ãƒˆ',floors:10,minLv:5},
      {id:'sewer',name:'ã‚«ãƒªã‚°ãƒ©ãƒ¼ã‚¼ä¸‹æ°´è·¯',floors:12,minLv:8},
      {id:'kaoka',name:'ã‚«ã‚ªã‚«ãƒ»ãƒ‘ãƒ©ãƒ¼ã‚¸éºè·¡',floors:15,minLv:12},
      {id:'deltis',name:'ãƒ‡ãƒ«ãƒ‡ã‚£ã‚¹å¤§è”µå®¤',floors:18,minLv:16},
      {id:'dragon',name:'é»„é¾ã®ç¥æ®¿è·¡',floors:20,minLv:20},
      {id:'trebor',name:'ãƒˆãƒ¬ãƒœãƒ¼ã®è©¦ç·´å ´',floors:25,minLv:25}
    ];

    const MONSTERS = [
      {name:'ãƒãƒ–ãƒªãƒ¼ã‚¹ãƒ©ã‚¤ãƒ ',hp:12,atk:4,def:1,exp:8,gold:3,dng:'slime',flr:1},
      {name:'ã‚³ãƒœãƒ«ãƒˆ',hp:18,atk:6,def:2,exp:12,gold:5,dng:'slime',flr:2},
      {name:'ã‚ªãƒ¼ã‚¯ãƒ™ãƒ“ãƒ¼',hp:25,atk:8,def:3,exp:18,gold:8,dng:'slime',flr:3},
      {name:'ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ãƒƒãƒˆ',hp:20,atk:10,def:2,exp:22,gold:10,dng:'slime',flr:4},
      {name:'ã‚¹ãƒ©ã‚¤ãƒ ã‚­ãƒ³ã‚°',hp:60,atk:18,def:6,exp:60,gold:40,dng:'slime',flr:5,boss:true},
      {name:'ã‚³ãƒœãƒ«ãƒˆã‚¦ã‚©ãƒ¼ãƒªã‚¢',hp:30,atk:12,def:5,exp:25,gold:12,dng:'kobold',flr:1},
      {name:'ã‚³ãƒœãƒ«ãƒˆãƒ¡ã‚¤ã‚¸',hp:22,atk:18,def:3,exp:35,gold:18,dng:'kobold',flr:4},
      {name:'ã‚ªãƒ¼ã‚¯',hp:40,atk:15,def:6,exp:40,gold:20,dng:'kobold',flr:6},
      {name:'ã‚³ãƒœãƒ«ãƒˆãƒ­ãƒ¼ãƒ‰',hp:90,atk:28,def:12,exp:120,gold:80,dng:'kobold',flr:8,boss:true},
      {name:'ã‚·ãƒ¼ãƒ•',hp:35,atk:20,def:6,exp:40,gold:25,dng:'thieves',flr:1},
      {name:'ã‚¢ã‚µã‚·ãƒ³',hp:45,atk:30,def:8,exp:60,gold:40,dng:'thieves',flr:5},
      {name:'ãƒ€ãƒ¼ã‚¯ã‚¨ãƒ«ãƒ•',hp:55,atk:35,def:10,exp:80,gold:50,dng:'thieves',flr:8},
      {name:'ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒ•',hp:140,atk:45,def:18,exp:180,gold:120,dng:'thieves',flr:10,boss:true},
      {name:'ã‚¾ãƒ³ãƒ“',hp:55,atk:15,def:5,exp:45,gold:20,dng:'sewer',flr:1},
      {name:'ã‚¹ã‚±ãƒ«ãƒˆãƒ³',hp:45,atk:20,def:8,exp:50,gold:25,dng:'sewer',flr:4},
      {name:'ã‚°ãƒ¼ãƒ«',hp:65,atk:25,def:10,exp:70,gold:35,dng:'sewer',flr:7},
      {name:'ãƒ¯ã‚¤ãƒˆ',hp:75,atk:35,def:12,exp:90,gold:50,dng:'sewer',flr:10},
      {name:'ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢',hp:220,atk:55,def:22,exp:280,gold:180,dng:'sewer',flr:12,boss:true},
      {name:'ã‚¹ãƒˆãƒ¼ãƒ³ã‚´ãƒ¼ãƒ¬ãƒ ',hp:100,atk:40,def:25,exp:120,gold:60,dng:'kaoka',flr:1},
      {name:'ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«',hp:90,atk:50,def:20,exp:150,gold:80,dng:'kaoka',flr:8},
      {name:'ã‚°ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ãƒ¢ãƒ³',hp:350,atk:75,def:35,exp:450,gold:300,dng:'kaoka',flr:15,boss:true},
      {name:'ãƒŸãƒŸãƒƒã‚¯',hp:80,atk:45,def:15,exp:100,gold:200,dng:'deltis',flr:1},
      {name:'ãƒãƒ³ãƒ†ã‚£ã‚³ã‚¢',hp:150,atk:60,def:25,exp:200,gold:150,dng:'deltis',flr:10},
      {name:'ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ‰ãƒ©ã‚´ãƒ³',hp:450,atk:90,def:45,exp:700,gold:600,dng:'deltis',flr:18,boss:true},
      {name:'ãƒ‰ãƒ©ã‚´ãƒ³ã‚¾ãƒ³ãƒ“',hp:150,atk:60,def:20,exp:200,gold:100,dng:'dragon',flr:1},
      {name:'ãƒã‚¤ã‚ºãƒ³ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆ',hp:180,atk:70,def:25,exp:280,gold:140,dng:'dragon',flr:10},
      {name:'ã‚¨ãƒ³ã‚·ã‚§ãƒ³ãƒˆãƒ‰ãƒ©ã‚´ãƒ³',hp:700,atk:110,def:55,exp:1200,gold:1000,dng:'dragon',flr:20,boss:true},
      {name:'ãƒˆãƒ¬ãƒœãƒ¼è¦ªè¡›éšŠ',hp:200,atk:80,def:35,exp:300,gold:150,dng:'trebor',flr:1},
      {name:'ãƒ€ãƒ¼ã‚¯ãƒŠã‚¤ãƒˆ',hp:250,atk:90,def:40,exp:400,gold:200,dng:'trebor',flr:15},
      {name:'ãƒ¯ãƒ¼ãƒ‰ãƒŠ',hp:1200,atk:160,def:70,exp:6000,gold:5000,dng:'trebor',flr:25,boss:true}
    ];

    const TRAPS = [{name:'ãƒã‚¤ã‚ºãƒ³ãƒ‹ãƒ¼ãƒ‰ãƒ«',dmg:0.1},{name:'ã‚¯ãƒ­ã‚¹ãƒœã‚¦ãƒœãƒ«ãƒˆ',dmg:0.15},{name:'çˆ†ç™ºã™ã‚‹ç®±',dmg:0.2},{name:'è½ã¨ã—ç©´',dmg:0.1},{name:'æ¯’ã‚¬ã‚¹',dmg:0.12}];

    // v14.2: æ–½è¨­ãƒ‡ãƒ¼ã‚¿ï¼ˆNildaé¢¨ãƒ€ãƒ¼ã‚¯ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ï¼‰
    const FACILITIES = [
      { id: 'guild', name: 'å†’é™ºè€…ã‚®ãƒ«ãƒ‰', desc: 'æ–°ãŸãªå†’é™ºè€…ã‚’ç™»éŒ²', color: '#4a3020' },
      { id: 'tavern', name: 'ãƒ†ã‚µãƒ¼ã‚¯ã®å®¿', desc: 'ãƒ‘ãƒ¼ãƒ†ã‚£ç®¡ç†ãƒ»è»¢è·', color: '#3a3528' },
      { id: 'shop', name: 'ãƒœãƒ«ã‚¿ãƒƒã‚¯å•†åº—', desc: 'æ­¦å™¨ãƒ»é˜²å…·ã®è³¼å…¥', color: '#2a3530' },
      { id: 'temple', name: 'ã‚µãƒ³ãƒ‰ãƒ«å¯ºé™¢', desc: 'HP/MPå›å¾©ãƒ»è˜‡ç”Ÿ', color: '#252838' },
      { id: 'storage', name: 'ä¸€å‘³ã®å±¯æ‰€', desc: 'æ‰€æŒå“ç®¡ç†', color: '#302828' },
      { id: 'bestiary', name: 'å›³æ›¸é¤¨', desc: 'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å›³é‘‘', color: '#282830' },
      { id: 'gate', name: 'å‡ºç™ºã‚²ãƒ¼ãƒˆ', desc: 'ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã¸å‡ºç™º', color: '#3d2a1a' },
    ];

    // ===== v15.0: ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚·ã‚¹ãƒ†ãƒ  =====
    // NPCãƒ‡ãƒ¼ã‚¿
    const NPCS = {
      seraphina: {
        name: 'ã‚»ãƒ©ãƒ•ã‚£ãƒŠ',
        title: 'å¤ä»£å²ç ”ç©¶è€…',
        portrait: 'ğŸ‘©â€ğŸ”¬',
        desc: 'ã€Œã‚¹ã‚­ãƒ¼ãƒã€ã®çœŸå®Ÿã‚’è¿½ã†è¬å¤šãå­¦è€…'
      },
      guildmaster: {
        name: 'ã‚®ãƒ«ãƒ‰ãƒã‚¹ã‚¿ãƒ¼',
        title: 'å†’é™ºè€…ã‚®ãƒ«ãƒ‰é•·',
        portrait: 'ğŸ‘´',
        desc: 'é•·å¹´ãƒªãƒ«ã‚¬ãƒŸãƒ³ã‚’è¦‹å®ˆã£ã¦ããŸè€äºº'
      }
    };

    // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ€ãƒ³ã‚¸ãƒ§ãƒ³å†…ç™ºè¦‹ç‰©ï¼‰
    const STORY_EVENTS = {
      thieves: {
        trigger: 'clear', // ãƒœã‚¹æ“ƒç ´æ™‚
        id: 'doc_royal',
        title: 'ç‹å®¶ã®å¤æ–‡æ›¸',
        text: 'ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒ•ã®éš ã—éƒ¨å±‹ã‹ã‚‰ã€å¤ã³ãŸç¾Šçš®ç´™ãŒè¦‹ã¤ã‹ã£ãŸã€‚\nç‹å®¶ã®å°ç« ãŒæŠ¼ã•ã‚Œã¦ã„ã‚‹ãŒã€æ–‡å­—ãŒã‹ã™ã‚Œã¦èª­ã‚ãªã„ã€‚\nã‚»ãƒ©ãƒ•ã‚£ãƒŠã«è¦‹ã›ã‚Œã°è§£èª­ã§ãã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚',
        item: { id: 'doc1', name: 'ç‹å®¶ã®å¤æ–‡æ›¸', type: 'document', rarity: 'rare' }
      },
      kaoka: {
        trigger: 'floor8',
        id: 'mural',
        title: 'è¬ã®å£ç”»',
        text: 'å´©ã‚Œã‹ã‘ãŸå£ã«ã€å¤ä»£ã®å£ç”»ãŒæ®‹ã£ã¦ã„ãŸã€‚\n\nä¸€äººã®é­”è¡“å¸«ãŒã€æ·±æ·µã®å‰ã«ç«‹ã¡å¡ãå§¿ã€‚\nãã®èƒŒå¾Œã«ã¯äººã€…ãŒç¥ˆã‚Šã‚’æ§ã’ã¦ã„ã‚‹ã€‚\n\nã€Œæ‚ªã®é­”è¡“å¸«ã€ã®å§¿ã«ã—ã¦ã¯ã€å¥‡å¦™ãªæ§‹å›³ã â€¦',
        item: { id: 'doc2', name: 'å£ç”»ã®å†™ã—', type: 'document', rarity: 'rare' }
      },
      dragon: {
        trigger: 'boss_before',
        id: 'dragon_speak',
        title: 'ç«œã®è¨€è‘‰',
        text: 'ã‚¨ãƒ³ã‚·ã‚§ãƒ³ãƒˆãƒ‰ãƒ©ã‚´ãƒ³ã¯æˆ¦ã„ã®å‰ã«å£ã‚’é–‹ã„ãŸã€‚\n\nã€Œæˆ‘ã¯1000å¹´ã€ã“ã®åœ°ã§é–€ã‚’è¦‹å®ˆã£ã¦ããŸã€‚\nã€€ã‹ã®è€…ã¨åŒã˜ãã€‚ã€\n\nã€Œã‹ã®è€…ã€ã¨ã¯èª°ã®ã“ã¨ã ï¼Ÿ',
        item: null
      },
      trebor: {
        trigger: 'boss_before',
        id: 'wardna_truth',
        title: 'ãƒ¯ãƒ¼ãƒ‰ãƒŠã®è¨€è‘‰',
        text: 'ãƒ¯ãƒ¼ãƒ‰ãƒŠã¯é™ã‹ã«èªã‚Šå§‹ã‚ãŸã€‚\n\nã€ŒãŠå‰ãŸã¡ã¯â€¦ä½•ã‚‚çŸ¥ã‚‰ãšã«ã“ã“ã¾ã§æ¥ãŸã®ã‹ã€‚ã€\n\nã€Œã€ã‚¹ã‚­ãƒ¼ãƒã€ã¯é–€ã‚’é–‹ãè¡“ã§ã¯ãªã„ã€‚\nã€€é–€ã‚’â€”â€”é–‰ã˜ã‚‹ãŸã‚ã®è¡“ã ã€‚ã€\n\nã€Œ1000å¹´å‰ã€é–€ã¯ã™ã§ã«é–‹ã„ã¦ã„ãŸã€‚\nã€€æˆ‘ã¯å‘½ã‚’è³­ã—ã¦ã€ãã‚Œã‚’åŠåˆ†é–‰ã˜ãŸã®ã ã€‚ã€\n\nã€Œãã—ã¦ä»Šã‚‚ã€æˆ‘ã¯ã“ã“ã§é–€ã‚’æŠ¼ã•ãˆç¶šã‘ã¦ã„ã‚‹ã€‚\nã€€æˆ‘ã‚’å€’ã›ã°ã€é–€ã¯å®Œå…¨ã«é–‹ãã€‚ã€\n\nã€Œæœ¬å½“ã®æ•µã¯ã€é–€ã®å‘ã“ã†ã«ã„ã‚‹ã€‚\nã€€ã€æ·±æ·µã®ç‹ã€ãŒã€‚ã€',
        item: { id: 'doc3', name: 'ãƒ¯ãƒ¼ãƒ‰ãƒŠã®æ—¥è¨˜', type: 'document', rarity: 'legendary' }
      }
    };

    // ã‚»ãƒ©ãƒ•ã‚£ãƒŠã®ä¼šè©±ï¼ˆé€²è¡Œåº¦ã§å¤‰åŒ–ï¼‰
    const SERAPHINA_DIALOGUES = {
      first: {
        lines: [
          'ã€Œåˆã‚ã¾ã—ã¦ã€‚ç§ã¯ã‚»ãƒ©ãƒ•ã‚£ãƒŠã€‚å¤ä»£å²ã®ç ”ç©¶ã‚’ã—ã¦ã„ã¾ã™ã€‚ã€',
          'ã€Œã€ã‚¹ã‚­ãƒ¼ãƒã€ã®çœŸå®Ÿã‚’çªãæ­¢ã‚ãŸãã¦ã€ã“ã®è¡—ã«æ¥ã¾ã—ãŸã€‚ã€',
          'ã€Œã‚ãªãŸãŒãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã§ä½•ã‹è¦‹ã¤ã‘ãŸã‚‰ã€ãœã²æ•™ãˆã¦ãã ã•ã„ã€‚ã€'
        ]
      },
      hasDoc1: {
        lines: [
          'ã€Œã“ã‚Œã¯â€¦ï¼ç‹å®¶ã®æ©Ÿå¯†æ–‡æ›¸ã§ã™ã­ã€‚ã€',
          'ã€Œè§£èª­ã—ã¦ã¿ã¾ã™ã€‚å°‘ã—æ™‚é–“ã‚’ãã ã•ã„â€¦ã€',
          'ã€Œâ€¦ã“ã‚Œã¯ã€‚æ­´å²ãŒæ›¸ãæ›ãˆã‚‰ã‚ŒãŸè¨¼æ‹ ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã€',
          'ã€Œã‚‚ã£ã¨èª¿ã¹ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æ¢ç´¢ã‚’ç¶šã‘ã¦ãã ã•ã„ã€‚ã€'
        ]
      },
      hasDoc2: {
        lines: [
          'ã€Œã“ã®å£ç”»â€¦ä¼æ‰¿ã¨å…¨ãé•ã„ã¾ã™ã€‚ã€',
          'ã€Œãƒ¯ãƒ¼ãƒ‰ãƒŠã¯æœ¬å½“ã«ã€æ‚ªã®é­”è¡“å¸«ã€ã ã£ãŸã®ã§ã—ã‚‡ã†ã‹ï¼Ÿã€',
          'ã€Œäººã€…ãŒå½¼ã«ç¥ˆã‚Šã‚’æ§ã’ã¦ã„ã‚‹ã€‚ã¾ã‚‹ã§è‹±é›„ã®ã‚ˆã†ã«â€¦ã€',
          'ã€ŒçœŸå®Ÿã¯æ·±æ·µã®æœ€å¥¥ã«ã‚ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã€'
        ]
      },
      hasDoc3: {
        lines: [
          'ã€Œãƒ¯ãƒ¼ãƒ‰ãƒŠã®æ—¥è¨˜â€¦ã“ã‚Œã§ã™ã¹ã¦ãŒæ˜ã‚‰ã‹ã«ãªã‚Šã¾ã—ãŸã€‚ã€',
          'ã€Œå½¼ã¯1000å¹´é–“ã€ãŸã£ãŸä¸€äººã§ä¸–ç•Œã‚’å®ˆã£ã¦ã„ãŸã®ã§ã™ã€‚ã€',
          'ã€Œæ­´å²ã¯å½¼ã‚’æ‚ªã¨å‘¼ã‚“ã ã€‚ã§ã‚‚ã€çœŸå®Ÿã¯é•ã£ãŸã€‚ã€',
          'ã€Œã‚ãªãŸã¯ä»Šã€çœŸå®Ÿã‚’çŸ¥ã‚‹æ•°å°‘ãªã„äººé–“ã®ä¸€äººã§ã™ã€‚ã€',
          'ã€Œã“ã®çœŸå®Ÿã‚’â€¦ã©ã†ã™ã‚‹ã‹ã¯ã€ã‚ãªãŸæ¬¡ç¬¬ã§ã™ã€‚ã€'
        ]
      }
    };

    // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿
    const ENDING = {
      wardnaChoice: {
        title: 'é¸æŠ',
        text: 'ãƒ¯ãƒ¼ãƒ‰ãƒŠã¯é™ã‹ã«ç«‹ã£ã¦ã„ã‚‹ã€‚\n\nå½¼ã‚’å€’ã›ã°ã€é–€ãŒé–‹ãã€‚\nã ãŒã€å½¼ã‚’è¦‹é€ƒã›ã°â€”â€”\n\nä½•ã‚’é¸ã¶ï¼Ÿ',
        choices: [
          { id: 'spare', text: 'è¦‹é€ƒã™' },
        ]
      },
      ending: {
        lines: [
          'ãƒ¯ãƒ¼ãƒ‰ãƒŠã¯é™ã‹ã«å¾®ç¬‘ã‚“ã ã€‚',
          '',
          'ã€Œä»Šã¯ã¾ã â€¦ä¸–ç•Œã¯ã‚ã®è€…ã¨æˆ¦ã†åŠ›ã‚’æŒãŸã¬ã€‚ã€',
          '',
          'ã€Œã ãŒã€ãŠå‰ãŸã¡ãªã‚‰ã„ã¤ã‹â€¦ã€',
          '',
          'ã€Œãã®æ—¥ã¾ã§ã€æˆ‘ã¯é–€ã‚’æŠ¼ã•ãˆç¶šã‘ã‚ˆã†ã€‚ã€',
          '',
          'ã€Œãã—ã¦ã€çœŸå®Ÿã¯â€¦ãŠå‰ãŸã¡ã®èƒ¸ã®ä¸­ã ã‘ã«ã€‚ã€',
          '',
          'å†’é™ºè€…ãŸã¡ã¯åœ°ä¸Šã¸æˆ»ã£ãŸã€‚',
          'ä¸–ç•Œã¯ä½•ã‚‚å¤‰ã‚ã‚‰ãªã„ã€‚',
          'ãƒ¯ãƒ¼ãƒ‰ãƒŠã¯ä»Šã‚‚ã€Œæ‚ªã®é­”è¡“å¸«ã€ã¨ã—ã¦èªã‚Šç¶™ãŒã‚Œã‚‹ã€‚',
          '',
          'ã ãŒã€å†’é™ºè€…ãŸã¡ã¯çŸ¥ã£ã¦ã„ã‚‹ã€‚',
          'æ·±æ·µã®åº•ã§ã€å­¤ç‹¬ã«ä¸–ç•Œã‚’å®ˆã‚Šç¶šã‘ã‚‹ç”·ãŒã„ã‚‹ã“ã¨ã‚’ã€‚',
          '',
          'ãã—ã¦â€”â€”',
          'ã„ã¤ã‹ã€æœ¬å½“ã®æˆ¦ã„ãŒå§‹ã¾ã‚‹ã“ã¨ã‚’ã€‚',
          '',
          '',
          'ã€ To be continued... ã€‘'
        ],
        postCredits: {
          text: 'æš—é—‡ã®ä¸­ã€å·¨å¤§ãªç›®ãŒé–‹ãã€‚\n\nã€Œâ€¦ãã‚ãã‚ã€ã‹ã€‚ã€',
          hint: 'Wizardry Schema 2 - Coming Soon...'
        }
      }
    };

    // ===== ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª =====
    function App() {
      const [screen, setScreen] = useState('title');
      const [party, setParty] = useState([]);
      const [gold, setGold] = useState(100);
      const [logs, setLogs] = useState([]);
      const [exploring, setExploring] = useState(false);
      const [paused, setPaused] = useState(false); // v13.1: ãƒœã‚¹æˆ¦å‰ã®ä¸€æ™‚åœæ­¢
      const [bossConfirm, setBossConfirm] = useState(null); // v13.1: ãƒœã‚¹ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
      const [dungeon, setDungeon] = useState(null);
      const [floor, setFloor] = useState(1);
      const [maxFloors, setMaxFloors] = useState({});
      const [clearedDungeons, setClearedDungeons] = useState({});
      const [retreatHP, setRetreatHP] = useState(30);
      const [autoPotion, setAutoPotion] = useState(true); // v13.1: è‡ªå‹•ãƒãƒ¼ã‚·ãƒ§ãƒ³
      const [activeTab, setActiveTab] = useState('dungeon');
      const [settings, setSettings] = useState({bgm:true,sfx:true,bgmVol:50,sfxVol:70});
      const [bestiary, setBestiary] = useState({});
      const [inventory, setInventory] = useState([]);
      const [showSettings, setShowSettings] = useState(false);
      const [showJobChange, setShowJobChange] = useState(null);
      const [shopCat, setShopCat] = useState('weapons');
      const [selChar, setSelChar] = useState(null);
      const [currentFacility, setCurrentFacility] = useState(null); // v14.0: æ–½è¨­ç”»é¢ç®¡ç†
      // v15.0: ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚·ã‚¹ãƒ†ãƒ 
      const [storyFlags, setStoryFlags] = useState({ metSeraphina: false, documents: [], eventsTriggered: [], endingReached: false });
      const [dialogueModal, setDialogueModal] = useState(null); // { npc: 'seraphina', lines: [...], currentLine: 0 }
      const [storyEventModal, setStoryEventModal] = useState(null); // ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºç”¨
      const [endingPhase, setEndingPhase] = useState(null); // 'choice' | 'ending' | 'postcredits'
      const logRef = useRef(null);

      const initSound = async () => { await soundEngine.init(); if (settings.bgm) soundEngine.startBGM(); };

      const addLog = useCallback((msg, type='normal') => {
        const c = {normal:'text-green-400',battle:'text-yellow-400',damage:'text-red-400',heal:'text-blue-400',item:'text-purple-400',level:'text-cyan-400',special:'text-pink-400',critical:'text-orange-400',boss:'gold-text',explore:'text-gray-400',clear:'text-yellow-300'}[type] || 'text-green-400';
        setLogs(prev => [...prev.slice(-100), {msg,c}]);
      }, []);

      // v13.1: ç¨®æ—ç‰¹æ€§ã‚’å–å¾—
      const getRaceTrait = (raceKey) => RACES[raceKey]?.trait || {};

      useEffect(() => {
        const s = localStorage.getItem('wizardrySchemaV15');
        if (s) { 
          const d = JSON.parse(s); 
          setParty(d.party||[]); 
          setGold(d.gold||100); 
          setMaxFloors(d.maxFloors||{}); 
          setClearedDungeons(d.clearedDungeons||{}); 
          setSettings(d.settings||{bgm:true,sfx:true,bgmVol:50,sfxVol:70}); 
          setBestiary(d.bestiary||{}); 
          setInventory(d.inventory||[]); 
          if (d.autoPotion !== undefined) setAutoPotion(d.autoPotion);
          if (d.storyFlags) setStoryFlags(d.storyFlags);
        }
      }, []);
      useEffect(() => { 
        if (party.length > 0) localStorage.setItem('wizardrySchemaV15', JSON.stringify({party,gold,maxFloors,clearedDungeons,settings,bestiary,inventory,autoPotion,storyFlags})); 
      }, [party,gold,maxFloors,clearedDungeons,settings,bestiary,inventory,autoPotion,storyFlags]);
      useEffect(() => { if (logRef.current) logRef.current.scrollTop = logRef.current.scrollHeight; }, [logs]);
      useEffect(() => { soundEngine.toggleBGM(settings.bgm); }, [settings.bgm]);
      useEffect(() => { soundEngine.setBgmVolume(-30 + settings.bgmVol*0.3); }, [settings.bgmVol]);
      useEffect(() => { soundEngine.setSfxVolume(-20 + settings.sfxVol*0.2); }, [settings.sfxVol]);

      const getDrop = (flr, isBoss = false, bossName = null) => {
        if (isBoss && bossName && BOSS_DROPS[bossName]) {
          const drops = BOSS_DROPS[bossName];
          if (Math.random() < 0.7) return {...drops[Math.floor(Math.random() * drops.length)], uid: Date.now()+Math.random()};
        }
        const r = Math.random();
        let rarity = 'common';
        if (r < 0.0002 && flr >= 25) rarity = 'legendary';
        else if (r < 0.015 && flr >= 15) rarity = 'epic';
        else if (r < 0.06 && flr >= 8) rarity = 'rare';
        else if (r < 0.2) rarity = 'uncommon';
        const all = [...ITEMS.weapons,...ITEMS.armors,...ITEMS.accessories];
        const avail = all.filter(i => i.rarity === rarity);
        if (!avail.length) return null;
        return {...avail[Math.floor(Math.random()*avail.length)], uid: Date.now()+Math.random()};
      };

      // v13.1: è‡ªå‹•ãƒãƒ¼ã‚·ãƒ§ãƒ³ä½¿ç”¨
      const useAutoPotion = useCallback(() => {
        if (!autoPotion) return;
        setParty(prev => {
          let newParty = [...prev];
          let usedPotions = [];
          
          newParty = newParty.map(char => {
            if (char.currentHp <= 0 || char.currentHp / char.maxHp > 0.3) return char;
            
            // æ‰€æŒå“ã‹ã‚‰ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¢ã™ï¼ˆã‚¨ãƒªã‚¯ã‚µãƒ¼ > ãƒã‚¤ãƒãƒ¼ã‚·ãƒ§ãƒ³ > ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
            const potionOrder = ['p003', 'p002', 'p001'];
            for (const pid of potionOrder) {
              const potionIdx = inventory.findIndex(i => i.id === pid);
              if (potionIdx !== -1) {
                const potion = inventory[potionIdx];
                const healAmount = Math.min(potion.heal, char.maxHp - char.currentHp);
                usedPotions.push({ idx: potionIdx, name: potion.name, charName: char.name, heal: healAmount });
                return { ...char, currentHp: Math.min(char.maxHp, char.currentHp + potion.heal) };
              }
            }
            return char;
          });
          
          // ä½¿ç”¨ã—ãŸãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‹ã‚‰å‰Šé™¤
          if (usedPotions.length > 0) {
            const indicesToRemove = usedPotions.map(p => p.idx);
            setInventory(prev => prev.filter((_, i) => !indicesToRemove.includes(i)));
            usedPotions.forEach(p => {
              addLog(`ğŸ’Š ${p.charName}ãŒ${p.name}ã‚’ä½¿ç”¨ (+${p.heal}HP)`, 'heal');
            });
            soundEngine.playHeal();
          }
          
          return newParty;
        });
      }, [autoPotion, inventory, addLog]);

      useEffect(() => {
        if (!exploring || party.length === 0 || !dungeon || paused) return;
        const interval = setInterval(() => {
          const alive = party.filter(c => c.currentHp > 0);
          if (alive.length === 0) {
            addLog('ã€å…¨æ»…ã€‘ãƒ‘ãƒ¼ãƒ†ã‚£ã¯å…¨æ»…ã—ãŸ...','damage');
            soundEngine.playDeath(); setExploring(false); setFloor(1); setParty(p => p.map(c => ({...c, currentHp: Math.floor(c.maxHp*0.5)}))); soundEngine.startBGM('town'); return;
          }
          if (alive.some(c => (c.currentHp/c.maxHp)*100 <= retreatHP)) {
            addLog(`ã€æ’¤é€€ã€‘HP${retreatHP}%ä»¥ä¸‹ã§å¸°é‚„`,'special');
            setExploring(false); setFloor(1); setParty(p => p.map(c => ({...c, currentHp: c.maxHp, currentMp: c.maxMp}))); soundEngine.startBGM('town'); return;
          }
          const event = Math.random();
          const dngData = DUNGEONS.find(d => d.id === dungeon);
          
          if (event < 0.85) {
            const monsters = MONSTERS.filter(m => m.dng === dungeon && m.flr <= floor);
            if (monsters.length === 0) return;
            const mon = {...monsters[Math.floor(Math.random()*monsters.length)]};
            const isBoss = mon.boss && floor === mon.flr;
            const monMaxHp = mon.hp;
            const isFinalBoss = isBoss && floor === dngData.floors;
            
            // v13.1: ãƒœã‚¹æˆ¦å‰ã®ä¸€æ™‚åœæ­¢ç¢ºèª
            if (isBoss && !bossConfirm) {
              soundEngine.playBoss();
              setPaused(true);
              setBossConfirm({ monster: mon, isFinal: isFinalBoss });
              addLog(`â”â”â” BOSSç™ºè¦‹: ${mon.name} â”â”â”`,'boss');
              
              // v15.0: ãƒœã‚¹æˆ¦å‰ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
              const storyEvent = STORY_EVENTS[dungeon];
              if (storyEvent && storyEvent.trigger === 'boss_before' && !storyFlags.eventsTriggered.includes(storyEvent.id)) {
                setTimeout(() => triggerStoryEvent(dungeon, 'boss_before'), 800);
              }
              return;
            }
            
            setBestiary(prev => ({...prev,[mon.name]:{...mon,cnt:(prev[mon.name]?.cnt||0)+1}}));
            
            if (isBoss) {
              addLog(`â”â”â” BOSSæˆ¦é—˜é–‹å§‹: ${mon.name} â”â”â”`,'boss');
            }
            
            let monHp = mon.hp;
            let mpUsed = {};
            let turnCount = 1;
            let partyDamage = {};
            let criticalHits = 0;
            
            while (monHp > 0 && alive.filter(c => (partyDamage[c.id]||0) < c.currentHp).length > 0 && turnCount <= 5) {
              if (isBoss) addLog(`ã€ã‚¿ãƒ¼ãƒ³${turnCount}ã€‘`,'battle');
              
              alive.forEach((char) => {
                if (monHp <= 0) return;
                const job = JOBS[char.jobKey];
                const trait = getRaceTrait(char.raceKey);
                
                // v13.1: ç¨®æ—ç‰¹æ€§ã«ã‚ˆã‚‹å›é¿åˆ¤å®š
                const evasionBonus = trait.evasion || 0;
                const isMiss = Math.random() < (0.08 - evasionBonus);
                if (isMiss) {
                  if (isBoss) addLog(`${char.name}ã®æ”»æ’ƒã¯å¤–ã‚ŒãŸ`,'normal');
                  return;
                }
                
                // v13.1: ç¨®æ—ç‰¹æ€§ã«ã‚ˆã‚‹ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è£œæ­£
                const critBonus = trait.critBonus || 0;
                const isCritical = Math.random() < (0.05 + char.luk * 0.005 + critBonus);
                
                if (job.spell && char.currentMp >= 2 && Math.random() < 0.35) {
                  const spells = job.spell === 'both' ? [...SPELLS.mage,...SPELLS.priest] : (SPELLS[job.spell]||[]);
                  const atkSpells = spells.filter(s => s.pow > 0 && s.mp <= char.currentMp && s.lv <= Math.floor(char.level/2)+1);
                  if (atkSpells.length > 0) {
                    const spell = atkSpells[Math.floor(Math.random()*atkSpells.length)];
                    // v13.1: ã‚¨ãƒ«ãƒ•ã®é­”æ³•ãƒœãƒ¼ãƒŠã‚¹
                    const magicBonus = trait.magicBonus || 0;
                    let dmg = Math.floor((spell.pow + Math.floor(char.int * 0.5)) * (1 + magicBonus));
                    if (isCritical) { dmg = Math.floor(dmg * 1.5); criticalHits++; }
                    monHp -= dmg;
                    mpUsed[char.id] = (mpUsed[char.id]||0) + spell.mp;
                    if (isBoss) addLog(`${char.name}ã€Œ${spell.name}ã€â†’ ${dmg}${isCritical?' ä¼šå¿ƒ!':''}`, isCritical?'critical':'special');
                    soundEngine.playAttack();
                    return;
                  }
                }
                // v13.3: ãƒ‰ãƒ¯ãƒ¼ãƒ•ã®æ”»æ’ƒãƒœãƒ¼ãƒŠã‚¹
                const atkBonus = trait.atkBonus || 0;
                let dmg = Math.max(1, Math.floor((char.atk * (1 + atkBonus)) - mon.def + Math.random()*8));
                if (isCritical) { dmg = Math.floor(dmg * 1.5); criticalHits++; }
                monHp -= dmg;
                if (isBoss) addLog(`${char.name}ã®æ”»æ’ƒ â†’ ${dmg}${isCritical?' ä¼šå¿ƒ!':''}`, isCritical?'critical':'battle');
                soundEngine.playAttack();
              });
              
              if (monHp > 0) {
                if (isBoss) addLog(`${mon.name} HP:${Math.max(0,monHp)}/${monMaxHp}`,'normal');
                soundEngine.playHit();
                const target = alive[Math.floor(Math.random()*alive.length)];
                const targetTrait = getRaceTrait(target.raceKey);
                
                // v13.1: ãƒ‰ãƒ¯ãƒ¼ãƒ•ã®é˜²å¾¡ãƒœãƒ¼ãƒŠã‚¹ã€ãƒãƒ¼ãƒ ã®é­”æ³•è€æ€§
                const defBonus = targetTrait.defBonus || 0;
                const effectiveDef = Math.floor(target.def * (1 + defBonus));
                let dmg = Math.max(1, mon.atk - effectiveDef + Math.floor(Math.random()*8));
                
                // v13.1: ç¨®æ—ç‰¹æ€§ã«ã‚ˆã‚‹å›é¿ï¼ˆè¢«æ”»æ’ƒæ™‚ï¼‰
                const targetEvasion = targetTrait.evasion || 0;
                if (Math.random() < targetEvasion) {
                  if (isBoss) addLog(`${target.name}ã¯æ”»æ’ƒã‚’å›é¿ï¼`,'special');
                } else {
                  partyDamage[target.id] = (partyDamage[target.id]||0) + dmg;
                  if (isBoss) addLog(`${mon.name} â†’ ${target.name}ã«${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸`,'damage');
                }
              }
              turnCount++;
            }
            
            if (monHp <= 0) {
              if (isBoss) {
                addLog(`â•â•â• ${mon.name}ã‚’æ’ƒç ´ï¼ â•â•â•`,'item');
                addLog(`+${mon.exp}EXP / +${mon.gold}G`,'item');
                setBossConfirm(null);
              } else {
                const critText = criticalHits > 0 ? ` ä¼šå¿ƒ${criticalHits}` : '';
                addLog(`${mon.name}æ’ƒç ´ +${mon.exp}EXP +${mon.gold}G${critText}`,'item');
              }
              
              soundEngine.playGold();
              setGold(prev => prev + mon.gold);
              
              if (isBoss || Math.random() < 0.12) {
                const drop = getDrop(floor,isBoss,mon.name);
                if (drop) {
                  setInventory(prev => [...prev,drop]);
                  addLog(`ã€ãƒ‰ãƒ­ãƒƒãƒ—ã€‘${drop.name}`,drop.rarity==='legendary'?'boss':'item');
                }
              }
              
              let levelUpChars = [];
              setParty(prev => prev.map(char => {
                let updated = {...char};
                if (mpUsed[char.id]) updated.currentMp = Math.max(0, updated.currentMp - mpUsed[char.id]);
                if (partyDamage[char.id]) updated.currentHp = Math.max(0, updated.currentHp - partyDamage[char.id]);
                if (char.currentHp > 0) {
                  // v13.1: äººé–“ã®EXPãƒœãƒ¼ãƒŠã‚¹
                  const trait = getRaceTrait(char.raceKey);
                  const expBonus = trait.expBonus || 0;
                  const expGain = Math.floor((mon.exp / alive.length) * (1 + expBonus));
                  const newExp = updated.exp + expGain;
                  const expNeed = updated.level * 100;
                  if (newExp >= expNeed) {
                    levelUpChars.push({name: char.name, oldLv: updated.level, newLv: updated.level + 1});
                    soundEngine.playLevelUp();
                    const hpUp = 5 + Math.floor(updated.vit*0.5);
                    const mpUp = 3 + Math.floor(updated.int*0.3);
                    updated = {...updated, exp: newExp - expNeed, level: updated.level + 1,
                      maxHp: updated.maxHp + hpUp, currentHp: updated.maxHp + hpUp,
                      maxMp: updated.maxMp + mpUp, currentMp: updated.maxMp + mpUp,
                      atk: updated.atk + 2, def: updated.def + 1};
                  } else { updated.exp = newExp; }
                }
                return updated;
              }));
              
              levelUpChars.forEach(c => {
                addLog(`â˜… ${c.name} Lv.${c.oldLv}â†’${c.newLv}ï¼`,'level');
              });
              
              // v13.1: æˆ¦é—˜å¾Œã®è‡ªå‹•ãƒãƒ¼ã‚·ãƒ§ãƒ³
              setTimeout(() => useAutoPotion(), 100);
              
              if (isFinalBoss) {
                soundEngine.playClear();
                setClearedDungeons(prev => ({...prev, [dungeon]: true}));
                
                // v15.0: ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ï¼ˆãƒœã‚¹ã‚¯ãƒªã‚¢æ™‚ï¼‰
                const storyEvent = STORY_EVENTS[dungeon];
                if (storyEvent && storyEvent.trigger === 'clear' && !storyFlags.eventsTriggered.includes(storyEvent.id)) {
                  setTimeout(() => triggerStoryEvent(dungeon, 'clear'), 500);
                }
                
                // v15.0: ãƒ¯ãƒ¼ãƒ‰ãƒŠæ’ƒç ´æ™‚ã¯ç‰¹åˆ¥ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã¸
                if (dungeon === 'trebor' && mon.name === 'ãƒ¯ãƒ¼ãƒ‰ãƒŠ') {
                  addLog('','normal');
                  addLog(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,'clear');
                  addLog(`ãƒ¯ãƒ¼ãƒ‰ãƒŠã¯é™ã‹ã«å€’ã‚ŒãŸ...`,'clear');
                  addLog(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,'clear');
                  setTimeout(() => {
                    setExploring(false);
                    setEndingPhase('choice');
                  }, 2000);
                  return;
                }
                
                addLog('','normal');
                addLog(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,'clear');
                addLog(`ğŸ† ${dngData.name} è¸ç ´ï¼ ğŸ†`,'clear');
                addLog(`â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,'clear');
                addLog('å¸°é‚„ã—ã¾ã™...','heal');
                setTimeout(() => {
                  setExploring(false);
                  setFloor(1);
                  setParty(p => p.map(c => ({...c, currentHp: c.maxHp, currentMp: c.maxMp})));
                  soundEngine.startBGM('town');
                }, 2000);
                return;
              }
            }
          } else if (event < 0.93) {
            if (floor < dngData.floors) {
              const newFloor = floor + 1;
              setFloor(newFloor);
              setMaxFloors(prev => ({...prev,[dungeon]:Math.max(prev[dungeon]||0,newFloor)}));
              addLog(`â”â”â” B${newFloor}Fã¸é™ã‚ŠãŸ â”â”â”`,'item');
              const floorDesc = getFloorDesc(dungeon, newFloor);
              if (floorDesc) addLog(floorDesc,'explore');
              
              // v15.0: ç‰¹å®šéšå±¤ã§ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
              const storyEvent = STORY_EVENTS[dungeon];
              if (storyEvent && storyEvent.trigger === `floor${newFloor}` && !storyFlags.eventsTriggered.includes(storyEvent.id)) {
                setTimeout(() => {
                  setPaused(true);
                  triggerStoryEvent(dungeon, `floor${newFloor}`);
                }, 500);
              }
            }
          } else if (event < 0.97) {
            const hasThief = alive.some(c => c.jobKey === 'thief' || c.jobKey === 'ninja');
            if (Math.random() < (hasThief ? 0.1 : 0.25)) {
              const trap = TRAPS[Math.floor(Math.random()*TRAPS.length)];
              addLog(`ç½ ç™ºå‹•ï¼${trap.name}`,'damage');
              soundEngine.playHit();
              setParty(p => p.map(c => ({...c, currentHp: Math.max(1, c.currentHp - Math.floor(c.maxHp*trap.dmg))})));
              setTimeout(() => useAutoPotion(), 100);
            } else {
              const goldFound = Math.floor(Math.random()*50*floor) + 20;
              setGold(prev => prev + goldFound);
              addLog(`å®ç®±ç™ºè¦‹ï¼ +${goldFound}G`,'item');
              soundEngine.playGold();
            }
          } else {
            addLog('æ³‰ã§å›å¾©','heal');
            soundEngine.playHeal();
            setParty(p => p.map(c => ({...c, currentHp: Math.min(c.maxHp, c.currentHp + Math.floor(c.maxHp*0.3)), currentMp: Math.min(c.maxMp, c.currentMp + Math.floor(c.maxMp*0.3))})));
          }
        }, 1200);
        return () => clearInterval(interval);
      }, [exploring, dungeon, floor, party, retreatHP, paused, bossConfirm, addLog, useAutoPotion]);

      const createChar = () => {
        if (party.length >= 6) return;
        const raceKeys = Object.keys(RACES);
        const raceKey = raceKeys[Math.floor(Math.random()*raceKeys.length)];
        const race = RACES[raceKey];
        const alignKeys = Object.keys(ALIGNMENTS);
        const alignKey = alignKeys[Math.floor(Math.random()*alignKeys.length)];
        const availJobs = Object.entries(JOBS).filter(([_,j]) => j.align.includes(alignKey) && j.tier === 1);
        const [jobKey, job] = availJobs[Math.floor(Math.random()*availJobs.length)];
        const bonus = Math.floor(Math.random()*15)+5;
        const vit = race.vit + Math.floor(bonus*0.4);
        const int = race.int + Math.floor(bonus*0.2);
        const newChar = {
          id: Date.now(), name: genName(raceKey), race: race.name, raceKey,
          alignment: ALIGNMENTS[alignKey].name, alignKey, job: job.name, jobKey,
          level: 1, exp: 0,
          maxHp: Math.floor((vit*3+20)*job.hpMod), currentHp: Math.floor((vit*3+20)*job.hpMod),
          maxMp: Math.floor((int*2+10)*job.mpMod), currentMp: Math.floor((int*2+10)*job.mpMod),
          atk: Math.floor((race.str*1.5+5)*job.atkMod), def: Math.floor((vit*1.2+3)*job.defMod),
          str: race.str, int, pie: race.pie, vit, agi: race.agi, luk: race.luk,
          equipment: {}, previousJobs: []
        };
        setParty(prev => [...prev, newChar]);
        addLog(`${newChar.name}ï¼ˆ${race.name}ã®${job.name}ï¼‰ãŒç™»éŒ²ï¼`,'level');
      };

      const canChangeJob = (char, jobKey) => {
        const job = JOBS[jobKey];
        if (!job.align.includes(char.alignKey)) return {can:false,reason:'å±æ€§ä¸ä¸€è‡´'};
        if (char.level < 10) return {can:false,reason:'Lv10å¿…è¦'};
        for (const [stat,req] of Object.entries(job.req)) if ((char[stat]||0) < req) return {can:false,reason:`${stat}${req}å¿…è¦`};
        return {can:true};
      };
      const changeJob = (charId, newJobKey) => {
        setParty(prev => prev.map(char => {
          if (char.id !== charId) return char;
          const newJob = JOBS[newJobKey];
          soundEngine.playLevelUp();
          addLog(`â˜… ${char.name}ã¯${newJob.name}ã«è»¢è·ï¼`,'level');
          const baseHp = Math.floor((char.vit*3+20)*newJob.hpMod);
          const baseMp = Math.floor((char.int*2+10)*newJob.mpMod);
          return {...char, job: newJob.name, jobKey: newJobKey, level: 1, exp: 0,
            maxHp: baseHp + Math.floor(char.maxHp*0.3), currentHp: baseHp + Math.floor(char.maxHp*0.3),
            maxMp: baseMp + Math.floor(char.maxMp*0.2), currentMp: baseMp + Math.floor(char.maxMp*0.2),
            atk: Math.floor((char.str*1.5+5)*newJob.atkMod), def: Math.floor((char.vit*1.2+3)*newJob.defMod),
            previousJobs: [...(char.previousJobs||[]), char.jobKey]};
        }));
        setShowJobChange(null);
      };

      const equipItem = (charId, item) => {
        const slot = ITEMS.weapons.some(w => w.id === item.id) || (item.id?.startsWith('bd') && item.atk && !item.def) ? 'weapon' 
                   : ITEMS.armors.some(a => a.id === item.id) || (item.id?.startsWith('bd') && item.def && !item.atk) ? 'armor' : 'accessory';
        setParty(prev => prev.map(char => {
          if (char.id !== charId) return char;
          const old = char.equipment[slot];
          let newAtk = char.atk, newDef = char.def;
          if (old) { if (old.atk) newAtk -= old.atk; if (old.def) newDef -= old.def; setInventory(p => [...p, old]); }
          if (item.atk) newAtk += item.atk; if (item.def) newDef += item.def;
          setInventory(p => p.filter(i => i.uid !== item.uid));
          return {...char, atk: newAtk, def: newDef, equipment: {...char.equipment, [slot]: item}};
        }));
      };

      const exportSave = () => { const blob = new Blob([JSON.stringify({party,gold,maxFloors,clearedDungeons,settings,bestiary,inventory,autoPotion})], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `wizardry-v13-${Date.now()}.json`; a.click(); };

      // v13.1: ãƒœã‚¹ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
      const BossConfirmModal = () => {
        if (!bossConfirm) return null;
        const { monster, isFinal } = bossConfirm;
        return (
          <div className="modal-overlay">
            <div className="retro-border bg-black p-6 max-w-md text-center">
              <h3 className="text-2xl gold-text mb-4">âš ï¸ BOSSç™ºè¦‹ âš ï¸</h3>
              <p className="text-xl mb-2">{monster.name}</p>
              <p className="text-sm text-gray-400 mb-4">HP:{monster.hp} ATK:{monster.atk} DEF:{monster.def}</p>
              {isFinal && <p className="text-yellow-400 mb-4">ğŸ† æœ€çµ‚ãƒœã‚¹ ğŸ†</p>}
              <div className="mb-4 text-left">
                <p className="text-sm text-gray-300 mb-2">ãƒ‘ãƒ¼ãƒ†ã‚£çŠ¶æ…‹:</p>
                {party.map(c => (
                  <div key={c.id} className="text-xs flex justify-between">
                    <span>{c.name}</span>
                    <span className={c.currentHp < c.maxHp * 0.5 ? 'red-text' : ''}>
                      HP:{c.currentHp}/{c.maxHp}
                    </span>
                  </div>
                ))}
              </div>
              <div className="flex gap-3 justify-center">
                <button onClick={() => { setPaused(false); }} className="retro-border px-6 py-2 hover:bg-green-900">âš”ï¸ æˆ¦ã†</button>
                <button onClick={() => { setBossConfirm(null); setPaused(false); setExploring(false); setFloor(1); setParty(p => p.map(c => ({...c, currentHp: c.maxHp, currentMp: c.maxMp}))); addLog('å¸°é‚„ã—ãŸ','heal'); soundEngine.startBGM('town'); }} className="retro-border px-6 py-2 hover:bg-red-900 text-red-400">ğŸƒ æ’¤é€€</button>
              </div>
            </div>
          </div>
        );
      };

      // v15.0: ä¼šè©±ãƒ¢ãƒ¼ãƒ€ãƒ«
      const DialogueModal = () => {
        if (!dialogueModal) return null;
        const { npc, lines, currentLine } = dialogueModal;
        const npcData = NPCS[npc];
        const isLastLine = currentLine >= lines.length - 1;
        
        const nextLine = () => {
          if (isLastLine) {
            setDialogueModal(null);
          } else {
            setDialogueModal(prev => ({ ...prev, currentLine: prev.currentLine + 1 }));
          }
        };
        
        return (
          <div className="modal-overlay" onClick={nextLine}>
            <div className="retro-border bg-black p-6 max-w-lg" onClick={e => e.stopPropagation()}>
              <div className="flex items-center gap-4 mb-4 pb-3" style={{borderBottom: '1px solid #3a3020'}}>
                <span className="text-4xl">{npcData?.portrait}</span>
                <div>
                  <h3 className="text-lg" style={{color: '#c4a060'}}>{npcData?.name}</h3>
                  <p className="text-xs" style={{color: '#6a5a4a'}}>{npcData?.title}</p>
                </div>
              </div>
              <p className="text-base leading-relaxed mb-6" style={{color: '#b8a880', minHeight: '80px'}}>
                {lines[currentLine]}
              </p>
              <div className="text-right">
                <button onClick={nextLine} className="btn-fantasy px-6 py-2">
                  {isLastLine ? 'é–‰ã˜ã‚‹' : 'æ¬¡ã¸ â–¶'}
                </button>
              </div>
            </div>
          </div>
        );
      };

      // v15.0: ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
      const StoryEventModal = () => {
        if (!storyEventModal) return null;
        const { title, text, item } = storyEventModal;
        
        const closeEvent = () => {
          // ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Œã°ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«è¿½åŠ 
          if (item) {
            setInventory(prev => [...prev, { ...item, uid: Date.now() }]);
            addLog(`ã€ç™ºè¦‹ã€‘${item.name}`, item.rarity === 'legendary' ? 'boss' : 'item');
          }
          setStoryEventModal(null);
          // æ¢ç´¢ä¸­ãªã‚‰ä¸€æ™‚åœæ­¢ã‚’è§£é™¤
          if (exploring && paused && !bossConfirm) {
            setPaused(false);
          }
        };
        
        return (
          <div className="modal-overlay">
            <div className="retro-border bg-black p-6 max-w-lg">
              <h3 className="text-xl gold-text mb-4 text-center">âœ¨ {title} âœ¨</h3>
              <div className="p-4 mb-4" style={{background: 'rgba(60,50,40,0.3)', borderRadius: '4px'}}>
                <p className="text-sm leading-relaxed whitespace-pre-line" style={{color: '#b8a880'}}>
                  {text}
                </p>
              </div>
              {item && (
                <div className="text-center mb-4">
                  <span className={`rarity-${item.rarity} text-lg`}>ğŸ“œ {item.name} ã‚’å…¥æ‰‹ï¼</span>
                </div>
              )}
              <div className="text-center">
                <button onClick={closeEvent} className="btn-fantasy px-8 py-2">
                  ç¢ºèª
                </button>
              </div>
            </div>
          </div>
        );
      };

      // v15.0: ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢
      const EndingScreen = () => {
        if (!endingPhase) return null;
        
        if (endingPhase === 'choice') {
          return (
            <div className="modal-overlay">
              <div className="retro-border bg-black p-8 max-w-lg text-center">
                <h3 className="text-2xl gold-text mb-6">{ENDING.wardnaChoice.title}</h3>
                <p className="text-base leading-relaxed whitespace-pre-line mb-8" style={{color: '#b8a880'}}>
                  {ENDING.wardnaChoice.text}
                </p>
                {ENDING.wardnaChoice.choices.map(c => (
                  <button key={c.id} onClick={() => setEndingPhase('ending')} 
                    className="btn-fantasy px-8 py-3 text-lg mx-2">
                    {c.text}
                  </button>
                ))}
              </div>
            </div>
          );
        }
        
        if (endingPhase === 'ending') {
          return (
            <div className="fixed inset-0 bg-black flex items-center justify-center overflow-y-auto">
              <div className="max-w-2xl p-8 text-center">
                <div className="space-y-4 mb-12">
                  {ENDING.ending.lines.map((line, i) => (
                    <p key={i} className={`text-lg ${line.includes('ã€') ? 'gold-text text-2xl mt-8' : ''}`} 
                      style={{color: line ? '#b8a880' : 'transparent', animation: `fadeIn ${0.5 + i * 0.1}s ease-out`}}>
                      {line || '\u00A0'}
                    </p>
                  ))}
                </div>
                <button onClick={() => setEndingPhase('postcredits')} className="btn-fantasy px-8 py-3 text-lg">
                  ç¶šãã‚’è¦‹ã‚‹
                </button>
              </div>
            </div>
          );
        }
        
        if (endingPhase === 'postcredits') {
          return (
            <div className="fixed inset-0 bg-black flex items-center justify-center">
              <div className="max-w-lg p-8 text-center">
                <p className="text-lg leading-relaxed whitespace-pre-line mb-8" style={{color: '#666'}}>
                  {ENDING.ending.postCredits.text}
                </p>
                <p className="text-xl gold-text mb-12" style={{animation: 'textGlow 2s ease-in-out infinite'}}>
                  {ENDING.ending.postCredits.hint}
                </p>
                <button onClick={() => {
                  setEndingPhase(null);
                  setStoryFlags(prev => ({ ...prev, endingReached: true }));
                  setScreen('title');
                }} className="btn-fantasy px-8 py-3">
                  ã‚¿ã‚¤ãƒˆãƒ«ã¸
                </button>
              </div>
            </div>
          );
        }
        
        return null;
      };

      // ã‚»ãƒ©ãƒ•ã‚£ãƒŠã¨ã®ä¼šè©±ã‚’é–‹å§‹
      const talkToSeraphina = () => {
        let dialogueKey = 'first';
        if (storyFlags.documents.includes('doc3')) dialogueKey = 'hasDoc3';
        else if (storyFlags.documents.includes('doc2')) dialogueKey = 'hasDoc2';
        else if (storyFlags.documents.includes('doc1')) dialogueKey = 'hasDoc1';
        
        const dialogue = SERAPHINA_DIALOGUES[dialogueKey];
        setDialogueModal({ npc: 'seraphina', lines: dialogue.lines, currentLine: 0 });
        
        if (!storyFlags.metSeraphina) {
          setStoryFlags(prev => ({ ...prev, metSeraphina: true }));
        }
      };

      // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼
      const triggerStoryEvent = (dungeonId, trigger) => {
        const event = STORY_EVENTS[dungeonId];
        if (!event || event.trigger !== trigger) return false;
        if (storyFlags.eventsTriggered.includes(event.id)) return false;
        
        setStoryEventModal({ title: event.title, text: event.text, item: event.item });
        setStoryFlags(prev => ({
          ...prev,
          eventsTriggered: [...prev.eventsTriggered, event.id],
          documents: event.item?.type === 'document' ? [...prev.documents, event.item.id] : prev.documents
        }));
        return true;
      };

      const JobModal = ({char, onClose}) => {
        if (!char) return null;
        return (
          <div className="modal-overlay" onClick={onClose}>
            <div className="retro-border bg-black p-4 max-w-md max-h-96 overflow-y-auto" onClick={e => e.stopPropagation()}>
              <h3 className="text-lg gold-text mb-3">ğŸ”„ è»¢è· - {char.name}</h3>
              <div className="space-y-2">{Object.entries(JOBS).map(([k,j]) => {
                if (k === char.jobKey) return null;
                const c = canChangeJob(char, k);
                return (<div key={k} className={`p-2 bg-gray-900 text-sm ${c.can?'cursor-pointer hover:bg-green-900':'opacity-50'}`} onClick={() => c.can && changeJob(char.id, k)}>
                  <div className="flex justify-between"><span className={j.tier===2?'gold-text':''}>{j.name}</span><span className="text-sm">{c.can?'å¯èƒ½':c.reason}</span></div>
                </div>);
              })}</div>
              <button onClick={onClose} className="mt-4 w-full retro-border py-2 hover:bg-red-900 text-red-400">é–‰ã˜ã‚‹</button>
            </div>
          </div>
        );
      };

      // v14.4: å£®å¤§ãªã‚¹ãƒˆãƒ¼ãƒªãƒ¼ï¼ˆã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°å°‚ç”¨ï¼‰
      const STORY = {
        opening: [
          { text: 'å¤ªå¤ã®æ˜”ã€ä¸–ç•Œã¯å…‰ã«æº€ã¡ã¦ã„ãŸã€‚', delay: 0 },
          { text: '', delay: 2000 },
          { text: 'äººã€…ã¯å¤§åœ°ã®æµã¿ã®ã‚‚ã¨ã€', delay: 3000 },
          { text: 'å¹³å’Œã«æš®ã‚‰ã—ã¦ã„ãŸã€‚', delay: 4500 },
          { text: '', delay: 6000 },
          { text: 'ã—ã‹ã—åƒå¹´å‰â€”â€”', delay: 7000 },
          { text: '', delay: 8500 },
          { text: 'ç‹‚æ°—ã®é­”è¡“å¸«ã€Œãƒ¯ãƒ¼ãƒ‰ãƒŠã€ã¯', delay: 9500 },
          { text: 'ç¦å¿Œã®é­”å°æ›¸ã€Œã‚¹ã‚­ãƒ¼ãƒã€ã‚’ç™ºå‹•ã—ãŸã€‚', delay: 11000 },
          { text: '', delay: 13000 },
          { text: 'ãã‚Œã¯ä¸–ç•Œã®æ·±æ·µã¸ã¨ç¶šãé–€ã‚’é–‹ãè¡“ã€‚', delay: 14000 },
          { text: '', delay: 16000 },
          { text: 'åœ°ã®åº•ã‹ã‚‰æ¹§ãå‡ºã—ãŸé­”ç‰©ãŸã¡ã¯', delay: 17000 },
          { text: 'ç‹å›½ã‚’è’¡ã„ã€æ–‡æ˜ã‚’ç°ç‡¼ã«å¸°ã—ãŸã€‚', delay: 18500 },
          { text: '', delay: 20500 },
          { text: 'äººã€…ã¯æ•£ã‚Šæ•£ã‚Šã«ãªã‚Šã€', delay: 21500 },
          { text: 'å…‰ã¯é—‡ã«é£²ã¾ã‚ŒãŸã€‚', delay: 23000 },
          { text: '', delay: 25000 },
          { text: 'ãã‚Œã‹ã‚‰é•·ã„æ™‚ãŒæµã‚ŒãŸã€‚', delay: 26000 },
          { text: '', delay: 28000 },
          { text: 'ä»Šã€å»ƒå¢Ÿã®è¡—ãƒªãƒ«ã‚¬ãƒŸãƒ³ã«', delay: 29000 },
          { text: 'å‹‡æ°—ã‚ã‚‹è€…ãŸã¡ãŒé›†ã¾ã‚Šå§‹ã‚ãŸã€‚', delay: 30500 },
          { text: '', delay: 32500 },
          { text: 'å½¼ã‚‰ã®ç›®çš„ã¯ãŸã ã²ã¨ã¤ã€‚', delay: 33500 },
          { text: '', delay: 35500 },
          { text: 'æ·±æ·µã®æœ€å¥¥ã«çœ ã‚‹ãƒ¯ãƒ¼ãƒ‰ãƒŠã‚’è¨ã¡ã€', delay: 36500 },
          { text: 'ã€Œã‚¹ã‚­ãƒ¼ãƒã€ã‚’æ°¸é ã«å°å°ã™ã‚‹ã“ã¨ã€‚', delay: 38000 },
          { text: '', delay: 40000 },
          { text: 'ã•ã‚ã€å†’é™ºè€…ã‚ˆâ€”â€”', delay: 41000 },
          { text: '', delay: 43000 },
          { text: 'ãŠå‰ã®ç‰©èªãŒã€ä»Šå§‹ã¾ã‚‹ã€‚', delay: 44000 },
        ],
        prologue: `æ·±æ·µã®æœ€å¥¥ã«çœ ã‚‹ãƒ¯ãƒ¼ãƒ‰ãƒŠã‚’è¨ã¡ã€
ã€Œã‚¹ã‚­ãƒ¼ãƒã€ã‚’å°å°ã›ã‚ˆã€‚`,
        cleared: `ã¤ã„ã«ãƒ¯ãƒ¼ãƒ‰ãƒŠã¯å€’ã‚ŒãŸã€‚

ã€Œã‚¹ã‚­ãƒ¼ãƒã€ã®åŠ›ã¯æ¶ˆãˆå»ã‚Šã€
æ·±æ·µã¸ã®é–€ã¯æ°¸é ã«é–‰ã–ã•ã‚ŒãŸã€‚

äººã€…ã¯å†ã³åœ°ä¸Šã«å¸Œæœ›ã‚’è¦‹å‡ºã—ã€
ãƒªãƒ«ã‚¬ãƒŸãƒ³ã®è¡—ã«ã¯æ´»æ°—ãŒæˆ»ã‚Šã¤ã¤ã‚ã‚‹ã€‚

ã—ã‹ã—ä¼èª¬ã¯èªã‚‹â€”â€”
ã€Œé—‡ã¯æ­»ãªãšã€ã„ã¤ã‹å¿…ãšè“‹ã‚‹ã€ã¨ã€‚

ãã®æ—¥ãŒæ¥ã‚‹ã¾ã§ã€
è‹±é›„ãŸã¡ã®ä¼èª¬ã¯èªã‚Šç¶™ãŒã‚Œã¦ã„ãã ã‚ã†ã€‚`
      };

      // v14.4: ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°ç”»é¢
      if (screen === 'opening') {
        const [visibleLines, setVisibleLines] = useState([]);
        const [openingDone, setOpeningDone] = useState(false);
        
        useEffect(() => {
          STORY.opening.forEach((line, idx) => {
            setTimeout(() => {
              setVisibleLines(prev => [...prev, line.text]);
              if (idx === STORY.opening.length - 1) {
                setTimeout(() => setOpeningDone(true), 3000);
              }
            }, line.delay);
          });
        }, []);
        
        const skipOpening = () => {
          setScreen('main');
          soundEngine.startBGM('town');
        };
        
        return (
          <div className="opening-container flex items-center justify-center">
            <div className="max-w-2xl text-center px-8">
              <h1 className="opening-title text-4xl mb-12" style={{color: '#c4a060', fontWeight: 700, letterSpacing: '0.15em'}}>WIZARDRY SCHEMA</h1>
              <div className="space-y-3">
                {visibleLines.map((line, i) => (
                  <p key={i} className="text-lg" style={{color: line ? '#b8a880' : 'transparent', animation: line ? 'fadeIn 1s ease-out' : 'none', minHeight: '1.5em'}}>
                    {line || '\u00A0'}
                  </p>
                ))}
              </div>
              {openingDone && (
                <button onClick={skipOpening} className="mt-12 btn-fantasy px-8 py-3 text-lg" style={{animation: 'fadeIn 1s ease-out'}}>
                  å†’é™ºã‚’å§‹ã‚ã‚‹
                </button>
              )}
            </div>
            <button onClick={skipOpening} className="skip-btn btn-fantasy px-4 py-2 text-sm">
              SKIP â–¶
            </button>
          </div>
        );
      }

      if (screen === 'title') {
        const isCleared = clearedDungeons['trebor'];
        const hasSave = party.length > 0;
        return (
          <div className="min-h-screen flex flex-col items-center justify-center p-4">
            <div className="retro-border p-8 text-center max-w-lg">
              <h1 className="text-3xl mb-3" style={{color: '#c4a060', fontWeight: 700, letterSpacing: '0.1em', textShadow: '0 2px 8px rgba(0,0,0,0.5)'}}>WIZARDRY SCHEMA</h1>
              <p className="text-sm mb-6" style={{color: '#6a5a4a'}}>ã€œ æ·±æ·µã®é­”å°æ›¸ ã€œ</p>
              <div className="text-left mb-6 p-4" style={{background: 'rgba(0,0,0,0.3)', borderRadius: '4px'}}>
                <p className="text-sm leading-relaxed whitespace-pre-line" style={{color: '#9a8a70'}}>
                  {isCleared ? STORY.cleared : STORY.prologue}
                </p>
              </div>
              <div className="space-y-3">
                {hasSave ? (
                  <>
                    <button onClick={() => {setScreen('main'); initSound();}} className="block w-full btn-fantasy px-6 py-3 text-lg">CONTINUE</button>
                    <button onClick={() => {if(!confirm('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦æœ€åˆã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ')) return; localStorage.removeItem('wizardrySchemaV15'); setParty([]); setGold(100); setMaxFloors({}); setClearedDungeons({}); setBestiary({}); setInventory([]); setScreen('opening'); initSound();}} className="block w-full btn-fantasy px-6 py-2 text-sm" style={{color: '#888'}}>NEW GAME</button>
                    <button onClick={exportSave} className="block w-full btn-fantasy px-6 py-2 text-sm" style={{color: '#6ab0ff'}}>EXPORT</button>
                  </>
                ) : (
                  <button onClick={() => {setScreen('opening'); initSound();}} className="block w-full btn-fantasy px-6 py-3 text-lg">NEW GAME</button>
                )}
              </div>
              <p className="text-xs mt-4" style={{color: '#4a4035'}}>v15.0</p>
            </div>
          </div>
        );
      }

      if (exploring) {
        return (
          <div className="min-h-screen p-2">
            <BossConfirmModal />
            <DialogueModal />
            <StoryEventModal />
            <EndingScreen />
            <div className="max-w-6xl mx-auto">
              <div className="retro-border p-3 mb-2 flex justify-between items-center">
                <div className="flex items-center gap-4">
                  <span className="gold-text text-xl">ğŸ° {DUNGEONS.find(d=>d.id===dungeon)?.name}</span>
                  <span className="text-3xl blink">B{floor}F</span>
                  {paused && <span className="text-yellow-400">ã€ä¸€æ™‚åœæ­¢ä¸­ã€‘</span>}
                </div>
                <div className="flex gap-4 items-center text-base">
                  <span className="gold-text">ğŸ’°{gold.toLocaleString()}G</span>
                  <span className="purple-text">ğŸ“¦{inventory.length}</span>
                  <button onClick={() => {setExploring(false); setFloor(1); setPaused(false); setBossConfirm(null); setParty(p => p.map(c => ({...c, currentHp: c.maxHp, currentMp: c.maxMp}))); addLog('å¸°é‚„ã—ãŸ','heal'); soundEngine.startBGM('town');}} className="retro-border px-4 py-2 hover:bg-red-900 text-red-400">å¸°é‚„</button>
                </div>
              </div>
              <div className="text-sm text-gray-500 mb-2 px-1">{getFloorDesc(dungeon, floor)}</div>
              <div className="grid lg:grid-cols-4 gap-2">
                <div className="lg:col-span-3 retro-border p-3">
                  <h2 className="text-base mb-2 border-b border-green-800 pb-1">ã€ å†’é™ºè¨˜éŒ² ã€‘</h2>
                  <div ref={logRef} className="h-96 overflow-y-auto bg-black p-2 text-sm log-scroll">
                    {logs.map((l,i) => <p key={i} className={`${l.c} mb-1`}>{l.msg || ' '}</p>)}
                  </div>
                </div>
                <div className="retro-border p-2">
                  <h2 className="text-base mb-2 border-b border-green-800 pb-1">ã€ ãƒ‘ãƒ¼ãƒ†ã‚£ ã€‘</h2>
                  <div className="space-y-2">
                    {party.map(char => (
                      <div key={char.id} className={`text-sm p-2 bg-gray-900 ${char.currentHp === 0 ? 'opacity-50' : ''}`}>
                        <div className="flex justify-between mb-1">
                          <span className="font-bold">{char.name}</span>
                          <span className="text-gray-500 text-xs">Lv.{char.level} {char.job}</span>
                        </div>
                        <div className="flex gap-2 text-xs">
                          <span className="red-text">HP:{char.currentHp}/{char.maxHp}</span>
                          <span className="blue-text">MP:{char.currentMp}/{char.maxMp}</span>
                        </div>
                        <div className="w-full bg-gray-700 h-2 mt-1 rounded">
                          <div className="bg-red-500 h-2 rounded" style={{width:`${(char.currentHp/char.maxHp)*100}%`}}/>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // v14.0: æ–½è¨­ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢
      if (!currentFacility) {
        return (
          <div className="min-h-screen p-4">
            {showJobChange && <JobModal char={showJobChange} onClose={() => setShowJobChange(null)} />}
            <DialogueModal />
            <StoryEventModal />
            <div className="max-w-4xl mx-auto">
              {/* v14.2: Nildaé¢¨ãƒ˜ãƒƒãƒ€ãƒ¼ */}
              <div className="text-center mb-6 pt-4">
                <h1 className="text-2xl mb-2" style={{color: '#c4a060', fontWeight: 700, letterSpacing: '0.15em', textShadow: '0 2px 4px rgba(0,0,0,0.5)'}}>WIZARDRY SCHEMA</h1>
                <p className="text-sm" style={{color: '#6a5a4a'}}>ã€œ ãƒªãƒ«ã‚¬ãƒŸãƒ³ã®è¡— ã€œ</p>
                <div className="flex justify-center gap-6 mt-4 text-sm" style={{color: '#6a5a4a'}}>
                  <span className="gold-text">{gold.toLocaleString()} G</span>
                  <span>æ‰€æŒå“ {inventory.length}</span>
                  <span>ä¸€è¡Œ {party.length}/6</span>
                </div>
              </div>
              {/* NPCã‚¬ã‚¤ãƒ‰ - ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€£å‹• */}
              <div className="retro-border p-4 mb-5">
                <p className="text-sm font-bold mb-2" style={{color: '#c4a060'}}>ã‚®ãƒ«ãƒ‰ã®å—ä»˜</p>
                <p className="text-sm" style={{color: '#a09080', lineHeight: '1.6'}}>
                  {clearedDungeons['trebor'] ? 'ã€Œä¼èª¬ã®è‹±é›„ãŸã¡ã‚ˆã€‚ãƒ¯ãƒ¼ãƒ‰ãƒŠã‚’å€’ã—ã¦ãã‚ŒãŸã®ã˜ã‚ƒãªã€‚ã“ã®ä¸–ç•Œã¯ããªãŸã«æ„Ÿè¬ã—ã¦ãŠã‚‹ã€‚ã€' :
                   party.length === 0 ? 'ã€Œã‚ˆã†ã“ãã€å†’é™ºè€…ã‚ˆã€‚æ·±æ·µã®é­”å°æ›¸ã€Œã‚¹ã‚­ãƒ¼ãƒã€ã‚’å°å°ã™ã‚‹ãŸã‚ã«ã€ã¾ãšã¯ä»²é–“ãŒå¿…è¦ã˜ã‚ƒã€‚ã€' :
                   party.length < 3 ? `ã€Œ${party[0]?.name}ãŸã¡ã‚ˆã€‚æ·±æ·µã¯å±é™ºã˜ã‚ƒã€‚ã‚‚ã†å°‘ã—ä»²é–“ã‚’é›†ã‚ã‚‹ã®ã˜ã‚ƒã€‚ã€` :
                   clearedDungeons['dragon'] ? 'ã€Œã„ã‚ˆã„ã‚ˆæœ€å¾Œã®è©¦ç·´å ´ã˜ã‚ƒã€‚ãƒ¯ãƒ¼ãƒ‰ãƒŠãŒå¾…ã£ã¦ãŠã‚‹ã€‚ã€Œã‚¹ã‚­ãƒ¼ãƒã€ã‚’å°å°ã›ã‚ˆï¼ã€' :
                   clearedDungeons['kaoka'] ? 'ã€Œå¤ä»£é¾ã®ç¥æ®¿ãŒè¦‹ã¤ã‹ã£ãŸãã†ã˜ã‚ƒãªã€‚ä¼èª¬ã®ç«œãŒå°å°ã®éµã‚’å®ˆã£ã¦ãŠã‚‹ã€‚ã€' :
                   clearedDungeons['sewer'] ? 'ã€Œé¥ã‹ãªã‚‹éºè·¡ãŒæµ®ä¸Šã—ãŸãã†ã˜ã‚ƒã€‚ã€Œã‚¹ã‚­ãƒ¼ãƒã€ã®æ‰‹ãŒã‹ã‚ŠãŒã‚ã‚‹ã‚„ã‚‚ã—ã‚Œã‚“ã€‚ã€' :
                   clearedDungeons['thieves'] ? 'ã€Œä¸‹æ°´é“ã«å¤ã„æ‚ªãŒæ½œã‚“ã§ãŠã‚‹ãã†ã˜ã‚ƒã€‚æ°—ã‚’ã¤ã‘ã‚‹ã®ã˜ã‚ƒãã€‚ã€' :
                   clearedDungeons['kobold'] ? 'ã€Œç›—è³Šã©ã‚‚ãŒå¤ã„éºç‰©ã‚’éš ã—æŒã£ã¦ãŠã‚‹ã¨ã„ã†å™‚ã‚‚ã‚ã‚‹ã®ã†ã€‚ã€' :
                   clearedDungeons['slime'] ? 'ã€Œæ¬¡ã¯ã‚³ãƒœãƒ«ãƒ‰ã®å·£ã˜ã‚ƒãªã€‚å¥‡å¦™ãªé­”åŠ›ã®æ³¢å‹•ãŒæ„Ÿã˜ã‚‰ã‚Œã‚‹ã€‚ã€' :
                   'ã€Œã¾ãšã¯ã‚¹ãƒ©ã‚¤ãƒ ã®ç©´ã§è…•è©¦ã—ã˜ã‚ƒã€‚æ·±æ·µã¸ã®é“ã¯é•·ã„ãã€‚ã€'}
                </p>
              </div>
              {/* v14.2: æ–½è¨­ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆNildaé¢¨2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ */}
              <div className="grid grid-cols-2 gap-4 mb-5">
                {FACILITIES.filter(f => f.id !== 'gate').map(f => (
                  <div key={f.id} onClick={() => setCurrentFacility(f.id)} 
                    className="facility-card p-5" style={{background: `linear-gradient(180deg, ${f.color} 0%, #1a1512 100%)`}}>
                    <h3 className="text-base font-bold mb-2" style={{color: '#e0d0b0'}}>{f.name}</h3>
                    <p className="text-xs" style={{color: '#6a5a4a'}}>{f.desc}</p>
                  </div>
                ))}
              </div>
              {/* å‡ºç™ºã‚²ãƒ¼ãƒˆï¼ˆå¤§ããç›®ç«‹ãŸã›ã‚‹ï¼‰ */}
              <div onClick={() => setCurrentFacility('gate')} className="gate-card facility-card p-6 cursor-pointer mb-5">
                <h3 className="text-xl font-bold gold-text mb-2">å‡ºç™ºã‚²ãƒ¼ãƒˆ</h3>
                <p className="text-sm" style={{color: '#a08050'}}>ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã¸å‡ºç™º</p>
              </div>
              {/* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚µãƒãƒªãƒ¼ */}
              {party.length > 0 && (
                <div className="retro-border p-4 mb-5">
                  <h3 className="section-title text-sm mb-3 pb-2" style={{borderColor: '#3a3020'}}>ãƒ‘ãƒ¼ãƒ†ã‚£</h3>
                  <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                    {party.map(c => (
                      <div key={c.id} className="char-card p-3 text-center">
                        <div className="font-bold truncate text-sm" style={{color: '#e0d0b0'}}>{c.name}</div>
                        <div className="text-xs mt-1" style={{color: '#6a5a4a'}}>Lv.{c.level} {c.job}</div>
                        <div className="mt-2 h-1 rounded" style={{background: '#1a1510', border: '1px solid #3a2a1a'}}>
                          <div className="h-full rounded" style={{width: `${(c.currentHp/c.maxHp)*100}%`, background: 'linear-gradient(90deg, #8b3535, #a04545)'}} />
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
              <div className="flex justify-between items-center text-sm" style={{color: '#5a4a3a'}}>
                <button onClick={() => setShowSettings(!showSettings)} className="hover:opacity-80" style={{color: '#8a7a5a'}}>âš™ï¸ è¨­å®š</button>
                <button onClick={() => setScreen('title')} className="hover:opacity-80" style={{color: '#8a7a5a'}}>ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
              </div>
              {showSettings && (
                <div className="retro-border p-4 mt-4 text-sm">
                  <div className="grid md:grid-cols-2 gap-4">
                    <div><label className="flex items-center gap-2 mb-2" style={{color: '#a09080'}}><input type="checkbox" checked={settings.bgm} onChange={e => setSettings(p => ({...p, bgm: e.target.checked}))} /> BGM</label>
                    <input type="range" min="0" max="100" value={settings.bgmVol} onChange={e => setSettings(p => ({...p, bgmVol: +e.target.value}))} className="w-full" style={{accentColor: '#8a7050'}} /></div>
                    <div><label className="flex items-center gap-2 mb-2" style={{color: '#a09080'}}><input type="checkbox" checked={settings.sfx} onChange={e => {setSettings(p => ({...p, sfx: e.target.checked})); soundEngine.sfxEnabled = e.target.checked;}} /> åŠ¹æœéŸ³</label>
                    <input type="range" min="0" max="100" value={settings.sfxVol} onChange={e => setSettings(p => ({...p, sfxVol: +e.target.value}))} className="w-full" style={{accentColor: '#8a7050'}} /></div>
                  </div>
                  <div className="mt-3 pt-3" style={{borderTop: '1px solid #3a3020'}}>
                    <label className="flex items-center gap-2" style={{color: '#a09080'}}><input type="checkbox" checked={autoPotion} onChange={e => setAutoPotion(e.target.checked)} /> ğŸ’Š è‡ªå‹•ãƒãƒ¼ã‚·ãƒ§ãƒ³ä½¿ç”¨</label>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      // v14.0: æ–½è¨­è©³ç´°ç”»é¢
      const facilityInfo = FACILITIES.find(f => f.id === currentFacility);
      return (
        <div className="min-h-screen p-2">
          {showJobChange && <JobModal char={showJobChange} onClose={() => setShowJobChange(null)} />}
          <div className="max-w-5xl mx-auto">
            {/* æ–½è¨­ãƒ˜ãƒƒãƒ€ãƒ¼ */}
            <div className="retro-border p-3 mb-3 flex justify-between items-center flex-wrap gap-2">
              <div className="flex items-center gap-3">
                <button onClick={() => setCurrentFacility(null)} className="text-lg hover:opacity-70 transition-opacity" style={{color: '#8a7a5a'}}>â—€ æˆ»ã‚‹</button>
                <h1 className="text-xl gold-text">{facilityInfo?.name}</h1>
              </div>
              <div className="flex gap-4 text-sm items-center" style={{color: '#8a7a5a'}}>
                <span className="gold-text">{gold.toLocaleString()} G</span>
                <span>æ‰€æŒå“ {inventory.length}</span>
              </div>
            </div>
            <div className="retro-border p-4">
              {currentFacility === 'gate' && (<>
                <h2 className="text-xl mb-3 border-b border-green-800 pb-2">ã€ è¿·å®®å…¥å£ ã€‘</h2>
                <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-2 mb-4">
                  {DUNGEONS.map((d, idx) => {
                    const avgLv = party.length > 0 ? Math.floor(party.reduce((a,c) => a+c.level, 0)/party.length) : 0;
                    const isCleared = clearedDungeons[d.id];
                    // v13.2: å‰ã®ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³è¸ç ´ã§æ¬¡ã‚’è§£æ”¾
                    const prevDungeon = idx > 0 ? DUNGEONS[idx - 1] : null;
                    const prevCleared = prevDungeon ? clearedDungeons[prevDungeon.id] : true;
                    const isUnlocked = idx === 0 || prevCleared;
                    const meetsLevel = avgLv >= d.minLv;
                    const canEnter = isUnlocked && meetsLevel && party.length > 0;
                    // å…¥ã‚Œãªã„ç†ç”±ã‚’åˆ¤å®š
                    let lockReason = '';
                    if (party.length === 0) lockReason = 'ãƒ‘ãƒ¼ãƒ†ã‚£ãªã—';
                    else if (!isUnlocked) lockReason = `ğŸ”’ ${prevDungeon?.name}è¸ç ´ã§è§£æ”¾`;
                    else if (!meetsLevel) lockReason = `Lvä¸è¶³ (å¹³å‡Lv.${avgLv})`;
                    return (<button key={d.id} onClick={() => {if (!canEnter) return; setExploring(true); setFloor(1); setLogs([]); addLog(`â”â”â” ${d.name}ã¸ â”â”â”`,'level'); addLog(getFloorDesc(d.id, 1),'explore'); setDungeon(d.id); soundEngine.startBGM(d.id);}} disabled={!canEnter}
                      className={`text-left p-3 text-sm bg-gray-900 ${canEnter?'hover:bg-green-800 cursor-pointer':'opacity-50'} ${isCleared?'border-l-4 border-yellow-500':''}`}>
                      <div className="font-bold flex items-center gap-1">{isCleared && 'ğŸ†'}{d.name}</div>
                      <div className="text-gray-500">B{d.floors}F / Lv.{d.minLv}+</div>
                      {maxFloors[d.id] && <div className="text-green-600">æœ€æ·±B{maxFloors[d.id]}F</div>}
                      {!canEnter && lockReason && <div className="text-red-400 text-xs mt-1">{lockReason}</div>}
                    </button>);
                  })}
                </div>
                <div className="p-2 bg-gray-900 text-sm inline-block"><span>é›¢è„±HP: {retreatHP}%</span><input type="range" min="10" max="50" value={retreatHP} onChange={e => setRetreatHP(+e.target.value)} className="ml-2 w-32" /></div>
              </>)}
              {currentFacility === 'guild' && (<>
                <h2 className="text-xl mb-3 border-b border-green-800 pb-2">ã€ å†’é™ºè€…ç™»éŒ² ã€‘</h2>
                {/* v15.0: ã‚»ãƒ©ãƒ•ã‚£ãƒŠNPC */}
                <div className="p-4 mb-4" style={{background: 'rgba(80,60,40,0.3)', borderRadius: '8px', border: '1px solid #5a4a3a'}}>
                  <div className="flex items-center gap-4">
                    <span className="text-4xl">ğŸ‘©â€ğŸ”¬</span>
                    <div className="flex-1">
                      <h3 className="text-base" style={{color: '#c4a060'}}>ã‚»ãƒ©ãƒ•ã‚£ãƒŠ <span className="text-xs" style={{color: '#6a5a4a'}}>å¤ä»£å²ç ”ç©¶è€…</span></h3>
                      <p className="text-xs mt-1" style={{color: '#8a7a6a'}}>
                        {storyFlags.documents.includes('doc3') ? 'ã€ŒçœŸå®Ÿã‚’çŸ¥ã£ãŸä»Šã€ä½•ã‚’æ€ã„ã¾ã™ã‹ï¼Ÿã€' :
                         storyFlags.documents.length > 0 ? 'ã€Œä½•ã‹æ–°ã—ã„ç™ºè¦‹ã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿã€' :
                         storyFlags.metSeraphina ? 'ã€Œãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã§è¦‹ã¤ã‘ãŸç‰©ãŒã‚ã‚Œã°ã€è¦‹ã›ã¦ãã ã•ã„ã€‚ã€' :
                         'ã€Œã‚ãªãŸã«è©±ã—ãŸã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã€'}
                      </p>
                    </div>
                    <button onClick={talkToSeraphina} className="btn-fantasy px-4 py-2 text-sm">è©±ã™</button>
                  </div>
                </div>
                <p className="text-gray-400 mb-4">æ–°ãŸãªå†’é™ºè€…ã‚’ã‚®ãƒ«ãƒ‰ã«ç™»éŒ²ã—ã¾ã™ã€‚</p>
                <div className="p-4 bg-gray-900 rounded mb-4">
                  <div className="text-center mb-4">
                    <span className="text-6xl">ğŸ‘¤</span>
                    <p className="text-lg mt-2">ç™»éŒ²æ¸ˆã¿: <span className="gold-text">{party.length}</span> / 6</p>
                  </div>
                  <button onClick={createChar} disabled={party.length>=6} 
                    className="w-full retro-border px-6 py-3 text-lg hover:bg-green-900 disabled:opacity-50">
                    ï¼‹ æ–°è¦å†’é™ºè€…ã‚’ç™»éŒ²
                  </button>
                  {party.length >= 6 && <p className="text-center text-yellow-400 mt-2">ç™»éŒ²ä¸Šé™ã«é”ã—ã¦ã„ã¾ã™</p>}
                </div>
                {party.length > 0 && (
                  <div className="text-sm text-gray-500">
                    <p className="mb-2">æœ€è¿‘ç™»éŒ²ã—ãŸå†’é™ºè€…:</p>
                    <div className="p-2 bg-gray-900 rounded">
                      <span className="font-bold">{party[party.length-1].name}</span>
                      <span className="text-gray-400 ml-2">{party[party.length-1].race} {party[party.length-1].job}</span>
                    </div>
                  </div>
                )}
              </>)}
              {currentFacility === 'tavern' && (<>
                <h2 className="text-xl mb-3 border-b border-green-800 pb-2">ã€ ãƒ‘ãƒ¼ãƒ†ã‚£ç®¡ç† ã€‘({party.length}/6)</h2>
                {party.length === 0 ? (
                  <div className="text-center py-8">
                    <p className="text-gray-500 mb-4">ãƒ‘ãƒ¼ãƒ†ã‚£ã«èª°ã‚‚ã„ã¾ã›ã‚“</p>
                    <button onClick={() => setCurrentFacility('guild')} className="retro-border px-4 py-2 hover:bg-amber-900">âš”ï¸ ã‚®ãƒ«ãƒ‰ã§å†’é™ºè€…ã‚’ç™»éŒ²</button>
                  </div>
                ) : (<>
                  <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3 mb-3">
                    {party.map(char => {
                      const trait = getRaceTrait(char.raceKey);
                      return (
                      <div key={char.id} className="p-3 bg-gray-900 text-sm">
                        <div className="flex justify-between"><span className="font-bold text-base">{char.name}</span><span className={ALIGNMENTS[char.alignKey]?.color}>{char.alignment}</span></div>
                        <div className="text-gray-400">Lv.{char.level} {char.race} {char.job}</div>
                        {trait.desc && <div className="text-xs text-cyan-400 mt-1">âœ¨ {trait.desc}</div>}
                        <div className="mt-2 grid grid-cols-2 gap-1"><span className="red-text">HP:{char.currentHp}/{char.maxHp}</span><span className="blue-text">MP:{char.currentMp}/{char.maxMp}</span><span>ATK:{char.atk}</span><span>DEF:{char.def}</span></div>
                        <div className="w-full bg-gray-700 h-1 mt-1"><div className="bg-red-500 h-1" style={{width:`${(char.currentHp/char.maxHp)*100}%`}}/></div>
                        <div className="mt-1 text-gray-500 text-xs">EXP: {char.exp}/{char.level * 100}</div>
                        <div className="mt-1 text-gray-600 text-xs">âš”ï¸{char.equipment?.weapon?.name||'-'} ğŸ›¡ï¸{char.equipment?.armor?.name||'-'} ğŸ’{char.equipment?.accessory?.name||'-'}</div>
                        <div className="mt-2 flex gap-2">
                          {char.level >= 10 && <button onClick={() => setShowJobChange(char)} className="text-xs text-cyan-400 hover:underline">ğŸ”„è»¢è·</button>}
                          <button onClick={() => setParty(p => p.filter(c => c.id !== char.id))} className="text-xs text-red-400 hover:underline">âŒè§£é›‡</button>
                        </div>
                      </div>
                    )})}
                  </div>
                </>)}
              </>)}
              {currentFacility === 'shop' && (<>
                <h2 className="text-xl mb-3 border-b border-green-800 pb-2">ã€ ãƒœãƒ«ã‚¿ãƒƒã‚¯å•†åº— ã€‘</h2>
                <div className="flex gap-1 mb-3">{['weapons','armors','accessories','consumables'].map(cat => (<button key={cat} onClick={() => setShopCat(cat)} className={`px-3 py-2 text-sm ${shopCat===cat?'bg-green-900 retro-border':'bg-gray-900'}`}>{{weapons:'âš”ï¸æ­¦å™¨',armors:'ğŸ›¡ï¸é˜²å…·',accessories:'ğŸ’è£…é£¾',consumables:'ğŸ§ªæ¶ˆè€—'}[cat]}</button>))}</div>
                <div className="space-y-1 max-h-72 overflow-y-auto">{ITEMS[shopCat].map((item,i) => { const canBuy = gold >= item.price; return (<div key={i} className={`p-2 text-sm flex justify-between ${canBuy?'bg-gray-900':'bg-gray-900 opacity-50'}`}><div><span className={`rarity-${item.rarity}`}>{item.name}</span><span className="text-gray-500 ml-2">{item.atk?`ATK+${item.atk}`:''}{item.def?`DEF+${item.def}`:''}{item.heal?`å›å¾©${item.heal}`:''}</span></div><button onClick={() => {if (!canBuy) return; setGold(p => p-item.price); setInventory(p => [...p, {...item, uid: Date.now()}]); soundEngine.playGold();}} disabled={!canBuy} className="gold-text hover:underline disabled:opacity-50">{item.price}G</button></div>);})}</div>
              </>)}
              {currentFacility === 'storage' && (<>
                <h2 className="text-xl mb-3 border-b border-green-800 pb-2">ã€ æ‰€æŒå“ ã€‘({inventory.length})</h2>
                <div className="mb-3"><span className="text-sm text-gray-400">è£…å‚™å…ˆ: </span>{party.map(char => (<button key={char.id} onClick={() => setSelChar(char.id)} className={`px-2 py-1 text-sm mx-1 ${selChar===char.id?'bg-green-900 retro-border':'bg-gray-900'}`}>{char.name}</button>))}</div>
                <div className="space-y-1 max-h-72 overflow-y-auto">{inventory.map(item => (<div key={item.uid} className="p-2 text-sm bg-gray-900 flex justify-between"><div><span className={`rarity-${item.rarity}`}>{item.name}</span><span className="text-gray-500 ml-2">{item.atk?`ATK+${item.atk}`:''}{item.def?`DEF+${item.def}`:''}{item.heal?`å›å¾©${item.heal}`:''}</span></div><div className="flex gap-2">{selChar && !item.heal && <button onClick={() => equipItem(selChar, item)} className="text-blue-400 hover:underline">è£…å‚™</button>}<button onClick={() => {setGold(p => p + Math.floor((item.price||10)/2)); setInventory(p => p.filter(i => i.uid !== item.uid));}} className="text-yellow-400 hover:underline">å£²å´</button></div></div>))}{inventory.length === 0 && <p className="text-gray-600 text-center py-4">ã‚¢ã‚¤ãƒ†ãƒ ãªã—</p>}</div>
              </>)}
              {currentFacility === 'bestiary' && (<>
                <h2 className="text-xl mb-3 border-b border-green-800 pb-2">ã€ ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å›³é‘‘ ã€‘</h2>
                <div className="grid md:grid-cols-3 lg:grid-cols-4 gap-2">{Object.entries(bestiary).map(([name, d]) => (<div key={name} className="p-2 bg-gray-900 text-sm"><div className="flex justify-between"><span className="font-bold">{d.boss?'ğŸ‘‘':''}{name}</span><span className="text-gray-500">Ã—{d.cnt}</span></div><div className="text-gray-400">HP:{d.hp} ATK:{d.atk}</div></div>))}</div>
              </>)}
              {currentFacility === 'temple' && (<>
                <h2 className="text-xl mb-3 border-b border-green-800 pb-2">ã€ ã‚«ãƒ³ãƒˆå¯ºé™¢ ã€‘</h2>
                <p className="text-gray-400 mb-4">ç¥ã®åŠ è­·ãŒã‚ãªãŸã‚’ç™’ã™ã§ã—ã‚‡ã†ã€‚</p>
                <div className="space-y-3">
                  <div className="p-4 bg-gray-900 rounded">
                    <h3 className="text-lg mb-2 blue-text">âœ¨ å…¨å“¡å›å¾©</h3>
                    <p className="text-sm text-gray-400 mb-3">ãƒ‘ãƒ¼ãƒ†ã‚£å…¨å“¡ã®HP/MPã‚’å®Œå…¨å›å¾©ã—ã¾ã™ã€‚</p>
                    <button onClick={() => { setParty(p => p.map(c => ({...c, currentHp: c.maxHp, currentMp: c.maxMp}))); soundEngine.playHeal(); }} 
                      className="retro-border px-4 py-2 hover:bg-blue-900"
                      disabled={party.length === 0 || party.every(c => c.currentHp === c.maxHp && c.currentMp === c.maxMp)}>
                      ğŸ’– å›å¾©ã™ã‚‹ï¼ˆç„¡æ–™ï¼‰
                    </button>
                  </div>
                  <div className="mt-4">
                    <h3 className="text-sm mb-2">ãƒ‘ãƒ¼ãƒ†ã‚£çŠ¶æ…‹:</h3>
                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-2">
                      {party.map(c => (
                        <div key={c.id} className="p-2 bg-gray-900 text-sm">
                          <div className="font-bold">{c.name}</div>
                          <div className="flex gap-2 mt-1">
                            <span className={c.currentHp < c.maxHp ? 'red-text' : ''}>HP:{c.currentHp}/{c.maxHp}</span>
                            <span className={c.currentMp < c.maxMp ? 'blue-text' : ''}>MP:{c.currentMp}/{c.maxMp}</span>
                          </div>
                          <div className="w-full bg-gray-700 h-1 mt-1"><div className="bg-green-500 h-1" style={{width:`${(c.currentHp/c.maxHp)*100}%`}}/></div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </>)}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
