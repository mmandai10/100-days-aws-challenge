<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wizardry Schema v12.1 - æ”¾ç½®å‹æ¢ç´¢RPG</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DotGothic16&display=swap');
    body { font-family: 'DotGothic16', sans-serif; background-color: #0a0a0a; color: #33ff33; }
    .retro-border { border: 2px solid #33ff33; box-shadow: 0 0 10px rgba(51, 255, 51, 0.3); }
    .log-scroll::-webkit-scrollbar { width: 8px; }
    .log-scroll::-webkit-scrollbar-track { background: #1a1a1a; }
    .log-scroll::-webkit-scrollbar-thumb { background-color: #33ff33; }
    .blink { animation: blink 1s infinite; }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
    .gold-text { color: #ffd700; }
    .red-text { color: #ff4444; }
    .blue-text { color: #44aaff; }
    .purple-text { color: #aa44ff; }
    .tab-btn { transition: all 0.2s; }
    .tab-btn:hover { background-color: #1a4a1a; }
    .tab-btn.active { background-color: #2a5a2a; border-color: #66ff66; }
    .rarity-common { color: #aaaaaa; }
    .rarity-uncommon { color: #44ff44; }
    .rarity-rare { color: #4488ff; }
    .rarity-epic { color: #aa44ff; }
    .rarity-legendary { color: #ffaa00; text-shadow: 0 0 8px #ffaa00; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ===== ã‚µã‚¦ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ³ =====
    class SoundEngine {
      constructor() { this.initialized = false; this.bgmEnabled = true; this.sfxEnabled = true; this.bgmVolume = -12; this.sfxVolume = -6; this.bgmLoop = null; this.isPlaying = false; }
      async init() {
        if (this.initialized) return;
        await Tone.start();
        this.bgmSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.5 } }).toDestination();
        this.bgmSynth.volume.value = this.bgmVolume;
        this.sfxSynth = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 } }).toDestination();
        this.sfxSynth.volume.value = this.sfxVolume;
        this.noiseSynth = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0 } }).toDestination();
        this.noiseSynth.volume.value = -20;
        this.initialized = true;
      }
      setBgmVolume(v) { this.bgmVolume = v; if (this.bgmSynth) this.bgmSynth.volume.value = v; }
      setSfxVolume(v) { this.sfxVolume = v; if (this.sfxSynth) this.sfxSynth.volume.value = v; if (this.noiseSynth) this.noiseSynth.volume.value = v - 14; }
      startBGM() {
        if (!this.initialized || !this.bgmEnabled || this.isPlaying) return;
        const melody = [['E4','8n'],['G4','8n'],['A4','8n'],['B4','8n'],['A4','8n'],['G4','8n'],['E4','4n'],['D4','8n'],['E4','8n'],['G4','8n'],['A4','8n'],['G4','8n'],['E4','8n'],['D4','4n']];
        let idx = 0;
        this.bgmLoop = new Tone.Loop((time) => { if (!this.bgmEnabled) return; const [n,d] = melody[idx % melody.length]; this.bgmSynth.triggerAttackRelease(n,d,time); idx++; }, '8n').start(0);
        Tone.Transport.bpm.value = 100; Tone.Transport.start(); this.isPlaying = true;
      }
      stopBGM() { if (this.bgmLoop) { this.bgmLoop.stop(); Tone.Transport.stop(); this.isPlaying = false; } }
      toggleBGM(e) { this.bgmEnabled = e; if (e && this.initialized) this.startBGM(); else this.stopBGM(); }
      playAttack() { if (this.initialized && this.sfxEnabled) { this.sfxSynth.triggerAttackRelease('C5','16n'); setTimeout(() => this.sfxSynth.triggerAttackRelease('E5','16n'), 50); } }
      playHit() { if (this.initialized && this.sfxEnabled) this.noiseSynth.triggerAttackRelease('16n'); }
      playLevelUp() { if (this.initialized && this.sfxEnabled) ['C5','E5','G5','C6'].forEach((n,i) => setTimeout(() => this.sfxSynth.triggerAttackRelease(n,'8n'), i*100)); }
      playHeal() { if (this.initialized && this.sfxEnabled) { this.sfxSynth.triggerAttackRelease('G5','4n'); setTimeout(() => this.sfxSynth.triggerAttackRelease('B5','4n'), 150); } }
      playGold() { if (this.initialized && this.sfxEnabled) { this.sfxSynth.triggerAttackRelease('E6','16n'); setTimeout(() => this.sfxSynth.triggerAttackRelease('G6','16n'), 80); } }
      playDeath() { if (this.initialized && this.sfxEnabled) ['E4','D4','C4','B3'].forEach((n,i) => setTimeout(() => this.sfxSynth.triggerAttackRelease(n,'8n'), i*200)); }
      playBoss() { if (this.initialized && this.sfxEnabled) ['C3','C3','G3','C3','G3','C4'].forEach((n,i) => setTimeout(() => this.sfxSynth.triggerAttackRelease(n,'8n'), i*150)); }
      playCritical() { if (this.initialized && this.sfxEnabled) { this.sfxSynth.triggerAttackRelease('G5','16n'); setTimeout(() => this.sfxSynth.triggerAttackRelease('B5','16n'), 30); setTimeout(() => this.sfxSynth.triggerAttackRelease('D6','16n'), 60); } }
    }
    const soundEngine = new SoundEngine();

    // ===== åå‰ç”Ÿæˆ =====
    const NAME_PARTS = {
      human: { prefix: ['ã‚¢ãƒ«','ãƒ™ãƒ«','ã‚«ã‚¤','ãƒ€ãƒ³','ã‚¨ãƒ«','ãƒ•ã‚£ãƒ³','ã‚¬ãƒ«','ãƒãƒ«','ã‚¤ãƒ«','ã‚¸ã‚§','ã‚±ã‚¤','ãƒ¬ã‚ª'], suffix: ['ã‚¹','ãƒ³','ãƒ‰','ã‚¯','ãƒˆ','ãƒ«','ãƒªã‚¢','ãƒŠ','ãƒ´ã‚£','ã‚¦ã‚¹','ã‚ªãƒ³'] },
      elf: { prefix: ['ã‚¨ã‚¢','ã‚»ãƒ¬','ã‚¬ãƒ©','ãƒ¬ã‚´','ã‚¢ãƒ©','ã‚¨ãƒ«','ãƒ•ã‚§ã‚¢','ã‚®ãƒ«','ãƒªãƒ³','ãƒ«ãƒ¼'], suffix: ['ã‚¦ã‚§ãƒ³','ãƒ‡ã‚£ãƒ«','ãƒ©ã‚¹','ãƒŸã‚¢','ãƒãƒ¼ãƒ«','ãƒªã‚ªãƒ³','ã‚¦ã‚£ãƒ³','ãƒ­ã‚¹','ãƒ•ã‚£ãƒ³'] },
      dwarf: { prefix: ['ãƒ‰ã‚¥','ãƒãƒ«','ã‚®ãƒ ','ãƒˆãƒ¼','ãƒ–ãƒ­','ãƒ€ã‚¤','ãƒ•ã‚¡','ã‚°ãƒ­','ã‚«ã‚¶','ãƒ¢ãƒ¼'], suffix: ['ãƒªãƒ³','ã‚¤ãƒ³','ãƒª','ãƒ«','ãƒ ','ãƒ‰','ã‚°','ã‚¯','ãƒœãƒ«','ãƒ€ãƒ«'] },
      gnome: { prefix: ['ãƒ•ã‚£','ã‚¸ãƒ³','ãƒœãƒœ','ãƒ‹ãƒ ','ã‚¬ãƒ¼','ãƒ”ãƒƒ','ãƒ†ã‚£ãƒ³','ã‚¦ã‚£','ã‚¶ãƒ³','ãƒªãƒª'], suffix: ['ãƒƒã‚¯','ã‚¹','ãƒ–ãƒ«','ãƒ‰ãƒ«','ãƒªãƒƒã‚¯','ãƒã‚¹','ãƒˆãƒ³','ã‚ºãƒ«','ãƒ³ã‚¯'] },
      porkul: { prefix: ['ãƒ‘ãƒƒ','ãƒ”ãƒƒ','ãƒ—ãƒ«','ãƒšã‚³','ãƒãƒ³','ãƒ›ãƒ“','ãƒ­ãƒ¼','ã‚µãƒ ','ãƒ•ãƒ­','ãƒ¡ãƒª'], suffix: ['ãƒ‰','ãƒˆ','ãƒ³','ãƒ«','ã‚¹','ãƒœ','ã‚´','ãƒ­','ã‚¸ãƒ¼','ã‚·ãƒ¼'] }
    };
    const genName = (race) => { const p = NAME_PARTS[race] || NAME_PARTS.human; return p.prefix[Math.floor(Math.random()*p.prefix.length)] + p.suffix[Math.floor(Math.random()*p.suffix.length)]; };

    // ===== ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ =====
    const RACES = { human: { name: 'äººé–“', str: 8, int: 8, pie: 5, vit: 8, agi: 8, luk: 9 }, elf: { name: 'ã‚¨ãƒ«ãƒ•', str: 7, int: 10, pie: 10, vit: 6, agi: 9, luk: 6 }, dwarf: { name: 'ãƒ‰ãƒ¯ãƒ¼ãƒ•', str: 10, int: 7, pie: 10, vit: 10, agi: 5, luk: 6 }, gnome: { name: 'ãƒãƒ¼ãƒ ', str: 7, int: 7, pie: 10, vit: 8, agi: 10, luk: 7 }, porkul: { name: 'ãƒãƒ¼ã‚¯ãƒ«', str: 5, int: 7, pie: 7, vit: 6, agi: 10, luk: 15 } };
    const ALIGNMENTS = { lawful: { name: 'ç§©åº', color: 'text-blue-400' }, neutral: { name: 'ä¸­ç«‹', color: 'text-gray-400' }, chaotic: { name: 'æ··æ²Œ', color: 'text-red-400' } };
    const JOBS = {
      fighter: { name: 'æˆ¦å£«', hpMod: 1.5, mpMod: 0.2, atkMod: 1.4, defMod: 1.3, align: ['lawful','neutral','chaotic'], spell: null, tier: 1, req: {} },
      mage: { name: 'é­”è¡“å¸«', hpMod: 0.6, mpMod: 1.8, atkMod: 0.6, defMod: 0.5, align: ['lawful','neutral','chaotic'], spell: 'mage', tier: 1, req: {} },
      priest: { name: 'åƒ§ä¾¶', hpMod: 0.9, mpMod: 1.4, atkMod: 0.8, defMod: 0.9, align: ['lawful','chaotic'], spell: 'priest', tier: 1, req: {} },
      thief: { name: 'ç›—è³Š', hpMod: 0.8, mpMod: 0.5, atkMod: 1.0, defMod: 0.7, align: ['neutral','chaotic'], spell: null, tier: 1, req: {} },
      bishop: { name: 'å¸æ•™', hpMod: 0.7, mpMod: 1.6, atkMod: 0.7, defMod: 0.6, align: ['lawful','chaotic'], spell: 'both', tier: 2, req: { int: 12, pie: 12 } },
      samurai: { name: 'ä¾', hpMod: 1.3, mpMod: 0.8, atkMod: 1.3, defMod: 1.1, align: ['lawful','neutral'], spell: 'mage', tier: 2, req: { str: 15, int: 11, vit: 14 } },
      lord: { name: 'å›ä¸»', hpMod: 1.4, mpMod: 1.0, atkMod: 1.2, defMod: 1.2, align: ['lawful'], spell: 'priest', tier: 2, req: { str: 15, pie: 12, vit: 15 } },
      ninja: { name: 'å¿è€…', hpMod: 1.0, mpMod: 0.6, atkMod: 1.5, defMod: 0.8, align: ['chaotic'], spell: null, tier: 2, req: { str: 15, int: 17, agi: 15 } }
    };
    const SPELLS = {
      mage: [{name:'ãƒãƒªãƒˆ',lv:1,mp:2,pow:15},{name:'ãƒ¢ã‚°ãƒ¬ãƒ•',lv:2,mp:3,pow:0,buff:'def'},{name:'ãƒãƒãƒªãƒˆ',lv:3,mp:5,pow:25},{name:'ãƒ©ãƒãƒªãƒˆ',lv:5,mp:7,pow:40},{name:'ãƒ€ãƒ«ãƒˆ',lv:6,mp:8,pow:50},{name:'ãƒãƒ€ãƒ«ãƒˆ',lv:7,mp:12,pow:65},{name:'ãƒ†ã‚£ãƒ«ãƒˆã‚¦ã‚§ã‚¤ãƒˆ',lv:8,mp:15,pow:80}],
      priest: [{name:'ãƒ‡ã‚£ã‚ªã‚¹',lv:1,mp:2,pow:0,heal:25},{name:'ãƒãƒ‡ã‚£ã‚ªã‚¹',lv:1,mp:2,pow:12},{name:'ãƒã‚¦ã‚¸',lv:2,mp:3,pow:0,buff:'atk'},{name:'ãƒ‡ã‚£ã‚¢ãƒ«',lv:3,mp:4,pow:0,heal:40},{name:'ãƒãƒ‡ã‚£ã‚¢ãƒ«',lv:4,mp:5,pow:25},{name:'ãƒãƒ‡ã‚£',lv:5,mp:8,pow:0,heal:80},{name:'ãƒãƒãƒ‡ã‚£',lv:6,mp:10,pow:45},{name:'ãƒãƒ‡ã‚£ã‚¢ãƒ«',lv:7,mp:15,pow:0,healAll:50}]
    };

    // ===== ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³é¢¨æ™¯æå†™ =====
    const DUNGEON_ATMOSPHERE = {
      slime: {
        name: 'ã‚¹ãƒ©ã‚¤ãƒ ã®ç©´',
        rooms: ['ç‹­ã„åœŸã®æ¨ªç©´','æ¹¿ã£ãŸæ´çªŸ','ç²˜æ¶²ã§è¦†ã‚ã‚ŒãŸå°éƒ¨å±‹','å´©ã‚Œã‹ã‘ãŸå‘é“','ç·‘è‰²ã«å…‰ã‚‹ç©ºæ´','æ»´ã‚‹æ°´éŸ³ãŒéŸ¿ãé€šè·¯'],
        floors: {
          1: { desc: 'å…¥å£ä»˜è¿‘ã€‚åœŸã®åŒ‚ã„ãŒé¼»ã‚’çªãã€‚', sounds: ['ãƒ”ãƒãƒ£ãƒ”ãƒãƒ£ã¨æ°´æ»´ã®éŸ³','å¾®ã‹ãªé¢¨ã®éŸ³'], features: ['è‹”ã‚€ã—ãŸå£','æ¹¿ã£ãŸåºŠ'] },
          2: { desc: 'å°‘ã—æ·±ããªã£ãŸã€‚ç²˜æ¶²ã®è·¡ãŒå¢—ãˆã¦ããŸã€‚', sounds: ['ãƒŒãƒ«ãƒŒãƒ«ã¨é€™ã†éŸ³','ã‚¨ã‚³ãƒ¼ã™ã‚‹è¶³éŸ³'], features: ['ã‚¹ãƒ©ã‚¤ãƒ ã®é€™ã£ãŸè·¡','å´©ã‚ŒãŸå²©'] },
          3: { desc: 'å®Œå…¨ã«åœ°ä¸‹æ·±ãã€‚å…‰ãŒå±Šã‹ãªã„ã€‚', sounds: ['ä¸æ°—å‘³ãªé™å¯‚','ä½•ã‹ãŒè ¢ãéŸ³'], features: ['å…‰ã‚‹ç²˜æ¶²','å¤ã„éª¨'] },
          4: { desc: 'ã‚¹ãƒ©ã‚¤ãƒ ã®å·£ã«è¿‘ã¥ã„ã¦ã„ã‚‹ã€‚ç©ºæ°—ãŒé‡ã„ã€‚', sounds: ['å¤§é‡ã®ç²˜æ¶²éŸ³','ä½ã„æŒ¯å‹•'], features: ['å·¨å¤§ãªç²˜æ¶²å¡Š','æº¶ã‘ãŸè£…å‚™ã®æ®‹éª¸'] },
          5: { desc: 'ã€ãƒœã‚¹éšå±¤ã€‘ã‚¹ãƒ©ã‚¤ãƒ ã‚­ãƒ³ã‚°ã®ç‰åº§ã®é–“ã€‚', sounds: ['å¨åœ§çš„ãªæŒ¯å‹•','ç‹ã®è„ˆå‹•'], features: ['å·¨å¤§ãªç‹ã®ç‰åº§','å®çŸ³ã®ã‚ˆã†ãªæ ¸'] }
        }
      },
      kobold: {
        name: 'ã‚³ãƒœãƒ«ãƒ‰ã®å·£',
        rooms: ['æ˜ã‚ŠæŠœã‹ã‚ŒãŸå°éƒ¨å±‹','æ­¦å™¨åº«','è¦‹å¼µã‚Šå°','å®´ä¼šå ´','ç¥­å£‡ã®é–“','ç‰¢ç„'],
        floors: {
          1: { desc: 'å·£ã®å…¥å£ã€‚è­¦æˆ’ã®æ°—é…ãŒã‚ã‚‹ã€‚', sounds: ['ã‚­ãƒ£ãƒ³ã‚­ãƒ£ãƒ³ã¨ã„ã†é³´ãå£°','é‡‘å±éŸ³'], features: ['ç²—æœ«ãªæŸµ','è¦‹å¼µã‚Šç©´'] },
          2: { desc: 'å±…ä½åŒºã«å…¥ã£ãŸã€‚ç”Ÿæ´»ã®ç—•è·¡ãŒè¦‹ãˆã‚‹ã€‚', sounds: ['ã‚¬ãƒ¤ã‚¬ãƒ¤ã—ãŸé¨’éŸ³','èª¿ç†ã®éŸ³'], features: ['è—ã®ãƒ™ãƒƒãƒ‰','ç„šãç«ã®è·¡'] },
          3: { desc: 'æˆ¦å£«ãŸã¡ã®åŒºç”»ã€‚æ­¦è£…ãŒå¼·åŒ–ã•ã‚Œã¦ã„ã‚‹ã€‚', sounds: ['æ­¦å™¨ã‚’ç ”ãéŸ³','è¨“ç·´ã®æ›ã‘å£°'], features: ['æ­¦å™¨æ£š','æˆ¦åˆ©å“ã®å±±'] },
          4: { desc: 'ç¥æ®¿åŒºç”»ã€‚ä¸æ°—å‘³ãªç¥­å£‡ãŒã‚ã‚‹ã€‚', sounds: ['è© å”±ã®å£°','å¤ªé¼“ã®éŸ³'], features: ['è¡€å¡—ã‚‰ã‚ŒãŸç¥­å£‡','å‘ªè¡“ã®é“å…·'] },
          5: { desc: 'ã‚³ãƒœãƒ«ãƒ‰ãƒ¡ã‚¤ã‚¸ã®ç ”ç©¶å®¤ã€‚', sounds: ['é­”åŠ›ã®å”¸ã‚Š','è–¬å“ã®æ³¡ç«‹ã¡'], features: ['é­”æ³•é™£','æ€ªã—ã’ãªè–¬ç“¶'] },
          6: { desc: 'å®ç‰©åº«ã¸ã®é€šè·¯ã€‚è­¦å‚™ãŒå³é‡ã€‚', sounds: ['é§ã®è¶³éŸ³','è­¦å ±ã®åˆå›³'], features: ['é ‘ä¸ˆãªæ‰‰','è¦‹å¼µã‚Šã®è©°æ‰€'] },
          7: { desc: 'ç‹ã®ç§å®¤ã«è¿‘ã¥ã„ã¦ã„ã‚‹ã€‚', sounds: ['å¨å³ã‚ã‚‹è¶³éŸ³','å‘½ä»¤ã®å£°'], features: ['è±ªè¯ãªè£…é£¾','æˆ¦æ——'] },
          8: { desc: 'ã€ãƒœã‚¹éšå±¤ã€‘ã‚³ãƒœãƒ«ãƒˆãƒ­ãƒ¼ãƒ‰ã®è¬è¦‹ã®é–“ã€‚', sounds: ['ç‹ã®å’†å“®','è‡£ä¸‹ã®æ­“å£°'], features: ['é»„é‡‘ã®ç‰åº§','ç•¥å¥ªå“ã®å±±'] }
        }
      },
      thieves: {
        name: 'ç›—è³Šã®ã‚¢ã‚¸ãƒˆ',
        rooms: ['éš ã—éƒ¨å±‹','å®ç‰©åº«','é…’å ´','è¨“ç·´å ´','æ‹·å•å®¤','é¦–é ˜ã®é–“'],
        floors: {
          1: { desc: 'å½è£…ã•ã‚ŒãŸå…¥å£ã€‚ç½ ã«æ³¨æ„ã€‚', sounds: ['é™å¯‚','å¾®ã‹ãªè¶³éŸ³'], features: ['éš ã—æ‰‰','å½ã®å£'] },
          5: { desc: 'æš—æ®ºè€…ã®å·£çªŸã€‚å±é™ºåº¦ãŒè·³ã­ä¸ŠãŒã‚‹ã€‚', sounds: ['ç„¡éŸ³','è¡£æ“¦ã‚Œã®éŸ³'], features: ['å½±ã«æ½œã‚€è€…','æ¯’å¡—ã‚Šã®åˆƒ'] },
          10: { desc: 'ã€ãƒœã‚¹éšå±¤ã€‘ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒ•ã®éš ã‚Œå®¶ã€‚', sounds: ['é™å¯‚ã®ä¸­ã®æ®ºæ°—','å‹åˆ©ã¸ã®æ¸‡æœ›'], features: ['è±ªè¯ãªç‰åº§','ç›—å“ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³'] }
        }
      },
      sewer: {
        name: 'ã‚«ãƒªã‚°ãƒ©ãƒ¼ã‚¼ä¸‹æ°´è·¯',
        rooms: ['æ±šæ°´è·¯','æµ„åŒ–æ§½','ç®¡ç†å®¤','å´©è½ã—ãŸé€šè·¯','åœ°ä¸‹å¢“åœ°','ç¥­å£‡'],
        floors: {
          1: { desc: 'ä¸‹æ°´ã®å…¥å£ã€‚æ‚ªè‡­ãŒé¼»ã‚’çªãã€‚', sounds: ['æ°´æµã®éŸ³','ãƒã‚ºãƒŸã®é³´ãå£°'], features: ['æ±šæ°´','è‹”'] },
          6: { desc: 'ã‚¢ãƒ³ãƒ‡ãƒƒãƒ‰ã®å·£çªŸã€‚ç”Ÿè€…ã‚’æ‹’ã‚€ã€‚', sounds: ['ã†ã‚ãå£°ã®åˆå”±','éª¨ã®è¶³éŸ³'], features: ['ç©ã¿ä¸Šã’ã‚‰ã‚ŒãŸéª¨','è…ã£ãŸæ­»ä½“'] },
          12: { desc: 'ã€ãƒœã‚¹éšå±¤ã€‘ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢ã®ç‰åº§ã®é–“ã€‚', sounds: ['æ”¯é…è€…ã®å¨åœ§','è¡€ã®å®´'], features: ['æ¼†é»’ã®ç‰åº§','è¡€ã®æ³‰'] }
        }
      },
      kaoka: {
        name: 'ã‚«ã‚ªã‚«ãƒ»ãƒ‘ãƒ©ãƒ¼ã‚¸éºè·¡',
        rooms: ['å´©ã‚ŒãŸç¥æ®¿','å®ç‰©åº«','ç¥­å¸ã®é–“','è©¦ç·´ã®å›å»Š','å°å°ã®é–“','æ·±æ·µã¸ã®é–€'],
        floors: {
          1: { desc: 'éºè·¡ã®å…¥å£ã€‚å¤ä»£ã®å¨å³ã‚’æ„Ÿã˜ã‚‹ã€‚', sounds: ['é¢¨åŒ–ã—ãŸçŸ³ã®éŸ³','é ã„éå»ã®æ®‹éŸ¿'], features: ['é¢¨åŒ–ã—ãŸçŸ³åƒ','å¤ä»£æ–‡å­—'] },
          8: { desc: 'ç¥æ®¿ã®ä¸­å±¤ã€‚ç½ ãŒå¤šãä»•æ›ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã€‚', sounds: ['æ©Ÿæ¢°ã®ä½œå‹•éŸ³','çŸ¢ãŒé£›ã¶éŸ³'], features: ['èµ·å‹•ã™ã‚‹ç½ ','å´©ã‚Œã‚‹åºŠ'] },
          15: { desc: 'ã€ãƒœã‚¹éšå±¤ã€‘ã‚°ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ãƒ¢ãƒ³ã®å°å°ã®é–“ã€‚', sounds: ['åœ°ç„ã®å’†å“®','æ¬¡å…ƒã®æ­ªã¿'], features: ['ç ´ã‚ŒãŸå°å°','æ‚ªé­”ã®ç‰åº§'] }
        }
      },
      deltis: {
        name: 'ãƒ‡ãƒ«ãƒ†ã‚£ã‚¹å¤§è”µå®¤',
        rooms: ['é‡‘è²¨ã®å±±','å®çŸ³ã®é–“','ç‹å† ã®éƒ¨å±‹','é­”æ³•é“å…·åº«','ç«œã®å·£','é»„é‡‘ã®ç‰åº§'],
        floors: {
          1: { desc: 'å¤§è”µå®¤ã®å…¥å£ã€‚é»„é‡‘ã®è¼ããŒè¦‹ãˆã‚‹ã€‚', sounds: ['é‡‘è²¨ã®éŸ³','é­”æ³•ã®è­¦å ±'], features: ['é‡‘ã®æ‰‰','å®ã®å±±'] },
          9: { desc: 'ç«œã®é ˜åŸŸã®å…¥å£ã€‚ç†±æ°—ãŒå¢—ã™ã€‚', sounds: ['ä½ã„å”¸ã‚Šå£°','ç‚ã®éŸ³'], features: ['ç„¦ã’ãŸè·¡','æº¶ã‘ãŸé‡‘'] },
          18: { desc: 'ã€ãƒœã‚¹éšå±¤ã€‘ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ‰ãƒ©ã‚´ãƒ³ã®å®ç‰©åº«ã€‚', sounds: ['ç«œã®é¼“å‹•','é»„é‡‘ã®æ­Œ'], features: ['é»„é‡‘ã®ç‰åº§','ç„¡é™ã®è²¡å®'] }
        }
      },
      dragon: {
        name: 'é»„é¾ã®ç¥æ®¿è·¡',
        rooms: ['ç«œéª¨ã®å›å»Š','ç‚ã®è©¦ç·´å ´','æ°·ã®é–“','é›·ã®ç¥­å£‡','ç«œç‹ã®å¢“æ‰€','æ˜‡å¤©ã®é–“'],
        floors: {
          1: { desc: 'ç¥æ®¿ã®å…¥å£ã€‚ç«œã®å¨å³ãŒæ¼‚ã†ã€‚', sounds: ['é¢¨ã®å’†å“®','é ã„ç«œã®å£°'], features: ['ç«œã®åƒ','å¤ä»£ã®ç¥­å£‡'] },
          10: { desc: 'è©¦ç·´ã®ä¸­å±¤ã€‚å…ƒç´ ã®åŠ›ãŒè’ã‚Œç‹‚ã†ã€‚', sounds: ['å…ƒç´ ã®è¡çª','åŠ›ã®å¥”æµ'], features: ['å…ƒç´ ã®æŸ±','è©¦ç·´ã®é–€'] },
          20: { desc: 'ã€ãƒœã‚¹éšå±¤ã€‘ã‚¨ãƒ³ã‚·ã‚§ãƒ³ãƒˆãƒ‰ãƒ©ã‚´ãƒ³ã®è–åŸŸã€‚', sounds: ['å¤ªå¤ã®å’†å“®','ä¸–ç•Œã®éœ‡ãˆ'], features: ['å¤ç«œã®ç‰åº§','å‰µä¸–ã®åŠ›'] }
        }
      },
      trebor: {
        name: 'ãƒˆãƒ¬ãƒœãƒ¼ã®è©¦ç·´å ´',
        rooms: ['è¦ªè¡›éšŠã®è©°æ‰€','é­”æ³•ã®è¿·è·¯','æ­»ã®å›å»Š','å¯©åˆ¤ã®é–“','ãƒ¯ãƒ¼ãƒ‰ãƒŠã®æ›¸åº«','æœ€çµ‚æ±ºæˆ¦å ´'],
        floors: {
          1: { desc: 'è©¦ç·´å ´ã®å…¥å£ã€‚æœ€å¼·ã®æˆ¦å£«ãŸã¡ãŒå¾…ã¤ã€‚', sounds: ['é§ã®éŸ³','èª“ã„ã®å£°'], features: ['èª“ã„ã®ç¢‘','æ „å…‰ã®å£'] },
          12: { desc: 'ä¸­å±¤ã€‚æ­´æˆ¦ã®å‹‡è€…ãŸã¡ã®å¢“æ¨™ãŒä¸¦ã¶ã€‚', sounds: ['éå»ã®æˆ¦ã„ã®æ®‹éŸ¿','é­‚ã®å˜†ã'], features: ['è‹±é›„ã®å¢“','ä¼èª¬ã®æ­¦å™¨'] },
          25: { desc: 'ã€æœ€çµ‚ãƒœã‚¹éšå±¤ã€‘ãƒ¯ãƒ¼ãƒ‰ãƒŠã®ç‰åº§ã®é–“ã€‚', sounds: ['é­”ç‹ã®åŠ›','çµ‚ç„‰ã®é˜'], features: ['æ¼†é»’ã®ç‰åº§','ä¸–ç•Œã®çµ‚ã‚ã‚Š'] }
        }
      }
    };

    // ===== æ¢ç´¢ãƒ»æˆ¦é—˜æå†™ =====
    const EXPLORATION_EVENTS = {
      move: ['æ…é‡ã«æ­©ã‚’é€²ã‚ã‚‹...','æ¾æ˜ã®æ˜ã‹ã‚Šã‚’é ¼ã‚Šã«é€²ã‚€...','å£ä¼ã„ã«ç§»å‹•ã™ã‚‹...','è¶³éŸ³ã‚’æ®ºã—ã¦é€²ã‚€...','å‘¨å›²ã‚’è­¦æˆ’ã—ãªãŒã‚‰æ­©ã...'],
      search: ['å‘¨å›²ã‚’èª¿ã¹ã‚‹...','æ€ªã—ã„å ´æ‰€ã‚’æ¢ã™...','å£ã«è€³ã‚’å½“ã¦ã‚‹...','åºŠã‚’èª¿ã¹ã‚‹...','å¤©äº•ã‚’è¦‹ä¸Šã’ã‚‹...'],
    };
    const BATTLE_DESC = {
      encounter: ['å‰æ–¹ã«å½±ãŒè¦‹ãˆã‚‹...{enemy}ã ï¼','çªç„¶ã€{enemy}ãŒé£›ã³å‡ºã—ã¦ããŸï¼','æš—é—˜ã®ä¸­ã‹ã‚‰{enemy}ãŒå§¿ã‚’ç¾ã—ãŸï¼','è¶³éŸ³ãŒè¿‘ã¥ã...{enemy}ãŒç¾ã‚ŒãŸï¼','ä¸æ°—å‘³ãªæ°—é…...æŒ¯ã‚Šå‘ãã¨{enemy}ï¼','{enemy}ãŒè¡Œãæ‰‹ã‚’å¡ã„ã§ã„ã‚‹ï¼'],
      attack: ['{name}ã¯å‰£ã‚’æŒ¯ã‚Šã‹ã–ã—ãŸï¼','{name}ã®æ¸¾èº«ã®ä¸€æ’ƒï¼','{name}ã¯ç´ æ—©ãæ–¬ã‚Šã‹ã‹ã£ãŸï¼','{name}ã¯åŠ›å¼·ãæ­¦å™¨ã‚’æŒ¯ã‚Šä¸‹ã‚ã—ãŸï¼','{name}ã®é€£ç¶šæ”»æ’ƒï¼','{name}ã¯éš™ã‚’çªã„ã¦æ”»æ’ƒï¼','{name}ã¯æ­£é¢ã‹ã‚‰æ–¬ã‚Šã¤ã‘ãŸï¼','{name}ãŒæ­¦å™¨ã‚’æ§‹ãˆçªé€²ï¼','{name}ã¯å›è»¢æ–¬ã‚Šã‚’ç¹°ã‚Šå‡ºã—ãŸï¼'],
      critical: ['ã€ä¼šå¿ƒã€‘æ€¥æ‰€ã«å‘½ä¸­ï¼','ã€ä¼šå¿ƒã€‘è¦‹äº‹ãªã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ’ãƒƒãƒˆï¼','ã€ä¼šå¿ƒã€‘æ¸¾èº«ã®ä¸€æ’ƒãŒç‚¸è£‚ï¼'],
      miss: ['{name}ã®æ”»æ’ƒã¯å¤–ã‚ŒãŸï¼','æ•µã¯ç´ æ—©ãå›é¿ã—ãŸï¼','{name}ã¯ç©ºæŒ¯ã‚Šã—ãŸï¼'],
      damage: ['{target}ã«{dmg}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼','{target}ã¯{dmg}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸï¼','{dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼{target}ãŒã‚ˆã‚ã‚ãï¼'],
      enemyAttack: ['{enemy}ãŒè¥²ã„ã‹ã‹ã£ã¦ããŸï¼','{enemy}ã®é‹­ã„æ”»æ’ƒï¼','{enemy}ã¯ç‰™ã‚’å‰¥ã„ãŸï¼','{enemy}ã®çˆªãŒå…‰ã‚‹ï¼','{enemy}ãŒçªé€²ã—ã¦ããŸï¼'],
      spell: ['{name}ã¯å‘ªæ–‡ã‚’å”±ãˆãŸ...ã€Œ{spell}ã€ï¼','ã€Œ{spell}ã€ï¼{name}ã®æ‰‹ã‹ã‚‰é­”åŠ›ãŒæ”¾ãŸã‚Œã‚‹ï¼'],
      victory: ['{enemy}ã‚’å€’ã—ãŸï¼','{enemy}ã¯å´©ã‚Œè½ã¡ãŸï¼','{enemy}ã¯æ¶ˆæ»…ã—ãŸï¼'],
      bossAppear: ['ã€è­¦å‘Šã€‘å¼·å¤§ãªæ°—é…ã‚’æ„Ÿã˜ã‚‹...','åœ°éŸ¿ãã¨ã¨ã‚‚ã«{enemy}ãŒç¾ã‚ŒãŸï¼'],
      battleStart: ['â”€â”€â”€â”€ æˆ¦é—˜é–‹å§‹ â”€â”€â”€â”€'],
      turn: ['ã€ã‚¿ãƒ¼ãƒ³{n}ã€‘'],
      monsterStatus: ['{enemy} HP: {hp}/{maxHp}']
    };
    const getBattleDesc = (type, params = {}) => {
      const arr = BATTLE_DESC[type];
      let msg = arr[Math.floor(Math.random() * arr.length)];
      Object.entries(params).forEach(([k, v]) => { msg = msg.replace(new RegExp(`\\{${k}\\}`, 'g'), v); });
      return msg;
    };
    const getExploreDesc = (type) => EXPLORATION_EVENTS[type][Math.floor(Math.random() * EXPLORATION_EVENTS[type].length)];
    const getRoomDesc = (dng, floor) => {
      const d = DUNGEON_ATMOSPHERE[dng];
      if (!d) return 'æš—ã„é€šè·¯ã‚’é€²ã‚€...';
      const room = d.rooms[Math.floor(Math.random() * d.rooms.length)];
      const floorData = d.floors[floor] || d.floors[Object.keys(d.floors).reduce((a,b) => Math.abs(b-floor) < Math.abs(a-floor) ? b : a)];
      const sound = floorData?.sounds?.[Math.floor(Math.random() * floorData.sounds.length)] || '';
      const feature = floorData?.features?.[Math.floor(Math.random() * floorData.features.length)] || '';
      return `[${room}] ${feature ? feature + 'ãŒã‚ã‚‹ã€‚' : ''} ${sound ? sound + 'ãŒèã“ãˆã‚‹ã€‚' : ''}`;
    };
    const getFloorDesc = (dng, floor) => {
      const d = DUNGEON_ATMOSPHERE[dng];
      if (!d) return '';
      const floorData = d.floors[floor] || d.floors[Object.keys(d.floors).reduce((a,b) => Math.abs(b-floor) < Math.abs(a-floor) ? b : a)];
      return floorData?.desc || '';
    };

    // ===== è£…å‚™å“ (ç°¡ç•¥åŒ–) =====
    const ITEMS = {
      weapons: [
        {id:'w001',name:'æŸ³ã®æ£’',atk:1,price:8,rarity:'common'},{id:'w016',name:'æ¨«ã®æ£’',atk:5,price:60,rarity:'common'},
        {id:'w025',name:'ä¸–ç•Œæ¨¹ã®æ–',atk:32,price:15000,rarity:'epic',jobs:['mage','bishop','priest']},
        {id:'w046',name:'ç«œéª¨ã®å‰£',atk:26,price:4000,rarity:'rare'},{id:'w053',name:'ç¥ç£éª¨ã®å‰£',atk:55,price:60000,rarity:'legendary'},
        {id:'w074',name:'ç²¾éŠ…ã®å‰£',atk:6,price:90,rarity:'common'},{id:'w091',name:'é’éŠ…ã®å‰£',atk:11,price:320,rarity:'uncommon'},
        {id:'w103',name:'éŒ¬é‰„ã®å‰£',atk:14,price:500,rarity:'uncommon'},{id:'w114',name:'ç‰é‹¼ã®æ‰“åˆ€',atk:24,price:2800,rarity:'rare',jobs:['samurai','ninja']},
        {id:'w117',name:'ãƒ€ãƒã‚¹ã‚«ã‚¹é‹¼ã®å‰£',atk:26,price:4500,rarity:'rare'},{id:'w121',name:'éš•é‰„ã®å‰£',atk:34,price:9000,rarity:'epic'},
        {id:'w150',name:'ãƒŸã‚¹ãƒªãƒ«ã‚½ãƒ¼ãƒ‰',atk:35,price:8000,rarity:'epic'},{id:'w160',name:'ã‚ªãƒªãƒãƒ«ã‚³ãƒ³ã‚½ãƒ¼ãƒ‰',atk:48,price:25000,rarity:'epic'},
        {id:'w172',name:'ã‚¨ã‚¯ã‚¹ã‚«ãƒªãƒãƒ¼',atk:60,price:60000,rarity:'epic',jobs:['lord']},{id:'w186',name:'ç¥æ®ºã—ã®å‰£',atk:99,price:999999,rarity:'legendary'}
      ],
      armors: [
        {id:'a001',name:'å¸ƒã®æœ',def:1,price:15,rarity:'common'},{id:'a007',name:'é©é§',def:4,price:100,rarity:'common'},
        {id:'a014',name:'æ¨«ã®ç›¾',def:4,price:80,rarity:'common'},{id:'a025',name:'ç«œéª¨ã®é§',def:24,price:5500,rarity:'rare'},
        {id:'a047',name:'é’éŠ…ã®é§',def:10,price:480,rarity:'uncommon'},{id:'a056',name:'ãƒã‚§ã‚¤ãƒ³ãƒ¡ã‚¤ãƒ«',def:12,price:600,rarity:'uncommon'},
        {id:'a062',name:'éš•é‰„ã®é§',def:35,price:16000,rarity:'epic'},{id:'a080',name:'ãƒŸã‚¹ãƒªãƒ«ãƒ¡ã‚¤ãƒ«',def:32,price:10000,rarity:'epic'},
        {id:'a085',name:'ã‚ªãƒªãƒãƒ«ã‚³ãƒ³ã‚¢ãƒ¼ãƒãƒ¼',def:48,price:35000,rarity:'epic'},{id:'a097',name:'ç¥ã€…ã®é§',def:75,price:300000,rarity:'legendary'}
      ],
      accessories: [
        {id:'c001',name:'æŸ³ã®ãŠå®ˆã‚Š',def:1,price:20,rarity:'common'},{id:'c010',name:'éŠ…ã®æŒ‡è¼ª',atk:1,price:40,rarity:'common'},
        {id:'c016',name:'éŠ€ã®æŒ‡è¼ª',atk:5,def:5,price:800,rarity:'rare'},{id:'c018',name:'ãƒŸã‚¹ãƒªãƒ«ãƒªãƒ³ã‚°',atk:10,def:10,price:8000,rarity:'epic'},
        {id:'c030',name:'ãƒ‰ãƒ©ã‚´ãƒ³ãƒªãƒ³ã‚°',atk:12,def:12,price:15000,rarity:'epic'},{id:'c041',name:'ã‚¤ãƒ³ãƒ•ã‚£ãƒ‹ãƒ†ã‚£ã‚¬ãƒ³ãƒˆãƒ¬ãƒƒãƒˆ',atk:30,def:30,price:400000,rarity:'legendary'}
      ],
      consumables: [{id:'p001',name:'ãƒãƒ¼ã‚·ãƒ§ãƒ³',price:50,rarity:'common',heal:30},{id:'p002',name:'ãƒã‚¤ãƒãƒ¼ã‚·ãƒ§ãƒ³',price:200,rarity:'uncommon',heal:100}]
    };

    // ===== ãƒœã‚¹å°‚ç”¨ãƒ‰ãƒ­ãƒƒãƒ— =====
    const BOSS_DROPS = {
      'ã‚¹ãƒ©ã‚¤ãƒ ã‚­ãƒ³ã‚°': [{id:'bd01',name:'ã‚¹ãƒ©ã‚¤ãƒ ã®ç‹å† ',atk:3,def:3,price:500,rarity:'uncommon'}],
      'ã‚³ãƒœãƒ«ãƒˆãƒ­ãƒ¼ãƒ‰': [{id:'bd03',name:'ã‚³ãƒœãƒ«ãƒˆã®å®ç ',atk:5,def:2,price:800,rarity:'uncommon'}],
      'ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒ•': [{id:'bd06',name:'å½±ã®ãƒãƒ³ãƒˆ',def:10,price:1800,rarity:'rare',jobs:['thief','ninja']}],
      'ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢': [{id:'bd09',name:'å¸è¡€é¬¼ã®ç‰™',atk:18,price:2800,rarity:'rare'}],
      'ã‚°ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ãƒ¢ãƒ³': [{id:'bd12',name:'æ‚ªé­”ã®è§’',atk:22,def:8,price:5000,rarity:'epic'}],
      'ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ‰ãƒ©ã‚´ãƒ³': [{id:'bd15',name:'é»„é‡‘ã®é±—',def:25,price:10000,rarity:'epic'}],
      'ã‚¨ãƒ³ã‚·ã‚§ãƒ³ãƒˆãƒ‰ãƒ©ã‚´ãƒ³': [{id:'bd20',name:'æ™‚ã®é±—',atk:25,def:25,price:25000,rarity:'legendary'}],
      'ãƒ¯ãƒ¼ãƒ‰ãƒŠ': [{id:'bd21',name:'é­”é™¤ã‘ã®è­·ç¬¦',atk:30,def:30,price:60000,rarity:'legendary'}]
    };

    const DUNGEONS = [
      {id:'slime',name:'ã‚¹ãƒ©ã‚¤ãƒ ã®ç©´',floors:5,minLv:1},
      {id:'kobold',name:'ã‚³ãƒœãƒ«ãƒ‰ã®å·£',floors:8,minLv:3},
      {id:'thieves',name:'ç›—è³Šã®ã‚¢ã‚¸ãƒˆ',floors:10,minLv:5},
      {id:'sewer',name:'ã‚«ãƒªã‚°ãƒ©ãƒ¼ã‚¼ä¸‹æ°´è·¯',floors:12,minLv:8},
      {id:'kaoka',name:'ã‚«ã‚ªã‚«ãƒ»ãƒ‘ãƒ©ãƒ¼ã‚¸éºè·¡',floors:15,minLv:12},
      {id:'deltis',name:'ãƒ‡ãƒ«ãƒ†ã‚£ã‚¹å¤§è”µå®¤',floors:18,minLv:16},
      {id:'dragon',name:'é»„é¾ã®ç¥æ®¿è·¡',floors:20,minLv:20},
      {id:'trebor',name:'ãƒˆãƒ¬ãƒœãƒ¼ã®è©¦ç·´å ´',floors:25,minLv:25}
    ];

    const MONSTERS = [
      {name:'ãƒãƒ–ãƒªãƒ¼ã‚¹ãƒ©ã‚¤ãƒ ',hp:12,atk:4,def:1,exp:8,gold:3,dng:'slime',flr:1},
      {name:'ã‚³ãƒœãƒ«ãƒˆ',hp:18,atk:6,def:2,exp:12,gold:5,dng:'slime',flr:2},
      {name:'ã‚ªãƒ¼ã‚¯ãƒ™ãƒ“ãƒ¼',hp:25,atk:8,def:3,exp:18,gold:8,dng:'slime',flr:3},
      {name:'ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ãƒƒãƒˆ',hp:20,atk:10,def:2,exp:22,gold:10,dng:'slime',flr:4},
      {name:'ã‚¹ãƒ©ã‚¤ãƒ ã‚­ãƒ³ã‚°',hp:60,atk:18,def:6,exp:60,gold:40,dng:'slime',flr:5,boss:true},
      {name:'ã‚³ãƒœãƒ«ãƒˆã‚¦ã‚©ãƒ¼ãƒªã‚¢',hp:30,atk:12,def:5,exp:25,gold:12,dng:'kobold',flr:1},
      {name:'ã‚³ãƒœãƒ«ãƒˆãƒ¡ã‚¤ã‚¸',hp:22,atk:18,def:3,exp:35,gold:18,dng:'kobold',flr:4},
      {name:'ã‚ªãƒ¼ã‚¯',hp:40,atk:15,def:6,exp:40,gold:20,dng:'kobold',flr:6},
      {name:'ã‚³ãƒœãƒ«ãƒˆãƒ­ãƒ¼ãƒ‰',hp:90,atk:28,def:12,exp:120,gold:80,dng:'kobold',flr:8,boss:true},
      {name:'ã‚·ãƒ¼ãƒ•',hp:35,atk:20,def:6,exp:40,gold:25,dng:'thieves',flr:1},
      {name:'ã‚¢ã‚µã‚·ãƒ³',hp:45,atk:30,def:8,exp:60,gold:40,dng:'thieves',flr:5},
      {name:'ãƒ€ãƒ¼ã‚¯ã‚¨ãƒ«ãƒ•',hp:55,atk:35,def:10,exp:80,gold:50,dng:'thieves',flr:8},
      {name:'ãƒã‚¹ã‚¿ãƒ¼ã‚·ãƒ¼ãƒ•',hp:140,atk:45,def:18,exp:180,gold:120,dng:'thieves',flr:10,boss:true},
      {name:'ã‚¾ãƒ³ãƒ“',hp:55,atk:15,def:5,exp:45,gold:20,dng:'sewer',flr:1},
      {name:'ã‚¹ã‚±ãƒ«ãƒˆãƒ³',hp:45,atk:20,def:8,exp:50,gold:25,dng:'sewer',flr:4},
      {name:'ã‚°ãƒ¼ãƒ«',hp:65,atk:25,def:10,exp:70,gold:35,dng:'sewer',flr:7},
      {name:'ãƒ¯ã‚¤ãƒˆ',hp:75,atk:35,def:12,exp:90,gold:50,dng:'sewer',flr:10},
      {name:'ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢',hp:220,atk:55,def:22,exp:280,gold:180,dng:'sewer',flr:12,boss:true},
      {name:'ã‚¹ãƒˆãƒ¼ãƒ³ã‚´ãƒ¼ãƒ¬ãƒ ',hp:100,atk:40,def:25,exp:120,gold:60,dng:'kaoka',flr:1},
      {name:'ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«',hp:90,atk:50,def:20,exp:150,gold:80,dng:'kaoka',flr:8},
      {name:'ã‚°ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ãƒ¢ãƒ³',hp:350,atk:75,def:35,exp:450,gold:300,dng:'kaoka',flr:15,boss:true},
      {name:'ãƒŸãƒŸãƒƒã‚¯',hp:80,atk:45,def:15,exp:100,gold:200,dng:'deltis',flr:1},
      {name:'ãƒãƒ³ãƒ†ã‚£ã‚³ã‚¢',hp:150,atk:60,def:25,exp:200,gold:150,dng:'deltis',flr:10},
      {name:'ã‚´ãƒ¼ãƒ«ãƒ‰ãƒ‰ãƒ©ã‚´ãƒ³',hp:450,atk:90,def:45,exp:700,gold:600,dng:'deltis',flr:18,boss:true},
      {name:'ãƒ‰ãƒ©ã‚´ãƒ³ã‚¾ãƒ³ãƒ“',hp:150,atk:60,def:20,exp:200,gold:100,dng:'dragon',flr:1},
      {name:'ãƒã‚¤ã‚ºãƒ³ã‚¸ãƒ£ã‚¤ã‚¢ãƒ³ãƒˆ',hp:180,atk:70,def:25,exp:280,gold:140,dng:'dragon',flr:10},
      {name:'ã‚¨ãƒ³ã‚·ã‚§ãƒ³ãƒˆãƒ‰ãƒ©ã‚´ãƒ³',hp:700,atk:110,def:55,exp:1200,gold:1000,dng:'dragon',flr:20,boss:true},
      {name:'ãƒˆãƒ¬ãƒœãƒ¼è¦ªè¡›éšŠ',hp:200,atk:80,def:35,exp:300,gold:150,dng:'trebor',flr:1},
      {name:'ãƒ€ãƒ¼ã‚¯ãƒŠã‚¤ãƒˆ',hp:250,atk:90,def:40,exp:400,gold:200,dng:'trebor',flr:15},
      {name:'ãƒ¯ãƒ¼ãƒ‰ãƒŠ',hp:1200,atk:160,def:70,exp:6000,gold:5000,dng:'trebor',flr:25,boss:true}
    ];

    const TRAPS = [{name:'ãƒã‚¤ã‚ºãƒ³ãƒ‹ãƒ¼ãƒ‰ãƒ«',dmg:0.1},{name:'ã‚¯ãƒ­ã‚¹ãƒœã‚¦ãƒœãƒ«ãƒˆ',dmg:0.15},{name:'çˆ†ç™ºã™ã‚‹ç®±',dmg:0.2},{name:'è½ã¨ã—ç©´',dmg:0.1},{name:'æ¯’ã‚¬ã‚¹',dmg:0.12}];

    // ===== ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª =====
    function App() {
      const [screen, setScreen] = useState('title');
      const [party, setParty] = useState([]);
      const [gold, setGold] = useState(100);
      const [logs, setLogs] = useState([]);
      const [exploring, setExploring] = useState(false);
      const [dungeon, setDungeon] = useState(null);
      const [floor, setFloor] = useState(1);
      const [maxFloors, setMaxFloors] = useState({});
      const [retreatHP, setRetreatHP] = useState(30);
      const [activeTab, setActiveTab] = useState('dungeon');
      const [settings, setSettings] = useState({bgm:true,sfx:true,bgmVol:50,sfxVol:70});
      const [bestiary, setBestiary] = useState({});
      const [inventory, setInventory] = useState([]);
      const [showSettings, setShowSettings] = useState(false);
      const [showJobChange, setShowJobChange] = useState(null);
      const [shopCat, setShopCat] = useState('weapons');
      const [selChar, setSelChar] = useState(null);
      const logRef = useRef(null);

      const initSound = async () => { await soundEngine.init(); if (settings.bgm) soundEngine.startBGM(); };

      const addLog = useCallback((msg, type='normal') => {
        const c = {normal:'text-green-400',battle:'text-yellow-400',damage:'text-red-400',heal:'text-blue-400',item:'text-purple-400',level:'text-cyan-400',special:'text-pink-400',critical:'text-orange-400',boss:'gold-text',explore:'text-gray-400'}[type] || 'text-green-400';
        setLogs(prev => [...prev.slice(-150), {msg,c}]);
      }, []);

      useEffect(() => {
        const s = localStorage.getItem('wizardrySchemaV12');
        if (s) { const d = JSON.parse(s); setParty(d.party||[]); setGold(d.gold||100); setMaxFloors(d.maxFloors||{}); setSettings(d.settings||{bgm:true,sfx:true,bgmVol:50,sfxVol:70}); setBestiary(d.bestiary||{}); setInventory(d.inventory||[]); }
      }, []);
      useEffect(() => { if (party.length > 0) localStorage.setItem('wizardrySchemaV12', JSON.stringify({party,gold,maxFloors,settings,bestiary,inventory})); }, [party,gold,maxFloors,settings,bestiary,inventory]);
      useEffect(() => { if (logRef.current) logRef.current.scrollTop = logRef.current.scrollHeight; }, [logs]);
      useEffect(() => { soundEngine.toggleBGM(settings.bgm); }, [settings.bgm]);
      useEffect(() => { soundEngine.setBgmVolume(-30 + settings.bgmVol*0.3); }, [settings.bgmVol]);
      useEffect(() => { soundEngine.setSfxVolume(-20 + settings.sfxVol*0.2); }, [settings.sfxVol]);

      const getDrop = (flr, isBoss = false, bossName = null) => {
        if (isBoss && bossName && BOSS_DROPS[bossName]) {
          const drops = BOSS_DROPS[bossName];
          if (Math.random() < 0.7) return {...drops[Math.floor(Math.random() * drops.length)], uid: Date.now()+Math.random()};
        }
        const r = Math.random();
        let rarity = 'common';
        if (r < 0.0002 && flr >= 25) rarity = 'legendary';
        else if (r < 0.015 && flr >= 15) rarity = 'epic';
        else if (r < 0.06 && flr >= 8) rarity = 'rare';
        else if (r < 0.2) rarity = 'uncommon';
        const all = [...ITEMS.weapons,...ITEMS.armors,...ITEMS.accessories];
        const avail = all.filter(i => i.rarity === rarity);
        if (!avail.length) return null;
        return {...avail[Math.floor(Math.random()*avail.length)], uid: Date.now()+Math.random()};
      };

      useEffect(() => {
        if (!exploring || party.length === 0 || !dungeon) return;
        const interval = setInterval(() => {
          const alive = party.filter(c => c.currentHp > 0);
          if (alive.length === 0) {
            addLog('','normal'); addLog('ã€å…¨æ»…ã€‘ãƒ‘ãƒ¼ãƒ†ã‚£ã¯å…¨æ»…ã—ãŸ...','damage');
            soundEngine.playDeath(); setExploring(false); setFloor(1); setParty(p => p.map(c => ({...c, currentHp: Math.floor(c.maxHp*0.5)}))); return;
          }
          if (alive.some(c => (c.currentHp/c.maxHp)*100 <= retreatHP)) {
            addLog('','normal'); addLog(`ã€æ’¤é€€ã€‘HP${retreatHP}%ä»¥ä¸‹...å¸°é‚„é–‹å§‹`,'special');
            setExploring(false); setFloor(1); setParty(p => p.map(c => ({...c, currentHp: c.maxHp, currentMp: c.maxMp}))); return;
          }
          const event = Math.random();
          const dngData = DUNGEONS.find(d => d.id === dungeon);
          
          addLog(getExploreDesc('move'),'explore');
          addLog(getRoomDesc(dungeon, floor),'explore');
          
          if (event < 0.85) {
            const monsters = MONSTERS.filter(m => m.dng === dungeon && m.flr <= floor);
            if (monsters.length === 0) return;
            const mon = {...monsters[Math.floor(Math.random()*monsters.length)]};
            const isBoss = mon.boss && floor === mon.flr;
            const monMaxHp = mon.hp;
            let battleLogs = [];
            if (isBoss) {
              soundEngine.playBoss();
              battleLogs.push({msg:`â”â”â” BOSS: ${mon.name} â”â”â”`,type:'boss'});
            } else {
              battleLogs.push({msg:getBattleDesc('encounter',{enemy:mon.name}),type:'battle'});
            }
            setBestiary(prev => ({...prev,[mon.name]:{...mon,cnt:(prev[mon.name]?.cnt||0)+1}}));
            let monHp = mon.hp;
            let mpUsed = {};
            let turnCount = 1;
            let partyDamage = {};
            while (monHp > 0 && alive.filter(c => (partyDamage[c.id]||0) < c.currentHp).length > 0 && turnCount <= 5) {
              battleLogs.push({msg:`ã€ã‚¿ãƒ¼ãƒ³${turnCount}ã€‘`,type:'battle'});
              alive.forEach((char) => {
                if (monHp <= 0) return;
                const job = JOBS[char.jobKey];
                const isCritical = Math.random() < (0.05 + char.luk * 0.005);
                const isMiss = Math.random() < 0.08;
                if (isMiss) { battleLogs.push({msg:`${char.name}ã®æ”»æ’ƒã¯å¤–ã‚ŒãŸï¼`,type:'normal'}); return; }
                if (job.spell && char.currentMp >= 2 && Math.random() < 0.35) {
                  const spells = job.spell === 'both' ? [...SPELLS.mage,...SPELLS.priest] : (SPELLS[job.spell]||[]);
                  const atkSpells = spells.filter(s => s.pow > 0 && s.mp <= char.currentMp && s.lv <= Math.floor(char.level/2)+1);
                  if (atkSpells.length > 0) {
                    const spell = atkSpells[Math.floor(Math.random()*atkSpells.length)];
                    let dmg = spell.pow + Math.floor(char.int * 0.5);
                    if (isCritical) dmg = Math.floor(dmg * 1.5);
                    monHp -= dmg;
                    mpUsed[char.id] = (mpUsed[char.id]||0) + spell.mp;
                    battleLogs.push({msg:`${char.name}ã€Œ${spell.name}ã€â†’ ${mon.name}ã«${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼`,type:isCritical?'critical':'special'});
                    soundEngine.playAttack();
                    return;
                  }
                }
                let dmg = Math.max(1, char.atk - mon.def + Math.floor(Math.random()*8));
                if (isCritical) dmg = Math.floor(dmg * 1.5);
                monHp -= dmg;
                battleLogs.push({msg:`${char.name}ã®æ”»æ’ƒ â†’ ${mon.name}ã«${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸${isCritical?' ã€ä¼šå¿ƒã€‘':''}`,type:isCritical?'critical':'battle'});
                soundEngine.playAttack();
              });
              if (monHp > 0) {
                battleLogs.push({msg:`  [${mon.name} HP:${Math.max(0,monHp)}/${monMaxHp}]`,type:'normal'});
                soundEngine.playHit();
                const target = alive[Math.floor(Math.random()*alive.length)];
                const dmg = Math.max(1, mon.atk - target.def + Math.floor(Math.random()*8));
                partyDamage[target.id] = (partyDamage[target.id]||0) + dmg;
                battleLogs.push({msg:`${mon.name}ã®æ”»æ’ƒ â†’ ${target.name}ã«${dmg}ãƒ€ãƒ¡ãƒ¼ã‚¸`,type:'damage'});
              }
              turnCount++;
            }
            if (monHp <= 0) {
              battleLogs.push({msg:`â•â•â• ${mon.name}ã‚’å€’ã—ãŸï¼ â•â•â•`,type:'item'});
              battleLogs.push({msg:`+${mon.exp}EXP / +${mon.gold}G`,type:'item'});
              soundEngine.playGold();
              setGold(prev => prev + mon.gold);
              if (isBoss || Math.random() < 0.12) {
                const drop = getDrop(floor,isBoss,mon.name);
                if (drop) {
                  setInventory(prev => [...prev,drop]);
                  battleLogs.push({msg:`ã€ãƒ‰ãƒ­ãƒƒãƒ—ã€‘${drop.name}`,type:drop.rarity==='legendary'?'boss':'item'});
                }
              }
              setParty(prev => prev.map(char => {
                let updated = {...char};
                if (mpUsed[char.id]) updated.currentMp = Math.max(0, updated.currentMp - mpUsed[char.id]);
                if (partyDamage[char.id]) updated.currentHp = Math.max(0, updated.currentHp - partyDamage[char.id]);
                if (char.currentHp > 0) {
                  const expGain = Math.floor(mon.exp / alive.length);
                  const newExp = updated.exp + expGain;
                  const expNeed = updated.level * 100;
                  if (newExp >= expNeed) {
                    battleLogs.push({msg:`â˜… ${char.name} Lv.${updated.level}â†’${updated.level+1}ï¼`,type:'level'});
                    soundEngine.playLevelUp();
                    const hpUp = 5 + Math.floor(updated.vit*0.5);
                    const mpUp = 3 + Math.floor(updated.int*0.3);
                    updated = {...updated, exp: newExp - expNeed, level: updated.level + 1,
                      maxHp: updated.maxHp + hpUp, currentHp: updated.maxHp + hpUp,
                      maxMp: updated.maxMp + mpUp, currentMp: updated.maxMp + mpUp,
                      atk: updated.atk + 2, def: updated.def + 1};
                  } else { updated.exp = newExp; }
                }
                return updated;
              }));
            }
            battleLogs.forEach((log, i) => setTimeout(() => addLog(log.msg, log.type), i * 60));
          } else if (event < 0.93) {
            if (floor < dngData.floors) {
              const newFloor = floor + 1;
              setFloor(newFloor);
              setMaxFloors(prev => ({...prev,[dungeon]:Math.max(prev[dungeon]||0,newFloor)}));
              addLog(`â”â”â” B${newFloor}Fã¸ â”â”â”`,'item');
              addLog(getFloorDesc(dungeon, newFloor),'explore');
            }
          } else if (event < 0.97) {
            addLog('å®ç®±ã‚’ç™ºè¦‹ï¼','item');
            const hasThief = alive.some(c => c.jobKey === 'thief' || c.jobKey === 'ninja');
            if (Math.random() < (hasThief ? 0.1 : 0.25)) {
              const trap = TRAPS[Math.floor(Math.random()*TRAPS.length)];
              addLog(`ç½ ï¼${trap.name}ãŒç™ºå‹•ï¼`,'damage');
              soundEngine.playHit();
              setParty(p => p.map(c => ({...c, currentHp: Math.max(1, c.currentHp - Math.floor(c.maxHp*trap.dmg))})));
            } else {
              const goldFound = Math.floor(Math.random()*50*floor) + 20;
              setGold(prev => prev + goldFound);
              addLog(`+${goldFound}G`,'item');
              soundEngine.playGold();
            }
          } else {
            addLog('ç¥ç§˜çš„ãªæ³‰ã‚’ç™ºè¦‹ï¼å›å¾©ã—ãŸ','heal');
            soundEngine.playHeal();
            setParty(p => p.map(c => ({...c, currentHp: Math.min(c.maxHp, c.currentHp + Math.floor(c.maxHp*0.3)), currentMp: Math.min(c.maxMp, c.currentMp + Math.floor(c.maxMp*0.3))})));
          }
        }, 1200);
        return () => clearInterval(interval);
      }, [exploring, dungeon, floor, party, retreatHP, addLog]);

      const createChar = () => {
        if (party.length >= 6) return;
        const raceKeys = Object.keys(RACES);
        const raceKey = raceKeys[Math.floor(Math.random()*raceKeys.length)];
        const race = RACES[raceKey];
        const alignKeys = Object.keys(ALIGNMENTS);
        const alignKey = alignKeys[Math.floor(Math.random()*alignKeys.length)];
        const availJobs = Object.entries(JOBS).filter(([_,j]) => j.align.includes(alignKey) && j.tier === 1);
        const [jobKey, job] = availJobs[Math.floor(Math.random()*availJobs.length)];
        const bonus = Math.floor(Math.random()*15)+5;
        const vit = race.vit + Math.floor(bonus*0.4);
        const int = race.int + Math.floor(bonus*0.2);
        const newChar = {
          id: Date.now(), name: genName(raceKey), race: race.name, raceKey,
          alignment: ALIGNMENTS[alignKey].name, alignKey, job: job.name, jobKey,
          level: 1, exp: 0,
          maxHp: Math.floor((vit*3+20)*job.hpMod), currentHp: Math.floor((vit*3+20)*job.hpMod),
          maxMp: Math.floor((int*2+10)*job.mpMod), currentMp: Math.floor((int*2+10)*job.mpMod),
          atk: Math.floor((race.str*1.5+5)*job.atkMod), def: Math.floor((vit*1.2+3)*job.defMod),
          str: race.str, int, pie: race.pie, vit, agi: race.agi, luk: race.luk,
          equipment: {}, previousJobs: []
        };
        setParty(prev => [...prev, newChar]);
        addLog(`${newChar.name}ï¼ˆ${race.name}ã®${job.name}ï¼‰ãŒç™»éŒ²ï¼`,'level');
      };

      const canChangeJob = (char, jobKey) => {
        const job = JOBS[jobKey];
        if (!job.align.includes(char.alignKey)) return {can:false,reason:'å±æ€§ä¸ä¸€è‡´'};
        if (char.level < 10) return {can:false,reason:'Lv10å¿…è¦'};
        for (const [stat,req] of Object.entries(job.req)) if ((char[stat]||0) < req) return {can:false,reason:`${stat}${req}å¿…è¦`};
        return {can:true};
      };
      const changeJob = (charId, newJobKey) => {
        setParty(prev => prev.map(char => {
          if (char.id !== charId) return char;
          const newJob = JOBS[newJobKey];
          soundEngine.playLevelUp();
          addLog(`â˜… ${char.name}ã¯${newJob.name}ã«è»¢è·ï¼`,'level');
          const baseHp = Math.floor((char.vit*3+20)*newJob.hpMod);
          const baseMp = Math.floor((char.int*2+10)*newJob.mpMod);
          return {...char, job: newJob.name, jobKey: newJobKey, level: 1, exp: 0,
            maxHp: baseHp + Math.floor(char.maxHp*0.3), currentHp: baseHp + Math.floor(char.maxHp*0.3),
            maxMp: baseMp + Math.floor(char.maxMp*0.2), currentMp: baseMp + Math.floor(char.maxMp*0.2),
            atk: Math.floor((char.str*1.5+5)*newJob.atkMod), def: Math.floor((char.vit*1.2+3)*newJob.defMod),
            previousJobs: [...(char.previousJobs||[]), char.jobKey]};
        }));
        setShowJobChange(null);
      };

      const equipItem = (charId, item) => {
        const slot = ITEMS.weapons.some(w => w.id === item.id) || (item.id?.startsWith('bd') && item.atk && !item.def) ? 'weapon' 
                   : ITEMS.armors.some(a => a.id === item.id) || (item.id?.startsWith('bd') && item.def && !item.atk) ? 'armor' : 'accessory';
        setParty(prev => prev.map(char => {
          if (char.id !== charId) return char;
          const old = char.equipment[slot];
          let newAtk = char.atk, newDef = char.def;
          if (old) { if (old.atk) newAtk -= old.atk; if (old.def) newDef -= old.def; setInventory(p => [...p, old]); }
          if (item.atk) newAtk += item.atk; if (item.def) newDef += item.def;
          setInventory(p => p.filter(i => i.uid !== item.uid));
          return {...char, atk: newAtk, def: newDef, equipment: {...char.equipment, [slot]: item}};
        }));
      };

      const exportSave = () => { const blob = new Blob([JSON.stringify({party,gold,maxFloors,settings,bestiary,inventory})], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `wizardry-v12-${Date.now()}.json`; a.click(); };

      const JobModal = ({char, onClose}) => {
        if (!char) return null;
        return (
          <div className="modal-overlay" onClick={onClose}>
            <div className="retro-border bg-black p-4 max-w-md max-h-96 overflow-y-auto" onClick={e => e.stopPropagation()}>
              <h3 className="text-lg gold-text mb-3">ğŸ”„ è»¢è· - {char.name}</h3>
              <div className="space-y-2">{Object.entries(JOBS).map(([k,j]) => {
                if (k === char.jobKey) return null;
                const c = canChangeJob(char, k);
                return (<div key={k} className={`p-2 bg-gray-900 ${c.can?'cursor-pointer hover:bg-green-900':'opacity-50'}`} onClick={() => c.can && changeJob(char.id, k)}>
                  <div className="flex justify-between"><span className={j.tier===2?'gold-text':''}>{j.name}</span><span className="text-xs">{c.can?'å¯èƒ½':c.reason}</span></div>
                </div>);
              })}</div>
              <button onClick={onClose} className="mt-4 w-full retro-border py-1 hover:bg-red-900 text-red-400">é–‰ã˜ã‚‹</button>
            </div>
          </div>
        );
      };

      if (screen === 'title') {
        return (
          <div className="min-h-screen flex flex-col items-center justify-center p-4">
            <div className="retro-border p-8 bg-black text-center max-w-md">
              <h1 className="text-3xl mb-2 gold-text">âš”ï¸ WIZARDRY SCHEMA âš”ï¸</h1>
              <p className="text-sm mb-1 text-gray-400">ã€œ ãƒªãƒ«ã‚¬ãƒŸãƒ³ã®è¿·å®® ã€œ</p>
              <p className="text-xs mb-6 text-gray-600">v12.1</p>
              <div className="space-y-3">
                <button onClick={() => {setScreen('main'); initSound();}} className="block w-full retro-border px-6 py-2 hover:bg-green-900">{party.length > 0 ? 'â–¶ CONTINUE' : 'â–¶ NEW GAME'}</button>
                {party.length > 0 && <><button onClick={exportSave} className="block w-full retro-border px-6 py-2 hover:bg-blue-900 text-blue-400">ğŸ“¤ EXPORT</button>
                <button onClick={() => {if(confirm('å‰Šé™¤ï¼Ÿ')){localStorage.removeItem('wizardrySchemaV12');location.reload();}}} className="block w-full retro-border px-6 py-2 hover:bg-red-900 text-red-400">ğŸ—‘ï¸ DELETE</button></>}
              </div>
            </div>
          </div>
        );
      }

      // ===== æ¢ç´¢ä¸­ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ =====
      if (exploring) {
        return (
          <div className="min-h-screen p-2">
            <div className="max-w-6xl mx-auto">
              <div className="retro-border p-2 mb-2 flex justify-between items-center">
                <div className="flex items-center gap-3">
                  <span className="gold-text text-lg">ğŸ° {DUNGEONS.find(d=>d.id===dungeon)?.name}</span>
                  <span className="text-2xl blink">B{floor}F</span>
                </div>
                <div className="flex gap-4 items-center">
                  <span className="gold-text">ğŸ’°{gold.toLocaleString()}G</span>
                  <span className="purple-text">ğŸ“¦{inventory.length}</span>
                  <button onClick={() => {setExploring(false); setFloor(1); setParty(p => p.map(c => ({...c, currentHp: c.maxHp, currentMp: c.maxMp}))); addLog('å¸°é‚„ã—ãŸ','heal');}} className="retro-border px-4 py-1 hover:bg-red-900 text-red-400 text-sm">å¸°é‚„</button>
                </div>
              </div>
              <div className="text-xs text-gray-500 mb-2 px-1">{getFloorDesc(dungeon, floor)}</div>
              <div className="grid lg:grid-cols-4 gap-2">
                {/* å†’é™ºè¨˜éŒ² - å¤§ãã */}
                <div className="lg:col-span-3 retro-border p-3">
                  <h2 className="text-sm mb-2 border-b border-green-800 pb-1">ã€ å†’é™ºè¨˜éŒ² ã€‘</h2>
                  <div ref={logRef} className="h-96 overflow-y-auto bg-black p-2 text-xs log-scroll">
                    {logs.map((l,i) => <p key={i} className={`${l.c} mb-1`}>{l.msg || ' '}</p>)}
                  </div>
                </div>
                {/* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆ */}
                <div className="retro-border p-2">
                  <h2 className="text-sm mb-2 border-b border-green-800 pb-1">ã€ ãƒ‘ãƒ¼ãƒ†ã‚£ ã€‘</h2>
                  <div className="space-y-2">
                    {party.map(char => (
                      <div key={char.id} className={`text-xs p-2 bg-gray-900 ${char.currentHp === 0 ? 'opacity-50' : ''}`}>
                        <div className="flex justify-between mb-1">
                          <span className="font-bold">{char.name}</span>
                          <span className="text-gray-500">Lv.{char.level} {char.job}</span>
                        </div>
                        <div className="flex gap-2 text-[10px]">
                          <span className="red-text">HP:{char.currentHp}/{char.maxHp}</span>
                          <span className="blue-text">MP:{char.currentMp}/{char.maxMp}</span>
                        </div>
                        <div className="w-full bg-gray-700 h-2 mt-1 rounded">
                          <div className="bg-red-500 h-2 rounded" style={{width:`${(char.currentHp/char.maxHp)*100}%`}}/>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // ===== é€šå¸¸æ™‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ =====
      return (
        <div className="min-h-screen p-2">
          {showJobChange && <JobModal char={showJobChange} onClose={() => setShowJobChange(null)} />}
          <div className="max-w-5xl mx-auto">
            <div className="retro-border p-3 mb-3 flex justify-between items-center flex-wrap gap-2">
              <h1 className="text-lg gold-text">âš”ï¸ WIZARDRY SCHEMA</h1>
              <div className="flex gap-4 text-sm items-center">
                <span className="gold-text">ğŸ’°{gold.toLocaleString()}G</span>
                <span className="purple-text">ğŸ“¦{inventory.length}</span>
                <button onClick={() => setShowSettings(!showSettings)} className="text-gray-400 hover:text-white">âš™ï¸</button>
              </div>
            </div>
            {showSettings && (
              <div className="retro-border p-3 mb-3 bg-gray-900 text-xs">
                <div className="grid md:grid-cols-2 gap-4">
                  <div><label className="flex items-center gap-2 mb-2"><input type="checkbox" checked={settings.bgm} onChange={e => setSettings(p => ({...p, bgm: e.target.checked}))} /> BGM</label>
                  <input type="range" min="0" max="100" value={settings.bgmVol} onChange={e => setSettings(p => ({...p, bgmVol: +e.target.value}))} className="w-full" /></div>
                  <div><label className="flex items-center gap-2 mb-2"><input type="checkbox" checked={settings.sfx} onChange={e => {setSettings(p => ({...p, sfx: e.target.checked})); soundEngine.sfxEnabled = e.target.checked;}} /> åŠ¹æœéŸ³</label>
                  <input type="range" min="0" max="100" value={settings.sfxVol} onChange={e => setSettings(p => ({...p, sfxVol: +e.target.value}))} className="w-full" /></div>
                </div>
              </div>
            )}
            <div className="flex gap-1 mb-3 flex-wrap">
              {['dungeon','party','shop','inventory','bestiary'].map(t => (
                <button key={t} onClick={() => setActiveTab(t)} className={`retro-border px-3 py-1 text-xs tab-btn ${activeTab===t?'active':''}`}>
                  {{dungeon:'ğŸ°ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³',party:'ğŸ‘¥ãƒ‘ãƒ¼ãƒ†ã‚£',shop:'ğŸ›’ã‚·ãƒ§ãƒƒãƒ—',inventory:'ğŸ“¦æ‰€æŒå“',bestiary:'ğŸ“–å›³é‘‘'}[t]}
                </button>
              ))}
            </div>
            <div className="retro-border p-4">
              {activeTab === 'dungeon' && (<>
                <h2 className="text-lg mb-3 border-b border-green-800 pb-2">ã€ è¿·å®®å…¥å£ ã€‘</h2>
                <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-2 mb-4">
                  {DUNGEONS.map(d => {
                    const avgLv = party.length > 0 ? Math.floor(party.reduce((a,c) => a+c.level, 0)/party.length) : 0;
                    const canEnter = avgLv >= d.minLv && party.length > 0;
                    return (<button key={d.id} onClick={() => {if (!canEnter) return; setExploring(true); setFloor(1); setLogs([]); addLog(`â”â”â” ${d.name}ã¸ â”â”â”`,'level'); addLog(getFloorDesc(d.id, 1),'explore'); setDungeon(d.id);}} disabled={!canEnter}
                      className={`text-left p-3 text-xs bg-gray-900 ${canEnter?'hover:bg-green-800 cursor-pointer':'opacity-50'}`}>
                      <div className="font-bold">{d.name}</div>
                      <div className="text-gray-500">B{d.floors}F / Lv.{d.minLv}+</div>
                      {maxFloors[d.id] && <div className="text-green-600">æœ€æ·±B{maxFloors[d.id]}F</div>}
                    </button>);
                  })}
                </div>
                <div className="p-2 bg-gray-900 text-xs inline-block"><span>é›¢è„±HP: {retreatHP}%</span><input type="range" min="10" max="50" value={retreatHP} onChange={e => setRetreatHP(+e.target.value)} className="ml-2 w-32" /></div>
              </>)}
              {activeTab === 'party' && (<>
                <h2 className="text-lg mb-3 border-b border-green-800 pb-2">ã€ ã‚®ãƒ«ã‚¬ãƒ¡ãƒƒã‚·ãƒ¥ã®é…’å ´ ã€‘({party.length}/6)</h2>
                <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-2 mb-3">
                  {party.map(char => (
                    <div key={char.id} className="p-3 bg-gray-900 text-xs">
                      <div className="flex justify-between"><span className="font-bold">{char.name}</span><span className={ALIGNMENTS[char.alignKey]?.color}>{char.alignment}</span></div>
                      <div className="text-gray-400">Lv.{char.level} {char.race} {char.job}</div>
                      <div className="mt-2 grid grid-cols-2 gap-1"><span className="red-text">HP:{char.currentHp}/{char.maxHp}</span><span className="blue-text">MP:{char.currentMp}/{char.maxMp}</span><span>ATK:{char.atk}</span><span>DEF:{char.def}</span></div>
                      <div className="w-full bg-gray-700 h-1 mt-1"><div className="bg-red-500 h-1" style={{width:`${(char.currentHp/char.maxHp)*100}%`}}/></div>
                      <div className="mt-1 text-gray-500 text-[10px]">EXP: {char.exp}/{char.level * 100}</div>
                      <div className="mt-1 text-gray-600 text-[10px]">âš”ï¸{char.equipment?.weapon?.name||'-'} ğŸ›¡ï¸{char.equipment?.armor?.name||'-'} ğŸ’{char.equipment?.accessory?.name||'-'}</div>
                      {char.level >= 10 && <button onClick={() => setShowJobChange(char)} className="mt-2 text-[10px] text-cyan-400 hover:underline">ğŸ”„è»¢è·</button>}
                    </div>
                  ))}
                </div>
                <div className="flex gap-2"><button onClick={createChar} disabled={party.length>=6} className="retro-border px-4 py-2 text-sm hover:bg-green-900 disabled:opacity-50">ï¼‹å†’é™ºè€…ç™»éŒ²</button>{party.length > 0 && <button onClick={() => setParty(p => p.slice(0,-1))} className="text-xs text-red-400 hover:underline">è§£é›‡</button>}</div>
              </>)}
              {activeTab === 'shop' && (<>
                <h2 className="text-lg mb-3 border-b border-green-800 pb-2">ã€ ãƒœãƒ«ã‚¿ãƒƒã‚¯å•†åº— ã€‘</h2>
                <div className="flex gap-1 mb-3">{['weapons','armors','accessories','consumables'].map(cat => (<button key={cat} onClick={() => setShopCat(cat)} className={`px-3 py-1 text-xs ${shopCat===cat?'bg-green-900 retro-border':'bg-gray-900'}`}>{{weapons:'âš”ï¸æ­¦å™¨',armors:'ğŸ›¡ï¸é˜²å…·',accessories:'ğŸ’è£…é£¾',consumables:'ğŸ§ªæ¶ˆè€—'}[cat]}</button>))}</div>
                <div className="space-y-1 max-h-64 overflow-y-auto">{ITEMS[shopCat].map((item,i) => { const canBuy = gold >= item.price; return (<div key={i} className={`p-2 text-xs flex justify-between ${canBuy?'bg-gray-900':'bg-gray-900 opacity-50'}`}><div><span className={`rarity-${item.rarity}`}>{item.name}</span><span className="text-gray-500 ml-2">{item.atk?`ATK+${item.atk}`:''}{item.def?`DEF+${item.def}`:''}</span></div><button onClick={() => {if (!canBuy) return; setGold(p => p-item.price); setInventory(p => [...p, {...item, uid: Date.now()}]); soundEngine.playGold();}} disabled={!canBuy} className="gold-text hover:underline disabled:opacity-50">{item.price}G</button></div>);})}</div>
              </>)}
              {activeTab === 'inventory' && (<>
                <h2 className="text-lg mb-3 border-b border-green-800 pb-2">ã€ æ‰€æŒå“ ã€‘({inventory.length})</h2>
                <div className="mb-3"><span className="text-xs text-gray-400">è£…å‚™å…ˆ: </span>{party.map(char => (<button key={char.id} onClick={() => setSelChar(char.id)} className={`px-2 py-1 text-xs mx-1 ${selChar===char.id?'bg-green-900 retro-border':'bg-gray-900'}`}>{char.name}</button>))}</div>
                <div className="space-y-1 max-h-64 overflow-y-auto">{inventory.map(item => (<div key={item.uid} className="p-2 text-xs bg-gray-900 flex justify-between"><div><span className={`rarity-${item.rarity}`}>{item.name}</span><span className="text-gray-500 ml-2">{item.atk?`ATK+${item.atk}`:''}{item.def?`DEF+${item.def}`:''}</span></div><div className="flex gap-2">{selChar && <button onClick={() => equipItem(selChar, item)} className="text-blue-400 hover:underline">è£…å‚™</button>}<button onClick={() => {setGold(p => p + Math.floor((item.price||10)/2)); setInventory(p => p.filter(i => i.uid !== item.uid));}} className="text-yellow-400 hover:underline">å£²å´</button></div></div>))}{inventory.length === 0 && <p className="text-gray-600 text-center py-4">ã‚¢ã‚¤ãƒ†ãƒ ãªã—</p>}</div>
              </>)}
              {activeTab === 'bestiary' && (<>
                <h2 className="text-lg mb-3 border-b border-green-800 pb-2">ã€ ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼å›³é‘‘ ã€‘</h2>
                <div className="grid md:grid-cols-3 lg:grid-cols-4 gap-2">{Object.entries(bestiary).map(([name, d]) => (<div key={name} className="p-2 bg-gray-900 text-xs"><div className="flex justify-between"><span className="font-bold">{d.boss?'ğŸ‘‘':''}{name}</span><span className="text-gray-500">Ã—{d.cnt}</span></div><div className="text-gray-400">HP:{d.hp} ATK:{d.atk}</div></div>))}</div>
              </>)}
            </div>
            <div className="text-center mt-3 text-xs text-gray-600"><button onClick={() => setScreen('title')} className="hover:text-green-400">ã‚¿ã‚¤ãƒˆãƒ«</button></div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
