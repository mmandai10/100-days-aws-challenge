<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wizardry Schema v17.1 - ÊîæÁΩÆÂûãÊé¢Á¥¢RPG</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap');
    /* v14.2: NildaÈ¢®„ÉÄ„Éº„ÇØ„Éï„Ç°„É≥„Çø„Ç∏„ÉºUI */
    body { font-family: 'Noto Serif JP', serif; background: linear-gradient(180deg, #1a1410 0%, #0d0a08 100%); color: #d4c4a8; min-height: 100vh; }
    .retro-border { border: 1px solid #5a4a3a; box-shadow: 0 2px 8px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05); background: rgba(30,25,20,0.9); }
    .log-scroll::-webkit-scrollbar { width: 6px; }
    .log-scroll::-webkit-scrollbar-track { background: #1a1510; }
    .log-scroll::-webkit-scrollbar-thumb { background-color: #5a4a3a; border-radius: 3px; }
    .blink { animation: blink 1.5s infinite; }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }
    .gold-text { color: #ffd700; text-shadow: 0 0 4px rgba(255,215,0,0.3); }
    .red-text { color: #e85555; }
    .blue-text { color: #6ab0ff; }
    .purple-text { color: #b088ff; }
    .tab-btn { transition: all 0.2s; }
    .tab-btn:hover { background-color: #2a2520; }
    .tab-btn.active { background-color: #3a3025; border-color: #8a7a5a; }
    .rarity-common { color: #888888; }
    .rarity-uncommon { color: #5cb85c; }
    .rarity-rare { color: #5bc0de; }
    .rarity-epic { color: #9b59b6; }
    .rarity-legendary { color: #f0ad4e; text-shadow: 0 0 8px #f0ad4e; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 100; }
    /* v14.2: NildaÈ¢®ÊñΩË®≠„Ç´„Éº„Éâ */
    .facility-card { 
      transition: all 0.3s; cursor: pointer; position: relative; overflow: hidden;
      background: linear-gradient(180deg, #2d2520 0%, #1a1512 100%);
      border: 1px solid #4a3a2a; border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    .facility-card:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 6px 20px rgba(200,150,80,0.2);
      border-color: #9a7a4a;
    }
    .facility-card::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,220,150,0.08), transparent); transition: left 0.5s; }
    .facility-card:hover::before { left: 100%; }
    /* Âá∫Áô∫„Ç≤„Éº„ÉàÁâπÂà•„Çπ„Çø„Ç§„É´ */
    .gate-card {
      background: linear-gradient(180deg, #3d2a1a 0%, #2a1a0a 50%, #1a0a00 100%);
      border: 2px solid #a07030;
      box-shadow: 0 0 25px rgba(180,120,40,0.25), inset 0 0 40px rgba(0,0,0,0.4);
    }
    .gate-card:hover {
      border-color: #d4a040;
      box-shadow: 0 0 35px rgba(220,160,60,0.35), inset 0 0 40px rgba(0,0,0,0.4);
      transform: translateY(-4px);
    }
    .back-btn { position: fixed; bottom: 20px; right: 20px; z-index: 50; }
    /* „Éú„Çø„É≥„Çπ„Çø„Ç§„É´ */
    button { font-family: 'Noto Serif JP', serif; }
    .btn-fantasy { background: linear-gradient(180deg, #3d3025 0%, #2a2015 100%); border: 1px solid #5a4a3a; color: #d4c4a8; border-radius: 4px; }
    .btn-fantasy:hover { background: linear-gradient(180deg, #4d4035 0%, #3a3025 100%); border-color: #8a7a5a; }
    .btn-danger { background: linear-gradient(180deg, #4a2520 0%, #3a1510 100%); border: 1px solid #6a4540; color: #e8a0a0; border-radius: 4px; }
    .btn-danger:hover { background: linear-gradient(180deg, #5a3530 0%, #4a2520 100%); }
    /* „Ç≠„É£„É©„Ç´„Éº„Éâ */
    .char-card { background: linear-gradient(180deg, #252018 0%, #1a1510 100%); border: 1px solid #3a3020; border-radius: 6px; }
    /* „Çª„ÇØ„Ç∑„Éß„É≥„Çø„Ç§„Éà„É´ */
    .section-title { color: #a08060; font-weight: 700; letter-spacing: 0.05em; }
    /* v14.4: „Ç™„Éº„Éó„Éã„É≥„Ç∞ÊºîÂá∫ */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slowScroll { from { transform: translateY(100%); } to { transform: translateY(-100%); } }
    @keyframes textGlow { 0%, 100% { text-shadow: 0 0 10px rgba(200,160,96,0.5); } 50% { text-shadow: 0 0 20px rgba(200,160,96,0.8), 0 0 40px rgba(200,160,96,0.4); } }
    .opening-container { position: fixed; inset: 0; background: linear-gradient(180deg, #0a0806 0%, #1a1410 50%, #0a0806 100%); overflow: hidden; }
    .opening-text { animation: slowScroll 45s linear forwards; }
    .opening-title { animation: fadeIn 3s ease-out, textGlow 4s ease-in-out infinite; }
    .skip-btn { position: fixed; bottom: 30px; right: 30px; opacity: 0.6; transition: opacity 0.3s; }
    .skip-btn:hover { opacity: 1; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ===== v14.4: „Éê„É≠„ÉÉ„ÇØË™ø„Ç¢„É≥„Éì„Ç®„É≥„ÉàBGM =====
    class SoundEngine {
      constructor() { 
        this.initialized = false; 
        this.bgmEnabled = true; 
        this.sfxEnabled = true; 
        this.bgmVolume = -16; 
        this.sfxVolume = -12; 
        this.isPlaying = false;
        this.currentTheme = 'town';
        this.chordIdx = 0;
        this.measureCount = 0;
      }
      
      // „ÉÄ„É≥„Ç∏„Éß„É≥Âà•„ÉÜ„Éº„ÉûÔºà„Éê„É≠„ÉÉ„ÇØË™ø„Ç≥„Éº„ÉâÈÄ≤Ë°åÔºâ
      themes = {
        town: { // Ë°ó - Á©è„ÇÑ„Åã„Å™„Éê„É≠„ÉÉ„ÇØ
          chords: [['D3','F3','A3'],['G2','B2','D3'],['C3','E3','G3'],['A2','C3','E3'],['D3','F3','A3'],['G2','B2','D3'],['E2','G2','B2'],['A2','C3','E3']],
          special: [['F3','A3','C4'],['G3','B3','D4'],['A3','C4','E4']], // Â§âÂåñÁêÉ
          tempo: 3500
        },
        slime: { // „Çπ„É©„Ç§„É† - Êòé„Çã„ÅÑÊé¢Á¥¢
          chords: [['C3','E3','G3'],['F2','A2','C3'],['G2','B2','D3'],['C3','E3','G3'],['A2','C3','E3'],['D3','F3','A3'],['G2','B2','D3'],['C3','E3','G3']],
          special: [['E3','G3','B3'],['F3','A3','C4']],
          tempo: 3200
        },
        kobold: { // „Ç≥„Éú„É´„Éâ - Á∑äÂºµÊÑü
          chords: [['D3','F3','A3'],['A2','C3','E3'],['Bb2','D3','F3'],['A2','C3','E3'],['D3','F3','A3'],['G2','Bb2','D3'],['A2','C3','E3'],['D3','F3','A3']],
          special: [['E3','G#3','B3'],['F3','A3','C4']],
          tempo: 3000
        },
        thieves: { // ÁõóË≥ä - Á•ûÁßòÁöÑ
          chords: [['E2','G2','B2'],['A2','C3','E3'],['D3','F3','A3'],['G2','B2','D3'],['C3','E3','G3'],['F2','A2','C3'],['B2','D3','F3'],['E2','G2','B2']],
          special: [['Ab2','C3','Eb3'],['Bb2','D3','F3']],
          tempo: 3800
        },
        sewer: { // ‰∏ãÊ∞¥ÈÅì - ‰∏çÊ∞óÂë≥
          chords: [['A2','C3','E3'],['E2','G2','B2'],['F2','A2','C3'],['D2','F2','A2'],['A2','C3','E3'],['G2','Bb2','D3'],['F2','A2','C3'],['E2','G2','B2']],
          special: [['Eb2','Gb2','Bb2'],['Ab2','C3','Eb3']],
          tempo: 4200
        },
        kaoka: { // ÈÅ∫Ë∑° - Âè§‰ª£„ÅÆÁ•ûÁßò
          chords: [['D3','F#3','A3'],['G2','B2','D3'],['E3','G3','B3'],['A2','C#3','E3'],['D3','F#3','A3'],['B2','D3','F#3'],['E3','G3','B3'],['A2','C#3','E3']],
          special: [['F#3','A3','C#4'],['B3','D4','F#4']],
          tempo: 4000
        },
        deltis: { // Â§ßËîµÂÆ§ - Ë±™ËèØ
          chords: [['G3','B3','D4'],['D3','F#3','A3'],['E3','G3','B3'],['A2','C#3','E3'],['G3','B3','D4'],['C3','E3','G3'],['D3','F#3','A3'],['G2','B2','D3']],
          special: [['E3','G#3','B3'],['A3','C#4','E4'],['D4','F#4','A4']],
          tempo: 3500
        },
        dragon: { // Á´ú„ÅÆÁ•ûÊÆø - ËçòÂé≥
          chords: [['C3','Eb3','G3'],['Ab2','C3','Eb3'],['Bb2','D3','F3'],['G2','Bb2','D3'],['C3','Eb3','G3'],['F2','Ab2','C3'],['G2','Bb2','D3'],['C3','Eb3','G3']],
          special: [['Db3','F3','Ab3'],['Eb3','G3','Bb3'],['F3','A3','C4']],
          tempo: 4500
        },
        trebor: { // ÊúÄÁµÇ - Áµ∂Êúõ„Å®Â∏åÊúõ
          chords: [['D3','F3','A3'],['Bb2','D3','F3'],['G2','Bb2','D3'],['A2','C#3','E3'],['D3','F3','A3'],['C3','E3','G3'],['Bb2','D3','F3'],['A2','C#3','E3']],
          special: [['E3','G#3','B3'],['F3','A3','C4'],['G3','B3','D4']],
          tempo: 5000
        }
      };
      
      async init() {
        if (this.initialized) return;
        await Tone.start();
        // „Éê„É≠„ÉÉ„ÇØË™ø„Ç™„É´„Ç¨„É≥È¢®„Ç∑„É≥„Çª
        this.padSynth = new Tone.PolySynth(Tone.Synth, {
          oscillator: { type: 'sine' },
          envelope: { attack: 1.5, decay: 0.8, sustain: 0.7, release: 2.5 }
        }).toDestination();
        this.padSynth.volume.value = this.bgmVolume;
        // È´òÈü≥„É°„É≠„Éá„Ç£Áî®ÔºàÂ§âÂåñÁêÉÔºâ
        this.melodySynth = new Tone.Synth({
          oscillator: { type: 'triangle' },
          envelope: { attack: 0.5, decay: 0.3, sustain: 0.4, release: 1.5 }
        }).toDestination();
        this.melodySynth.volume.value = this.bgmVolume - 6;
        // SEÁî®„Ç∑„É≥„Çª
        this.sfxSynth = new Tone.Synth({
          oscillator: { type: 'sine' },
          envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.5 }
        }).toDestination();
        this.sfxSynth.volume.value = this.sfxVolume;
        this.initialized = true;
      }
      
      setBgmVolume(v) { 
        this.bgmVolume = v; 
        if (this.padSynth) this.padSynth.volume.value = v; 
        if (this.melodySynth) this.melodySynth.volume.value = v - 6;
      }
      setSfxVolume(v) { this.sfxVolume = v; if (this.sfxSynth) this.sfxSynth.volume.value = v; }
      
      startBGM(theme = 'town') {
        if (!this.initialized || !this.bgmEnabled) return;
        if (this.isPlaying) this.stopBGM();
        
        this.currentTheme = theme;
        const t = this.themes[theme] || this.themes.town;
        this.chordIdx = 0;
        this.measureCount = 0;
        
        // ÊúÄÂàù„ÅÆ„Ç≥„Éº„Éâ„ÇíÂç≥Â∫ß„Å´ÂÜçÁîü
        this.padSynth.triggerAttackRelease(t.chords[0], '2n');
        this.chordIdx = 1;
        
        this.bgmInterval = setInterval(() => {
          if (!this.bgmEnabled) return;
          this.measureCount++;
          
          // 12Âõû„Å´1ÂõûÂ§âÂåñÁêÉÔºàÁâπÊÆä„Ç≥„Éº„ÉâÔºâ
          if (this.measureCount % 12 === 0 && t.special && Math.random() < 0.5) {
            const special = t.special[Math.floor(Math.random() * t.special.length)];
            this.padSynth.triggerAttackRelease(special, '2n');
            // „É°„É≠„Éá„Ç£Èü≥„ÇÇËøΩÂä†
            setTimeout(() => {
              if (this.bgmEnabled) this.melodySynth.triggerAttackRelease(special[2], '4n');
            }, 800);
          } else {
            const chord = t.chords[this.chordIdx % t.chords.length];
            this.padSynth.triggerAttackRelease(chord, '2n');
            this.chordIdx++;
          }
        }, t.tempo);
        
        this.isPlaying = true;
      }
      
      changeBGM(theme) {
        if (this.currentTheme === theme) return;
        this.startBGM(theme);
      }
      
      stopBGM() { 
        if (this.bgmInterval) { clearInterval(this.bgmInterval); this.bgmInterval = null; } 
        this.isPlaying = false; 
      }
      toggleBGM(e) { this.bgmEnabled = e; if (e && this.initialized) this.startBGM(this.currentTheme); else this.stopBGM(); }
      
      // SE
      playClick() { if (this.initialized && this.sfxEnabled) this.sfxSynth.triggerAttackRelease('E5','32n'); }
      playLevelUp() { if (this.initialized && this.sfxEnabled) { this.sfxSynth.triggerAttackRelease('C5','8n'); setTimeout(() => this.sfxSynth.triggerAttackRelease('E5','8n'), 150); setTimeout(() => this.sfxSynth.triggerAttackRelease('G5','4n'), 300); } }
      playBossClear() { if (this.initialized && this.sfxEnabled) { ['C4','E4','G4','C5'].forEach((n,i) => setTimeout(() => this.sfxSynth.triggerAttackRelease(n,'4n'), i*200)); } }
      // ‰∫íÊèõÊÄßÁî®Á©∫Èñ¢Êï∞
      playAttack() {}
      playHit() {}
      playHeal() {}
      playGold() {}
      playDeath() {}
      playBoss() {}
      playClear() { this.playBossClear(); }
      playCritical() {}
    }
    const soundEngine = new SoundEngine();

    // ===== ÂêçÂâçÁîüÊàê =====
    const NAME_PARTS = {
      human: { prefix: ['„Ç¢„É´','„Éô„É´','„Ç´„Ç§','„ÉÄ„É≥','„Ç®„É´','„Éï„Ç£„É≥','„Ç¨„É´','„Éè„É´','„Ç§„É´','„Ç∏„Çß','„Ç±„Ç§','„É¨„Ç™'], suffix: ['„Çπ','„É≥','„Éâ','„ÇØ','„Éà','„É´','„É™„Ç¢','„Éä','„É¥„Ç£','„Ç¶„Çπ','„Ç™„É≥'] },
      elf: { prefix: ['„Ç®„Ç¢','„Çª„É¨','„Ç¨„É©','„É¨„Ç¥','„Ç¢„É©','„Ç®„É´','„Éï„Çß„Ç¢','„ÇÆ„É´','„É™„É≥','„É´„Éº'], suffix: ['„Ç¶„Çß„É≥','„Éá„Ç£„É´','„É©„Çπ','„Éü„Ç¢','„Éé„Éº„É´','„É™„Ç™„É≥','„Ç¶„Ç£„É≥','„É≠„Çπ','„Éï„Ç£„É≥'] },
      dwarf: { prefix: ['„Éâ„Ç•','„Éê„É´','„ÇÆ„É†','„Éà„Éº','„Éñ„É≠','„ÉÄ„Ç§','„Éï„Ç°','„Ç∞„É≠','„Ç´„Ç∂','„É¢„Éº'], suffix: ['„É™„É≥','„Ç§„É≥','„É™','„É´','„É†','„Éâ','„Ç∞','„ÇØ','„Éú„É´','„ÉÄ„É´'] },
      gnome: { prefix: ['„Éï„Ç£','„Ç∏„É≥','„Éú„Éú','„Éã„É†','„Ç¨„Éº','„Éî„ÉÉ','„ÉÜ„Ç£„É≥','„Ç¶„Ç£','„Ç∂„É≥','„É™„É™'], suffix: ['„ÉÉ„ÇØ','„Çπ','„Éñ„É´','„Éâ„É´','„É™„ÉÉ„ÇØ','„Éê„Çπ','„Éà„É≥','„Ç∫„É´','„É≥„ÇØ'] },
      porkul: { prefix: ['„Éë„ÉÉ','„Éî„ÉÉ','„Éó„É´','„Éö„Ç≥','„Éù„É≥','„Éõ„Éì','„É≠„Éº','„Çµ„É†','„Éï„É≠','„É°„É™'], suffix: ['„Éâ','„Éà','„É≥','„É´','„Çπ','„Éú','„Ç¥','„É≠','„Ç∏„Éº','„Ç∑„Éº'] }
    };
    const genName = (race) => { const p = NAME_PARTS[race] || NAME_PARTS.human; return p.prefix[Math.floor(Math.random()*p.prefix.length)] + p.suffix[Math.floor(Math.random()*p.suffix.length)]; };

    // ===== „Ç≤„Éº„É†„Éá„Éº„Çø =====
    // v13.3: Á®ÆÊóè„Éá„Éº„Çø„ÇíWikiÊú¨ÂÆ∂(wiz.gamerch.com)„Å´Ê∫ñÊã†
    const RACES = {
      human: { name: '‰∫∫Èñì', str: 8, vit: 7, int: 8, pie: 6, agi: 6, luk: 7, trait: { expBonus: 0.3, desc: 'EXP+30%' } },
      elf: { name: '„Ç®„É´„Éï', str: 6, vit: 5, int: 10, pie: 8, agi: 8, luk: 6, trait: { magicBonus: 0.2, desc: 'È≠îÊ≥ïÊîªÊíÉ+20%' } },
      dwarf: { name: '„Éâ„ÉØ„Éº„Éï', str: 10, vit: 9, int: 6, pie: 9, agi: 4, luk: 6, trait: { atkBonus: 0.15, defBonus: 0.1, desc: 'ATK+15% DEF+10%' } },
      gnome: { name: '„Éé„Éº„É†', str: 7, vit: 8, int: 7, pie: 10, agi: 7, luk: 7, trait: { healBonus: 0.2, magicResist: 0.1, desc: 'ÂõûÂæ©È≠îÊ≥ï+20%' } },
      porkul: { name: '„Éù„Éº„ÇØ„É´', str: 5, vit: 4, int: 5, pie: 6, agi: 9, luk: 8, trait: { critBonus: 0.1, desc: '‰ºöÂøÉÁéá+10%' } }
    };
    const ALIGNMENTS = { lawful: { name: 'Áß©Â∫è', color: 'text-blue-400' }, neutral: { name: '‰∏≠Á´ã', color: 'text-gray-400' }, chaotic: { name: 'Ê∑∑Ê≤å', color: 'text-red-400' } };
    const JOBS = {
      fighter: { name: 'Êà¶Â£´', hpMod: 1.5, mpMod: 0.2, atkMod: 1.4, defMod: 1.3, align: ['lawful','neutral','chaotic'], spell: null, tier: 1, req: {} },
      mage: { name: 'È≠îË°ìÂ∏´', hpMod: 0.6, mpMod: 1.8, atkMod: 0.6, defMod: 0.5, align: ['lawful','neutral','chaotic'], spell: 'mage', tier: 1, req: {} },
      priest: { name: 'ÂÉß‰æ∂', hpMod: 0.9, mpMod: 1.4, atkMod: 0.8, defMod: 0.9, align: ['lawful','chaotic'], spell: 'priest', tier: 1, req: {} },
      thief: { name: 'ÁõóË≥ä', hpMod: 0.8, mpMod: 0.5, atkMod: 1.0, defMod: 0.7, align: ['neutral','chaotic'], spell: null, tier: 1, req: {} },
      bishop: { name: 'Âè∏Êïô', hpMod: 0.7, mpMod: 1.6, atkMod: 0.7, defMod: 0.6, align: ['lawful','chaotic'], spell: 'both', tier: 2, req: { int: 12, pie: 12 } },
      samurai: { name: '‰æç', hpMod: 1.3, mpMod: 0.8, atkMod: 1.3, defMod: 1.1, align: ['lawful','neutral'], spell: 'mage', tier: 2, req: { str: 15, int: 11, vit: 14 } },
      lord: { name: 'Âêõ‰∏ª', hpMod: 1.4, mpMod: 1.0, atkMod: 1.2, defMod: 1.2, align: ['lawful'], spell: 'priest', tier: 2, req: { str: 15, pie: 12, vit: 15 } },
      ninja: { name: 'ÂøçËÄÖ', hpMod: 1.0, mpMod: 0.6, atkMod: 1.5, defMod: 0.8, align: ['chaotic'], spell: null, tier: 2, req: { str: 15, int: 17, agi: 15 } }
    };
    const SPELLS = {
      mage: [{name:'„Éè„É™„Éà',lv:1,mp:2,pow:15},{name:'„É¢„Ç∞„É¨„Éï',lv:2,mp:3,pow:0,buff:'def'},{name:'„Éû„Éè„É™„Éà',lv:3,mp:5,pow:25},{name:'„É©„Éè„É™„Éà',lv:5,mp:7,pow:40},{name:'„ÉÄ„É´„Éà',lv:6,mp:8,pow:50},{name:'„Éû„ÉÄ„É´„Éà',lv:7,mp:12,pow:65},{name:'„ÉÜ„Ç£„É´„Éà„Ç¶„Çß„Ç§„Éà',lv:8,mp:15,pow:80}],
      priest: [{name:'„Éá„Ç£„Ç™„Çπ',lv:1,mp:2,pow:0,heal:25},{name:'„Éê„Éá„Ç£„Ç™„Çπ',lv:1,mp:2,pow:12},{name:'„Éû„Ç¶„Ç∏',lv:2,mp:3,pow:0,buff:'atk'},{name:'„Éá„Ç£„Ç¢„É´',lv:3,mp:4,pow:0,heal:40},{name:'„Éê„Éá„Ç£„Ç¢„É´',lv:4,mp:5,pow:25},{name:'„Éû„Éá„Ç£',lv:5,mp:8,pow:0,heal:80},{name:'„Éê„Éû„Éá„Ç£',lv:6,mp:10,pow:45},{name:'„Éû„Éá„Ç£„Ç¢„É´',lv:7,mp:15,pow:0,healAll:50}]
    };

    // ===== „ÉÄ„É≥„Ç∏„Éß„É≥È¢®ÊôØÊèèÂÜô =====
    const DUNGEON_ATMOSPHERE = {
      slime: { name: '„Çπ„É©„Ç§„É†„ÅÆÁ©¥', rooms: ['Áã≠„ÅÑÂúü„ÅÆÊ®™Á©¥','Êπø„Å£„ÅüÊ¥ûÁ™ü','Á≤òÊ∂≤„ÅßË¶Ü„Çè„Çå„ÅüÂ∞èÈÉ®Â±ã'], floors: { 1: { desc: 'ÂÖ•Âè£‰ªòËøë„ÄÇÂúü„ÅÆÂåÇ„ÅÑ„ÅåÈºª„ÇíÁ™Å„Åè„ÄÇ' }, 5: { desc: '„Äê„Éú„ÇπÈöéÂ±§„Äë„Çπ„É©„Ç§„É†„Ç≠„É≥„Ç∞„ÅÆÁéâÂ∫ß„ÅÆÈñì„ÄÇ' } } },
      kobold: { name: '„Ç≥„Éú„É´„Éâ„ÅÆÂ∑£', rooms: ['Êéò„ÇäÊäú„Åã„Çå„ÅüÂ∞èÈÉ®Â±ã','Ê≠¶Âô®Â∫´','Ë¶ãÂºµ„ÇäÂè∞'], floors: { 1: { desc: 'Â∑£„ÅÆÂÖ•Âè£„ÄÇË≠¶Êàí„ÅÆÊ∞óÈÖç„Åå„ÅÇ„Çã„ÄÇ' }, 8: { desc: '„Äê„Éú„ÇπÈöéÂ±§„Äë„Ç≥„Éú„É´„Éà„É≠„Éº„Éâ„ÅÆË¨ÅË¶ã„ÅÆÈñì„ÄÇ' } } },
      thieves: { name: 'ÁõóË≥ä„ÅÆ„Ç¢„Ç∏„Éà', rooms: ['Èö†„ÅóÈÉ®Â±ã','ÂÆùÁâ©Â∫´','ÈÖíÂ†¥'], floors: { 1: { desc: 'ÂÅΩË£Ö„Åï„Çå„ÅüÂÖ•Âè£„ÄÇÁΩ†„Å´Ê≥®ÊÑè„ÄÇ' }, 10: { desc: '„Äê„Éú„ÇπÈöéÂ±§„Äë„Éû„Çπ„Çø„Éº„Ç∑„Éº„Éï„ÅÆÈö†„ÇåÂÆ∂„ÄÇ' } } },
      sewer: { name: '„Ç´„É™„Ç∞„É©„Éº„Çº‰∏ãÊ∞¥Ë∑Ø', rooms: ['Ê±öÊ∞¥Ë∑Ø','ÊµÑÂåñÊßΩ','ÁÆ°ÁêÜÂÆ§'], floors: { 1: { desc: '‰∏ãÊ∞¥„ÅÆÂÖ•Âè£„ÄÇÊÇ™Ëá≠„ÅåÈºª„ÇíÁ™Å„Åè„ÄÇ' }, 12: { desc: '„Äê„Éú„ÇπÈöéÂ±§„Äë„É¥„Ç°„É≥„Éë„Ç§„Ç¢„ÅÆÁéâÂ∫ß„ÅÆÈñì„ÄÇ' } } },
      kaoka: { name: '„Ç´„Ç™„Ç´„Éª„Éë„É©„Éº„Ç∏ÈÅ∫Ë∑°', rooms: ['Â¥©„Çå„ÅüÁ•ûÊÆø','ÂÆùÁâ©Â∫´','Á•≠Âè∏„ÅÆÈñì'], floors: { 1: { desc: 'ÈÅ∫Ë∑°„ÅÆÂÖ•Âè£„ÄÇÂè§‰ª£„ÅÆÂ®ÅÂé≥„ÇíÊÑü„Åò„Çã„ÄÇ' }, 15: { desc: '„Äê„Éú„ÇπÈöéÂ±§„Äë„Ç∞„É¨„Éº„Çø„Éº„Éá„Éº„É¢„É≥„ÅÆÂ∞ÅÂç∞„ÅÆÈñì„ÄÇ' } } },
      deltis: { name: '„Éá„É´„Éá„Ç£„ÇπÂ§ßËîµÂÆ§', rooms: ['ÈáëË≤®„ÅÆÂ±±','ÂÆùÁü≥„ÅÆÈñì','ÁéãÂÜ†„ÅÆÈÉ®Â±ã'], floors: { 1: { desc: 'Â§ßËîµÂÆ§„ÅÆÂÖ•Âè£„ÄÇÈªÑÈáë„ÅÆËºù„Åç„ÅåË¶ã„Åà„Çã„ÄÇ' }, 18: { desc: '„Äê„Éú„ÇπÈöéÂ±§„Äë„Ç¥„Éº„É´„Éâ„Éâ„É©„Ç¥„É≥„ÅÆÂÆùÁâ©Â∫´„ÄÇ' } } },
      dragon: { name: 'ÈªÑÈæç„ÅÆÁ•ûÊÆøË∑°', rooms: ['Á´úÈ™®„ÅÆÂõûÂªä','ÁÇé„ÅÆË©¶Á∑¥Â†¥','Ê∞∑„ÅÆÈñì'], floors: { 1: { desc: 'Á•ûÊÆø„ÅÆÂÖ•Âè£„ÄÇÁ´ú„ÅÆÂ®ÅÂé≥„ÅåÊºÇ„ÅÜ„ÄÇ' }, 20: { desc: '„Äê„Éú„ÇπÈöéÂ±§„Äë„Ç®„É≥„Ç∑„Çß„É≥„Éà„Éâ„É©„Ç¥„É≥„ÅÆËÅñÂüü„ÄÇ' } } },
      trebor: { name: '„Éà„É¨„Éú„Éº„ÅÆË©¶Á∑¥Â†¥', rooms: ['Ë¶™Ë°õÈöä„ÅÆË©∞ÊâÄ','È≠îÊ≥ï„ÅÆËø∑Ë∑Ø','Ê≠ª„ÅÆÂõûÂªä'], floors: { 1: { desc: 'Ë©¶Á∑¥Â†¥„ÅÆÂÖ•Âè£„ÄÇÊúÄÂº∑„ÅÆÊà¶Â£´„Åü„Å°„ÅåÂæÖ„Å§„ÄÇ' }, 25: { desc: '„ÄêÊúÄÁµÇ„Éú„ÇπÈöéÂ±§„Äë„ÉØ„Éº„Éâ„Éä„ÅÆÁéâÂ∫ß„ÅÆÈñì„ÄÇ' } } }
    };

    const getFloorDesc = (dng, floor) => {
      const d = DUNGEON_ATMOSPHERE[dng];
      if (!d) return '';
      const floorData = d.floors[floor] || d.floors[Object.keys(d.floors).reduce((a,b) => Math.abs(b-floor) < Math.abs(a-floor) ? b : a)];
      return floorData?.desc || '';
    };

    // ===== Ë£ÖÂÇôÂìÅ =====
    const ITEMS = {
      weapons: [
        {id:'w001',name:'Êü≥„ÅÆÊ£í',atk:1,price:8,rarity:'common'},{id:'w016',name:'Ê®´„ÅÆÊ£í',atk:5,price:60,rarity:'common'},
        {id:'w025',name:'‰∏ñÁïåÊ®π„ÅÆÊùñ',atk:32,price:15000,rarity:'epic',jobs:['mage','bishop','priest']},
        {id:'w046',name:'Á´úÈ™®„ÅÆÂâ£',atk:26,price:4000,rarity:'rare'},{id:'w053',name:'Á•ûÁç£È™®„ÅÆÂâ£',atk:55,price:60000,rarity:'legendary'},
        {id:'w074',name:'Á≤æÈäÖ„ÅÆÂâ£',atk:6,price:90,rarity:'common'},{id:'w091',name:'ÈùíÈäÖ„ÅÆÂâ£',atk:11,price:320,rarity:'uncommon'},
        {id:'w103',name:'Èå¨ÈâÑ„ÅÆÂâ£',atk:14,price:500,rarity:'uncommon'},{id:'w114',name:'ÁéâÈãº„ÅÆÊâìÂàÄ',atk:24,price:2800,rarity:'rare',jobs:['samurai','ninja']},
        {id:'w117',name:'„ÉÄ„Éû„Çπ„Ç´„ÇπÈãº„ÅÆÂâ£',atk:26,price:4500,rarity:'rare'},{id:'w121',name:'ÈöïÈâÑ„ÅÆÂâ£',atk:34,price:9000,rarity:'epic'},
        {id:'w150',name:'„Éü„Çπ„É™„É´„ÇΩ„Éº„Éâ',atk:35,price:8000,rarity:'epic'},{id:'w160',name:'„Ç™„É™„Éè„É´„Ç≥„É≥„ÇΩ„Éº„Éâ',atk:48,price:25000,rarity:'epic'},
        {id:'w172',name:'„Ç®„ÇØ„Çπ„Ç´„É™„Éê„Éº',atk:60,price:60000,rarity:'epic',jobs:['lord']},{id:'w186',name:'Á•ûÊÆ∫„Åó„ÅÆÂâ£',atk:99,price:999999,rarity:'legendary'}
      ],
      armors: [
        {id:'a001',name:'Â∏É„ÅÆÊúç',def:1,price:15,rarity:'common'},{id:'a007',name:'Èù©Èéß',def:4,price:100,rarity:'common'},
        {id:'a014',name:'Ê®´„ÅÆÁõæ',def:4,price:80,rarity:'common'},{id:'a025',name:'Á´úÈ™®„ÅÆÈéß',def:24,price:5500,rarity:'rare'},
        {id:'a047',name:'ÈùíÈäÖ„ÅÆÈéß',def:10,price:480,rarity:'uncommon'},{id:'a056',name:'„ÉÅ„Çß„Ç§„É≥„É°„Ç§„É´',def:12,price:600,rarity:'uncommon'},
        {id:'a062',name:'ÈöïÈâÑ„ÅÆÈéß',def:35,price:16000,rarity:'epic'},{id:'a080',name:'„Éü„Çπ„É™„É´„É°„Ç§„É´',def:32,price:10000,rarity:'epic'},
        {id:'a085',name:'„Ç™„É™„Éè„É´„Ç≥„É≥„Ç¢„Éº„Éû„Éº',def:48,price:35000,rarity:'epic'},{id:'a097',name:'Á•û„ÄÖ„ÅÆÈéß',def:75,price:300000,rarity:'legendary'}
      ],
      accessories: [
        {id:'c001',name:'Êü≥„ÅÆ„ÅäÂÆà„Çä',def:1,price:20,rarity:'common'},{id:'c010',name:'ÈäÖ„ÅÆÊåáËº™',atk:1,price:40,rarity:'common'},
        {id:'c016',name:'ÈäÄ„ÅÆÊåáËº™',atk:5,def:5,price:800,rarity:'rare'},{id:'c018',name:'„Éü„Çπ„É™„É´„É™„É≥„Ç∞',atk:10,def:10,price:8000,rarity:'epic'},
        {id:'c030',name:'„Éâ„É©„Ç¥„É≥„É™„É≥„Ç∞',atk:12,def:12,price:15000,rarity:'epic'},{id:'c041',name:'„Ç§„É≥„Éï„Ç£„Éã„ÉÜ„Ç£„Ç¨„É≥„Éà„É¨„ÉÉ„Éà',atk:30,def:30,price:400000,rarity:'legendary'}
      ],
      consumables: [
        {id:'p001',name:'„Éù„Éº„Ç∑„Éß„É≥',price:50,rarity:'common',heal:30},
        {id:'p002',name:'„Éè„Ç§„Éù„Éº„Ç∑„Éß„É≥',price:200,rarity:'uncommon',heal:100},
        {id:'p003',name:'„Ç®„É™„ÇØ„Çµ„Éº',price:500,rarity:'rare',heal:9999}
      ]
    };

    const BOSS_DROPS = {
      '„Çπ„É©„Ç§„É†„Ç≠„É≥„Ç∞': [{id:'bd01',name:'„Çπ„É©„Ç§„É†„ÅÆÁéãÂÜ†',atk:3,def:3,price:500,rarity:'uncommon'}],
      '„Ç≥„Éú„É´„Éà„É≠„Éº„Éâ': [{id:'bd03',name:'„Ç≥„Éú„É´„Éà„ÅÆÂÆùÁè†',atk:5,def:2,price:800,rarity:'uncommon'}],
      '„Éû„Çπ„Çø„Éº„Ç∑„Éº„Éï': [{id:'bd06',name:'ÂΩ±„ÅÆ„Éû„É≥„Éà',def:10,price:1800,rarity:'rare',jobs:['thief','ninja']}],
      '„É¥„Ç°„É≥„Éë„Ç§„Ç¢': [{id:'bd09',name:'Âê∏Ë°ÄÈ¨º„ÅÆÁâô',atk:18,price:2800,rarity:'rare'}],
      '„Ç∞„É¨„Éº„Çø„Éº„Éá„Éº„É¢„É≥': [{id:'bd12',name:'ÊÇ™È≠î„ÅÆËßí',atk:22,def:8,price:5000,rarity:'epic'}],
      '„Ç¥„Éº„É´„Éâ„Éâ„É©„Ç¥„É≥': [{id:'bd15',name:'ÈªÑÈáë„ÅÆÈ±ó',def:25,price:10000,rarity:'epic'}],
      '„Ç®„É≥„Ç∑„Çß„É≥„Éà„Éâ„É©„Ç¥„É≥': [{id:'bd20',name:'ÊôÇ„ÅÆÈ±ó',atk:25,def:25,price:25000,rarity:'legendary'}],
      '„ÉØ„Éº„Éâ„Éä': [{id:'bd21',name:'È≠îÈô§„Åë„ÅÆË≠∑Á¨¶',atk:30,def:30,price:60000,rarity:'legendary'}]
    };

    const DUNGEONS = [
      {id:'slime',name:'„Çπ„É©„Ç§„É†„ÅÆÁ©¥',floors:5,minLv:1},
      {id:'kobold',name:'„Ç≥„Éú„É´„Éâ„ÅÆÂ∑£',floors:8,minLv:3},
      {id:'thieves',name:'ÁõóË≥ä„ÅÆ„Ç¢„Ç∏„Éà',floors:10,minLv:5},
      {id:'sewer',name:'„Ç´„É™„Ç∞„É©„Éº„Çº‰∏ãÊ∞¥Ë∑Ø',floors:12,minLv:8},
      {id:'kaoka',name:'„Ç´„Ç™„Ç´„Éª„Éë„É©„Éº„Ç∏ÈÅ∫Ë∑°',floors:15,minLv:12},
      {id:'deltis',name:'„Éá„É´„Éá„Ç£„ÇπÂ§ßËîµÂÆ§',floors:18,minLv:16},
      {id:'dragon',name:'ÈªÑÈæç„ÅÆÁ•ûÊÆøË∑°',floors:20,minLv:20},
      {id:'trebor',name:'„Éà„É¨„Éú„Éº„ÅÆË©¶Á∑¥Â†¥',floors:25,minLv:25}
    ];

    const MONSTERS = [
      {name:'„Éê„Éñ„É™„Éº„Çπ„É©„Ç§„É†',hp:12,atk:4,def:1,exp:8,gold:3,dng:'slime',flr:1},
      {name:'„Ç≥„Éú„É´„Éà',hp:18,atk:6,def:2,exp:12,gold:5,dng:'slime',flr:2},
      {name:'„Ç™„Éº„ÇØ„Éô„Éì„Éº',hp:25,atk:8,def:3,exp:18,gold:8,dng:'slime',flr:3},
      {name:'„Ç∏„É£„Ç§„Ç¢„É≥„Éà„É©„ÉÉ„Éà',hp:20,atk:10,def:2,exp:22,gold:10,dng:'slime',flr:4},
      {name:'„Çπ„É©„Ç§„É†„Ç≠„É≥„Ç∞',hp:60,atk:18,def:6,exp:60,gold:40,dng:'slime',flr:5,boss:true},
      {name:'„Ç≥„Éú„É´„Éà„Ç¶„Ç©„Éº„É™„Ç¢',hp:30,atk:12,def:5,exp:25,gold:12,dng:'kobold',flr:1},
      {name:'„Ç≥„Éú„É´„Éà„É°„Ç§„Ç∏',hp:22,atk:18,def:3,exp:35,gold:18,dng:'kobold',flr:4},
      {name:'„Ç™„Éº„ÇØ',hp:40,atk:15,def:6,exp:40,gold:20,dng:'kobold',flr:6},
      {name:'„Ç≥„Éú„É´„Éà„É≠„Éº„Éâ',hp:90,atk:28,def:12,exp:120,gold:80,dng:'kobold',flr:8,boss:true},
      {name:'„Ç∑„Éº„Éï',hp:35,atk:20,def:6,exp:40,gold:25,dng:'thieves',flr:1},
      {name:'„Ç¢„Çµ„Ç∑„É≥',hp:45,atk:30,def:8,exp:60,gold:40,dng:'thieves',flr:5},
      {name:'„ÉÄ„Éº„ÇØ„Ç®„É´„Éï',hp:55,atk:35,def:10,exp:80,gold:50,dng:'thieves',flr:8},
      {name:'„Éû„Çπ„Çø„Éº„Ç∑„Éº„Éï',hp:140,atk:45,def:18,exp:180,gold:120,dng:'thieves',flr:10,boss:true},
      {name:'„Çæ„É≥„Éì',hp:55,atk:15,def:5,exp:45,gold:20,dng:'sewer',flr:1},
      {name:'„Çπ„Ç±„É´„Éà„É≥',hp:45,atk:20,def:8,exp:50,gold:25,dng:'sewer',flr:4},
      {name:'„Ç∞„Éº„É´',hp:65,atk:25,def:10,exp:70,gold:35,dng:'sewer',flr:7},
      {name:'„ÉØ„Ç§„Éà',hp:75,atk:35,def:12,exp:90,gold:50,dng:'sewer',flr:10},
      {name:'„É¥„Ç°„É≥„Éë„Ç§„Ç¢',hp:220,atk:55,def:22,exp:280,gold:180,dng:'sewer',flr:12,boss:true},
      {name:'„Çπ„Éà„Éº„É≥„Ç¥„Éº„É¨„É†',hp:100,atk:40,def:25,exp:120,gold:60,dng:'kaoka',flr:1},
      {name:'„Ç¨„Éº„Ç¥„Ç§„É´',hp:90,atk:50,def:20,exp:150,gold:80,dng:'kaoka',flr:8},
      {name:'„Ç∞„É¨„Éº„Çø„Éº„Éá„Éº„É¢„É≥',hp:350,atk:75,def:35,exp:450,gold:300,dng:'kaoka',flr:15,boss:true},
      {name:'„Éü„Éü„ÉÉ„ÇØ',hp:80,atk:45,def:15,exp:100,gold:200,dng:'deltis',flr:1},
      {name:'„Éû„É≥„ÉÜ„Ç£„Ç≥„Ç¢',hp:150,atk:60,def:25,exp:200,gold:150,dng:'deltis',flr:10},
      {name:'„Ç¥„Éº„É´„Éâ„Éâ„É©„Ç¥„É≥',hp:450,atk:90,def:45,exp:700,gold:600,dng:'deltis',flr:18,boss:true},
      {name:'„Éâ„É©„Ç¥„É≥„Çæ„É≥„Éì',hp:150,atk:60,def:20,exp:200,gold:100,dng:'dragon',flr:1},
      {name:'„Éù„Ç§„Ç∫„É≥„Ç∏„É£„Ç§„Ç¢„É≥„Éà',hp:180,atk:70,def:25,exp:280,gold:140,dng:'dragon',flr:10},
      {name:'„Ç®„É≥„Ç∑„Çß„É≥„Éà„Éâ„É©„Ç¥„É≥',hp:700,atk:110,def:55,exp:1200,gold:1000,dng:'dragon',flr:20,boss:true},
      {name:'„Éà„É¨„Éú„ÉºË¶™Ë°õÈöä',hp:200,atk:80,def:35,exp:300,gold:150,dng:'trebor',flr:1},
      {name:'„ÉÄ„Éº„ÇØ„Éä„Ç§„Éà',hp:250,atk:90,def:40,exp:400,gold:200,dng:'trebor',flr:15},
      {name:'„ÉØ„Éº„Éâ„Éä',hp:1200,atk:160,def:70,exp:6000,gold:5000,dng:'trebor',flr:25,boss:true}
    ];

    const TRAPS = [{name:'„Éù„Ç§„Ç∫„É≥„Éã„Éº„Éâ„É´',dmg:0.1},{name:'„ÇØ„É≠„Çπ„Éú„Ç¶„Éú„É´„Éà',dmg:0.15},{name:'ÁàÜÁô∫„Åô„ÇãÁÆ±',dmg:0.2},{name:'ËêΩ„Å®„ÅóÁ©¥',dmg:0.1},{name:'ÊØí„Ç¨„Çπ',dmg:0.12}];

    // v14.2: ÊñΩË®≠„Éá„Éº„ÇøÔºàNildaÈ¢®„ÉÄ„Éº„ÇØ„Éï„Ç°„É≥„Çø„Ç∏„ÉºÔºâ
    const FACILITIES = [
      { id: 'guild', name: 'ÂÜíÈô∫ËÄÖ„ÇÆ„É´„Éâ', desc: 'Êñ∞„Åü„Å™ÂÜíÈô∫ËÄÖ„ÇíÁôªÈå≤', color: '#4a3020' },
      { id: 'tavern', name: '„ÉÜ„Çµ„Éº„ÇØ„ÅÆÂÆø', desc: '„Éë„Éº„ÉÜ„Ç£ÁÆ°ÁêÜ„ÉªËª¢ËÅ∑', color: '#3a3528' },
      { id: 'shop', name: '„Éú„É´„Çø„ÉÉ„ÇØÂïÜÂ∫ó', desc: 'Ê≠¶Âô®„ÉªÈò≤ÂÖ∑„ÅÆË≥ºÂÖ•', color: '#2a3530' },
      { id: 'temple', name: '„Çµ„É≥„Éâ„É´ÂØ∫Èô¢', desc: 'HP/MPÂõûÂæ©„ÉªËòáÁîü', color: '#252838' },
      { id: 'storage', name: '‰∏ÄÂë≥„ÅÆÂ±ØÊâÄ', desc: 'ÊâÄÊåÅÂìÅÁÆ°ÁêÜ', color: '#302828' },
      { id: 'bestiary', name: 'Âõ≥Êõ∏È§®', desc: '„É¢„É≥„Çπ„Çø„ÉºÂõ≥Èëë', color: '#282830' },
      { id: 'gate', name: 'Âá∫Áô∫„Ç≤„Éº„Éà', desc: '„ÉÄ„É≥„Ç∏„Éß„É≥„Å∏Âá∫Áô∫', color: '#3d2a1a' },
    ];

    // ===== v15.0: „Çπ„Éà„Éº„É™„Éº„Ç∑„Çπ„ÉÜ„É† =====
    // NPC„Éá„Éº„Çø
    const NPCS = {
      seraphina: {
        name: '„Çª„É©„Éï„Ç£„Éä',
        title: 'Âè§‰ª£Âè≤Á†îÁ©∂ËÄÖ',
        portrait: 'üë©‚Äçüî¨',
        desc: '„Äå„Çπ„Ç≠„Éº„Éû„Äç„ÅÆÁúüÂÆü„ÇíËøΩ„ÅÜË¨éÂ§ö„ÅçÂ≠¶ËÄÖ'
      },
      guildmaster: {
        name: '„ÇÆ„É´„Éâ„Éû„Çπ„Çø„Éº',
        title: 'ÂÜíÈô∫ËÄÖ„ÇÆ„É´„ÉâÈï∑',
        portrait: 'üë¥',
        desc: 'Èï∑Âπ¥„É™„É´„Ç¨„Éü„É≥„ÇíË¶ãÂÆà„Å£„Å¶„Åç„ÅüËÄÅ‰∫∫'
      }
    };

    // „Çπ„Éà„Éº„É™„Éº„Ç§„Éô„É≥„ÉàÔºà„ÉÄ„É≥„Ç∏„Éß„É≥ÂÜÖÁô∫Ë¶ãÁâ©Ôºâ
    const STORY_EVENTS = {
      slime: {
        trigger: 'clear',
        id: 'adventurer_remains',
        title: 'ÂÜíÈô∫ËÄÖ„ÅÆÈÅ∫ÂìÅ',
        text: '„Çπ„É©„Ç§„É†„Ç≠„É≥„Ç∞„ÅÆÂ∑£„ÅÆÂ••„Åß„ÄÅÁôΩÈ™®Âåñ„Åó„ÅüÈÅ∫‰Ωì„ÇíË¶ã„Å§„Åë„Åü„ÄÇ\n\nÂè§„Å≥„ÅüÈù©Ë¢ã„ÅÆ‰∏≠„Å´„ÄÅÊó•Ë®ò„ÅÆÊñ≠Áâá„ÅåÊÆã„Å£„Å¶„ÅÑ„Çã„ÄÇ\n\n„Äå‚Ä¶Ê∑±Ê∑µ„ÅÆÂÖ•Âè£„ÇíË¶ã„Å§„Åë„Åü„ÄÇ„ÅÇ„ÅÆÂ°©„ÅÑÁ©¥„ÅÆÂ••„Å´„ÄÅ\n„ÄÄÂçÉÂπ¥Ââç„ÅÆÊà¶„ÅÑ„ÅÆÁóïË∑°„ÅåÊÆã„Å£„Å¶„ÅÑ„Çã„ÄÇ\n„ÄÄ„Äé„Çπ„Ç≠„Éº„Éû„Äè„ÅÆÁúüÂÆü„ÅØ„ÄÅÊ≠¥Âè≤„ÅåË™û„Çã„ÇÇ„ÅÆ„Å®ÈÅï„ÅÜ‚Ä¶„Äç\n\nÊó•Ë®ò„ÅØ„Åù„Åì„ÅßÈÄîÂàá„Çå„Å¶„ÅÑ„Çã„ÄÇ\n„Åì„ÅÆÂÜíÈô∫ËÄÖ„ÅØ„ÄÅ‰Ωï„ÇíË¶ã„Å§„Åë„Åü„ÅÆ„Å†„Çç„ÅÜ„Åã„ÄÇ',
        item: { id: 'doc0', name: 'ÂÜíÈô∫ËÄÖ„ÅÆÊó•Ë®òÔºàÊñ≠ÁâáÔºâ', type: 'document', rarity: 'uncommon' }
      },
      kobold: {
        trigger: 'floor6',
        id: 'kobold_legend',
        title: '„Ç≥„Éú„É´„Éà„ÅÆ‰ºùÊâø',
        text: 'Â£Å„Å´Âàª„Åæ„Çå„ÅüÁ®öÊãô„Å™Áµµ„ÄÇ\n„Ç≥„Éú„É´„Éà„Åü„Å°„Åå‰ª£„ÄÖË™û„ÇäÁ∂ô„ÅÑ„Åß„Åç„Åü„ÇÇ„ÅÆ„Çâ„Åó„ÅÑ„ÄÇ\n\nÁµµ„Å´„ÅØ„Åì„ÅÜË®ò„Åï„Çå„Å¶„ÅÑ„Çã„ÄÇ\n\n„ÄåÊöó„ÅçÁ©¥„ÅÆÂ••„Å´„ÄÅÈñÄ„ÅÇ„Çä„ÄÇ\n„ÄÄÈñÄ„ÅÆÁï™‰∫∫„ÄÅÂçÉÂπ¥Á´ã„Å§„ÄÇ„Äç\n\n„ÄåÁæ§„Çå„ÅØÁü•„Çã„ÄÇÁï™‰∫∫„ÄÅÊÇ™„Å´„ÅÇ„Çâ„Åö„ÄÇ\n„ÄÄÁæ§„Çå„ÅØÂÆà„Çã„ÄÇÁï™‰∫∫„ÅÆÈÅì„Çí„ÄÇ„Äç\n\n„Äå‰∫∫„ÅÆÂ≠êÊù•„Åü„Çä„Å¶„ÄÅÁï™‰∫∫„ÇíÊíÉ„Å§„ÄÇ\n„ÄÄÁæ§„Çå„ÅØÈòª„ÇÄ„ÄÇÁæ§„Çå„ÅÆÂΩπÁõÆ„Å™„Çä„ÄÇ„Äç\n\n„Ç≥„Éú„É´„Éà„Åü„Å°„ÅØ„ÄÅ‰Ωï„ÇíÂÆà„Å£„Å¶„ÅÑ„Çã„ÅÆ„Å†„Çç„ÅÜ„Åã„ÄÇ',
        item: null
      },
      thieves: {
        trigger: 'clear', // „Éú„ÇπÊìÉÁ†¥ÊôÇ
        id: 'doc_royal',
        title: 'ÁéãÂÆ∂„ÅÆÂè§ÊñáÊõ∏',
        text: '„Éû„Çπ„Çø„Éº„Ç∑„Éº„Éï„ÅÆÈö†„ÅóÈÉ®Â±ã„Åã„Çâ„ÄÅÂè§„Å≥„ÅüÁæäÁöÆÁ¥ô„ÅåË¶ã„Å§„Åã„Å£„Åü„ÄÇ\nÁéãÂÆ∂„ÅÆÂç∞Á´†„ÅåÊäº„Åï„Çå„Å¶„ÅÑ„Çã„Åå„ÄÅÊñáÂ≠ó„Åå„Åã„Åô„Çå„Å¶Ë™≠„ÇÅ„Å™„ÅÑ„ÄÇ\n„Çª„É©„Éï„Ç£„Éä„Å´Ë¶ã„Åõ„Çå„Å∞Ëß£Ë™≠„Åß„Åç„Çã„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„ÄÇ',
        item: { id: 'doc1', name: 'ÁéãÂÆ∂„ÅÆÂè§ÊñáÊõ∏', type: 'document', rarity: 'rare' }
      },
      sewer: {
        trigger: 'floor8',
        id: 'bloody_monument',
        title: 'Ë°ÄÂ°ó„Çâ„Çå„ÅüÁü≥Á¢ë',
        text: '‰∏ãÊ∞¥ÈÅì„ÅÆÂ£Å„Å´„ÄÅÂè§„ÅÑÁü≥Á¢ë„ÅåÂüã„ÇÅËæº„Åæ„Çå„Å¶„ÅÑ„Çã„ÄÇ\nË°Ä„ÅÆ„Çà„ÅÜ„Å™Ëµ§Èªí„ÅÑÊüì„Åø„Åå„ÄÅÊñáÂ≠ó„ÇíË¶ö„Å£„Å¶„ÅÑ„Çã„ÄÇ\n\n„ÄåÊàë„ÄÅ„Åì„ÅÆÂú∞„Å´Á∏õ„Çâ„Çå„ÅóËÄÖ„ÄÇ\n„ÄÄÂçÉÂπ¥„ÅÆÂ•ëÁ¥Ñ„Å´„Çà„Çä„Å¶„ÄÇ„Äç\n\n„ÄåÈñÄ„Çà„ÇäÈÄô„ÅÜËÄÖ„ÅÇ„Çâ„Å∞„ÄÅÊàë„ÅåÈÅõ„ÅÜ„ÄÇ\n„ÄÄ„Åù„Çå„ÅåÊàë„ÅÆÂÉß„ÅÑ„Å™„Çä„ÄÇ„Äç\n\n„Äå„Åã„ÅÆÈ≠îË°ìÂ∏´„ÅÆÊÑèÂøó„ÇíÁ∂ô„Åé„ÄÅ\n„ÄÄÊàë„ÅØÊ∞∏Âä´„ÇíÁîü„Åç„Çã„ÄÇ„Äç\n\n„É¥„Ç°„É≥„Éë„Ç§„Ç¢„ÇÇ„Åæ„Åü„ÄÅ„ÄåÈñÄ„Äç„ÇíÂÆà„ÇãËÄÖ„Å™„ÅÆ„Åã„ÄÇ',
        item: null
      },
      kaoka: {
        trigger: 'floor8',
        id: 'mural',
        title: 'Ë¨é„ÅÆÂ£ÅÁîª',
        text: 'Â¥©„Çå„Åã„Åë„ÅüÂ£Å„Å´„ÄÅÂè§‰ª£„ÅÆÂ£ÅÁîª„ÅåÊÆã„Å£„Å¶„ÅÑ„Åü„ÄÇ\n\n‰∏Ä‰∫∫„ÅÆÈ≠îË°ìÂ∏´„Åå„ÄÅÊ∑±Ê∑µ„ÅÆÂâç„Å´Á´ã„Å°Â°Å„ÅêÂßø„ÄÇ\n„Åù„ÅÆËÉåÂæå„Å´„ÅØ‰∫∫„ÄÖ„ÅåÁ•à„Çä„ÇíÊçß„Åí„Å¶„ÅÑ„Çã„ÄÇ\n\n„ÄåÊÇ™„ÅÆÈ≠îË°ìÂ∏´„Äç„ÅÆÂßø„Å´„Åó„Å¶„ÅØ„ÄÅÂ•áÂ¶ô„Å™ÊßãÂõ≥„Å†‚Ä¶',
        item: { id: 'doc2', name: 'Â£ÅÁîª„ÅÆÂÜô„Åó', type: 'document', rarity: 'rare' }
      },
      deltis: {
        trigger: 'floor12',
        id: 'golden_tablet',
        title: 'ÈªÑÈáë„ÅÆË®òÈå≤Êùø',
        text: 'ÂÆùÁâ©„ÅÆÂ±±„ÅÆ‰∏≠„Å´„ÄÅÁ¥îÈáë„ÅÆÊùø„ÅåÂüã„ÇÇ„Çå„Å¶„ÅÑ„Åü„ÄÇ\nÂè§‰ª£„ÅÆÂèñÂºïË®òÈå≤„ÅåÂàª„Åæ„Çå„Å¶„ÅÑ„Çã„ÄÇ\n\n„Äå„Äé„Çπ„Ç≠„Éº„Éû„Äè„ÅÆË°ìÂºè„ÄÅÊàêÂäü„Åõ„Çä„ÄÇ\n„ÄÄ‰ª£ÂÑ™„Å®„Åó„Å¶‰ª•‰∏ã„ÇíÁ¥ç„ÇÄ„ÄÇ„Äç\n\n„ÄåÁéãÂõΩ„ÅÆË≤°ÂÆù„ÅÆÂçäÂàÜ„ÄÇ\n„ÄÄÈ≠îË°ìÂ∏´„ÉØ„Éº„Éâ„Éä„ÅÆÁîüÊ∂Ø„ÄÇ\n„ÄÄ„Åù„Åó„Å¶‚Äî‚ÄîÊ≠¥Âè≤„Å´„Åä„Åë„ÇãÂΩº„ÅÆÂêçË™â„ÄÇ„Äç\n\n„Äå„Åì„Çå„Å´„Çà„ÇäÈñÄ„ÅØÈñâ„Åñ„Åï„Çå„ÄÅ\n„ÄÄ‰∏ñÁïå„ÅØÊïë„Çè„Çå„Åü„Çä„ÄÇ„Äç\n\n‚Ä¶„ÉØ„Éº„Éâ„Éä„ÅØ„ÄåÊÇ™„ÅÆÈ≠îË°ìÂ∏´„Äç„Åß„ÅØ„Å™„Åã„Å£„Åü„ÅÆ„ÅãÔºü',
        item: { id: 'doc_deltis', name: 'ÈªÑÈáë„ÅÆË®òÈå≤Êùø', type: 'document', rarity: 'epic' }
      },
      dragon: {
        trigger: 'boss_before',
        id: 'dragon_speak',
        title: 'Á´ú„ÅÆË®ÄËëâ',
        text: '„Ç®„É≥„Ç∑„Çß„É≥„Éà„Éâ„É©„Ç¥„É≥„ÅØÊà¶„ÅÑ„ÅÆÂâç„Å´Âè£„ÇíÈñã„ÅÑ„Åü„ÄÇ\n\n„ÄåÊàë„ÅØ1000Âπ¥„ÄÅ„Åì„ÅÆÂú∞„ÅßÈñÄ„ÇíË¶ãÂÆà„Å£„Å¶„Åç„Åü„ÄÇ\n„ÄÄ„Åã„ÅÆËÄÖ„Å®Âêå„Åò„Åè„ÄÇ„Äç\n\n„Äå„Åã„ÅÆËÄÖ„Äç„Å®„ÅØË™∞„ÅÆ„Åì„Å®„Å†Ôºü',
        item: null
      },
      trebor: {
        trigger: 'boss_before',
        id: 'wardna_truth',
        title: '„ÉØ„Éº„Éâ„Éä„ÅÆË®ÄËëâ',
        text: '„ÉØ„Éº„Éâ„Éä„ÅØÈùô„Åã„Å´Ë™û„ÇäÂßã„ÇÅ„Åü„ÄÇ\n\n„Äå„ÅäÂâç„Åü„Å°„ÅØ‚Ä¶‰Ωï„ÇÇÁü•„Çâ„Åö„Å´„Åì„Åì„Åæ„ÅßÊù•„Åü„ÅÆ„Åã„ÄÇ„Äç\n\n„Äå„Äé„Çπ„Ç≠„Éº„Éû„Äè„ÅØÈñÄ„ÇíÈñã„ÅèË°ì„Åß„ÅØ„Å™„ÅÑ„ÄÇ\n„ÄÄÈñÄ„Çí‚Äî‚ÄîÈñâ„Åò„Çã„Åü„ÇÅ„ÅÆË°ì„Å†„ÄÇ„Äç\n\n„Äå1000Âπ¥Ââç„ÄÅÈñÄ„ÅØ„Åô„Åß„Å´Èñã„ÅÑ„Å¶„ÅÑ„Åü„ÄÇ\n„ÄÄÊàë„ÅØÂëΩ„ÇíË≥≠„Åó„Å¶„ÄÅ„Åù„Çå„ÇíÂçäÂàÜÈñâ„Åò„Åü„ÅÆ„Å†„ÄÇ„Äç\n\n„Äå„Åù„Åó„Å¶‰ªä„ÇÇ„ÄÅÊàë„ÅØ„Åì„Åì„ÅßÈñÄ„ÇíÊäº„Åï„ÅàÁ∂ö„Åë„Å¶„ÅÑ„Çã„ÄÇ\n„ÄÄÊàë„ÇíÂÄí„Åõ„Å∞„ÄÅÈñÄ„ÅØÂÆåÂÖ®„Å´Èñã„Åè„ÄÇ„Äç\n\n„ÄåÊú¨ÂΩì„ÅÆÊïµ„ÅØ„ÄÅÈñÄ„ÅÆÂêë„Åì„ÅÜ„Å´„ÅÑ„Çã„ÄÇ\n„ÄÄ„ÄéÊ∑±Ê∑µ„ÅÆÁéã„Äè„Åå„ÄÇ„Äç',
        item: { id: 'doc3', name: '„ÉØ„Éº„Éâ„Éä„ÅÆÊó•Ë®ò', type: 'document', rarity: 'legendary' }
      }
    };

    // „Çª„É©„Éï„Ç£„Éä„ÅÆ‰ºöË©±ÔºàÈÄ≤Ë°åÂ∫¶„ÅßÂ§âÂåñÔºâ
    const SERAPHINA_DIALOGUES = {
      first: {
        lines: [
          '„ÄåÂàù„ÇÅ„Åæ„Åó„Å¶„ÄÇÁßÅ„ÅØ„Çª„É©„Éï„Ç£„Éä„ÄÇÂè§‰ª£Âè≤„ÅÆÁ†îÁ©∂„Çí„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Äç',
          '„Äå„Äé„Çπ„Ç≠„Éº„Éû„Äè„ÅÆÁúüÂÆü„ÇíÁ™Å„ÅçÊ≠¢„ÇÅ„Åü„Åè„Å¶„ÄÅ„Åì„ÅÆË°ó„Å´Êù•„Åæ„Åó„Åü„ÄÇ„Äç',
          '„Äå„ÅÇ„Å™„Åü„Åå„ÉÄ„É≥„Ç∏„Éß„É≥„Åß‰Ωï„ÅãË¶ã„Å§„Åë„Åü„Çâ„ÄÅ„Åú„Å≤Êïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Äç'
        ]
      },
      hasDoc0: {
        lines: [
          '„Äå„Åì„Çå„ÅØ‚Ä¶ÂÜíÈô∫ËÄÖ„ÅÆÊó•Ë®ò„Åß„Åô„Å≠„ÄÇ„Äç',
          '„Äå„Äé„Çπ„Ç≠„Éº„Éû„Äè„ÅÆÁúüÂÆü„ÅåÊ≠¥Âè≤„Å®ÈÅï„ÅÜ‚Ä¶ËààÂë≥Ê∑±„ÅÑ„Åß„Åô„ÄÇ„Äç',
          '„Äå„Åì„ÅÆÂÜíÈô∫ËÄÖ„ÅØ‰Ωï„Åã„ÇíË¶ã„Å§„Åë„Åü„ÅÆ„Åß„Åó„Çá„ÅÜ„ÄÇ„Äç',
          '„Äå„ÇÇ„Å£„Å®Ê∑±„Åè„ÅÆ„ÉÄ„É≥„Ç∏„Éß„É≥„ÇíÊé¢Á¥¢„Åô„Çå„Å∞„ÄÅÊâã„Åå„Åã„Çä„ÅåË¶ã„Å§„Åã„Çã„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇ„Äç'
        ]
      },
      hasDoc1: {
        lines: [
          '„Äå„Åì„Çå„ÅØ‚Ä¶ÔºÅÁéãÂÆ∂„ÅÆÊ©üÂØÜÊñáÊõ∏„Åß„Åô„Å≠„ÄÇ„Äç',
          '„ÄåËß£Ë™≠„Åó„Å¶„Åø„Åæ„Åô„ÄÇÂ∞ë„ÅóÊôÇÈñì„Çí„Åè„Å†„Åï„ÅÑ‚Ä¶„Äç',
          '„Äå‚Ä¶„Åì„Çå„ÅØ„ÄÇÊ≠¥Âè≤„ÅåÊõ∏„ÅçÊèõ„Åà„Çâ„Çå„ÅüË®ºÊã†„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇ„Äç',
          '„Äå„ÇÇ„Å£„Å®Ë™ø„Åπ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊé¢Á¥¢„ÇíÁ∂ö„Åë„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Äç'
        ]
      },
      hasDoc2: {
        lines: [
          '„Äå„Åì„ÅÆÂ£ÅÁîª‚Ä¶‰ºùÊâø„Å®ÂÖ®„ÅèÈÅï„ÅÑ„Åæ„Åô„ÄÇ„Äç',
          '„Äå„ÉØ„Éº„Éâ„Éä„ÅØÊú¨ÂΩì„Å´„ÄéÊÇ™„ÅÆÈ≠îË°ìÂ∏´„Äè„Å†„Å£„Åü„ÅÆ„Åß„Åó„Çá„ÅÜ„ÅãÔºü„Äç',
          '„Äå‰∫∫„ÄÖ„ÅåÂΩº„Å´Á•à„Çä„ÇíÊçß„Åí„Å¶„ÅÑ„Çã„ÄÇ„Åæ„Çã„ÅßËã±ÈõÑ„ÅÆ„Çà„ÅÜ„Å´‚Ä¶„Äç',
          '„ÄåÁúüÂÆü„ÅØÊ∑±Ê∑µ„ÅÆÊúÄÂ••„Å´„ÅÇ„Çã„ÅÆ„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇ„Äç'
        ]
      },
      hasDoc3: {
        lines: [
          '„Äå„ÉØ„Éº„Éâ„Éä„ÅÆÊó•Ë®ò‚Ä¶„Åì„Çå„Åß„Åô„Åπ„Å¶„ÅåÊòé„Çâ„Åã„Å´„Å™„Çä„Åæ„Åó„Åü„ÄÇ„Äç',
          '„ÄåÂΩº„ÅØ1000Âπ¥Èñì„ÄÅ„Åü„Å£„Åü‰∏Ä‰∫∫„Åß‰∏ñÁïå„ÇíÂÆà„Å£„Å¶„ÅÑ„Åü„ÅÆ„Åß„Åô„ÄÇ„Äç',
          '„ÄåÊ≠¥Âè≤„ÅØÂΩº„ÇíÊÇ™„Å®Âëº„Çì„Å†„ÄÇ„Åß„ÇÇ„ÄÅÁúüÂÆü„ÅØÈÅï„Å£„Åü„ÄÇ„Äç',
          '„Äå„ÅÇ„Å™„Åü„ÅØ‰ªä„ÄÅÁúüÂÆü„ÇíÁü•„ÇãÊï∞Â∞ë„Å™„ÅÑ‰∫∫Èñì„ÅÆ‰∏Ä‰∫∫„Åß„Åô„ÄÇ„Äç',
          '„Äå„Åì„ÅÆÁúüÂÆü„Çí‚Ä¶„Å©„ÅÜ„Åô„Çã„Åã„ÅØ„ÄÅ„ÅÇ„Å™„ÅüÊ¨°Á¨¨„Åß„Åô„ÄÇ„Äç'
        ]
      }
    };

    // „Ç®„É≥„Éá„Ç£„É≥„Ç∞„Éá„Éº„Çø
    const ENDING = {
      wardnaChoice: {
        title: 'ÈÅ∏Êäû',
        text: '„ÉØ„Éº„Éâ„Éä„ÅØÈùô„Åã„Å´Á´ã„Å£„Å¶„ÅÑ„Çã„ÄÇ\n\nÂΩº„ÇíÂÄí„Åõ„Å∞„ÄÅÈñÄ„ÅåÈñã„Åè„ÄÇ\n„Å†„Åå„ÄÅÂΩº„ÇíË¶ãÈÄÉ„Åõ„Å∞‚Äî‚Äî\n\n‰Ωï„ÇíÈÅ∏„Å∂Ôºü',
        choices: [
          { id: 'spare', text: 'Ë¶ãÈÄÉ„Åô' },
          { id: 'prestige', text: '‚ú® Ëª¢Áîü„Åô„Çã' },
        ]
      },
      ending: {
        lines: [
          '„ÉØ„Éº„Éâ„Éä„ÅØÈùô„Åã„Å´ÂæÆÁ¨ë„Çì„Å†„ÄÇ',
          '',
          '„Äå‰ªä„ÅØ„Åæ„Å†‚Ä¶‰∏ñÁïå„ÅØ„ÅÇ„ÅÆËÄÖ„Å®Êà¶„ÅÜÂäõ„ÇíÊåÅ„Åü„Å¨„ÄÇ„Äç',
          '',
          '„Äå„Å†„Åå„ÄÅ„ÅäÂâç„Åü„Å°„Å™„Çâ„ÅÑ„Å§„Åã‚Ä¶„Äç',
          '',
          '„Äå„Åù„ÅÆÊó•„Åæ„Åß„ÄÅÊàë„ÅØÈñÄ„ÇíÊäº„Åï„ÅàÁ∂ö„Åë„Çà„ÅÜ„ÄÇ„Äç',
          '',
          '„Äå„Åù„Åó„Å¶„ÄÅÁúüÂÆü„ÅØ‚Ä¶„ÅäÂâç„Åü„Å°„ÅÆËÉ∏„ÅÆ‰∏≠„Å†„Åë„Å´„ÄÇ„Äç',
          '',
          'ÂÜíÈô∫ËÄÖ„Åü„Å°„ÅØÂú∞‰∏ä„Å∏Êàª„Å£„Åü„ÄÇ',
          '‰∏ñÁïå„ÅØ‰Ωï„ÇÇÂ§â„Çè„Çâ„Å™„ÅÑ„ÄÇ',
          '„ÉØ„Éº„Éâ„Éä„ÅØ‰ªä„ÇÇ„ÄåÊÇ™„ÅÆÈ≠îË°ìÂ∏´„Äç„Å®„Åó„Å¶Ë™û„ÇäÁ∂ô„Åå„Çå„Çã„ÄÇ',
          '',
          '„Å†„Åå„ÄÅÂÜíÈô∫ËÄÖ„Åü„Å°„ÅØÁü•„Å£„Å¶„ÅÑ„Çã„ÄÇ',
          'Ê∑±Ê∑µ„ÅÆÂ∫ï„Åß„ÄÅÂ≠§Áã¨„Å´‰∏ñÁïå„ÇíÂÆà„ÇäÁ∂ö„Åë„ÇãÁî∑„Åå„ÅÑ„Çã„Åì„Å®„Çí„ÄÇ',
          '',
          '„Åù„Åó„Å¶‚Äî‚Äî',
          '„ÅÑ„Å§„Åã„ÄÅÊú¨ÂΩì„ÅÆÊà¶„ÅÑ„ÅåÂßã„Åæ„Çã„Åì„Å®„Çí„ÄÇ',
          '',
          '',
          '„Äê To be continued... „Äë'
        ],
        postCredits: {
          text: 'ÊöóÈóá„ÅÆ‰∏≠„ÄÅÂ∑®Â§ß„Å™ÁõÆ„ÅåÈñã„Åè„ÄÇ\n\n„Äå‚Ä¶„Åù„Çç„Åù„Çç„ÄÅ„Åã„ÄÇ„Äç',
          hint: 'Wizardry Schema 2 - Coming Soon...'
        }
      }
    };

    // ===== „É°„Ç§„É≥„Ç¢„Éó„É™ =====
    function App() {
      const [screen, setScreen] = useState('title');
      const [party, setParty] = useState([]);
      const [gold, setGold] = useState(100);
      const [logs, setLogs] = useState([]);
      const [exploring, setExploring] = useState(false);
      const [paused, setPaused] = useState(false); // v13.1: „Éú„ÇπÊà¶Ââç„ÅÆ‰∏ÄÊôÇÂÅúÊ≠¢
      const [bossConfirm, setBossConfirm] = useState(null); // v13.1: „Éú„ÇπÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´
      const [dungeon, setDungeon] = useState(null);
      const [floor, setFloor] = useState(1);
      const [maxFloors, setMaxFloors] = useState({});
      const [clearedDungeons, setClearedDungeons] = useState({});
      const [retreatHP, setRetreatHP] = useState(30);
      const [autoPotion, setAutoPotion] = useState(true); // v13.1: Ëá™Âãï„Éù„Éº„Ç∑„Éß„É≥
      const [autoResume, setAutoResume] = useState(false); // v17.0: Ëá™ÂãïÊé¢Á¥¢ÂÜçÈñã
      const [lastDungeon, setLastDungeon] = useState(null); // v17.0: ÊúÄÂæå„Å´Êé¢Á¥¢„Åó„Åü„ÉÄ„É≥„Ç∏„Éß„É≥
      const [autoSell, setAutoSell] = useState(false); // v17.0: Ëá™ÂãïÂ£≤Âç¥
      const [activeTab, setActiveTab] = useState('dungeon');
      const [settings, setSettings] = useState({bgm:true,sfx:true,bgmVol:50,sfxVol:70});
      const [bestiary, setBestiary] = useState({});
      const [inventory, setInventory] = useState([]);
      const [showSettings, setShowSettings] = useState(false);
      const [showJobChange, setShowJobChange] = useState(null);
      const [shopCat, setShopCat] = useState('weapons');
      const [selChar, setSelChar] = useState(null);
      const [currentFacility, setCurrentFacility] = useState(null); // v14.0: ÊñΩË®≠ÁîªÈù¢ÁÆ°ÁêÜ
      // v15.0: „Çπ„Éà„Éº„É™„Éº„Ç∑„Çπ„ÉÜ„É†
      const [storyFlags, setStoryFlags] = useState({ metSeraphina: false, documents: [], eventsTriggered: [], endingReached: false });
      // v16.0: „Éó„É¨„Çπ„ÉÜ„Éº„Ç∏ÔºàËª¢ÁîüÔºâ„Ç∑„Çπ„ÉÜ„É†
      const [prestige, setPrestige] = useState({ count: 0, totalClears: 0 }); // count=Ëª¢ÁîüÂõûÊï∞, totalClears=Á¥ØË®à„ÇØ„É™„Ç¢Êï∞
      const [dialogueModal, setDialogueModal] = useState(null); // { npc: 'seraphina', lines: [...], currentLine: 0 }
      const [storyEventModal, setStoryEventModal] = useState(null); // „Ç§„Éô„É≥„ÉàË°®Á§∫Áî®
      const [endingPhase, setEndingPhase] = useState(null); // 'choice' | 'ending' | 'postcredits'
      // v15.1: „Ç™„Éº„Éó„Éã„É≥„Ç∞Áî®„ÅÆstateÔºà„Éï„ÉÉ„ÇØ„É´„Éº„É´ÂØæÂøúÔºâ
      const [openingLines, setOpeningLines] = useState([]);
      const [openingDone, setOpeningDone] = useState(false);
      const logRef = useRef(null);

      const initSound = async () => { await soundEngine.init(); if (settings.bgm) soundEngine.startBGM(); };

      // v17.1: Ëá™ÂãïÊé¢Á¥¢ÂÜçÈñã„ÅÆ„Ç¢„É≥„É≠„ÉÉ„ÇØÊù°‰ª∂ÔºàËª¢Áîü1Âõû‰ª•‰∏äÔºâ
      const isAutoResumeUnlocked = prestige.count >= 1;
      // v17.1: Ëá™ÂãïÂ£≤Âç¥„ÅÆ„Ç¢„É≥„É≠„ÉÉ„ÇØÊù°‰ª∂ÔºàËª¢Áîü3Âõû‰ª•‰∏äÔºâ
      const isAutoSellUnlocked = prestige.count >= 3;

      // v16.0: „Éó„É¨„Çπ„ÉÜ„Éº„Ç∏„Éú„Éº„Éä„ÇπË®àÁÆó
      const getPrestigeBonus = () => ({
        exp: 1 + prestige.count * 0.1,  // Ëª¢Áîü1Âõû„Åî„Å®„Å´EXP +10%
        gold: 1 + prestige.count * 0.1  // Ëª¢Áîü1Âõû„Åî„Å®„Å´„Ç¥„Éº„É´„Éâ +10%
      });

      // v17.0: Ëá™ÂãïÊé¢Á¥¢ÂÜçÈñãÂá¶ÁêÜ
      const startAutoResume = (dngId) => {
        if (!autoResume || !isAutoResumeUnlocked || !dngId) return;
        const dngData = DUNGEONS.find(d => d.id === dngId);
        if (!dngData) return;
        // 3ÁßíÂæå„Å´Ëá™ÂãïÂÜçÈñã
        setTimeout(() => {
          addLog('üîÑ Ëá™ÂãïÊé¢Á¥¢ÂÜçÈñã...', 'special');
          setExploring(true);
          setFloor(1);
          setDungeon(dngId);
          soundEngine.startBGM(dngId);
          addLog(`‚îÅ‚îÅ‚îÅ ${dngData.name}„Å∏ ‚îÅ‚îÅ‚îÅ`, 'level');
          addLog(getFloorDesc(dngId, 1), 'explore');
        }, 3000);
      };

      // v16.0: Ëª¢ÁîüÂá¶ÁêÜ
      const doPrestige = () => {
        setPrestige(prev => ({ count: prev.count + 1, totalClears: prev.totalClears + 1 }));
        setParty([]);
        setGold(100);
        setMaxFloors({});
        setClearedDungeons({});
        setInventory([]);
        setStoryFlags({ metSeraphina: false, documents: [], eventsTriggered: [], endingReached: false });
        setFloor(1);
        setDungeon(null);
        setExploring(false);
        setEndingPhase(null);
        setScreen('main');
        soundEngine.startBGM('town');
        addLog(`‚ú® Ëª¢ÁîüÂÆå‰∫ÜÔºÅEXP/„Ç¥„Éº„É´„Éâ„Éú„Éº„Éä„Çπ: +${(prestige.count + 1) * 10}%`, 'level');
      };

      const addLog = useCallback((msg, type='normal') => {
        const c = {normal:'text-green-400',battle:'text-yellow-400',damage:'text-red-400',heal:'text-blue-400',item:'text-purple-400',level:'text-cyan-400',special:'text-pink-400',critical:'text-orange-400',boss:'gold-text',explore:'text-gray-400',clear:'text-yellow-300'}[type] || 'text-green-400';
        setLogs(prev => [...prev.slice(-100), {msg,c}]);
      }, []);

      // v13.1: Á®ÆÊóèÁâπÊÄß„ÇíÂèñÂæó
      const getRaceTrait = (raceKey) => RACES[raceKey]?.trait || {};

      useEffect(() => {
        const s = localStorage.getItem('wizardrySchemaV15');
        if (s) { 
          const d = JSON.parse(s); 
          setParty(d.party||[]); 
          setGold(d.gold||100); 
          setMaxFloors(d.maxFloors||{}); 
          setClearedDungeons(d.clearedDungeons||{}); 
          setSettings(d.settings||{bgm:true,sfx:true,bgmVol:50,sfxVol:70}); 
          setBestiary(d.bestiary||{}); 
          setInventory(d.inventory||[]); 
          if (d.autoPotion !== undefined) setAutoPotion(d.autoPotion);
          if (d.storyFlags) setStoryFlags(d.storyFlags);
          if (d.prestige) setPrestige(d.prestige);
        }
      }, []);
      useEffect(() => { 
        if (party.length > 0) localStorage.setItem('wizardrySchemaV15', JSON.stringify({party,gold,maxFloors,clearedDungeons,settings,bestiary,inventory,autoPotion,storyFlags,prestige})); 
      }, [party,gold,maxFloors,clearedDungeons,settings,bestiary,inventory,autoPotion,storyFlags,prestige]);
      useEffect(() => { if (logRef.current) logRef.current.scrollTop = logRef.current.scrollHeight; }, [logs]);
      useEffect(() => { soundEngine.toggleBGM(settings.bgm); }, [settings.bgm]);
      useEffect(() => { soundEngine.setBgmVolume(-30 + settings.bgmVol*0.3); }, [settings.bgmVol]);
      useEffect(() => { soundEngine.setSfxVolume(-20 + settings.sfxVol*0.2); }, [settings.sfxVol]);

      const getDrop = (flr, isBoss = false, bossName = null) => {
        if (isBoss && bossName && BOSS_DROPS[bossName]) {
          const drops = BOSS_DROPS[bossName];
          if (Math.random() < 0.7) return {...drops[Math.floor(Math.random() * drops.length)], uid: Date.now()+Math.random()};
        }
        const r = Math.random();
        let rarity = 'common';
        if (r < 0.0002 && flr >= 25) rarity = 'legendary';
        else if (r < 0.015 && flr >= 15) rarity = 'epic';
        else if (r < 0.06 && flr >= 8) rarity = 'rare';
        else if (r < 0.2) rarity = 'uncommon';
        const all = [...ITEMS.weapons,...ITEMS.armors,...ITEMS.accessories];
        const avail = all.filter(i => i.rarity === rarity);
        if (!avail.length) return null;
        return {...avail[Math.floor(Math.random()*avail.length)], uid: Date.now()+Math.random()};
      };

      // v13.1: Ëá™Âãï„Éù„Éº„Ç∑„Éß„É≥‰ΩøÁî®
      const useAutoPotion = useCallback(() => {
        if (!autoPotion) return;
        setParty(prev => {
          let newParty = [...prev];
          let usedPotions = [];
          
          newParty = newParty.map(char => {
            if (char.currentHp <= 0 || char.currentHp / char.maxHp > 0.3) return char;
            
            // ÊâÄÊåÅÂìÅ„Åã„Çâ„Éù„Éº„Ç∑„Éß„É≥„ÇíÊé¢„ÅôÔºà„Ç®„É™„ÇØ„Çµ„Éº > „Éè„Ç§„Éù„Éº„Ç∑„Éß„É≥ > „Éù„Éº„Ç∑„Éß„É≥Ôºâ
            const potionOrder = ['p003', 'p002', 'p001'];
            for (const pid of potionOrder) {
              const potionIdx = inventory.findIndex(i => i.id === pid);
              if (potionIdx !== -1) {
                const potion = inventory[potionIdx];
                const healAmount = Math.min(potion.heal, char.maxHp - char.currentHp);
                usedPotions.push({ idx: potionIdx, name: potion.name, charName: char.name, heal: healAmount });
                return { ...char, currentHp: Math.min(char.maxHp, char.currentHp + potion.heal) };
              }
            }
            return char;
          });
          
          // ‰ΩøÁî®„Åó„Åü„Éù„Éº„Ç∑„Éß„É≥„Çí„Ç§„É≥„Éô„É≥„Éà„É™„Åã„ÇâÂâäÈô§
          if (usedPotions.length > 0) {
            const indicesToRemove = usedPotions.map(p => p.idx);
            setInventory(prev => prev.filter((_, i) => !indicesToRemove.includes(i)));
            usedPotions.forEach(p => {
              addLog(`üíä ${p.charName}„Åå${p.name}„Çí‰ΩøÁî® (+${p.heal}HP)`, 'heal');
            });
            soundEngine.playHeal();
          }
          
          return newParty;
        });
      }, [autoPotion, inventory, addLog]);

      useEffect(() => {
        if (!exploring || party.length === 0 || !dungeon || paused) return;
        const interval = setInterval(() => {
          const alive = party.filter(c => c.currentHp > 0);
          if (alive.length === 0) {
            addLog('„ÄêÂÖ®ÊªÖ„Äë„Éë„Éº„ÉÜ„Ç£„ÅØÂÖ®ÊªÖ„Åó„Åü...','damage');
            soundEngine.playDeath(); setExploring(false); setFloor(1); setParty(p => p.map(c => ({...c, currentHp: Math.floor(c.maxHp*0.5)}))); soundEngine.startBGM('town'); return;
          }
          if (alive.some(c => (c.currentHp/c.maxHp)*100 <= retreatHP)) {
            addLog(`„ÄêÊí§ÈÄÄ„ÄëHP${retreatHP}%‰ª•‰∏ã„ÅßÂ∏∞ÈÇÑ`,'special');
            const currentDng = dungeon; // v17.0: Âæ©Â∏∞Áî®„Å´‰øùÂ≠ò
            setExploring(false); setFloor(1); setParty(p => p.map(c => ({...c, currentHp: c.maxHp, currentMp: c.maxMp}))); soundEngine.startBGM('town');
            startAutoResume(currentDng); // v17.0: Ëá™ÂãïÊé¢Á¥¢ÂÜçÈñã
            return;
          }
          const event = Math.random();
          const dngData = DUNGEONS.find(d => d.id === dungeon);
          
          if (event < 0.85) {
            const monsters = MONSTERS.filter(m => m.dng === dungeon && m.flr <= floor);
            if (monsters.length === 0) return;
            const mon = {...monsters[Math.floor(Math.random()*monsters.length)]};
            const isBoss = mon.boss && floor === mon.flr;
            const monMaxHp = mon.hp;
            const isFinalBoss = isBoss && floor === dngData.floors;
            
            // v13.1: „Éú„ÇπÊà¶Ââç„ÅÆ‰∏ÄÊôÇÂÅúÊ≠¢Á¢∫Ë™ç
            if (isBoss && !bossConfirm) {
              soundEngine.playBoss();
              setPaused(true);
              setBossConfirm({ monster: mon, isFinal: isFinalBoss });
              addLog(`‚îÅ‚îÅ‚îÅ BOSSÁô∫Ë¶ã: ${mon.name} ‚îÅ‚îÅ‚îÅ`,'boss');
              
              // v15.0: „Éú„ÇπÊà¶Ââç„Çπ„Éà„Éº„É™„Éº„Ç§„Éô„É≥„Éà
              const storyEvent = STORY_EVENTS[dungeon];
              if (storyEvent && storyEvent.trigger === 'boss_before' && !storyFlags.eventsTriggered.includes(storyEvent.id)) {
                setTimeout(() => triggerStoryEvent(dungeon, 'boss_before'), 800);
              }
              return;
            }
            
            setBestiary(prev => ({...prev,[mon.name]:{...mon,cnt:(prev[mon.name]?.cnt||0)+1}}));
            
            if (isBoss) {
              addLog(`‚îÅ‚îÅ‚îÅ BOSSÊà¶ÈóòÈñãÂßã: ${mon.name} ‚îÅ‚îÅ‚îÅ`,'boss');
            }
            
            let monHp = mon.hp;
            let mpUsed = {};
            let turnCount = 1;
            let partyDamage = {};
            let criticalHits = 0;
            
            while (monHp > 0 && alive.filter(c => (partyDamage[c.id]||0) < c.currentHp).length > 0 && turnCount <= 5) {
              if (isBoss) addLog(`„Äê„Çø„Éº„É≥${turnCount}„Äë`,'battle');
              
              alive.forEach((char) => {
                if (monHp <= 0) return;
                const job = JOBS[char.jobKey];
                const trait = getRaceTrait(char.raceKey);
                
                // v13.1: Á®ÆÊóèÁâπÊÄß„Å´„Çà„ÇãÂõûÈÅøÂà§ÂÆö
                const evasionBonus = trait.evasion || 0;
                const isMiss = Math.random() < (0.08 - evasionBonus);
                if (isMiss) {
                  if (isBoss) addLog(`${char.name}„ÅÆÊîªÊíÉ„ÅØÂ§ñ„Çå„Åü`,'normal');
                  return;
                }
                
                // v13.1: Á®ÆÊóèÁâπÊÄß„Å´„Çà„Çã„ÇØ„É™„ÉÜ„Ç£„Ç´„É´Ë£úÊ≠£
                const critBonus = trait.critBonus || 0;
                const isCritical = Math.random() < (0.05 + char.luk * 0.005 + critBonus);
                
                if (job.spell && char.currentMp >= 2 && Math.random() < 0.35) {
                  const spells = job.spell === 'both' ? [...SPELLS.mage,...SPELLS.priest] : (SPELLS[job.spell]||[]);
                  const atkSpells = spells.filter(s => s.pow > 0 && s.mp <= char.currentMp && s.lv <= Math.floor(char.level/2)+1);
                  if (atkSpells.length > 0) {
                    const spell = atkSpells[Math.floor(Math.random()*atkSpells.length)];
                    // v13.1: „Ç®„É´„Éï„ÅÆÈ≠îÊ≥ï„Éú„Éº„Éä„Çπ
                    const magicBonus = trait.magicBonus || 0;
                    let dmg = Math.floor((spell.pow + Math.floor(char.int * 0.5)) * (1 + magicBonus));
                    if (isCritical) { dmg = Math.floor(dmg * 1.5); criticalHits++; }
                    monHp -= dmg;
                    mpUsed[char.id] = (mpUsed[char.id]||0) + spell.mp;
                    if (isBoss) addLog(`${char.name}„Äå${spell.name}„Äç‚Üí ${dmg}${isCritical?' ‰ºöÂøÉ!':''}`, isCritical?'critical':'special');
                    soundEngine.playAttack();
                    return;
                  }
                }
                // v13.3: „Éâ„ÉØ„Éº„Éï„ÅÆÊîªÊíÉ„Éú„Éº„Éä„Çπ
                const atkBonus = trait.atkBonus || 0;
                let dmg = Math.max(1, Math.floor((char.atk * (1 + atkBonus)) - mon.def + Math.random()*8));
                if (isCritical) { dmg = Math.floor(dmg * 1.5); criticalHits++; }
                monHp -= dmg;
                if (isBoss) addLog(`${char.name}„ÅÆÊîªÊíÉ ‚Üí ${dmg}${isCritical?' ‰ºöÂøÉ!':''}`, isCritical?'critical':'battle');
                soundEngine.playAttack();
              });
              
              if (monHp > 0) {
                if (isBoss) addLog(`${mon.name} HP:${Math.max(0,monHp)}/${monMaxHp}`,'normal');
                soundEngine.playHit();
                const target = alive[Math.floor(Math.random()*alive.length)];
                const targetTrait = getRaceTrait(target.raceKey);
                
                // v13.1: „Éâ„ÉØ„Éº„Éï„ÅÆÈò≤Âæ°„Éú„Éº„Éä„Çπ„ÄÅ„Éé„Éº„É†„ÅÆÈ≠îÊ≥ïËÄêÊÄß
                const defBonus = targetTrait.defBonus || 0;
                const effectiveDef = Math.floor(target.def * (1 + defBonus));
                let dmg = Math.max(1, mon.atk - effectiveDef + Math.floor(Math.random()*8));
                
                // v13.1: Á®ÆÊóèÁâπÊÄß„Å´„Çà„ÇãÂõûÈÅøÔºàË¢´ÊîªÊíÉÊôÇÔºâ
                const targetEvasion = targetTrait.evasion || 0;
                if (Math.random() < targetEvasion) {
                  if (isBoss) addLog(`${target.name}„ÅØÊîªÊíÉ„ÇíÂõûÈÅøÔºÅ`,'special');
                } else {
                  partyDamage[target.id] = (partyDamage[target.id]||0) + dmg;
                  if (isBoss) addLog(`${mon.name} ‚Üí ${target.name}„Å´${dmg}„ÉÄ„É°„Éº„Ç∏`,'damage');
                }
              }
              turnCount++;
            }
            
            if (monHp <= 0) {
              if (isBoss) {
                addLog(`‚ïê‚ïê‚ïê ${mon.name}„ÇíÊíÉÁ†¥ÔºÅ ‚ïê‚ïê‚ïê`,'item');
                addLog(`+${mon.exp}EXP / +${mon.gold}G`,'item');
                setBossConfirm(null);
              } else {
                const critText = criticalHits > 0 ? ` ‰ºöÂøÉ${criticalHits}` : '';
                addLog(`${mon.name}ÊíÉÁ†¥ +${mon.exp}EXP +${mon.gold}G${critText}`,'item');
              }
              
              soundEngine.playGold();
              // v16.0: „Ç¥„Éº„É´„Éâ„Å´„ÇÇ„Éó„É¨„Çπ„ÉÜ„Éº„Ç∏„Éú„Éº„Éä„ÇπÈÅ©Áî®
              const goldPrestigeBonus = 1 + prestige.count * 0.1;
              setGold(prev => prev + Math.floor(mon.gold * goldPrestigeBonus));
              
              if (isBoss || Math.random() < 0.12) {
                const drop = getDrop(floor,isBoss,mon.name);
                if (drop) {
                  // v17.0: Ëá™ÂãïÂ£≤Âç¥ÔºàCommonË£ÖÂÇô„ÇíËá™Âãï„ÅßÂ£≤„ÇãÔºâ
                  if (autoSell && isAutoSellUnlocked && drop.rarity === 'common' && !drop.heal) {
                    const sellPrice = Math.floor((drop.price || 10) / 2);
                    setGold(prev => prev + sellPrice);
                    addLog(`üí∞Ëá™ÂãïÂ£≤Âç¥: ${drop.name} (+${sellPrice}G)`, 'item');
                  } else {
                    setInventory(prev => [...prev,drop]);
                    addLog(`„Äê„Éâ„É≠„ÉÉ„Éó„Äë${drop.name}`,drop.rarity==='legendary'?'boss':'item');
                  }
                }
              }
              
              let levelUpChars = [];
              setParty(prev => prev.map(char => {
                let updated = {...char};
                if (mpUsed[char.id]) updated.currentMp = Math.max(0, updated.currentMp - mpUsed[char.id]);
                if (partyDamage[char.id]) updated.currentHp = Math.max(0, updated.currentHp - partyDamage[char.id]);
                if (char.currentHp > 0) {
                  // v13.1: ‰∫∫Èñì„ÅÆEXP„Éú„Éº„Éä„Çπ
                  const trait = getRaceTrait(char.raceKey);
                  const expBonus = trait.expBonus || 0;
                  // v16.0: „Éó„É¨„Çπ„ÉÜ„Éº„Ç∏„Éú„Éº„Éä„ÇπÈÅ©Áî®
                  const prestigeBonus = 1 + prestige.count * 0.1; // Ëª¢Áîü1Âõû„Åî„Å®„Å´+10%
                  const expGain = Math.floor((mon.exp / alive.length) * (1 + expBonus) * prestigeBonus);
                  const newExp = updated.exp + expGain;
                  const expNeed = updated.level * 100;
                  if (newExp >= expNeed) {
                    levelUpChars.push({name: char.name, oldLv: updated.level, newLv: updated.level + 1});
                    soundEngine.playLevelUp();
                    const hpUp = 5 + Math.floor(updated.vit*0.5);
                    const mpUp = 3 + Math.floor(updated.int*0.3);
                    updated = {...updated, exp: newExp - expNeed, level: updated.level + 1,
                      maxHp: updated.maxHp + hpUp, currentHp: updated.maxHp + hpUp,
                      maxMp: updated.maxMp + mpUp, currentMp: updated.maxMp + mpUp,
                      atk: updated.atk + 2, def: updated.def + 1};
                  } else { updated.exp = newExp; }
                }
                return updated;
              }));
              
              levelUpChars.forEach(c => {
                addLog(`‚òÖ ${c.name} Lv.${c.oldLv}‚Üí${c.newLv}ÔºÅ`,'level');
              });
              
              // v13.1: Êà¶ÈóòÂæå„ÅÆËá™Âãï„Éù„Éº„Ç∑„Éß„É≥
              setTimeout(() => useAutoPotion(), 100);
              
              if (isFinalBoss) {
                soundEngine.playClear();
                setClearedDungeons(prev => ({...prev, [dungeon]: true}));
                
                // v15.0: „Çπ„Éà„Éº„É™„Éº„Ç§„Éô„É≥„Éà„Éà„É™„Ç¨„ÉºÔºà„Éú„Çπ„ÇØ„É™„Ç¢ÊôÇÔºâ
                const storyEvent = STORY_EVENTS[dungeon];
                if (storyEvent && storyEvent.trigger === 'clear' && !storyFlags.eventsTriggered.includes(storyEvent.id)) {
                  setTimeout(() => triggerStoryEvent(dungeon, 'clear'), 500);
                }
                
                // v15.0: „ÉØ„Éº„Éâ„ÉäÊíÉÁ†¥ÊôÇ„ÅØÁâπÂà•„Ç®„É≥„Éá„Ç£„É≥„Ç∞„Å∏
                if (dungeon === 'trebor' && mon.name === '„ÉØ„Éº„Éâ„Éä') {
                  addLog('','normal');
                  addLog(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`,'clear');
                  addLog(`„ÉØ„Éº„Éâ„Éä„ÅØÈùô„Åã„Å´ÂÄí„Çå„Åü...`,'clear');
                  addLog(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`,'clear');
                  setTimeout(() => {
                    setExploring(false);
                    setEndingPhase('choice');
                  }, 2000);
                  return;
                }
                
                addLog('','normal');
                addLog(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`,'clear');
                addLog(`üèÜ ${dngData.name} Ë∏èÁ†¥ÔºÅ üèÜ`,'clear');
                addLog(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`,'clear');
                addLog('Â∏∞ÈÇÑ„Åó„Åæ„Åô...','heal');
                setTimeout(() => {
                  setExploring(false);
                  setFloor(1);
                  setParty(p => p.map(c => ({...c, currentHp: c.maxHp, currentMp: c.maxMp})));
                  soundEngine.startBGM('town');
                }, 2000);
                return;
              }
            }
          } else if (event < 0.93) {
            if (floor < dngData.floors) {
              const newFloor = floor + 1;
              setFloor(newFloor);
              setMaxFloors(prev => ({...prev,[dungeon]:Math.max(prev[dungeon]||0,newFloor)}));
              addLog(`‚îÅ‚îÅ‚îÅ B${newFloor}F„Å∏Èôç„Çä„Åü ‚îÅ‚îÅ‚îÅ`,'item');
              const floorDesc = getFloorDesc(dungeon, newFloor);
              if (floorDesc) addLog(floorDesc,'explore');
              
              // v15.0: ÁâπÂÆöÈöéÂ±§„Åß„ÅÆ„Çπ„Éà„Éº„É™„Éº„Ç§„Éô„É≥„Éà
              const storyEvent = STORY_EVENTS[dungeon];
              if (storyEvent && storyEvent.trigger === `floor${newFloor}` && !storyFlags.eventsTriggered.includes(storyEvent.id)) {
                setTimeout(() => {
                  setPaused(true);
                  triggerStoryEvent(dungeon, `floor${newFloor}`);
                }, 500);
              }
            }
          } else if (event < 0.97) {
            const hasThief = alive.some(c => c.jobKey === 'thief' || c.jobKey === 'ninja');
            if (Math.random() < (hasThief ? 0.1 : 0.25)) {
              const trap = TRAPS[Math.floor(Math.random()*TRAPS.length)];
              addLog(`ÁΩ†Áô∫ÂãïÔºÅ${trap.name}`,'damage');
              soundEngine.playHit();
              setParty(p => p.map(c => ({...c, currentHp: Math.max(1, c.currentHp - Math.floor(c.maxHp*trap.dmg))})));
              setTimeout(() => useAutoPotion(), 100);
            } else {
              const goldFound = Math.floor(Math.random()*50*floor) + 20;
              setGold(prev => prev + goldFound);
              addLog(`ÂÆùÁÆ±Áô∫Ë¶ãÔºÅ +${goldFound}G`,'item');
              soundEngine.playGold();
            }
          } else {
            addLog('Ê≥â„ÅßÂõûÂæ©','heal');
            soundEngine.playHeal();
            setParty(p => p.map(c => ({...c, currentHp: Math.min(c.maxHp, c.currentHp + Math.floor(c.maxHp*0.3)), currentMp: Math.min(c.maxMp, c.currentMp + Math.floor(c.maxMp*0.3))})));
          }
        }, 1200);
        return () => clearInterval(interval);
      }, [exploring, dungeon, floor, party, retreatHP, paused, bossConfirm, addLog, useAutoPotion]);

      const createChar = () => {
        if (party.length >= 6) return;
        const raceKeys = Object.keys(RACES);
        const raceKey = raceKeys[Math.floor(Math.random()*raceKeys.length)];
        const race = RACES[raceKey];
        const alignKeys = Object.keys(ALIGNMENTS);
        const alignKey = alignKeys[Math.floor(Math.random()*alignKeys.length)];
        const availJobs = Object.entries(JOBS).filter(([_,j]) => j.align.includes(alignKey) && j.tier === 1);
        const [jobKey, job] = availJobs[Math.floor(Math.random()*availJobs.length)];
        const bonus = Math.floor(Math.random()*15)+5;
        const vit = race.vit + Math.floor(bonus*0.4);
        const int = race.int + Math.floor(bonus*0.2);
        const newChar = {
          id: Date.now(), name: genName(raceKey), race: race.name, raceKey,
          alignment: ALIGNMENTS[alignKey].name, alignKey, job: job.name, jobKey,
          level: 1, exp: 0,
          maxHp: Math.floor((vit*3+20)*job.hpMod), currentHp: Math.floor((vit*3+20)*job.hpMod),
          maxMp: Math.floor((int*2+10)*job.mpMod), currentMp: Math.floor((int*2+10)*job.mpMod),
          atk: Math.floor((race.str*1.5+5)*job.atkMod), def: Math.floor((vit*1.2+3)*job.defMod),
          str: race.str, int, pie: race.pie, vit, agi: race.agi, luk: race.luk,
          equipment: {}, previousJobs: []
        };
        setParty(prev => [...prev, newChar]);
        addLog(`${newChar.name}Ôºà${race.name}„ÅÆ${job.name}Ôºâ„ÅåÁôªÈå≤ÔºÅ`,'level');
      };

      const canChangeJob = (char, jobKey) => {
        const job = JOBS[jobKey];
        if (!job.align.includes(char.alignKey)) return {can:false,reason:'Â±ûÊÄß‰∏ç‰∏ÄËá¥'};
        if (char.level < 10) return {can:false,reason:'Lv10ÂøÖË¶Å'};
        for (const [stat,req] of Object.entries(job.req)) if ((char[stat]||0) < req) return {can:false,reason:`${stat}${req}ÂøÖË¶Å`};
        return {can:true};
      };
      const changeJob = (charId, newJobKey) => {
        setParty(prev => prev.map(char => {
          if (char.id !== charId) return char;
          const newJob = JOBS[newJobKey];
          soundEngine.playLevelUp();
          addLog(`‚òÖ ${char.name}„ÅØ${newJob.name}„Å´Ëª¢ËÅ∑ÔºÅ`,'level');
          const baseHp = Math.floor((char.vit*3+20)*newJob.hpMod);
          const baseMp = Math.floor((char.int*2+10)*newJob.mpMod);
          return {...char, job: newJob.name, jobKey: newJobKey, level: 1, exp: 0,
            maxHp: baseHp + Math.floor(char.maxHp*0.3), currentHp: baseHp + Math.floor(char.maxHp*0.3),
            maxMp: baseMp + Math.floor(char.maxMp*0.2), currentMp: baseMp + Math.floor(char.maxMp*0.2),
            atk: Math.floor((char.str*1.5+5)*newJob.atkMod), def: Math.floor((char.vit*1.2+3)*newJob.defMod),
            previousJobs: [...(char.previousJobs||[]), char.jobKey]};
        }));
        setShowJobChange(null);
      };

      const equipItem = (charId, item) => {
        const slot = ITEMS.weapons.some(w => w.id === item.id) || (item.id?.startsWith('bd') && item.atk && !item.def) ? 'weapon' 
                   : ITEMS.armors.some(a => a.id === item.id) || (item.id?.startsWith('bd') && item.def && !item.atk) ? 'armor' : 'accessory';
        setParty(prev => prev.map(char => {
          if (char.id !== charId) return char;
          const old = char.equipment[slot];
          let newAtk = char.atk, newDef = char.def;
          if (old) { if (old.atk) newAtk -= old.atk; if (old.def) newDef -= old.def; setInventory(p => [...p, old]); }
          if (item.atk) newAtk += item.atk; if (item.def) newDef += item.def;
          setInventory(p => p.filter(i => i.uid !== item.uid));
          return {...char, atk: newAtk, def: newDef, equipment: {...char.equipment, [slot]: item}};
        }));
      };

      const exportSave = () => { const blob = new Blob([JSON.stringify({party,gold,maxFloors,clearedDungeons,settings,bestiary,inventory,autoPotion})], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `wizardry-v13-${Date.now()}.json`; a.click(); };

      // v13.1: „Éú„ÇπÁ¢∫Ë™ç„É¢„Éº„ÉÄ„É´
      const BossConfirmModal = () => {
        if (!bossConfirm) return null;
        const { monster, isFinal } = bossConfirm;
        return (
          <div className="modal-overlay">
            <div className="retro-border bg-black p-6 max-w-md text-center">
              <h3 className="text-2xl gold-text mb-4">‚ö†Ô∏è BOSSÁô∫Ë¶ã ‚ö†Ô∏è</h3>
              <p className="text-xl mb-2">{monster.name}</p>
              <p className="text-sm text-gray-400 mb-4">HP:{monster.hp} ATK:{monster.atk} DEF:{monster.def}</p>
              {isFinal && <p className="text-yellow-400 mb-4">üèÜ ÊúÄÁµÇ„Éú„Çπ üèÜ</p>}
              <div className="mb-4 text-left">
                <p className="text-sm text-gray-300 mb-2">„Éë„Éº„ÉÜ„Ç£Áä∂ÊÖã:</p>
                {party.map(c => (
                  <div key={c.id} className="text-xs flex justify-between">
                    <span>{c.name}</span>
                    <span className={c.currentHp < c.maxHp * 0.5 ? 'red-text' : ''}>
                      HP:{c.currentHp}/{c.maxHp}
                    </span>
                  </div>
                ))}
              </div>
              <div className="flex gap-3 justify-center">
                <button onClick={() => { setPaused(false); }} className="retro-border px-6 py-2 hover:bg-green-900">‚öîÔ∏è Êà¶„ÅÜ</button>
                <button onClick={() => { setBossConfirm(null); setPaused(false); setExploring(false); setFloor(1); setParty(p => p.map(c => ({...c, currentHp: c.maxHp, currentMp: c.maxMp}))); addLog('Â∏∞ÈÇÑ„Åó„Åü','heal'); soundEngine.startBGM('town'); }} className="retro-border px-6 py-2 hover:bg-red-900 text-red-400">üèÉ Êí§ÈÄÄ</button>
              </div>
            </div>
          </div>
        );
      };

      // v15.0: ‰ºöË©±„É¢„Éº„ÉÄ„É´
      const DialogueModal = () => {
        if (!dialogueModal) return null;
        const { npc, lines, currentLine } = dialogueModal;
        const npcData = NPCS[npc];
        const isLastLine = currentLine >= lines.length - 1;
        
        const nextLine = () => {
          if (isLastLine) {
            setDialogueModal(null);
          } else {
            setDialogueModal(prev => ({ ...prev, currentLine: prev.currentLine + 1 }));
          }
        };
        
        return (
          <div className="modal-overlay" onClick={nextLine}>
            <div className="retro-border bg-black p-6 max-w-lg" onClick={e => e.stopPropagation()}>
              <div className="flex items-center gap-4 mb-4 pb-3" style={{borderBottom: '1px solid #3a3020'}}>
                <span className="text-4xl">{npcData?.portrait}</span>
                <div>
                  <h3 className="text-lg" style={{color: '#c4a060'}}>{npcData?.name}</h3>
                  <p className="text-xs" style={{color: '#6a5a4a'}}>{npcData?.title}</p>
                </div>
              </div>
              <p className="text-base leading-relaxed mb-6" style={{color: '#b8a880', minHeight: '80px'}}>
                {lines[currentLine]}
              </p>
              <div className="text-right">
                <button onClick={nextLine} className="btn-fantasy px-6 py-2">
                  {isLastLine ? 'Èñâ„Åò„Çã' : 'Ê¨°„Å∏ ‚ñ∂'}
                </button>
              </div>
            </div>
          </div>
        );
      };

      // v15.0: „Çπ„Éà„Éº„É™„Éº„Ç§„Éô„É≥„Éà„É¢„Éº„ÉÄ„É´
      const StoryEventModal = () => {
        if (!storyEventModal) return null;
        const { title, text, item } = storyEventModal;
        
        const closeEvent = () => {
          // „Ç¢„Ç§„ÉÜ„É†„Åå„ÅÇ„Çå„Å∞„Ç§„É≥„Éô„É≥„Éà„É™„Å´ËøΩÂä†
          if (item) {
            setInventory(prev => [...prev, { ...item, uid: Date.now() }]);
            addLog(`„ÄêÁô∫Ë¶ã„Äë${item.name}`, item.rarity === 'legendary' ? 'boss' : 'item');
          }
          setStoryEventModal(null);
          // Êé¢Á¥¢‰∏≠„Å™„Çâ‰∏ÄÊôÇÂÅúÊ≠¢„ÇíËß£Èô§
          if (exploring && paused && !bossConfirm) {
            setPaused(false);
          }
        };
        
        return (
          <div className="modal-overlay">
            <div className="retro-border bg-black p-6 max-w-lg">
              <h3 className="text-xl gold-text mb-4 text-center">‚ú® {title} ‚ú®</h3>
              <div className="p-4 mb-4" style={{background: 'rgba(60,50,40,0.3)', borderRadius: '4px'}}>
                <p className="text-sm leading-relaxed whitespace-pre-line" style={{color: '#b8a880'}}>
                  {text}
                </p>
              </div>
              {item && (
                <div className="text-center mb-4">
                  <span className={`rarity-${item.rarity} text-lg`}>üìú {item.name} „ÇíÂÖ•ÊâãÔºÅ</span>
                </div>
              )}
              <div className="text-center">
                <button onClick={closeEvent} className="btn-fantasy px-8 py-2">
                  Á¢∫Ë™ç
                </button>
              </div>
            </div>
          </div>
        );
      };

      // v15.0: „Ç®„É≥„Éá„Ç£„É≥„Ç∞ÁîªÈù¢
      const EndingScreen = () => {
        if (!endingPhase) return null;
        
        if (endingPhase === 'choice') {
          return (
            <div className="modal-overlay">
              <div className="retro-border bg-black p-8 max-w-lg text-center">
                <h3 className="text-2xl gold-text mb-6">{ENDING.wardnaChoice.title}</h3>
                <p className="text-base leading-relaxed whitespace-pre-line mb-6" style={{color: '#b8a880'}}>
                  {ENDING.wardnaChoice.text}
                </p>
                {prestige.count > 0 && (
                  <p className="text-sm mb-4" style={{color: '#6a8a6a'}}>
                    üåÄ ÁèæÂú®„ÅÆËª¢ÁîüÂõûÊï∞: {prestige.count}Âõû (EXP/Gold +{prestige.count * 10}%)
                  </p>
                )}
                <p className="text-sm mb-6" style={{color: '#8a8a6a'}}>
                  Ëª¢Áîü„Åô„Çã„Å®: ÂÖ®„É™„Çª„ÉÉ„Éà + Ê∞∏Á∂ö„Éú„Éº„Éä„Çπ EXP/Gold +{(prestige.count + 1) * 10}%
                </p>
                {ENDING.wardnaChoice.choices.map(c => (
                  <button key={c.id} onClick={() => c.id === 'prestige' ? doPrestige() : setEndingPhase('ending')} 
                    className="btn-fantasy px-8 py-3 text-lg mx-2">
                    {c.text}
                  </button>
                ))}
              </div>
            </div>
          );
        }
        
        if (endingPhase === 'ending') {
          return (
            <div className="fixed inset-0 bg-black flex items-center justify-center overflow-y-auto">
              <div className="max-w-2xl p-8 text-center">
                <div className="space-y-4 mb-12">
                  {ENDING.ending.lines.map((line, i) => (
                    <p key={i} className={`text-lg ${line.includes('„Äê') ? 'gold-text text-2xl mt-8' : ''}`} 
                      style={{color: line ? '#b8a880' : 'transparent', animation: `fadeIn ${0.5 + i * 0.1}s ease-out`}}>
                      {line || '\u00A0'}
                    </p>
                  ))}
                </div>
                <button onClick={() => setEndingPhase('postcredits')} className="btn-fantasy px-8 py-3 text-lg">
                  Á∂ö„Åç„ÇíË¶ã„Çã
                </button>
              </div>
            </div>
          );
        }
        
        if (endingPhase === 'postcredits') {
          return (
            <div className="fixed inset-0 bg-black flex items-center justify-center">
              <div className="max-w-lg p-8 text-center">
                <p className="text-lg leading-relaxed whitespace-pre-line mb-8" style={{color: '#666'}}>
                  {ENDING.ending.postCredits.text}
                </p>
                <p className="text-xl gold-text mb-12" style={{animation: 'textGlow 2s ease-in-out infinite'}}>
                  {ENDING.ending.postCredits.hint}
                </p>
                <button onClick={() => {
                  setEndingPhase(null);
                  setStoryFlags(prev => ({ ...prev, endingReached: true }));
                  setScreen('title');
                }} className="btn-fantasy px-8 py-3">
                  „Çø„Ç§„Éà„É´„Å∏
                </button>
              </div>
            </div>
          );
        }
        
        return null;
      };

      // „Çª„É©„Éï„Ç£„Éä„Å®„ÅÆ‰ºöË©±„ÇíÈñãÂßã
      const talkToSeraphina = () => {
        let dialogueKey = 'first';
        if (storyFlags.documents.includes('doc3')) dialogueKey = 'hasDoc3';
        else if (storyFlags.documents.includes('doc2')) dialogueKey = 'hasDoc2';
        else if (storyFlags.documents.includes('doc1')) dialogueKey = 'hasDoc1';
        else if (storyFlags.documents.includes('doc0')) dialogueKey = 'hasDoc0';
        
        const dialogue = SERAPHINA_DIALOGUES[dialogueKey];
        setDialogueModal({ npc: 'seraphina', lines: dialogue.lines, currentLine: 0 });
        
        if (!storyFlags.metSeraphina) {
          setStoryFlags(prev => ({ ...prev, metSeraphina: true }));
        }
      };

      // „Çπ„Éà„Éº„É™„Éº„Ç§„Éô„É≥„Éà„Çí„Éà„É™„Ç¨„Éº
      const triggerStoryEvent = (dungeonId, trigger) => {
        const event = STORY_EVENTS[dungeonId];
        if (!event || event.trigger !== trigger) return false;
        if (storyFlags.eventsTriggered.includes(event.id)) return false;
        
        setStoryEventModal({ title: event.title, text: event.text, item: event.item });
        setStoryFlags(prev => ({
          ...prev,
          eventsTriggered: [...prev.eventsTriggered, event.id],
          documents: event.item?.type === 'document' ? [...prev.documents, event.item.id] : prev.documents
        }));
        return true;
      };

      const JobModal = ({char, onClose}) => {
        if (!char) return null;
        return (
          <div className="modal-overlay" onClick={onClose}>
            <div className="retro-border bg-black p-4 max-w-md max-h-96 overflow-y-auto" onClick={e => e.stopPropagation()}>
              <h3 className="text-lg gold-text mb-3">üîÑ Ëª¢ËÅ∑ - {char.name}</h3>
              <div className="space-y-2">{Object.entries(JOBS).map(([k,j]) => {
                if (k === char.jobKey) return null;
                const c = canChangeJob(char, k);
                return (<div key={k} className={`p-2 bg-gray-900 text-sm ${c.can?'cursor-pointer hover:bg-green-900':'opacity-50'}`} onClick={() => c.can && changeJob(char.id, k)}>
                  <div className="flex justify-between"><span className={j.tier===2?'gold-text':''}>{j.name}</span><span className="text-sm">{c.can?'ÂèØËÉΩ':c.reason}</span></div>
                </div>);
              })}</div>
              <button onClick={onClose} className="mt-4 w-full retro-border py-2 hover:bg-red-900 text-red-400">Èñâ„Åò„Çã</button>
            </div>
          </div>
        );
      };

      // v14.4: Â£ÆÂ§ß„Å™„Çπ„Éà„Éº„É™„ÉºÔºà„Ç™„Éº„Éó„Éã„É≥„Ç∞Â∞ÇÁî®Ôºâ
      const STORY = {
        opening: [
          { text: 'Â§™Âè§„ÅÆÊòî„ÄÅ‰∏ñÁïå„ÅØÂÖâ„Å´Ê∫Ä„Å°„Å¶„ÅÑ„Åü„ÄÇ', delay: 0 },
          { text: '', delay: 2000 },
          { text: '‰∫∫„ÄÖ„ÅØÂ§ßÂú∞„ÅÆÊÅµ„Åø„ÅÆ„ÇÇ„Å®„ÄÅ', delay: 3000 },
          { text: 'Âπ≥Âíå„Å´ÊöÆ„Çâ„Åó„Å¶„ÅÑ„Åü„ÄÇ', delay: 4500 },
          { text: '', delay: 6000 },
          { text: '„Åó„Åã„ÅóÂçÉÂπ¥Ââç‚Äî‚Äî', delay: 7000 },
          { text: '', delay: 8500 },
          { text: 'ÁãÇÊ∞ó„ÅÆÈ≠îË°ìÂ∏´„Äå„ÉØ„Éº„Éâ„Éä„Äç„ÅØ', delay: 9500 },
          { text: 'Á¶ÅÂøå„ÅÆÈ≠îÂ∞éÊõ∏„Äå„Çπ„Ç≠„Éº„Éû„Äç„ÇíÁô∫Âãï„Åó„Åü„ÄÇ', delay: 11000 },
          { text: '', delay: 13000 },
          { text: '„Åù„Çå„ÅØ‰∏ñÁïå„ÅÆÊ∑±Ê∑µ„Å∏„Å®Á∂ö„ÅèÈñÄ„ÇíÈñã„ÅèË°ì„ÄÇ', delay: 14000 },
          { text: '', delay: 16000 },
          { text: 'Âú∞„ÅÆÂ∫ï„Åã„ÇâÊπß„ÅçÂá∫„Åó„ÅüÈ≠îÁâ©„Åü„Å°„ÅØ', delay: 17000 },
          { text: 'ÁéãÂõΩ„ÇíËí°„ÅÑ„ÄÅÊñáÊòé„ÇíÁÅ∞Ááº„Å´Â∏∞„Åó„Åü„ÄÇ', delay: 18500 },
          { text: '', delay: 20500 },
          { text: '‰∫∫„ÄÖ„ÅØÊï£„ÇäÊï£„Çä„Å´„Å™„Çä„ÄÅ', delay: 21500 },
          { text: 'ÂÖâ„ÅØÈóá„Å´È£≤„Åæ„Çå„Åü„ÄÇ', delay: 23000 },
          { text: '', delay: 25000 },
          { text: '„Åù„Çå„Åã„ÇâÈï∑„ÅÑÊôÇ„ÅåÊµÅ„Çå„Åü„ÄÇ', delay: 26000 },
          { text: '', delay: 28000 },
          { text: '‰ªä„ÄÅÂªÉÂ¢ü„ÅÆË°ó„É™„É´„Ç¨„Éü„É≥„Å´', delay: 29000 },
          { text: 'ÂãáÊ∞ó„ÅÇ„ÇãËÄÖ„Åü„Å°„ÅåÈõÜ„Åæ„ÇäÂßã„ÇÅ„Åü„ÄÇ', delay: 30500 },
          { text: '', delay: 32500 },
          { text: 'ÂΩº„Çâ„ÅÆÁõÆÁöÑ„ÅØ„Åü„Å†„Å≤„Å®„Å§„ÄÇ', delay: 33500 },
          { text: '', delay: 35500 },
          { text: 'Ê∑±Ê∑µ„ÅÆÊúÄÂ••„Å´Áú†„Çã„ÉØ„Éº„Éâ„Éä„ÇíË®é„Å°„ÄÅ', delay: 36500 },
          { text: '„Äå„Çπ„Ç≠„Éº„Éû„Äç„ÇíÊ∞∏ÈÅ†„Å´Â∞ÅÂç∞„Åô„Çã„Åì„Å®„ÄÇ', delay: 38000 },
          { text: '', delay: 40000 },
          { text: '„Åï„ÅÇ„ÄÅÂÜíÈô∫ËÄÖ„Çà‚Äî‚Äî', delay: 41000 },
          { text: '', delay: 43000 },
          { text: '„ÅäÂâç„ÅÆÁâ©Ë™û„Åå„ÄÅ‰ªäÂßã„Åæ„Çã„ÄÇ', delay: 44000 },
        ],
        prologue: `Ê∑±Ê∑µ„ÅÆÊúÄÂ••„Å´Áú†„Çã„ÉØ„Éº„Éâ„Éä„ÇíË®é„Å°„ÄÅ
„Äå„Çπ„Ç≠„Éº„Éû„Äç„ÇíÂ∞ÅÂç∞„Åõ„Çà„ÄÇ`,
        cleared: `„Å§„ÅÑ„Å´„ÉØ„Éº„Éâ„Éä„ÅØÂÄí„Çå„Åü„ÄÇ

„Äå„Çπ„Ç≠„Éº„Éû„Äç„ÅÆÂäõ„ÅØÊ∂à„ÅàÂéª„Çä„ÄÅ
Ê∑±Ê∑µ„Å∏„ÅÆÈñÄ„ÅØÊ∞∏ÈÅ†„Å´Èñâ„Åñ„Åï„Çå„Åü„ÄÇ

‰∫∫„ÄÖ„ÅØÂÜç„Å≥Âú∞‰∏ä„Å´Â∏åÊúõ„ÇíË¶ãÂá∫„Åó„ÄÅ
„É™„É´„Ç¨„Éü„É≥„ÅÆË°ó„Å´„ÅØÊ¥ªÊ∞ó„ÅåÊàª„Çä„Å§„Å§„ÅÇ„Çã„ÄÇ

„Åó„Åã„Åó‰ºùË™¨„ÅØË™û„Çã‚Äî‚Äî
„ÄåÈóá„ÅØÊ≠ª„Å™„Åö„ÄÅ„ÅÑ„Å§„ÅãÂøÖ„ÅöËìã„Çã„Äç„Å®„ÄÇ

„Åù„ÅÆÊó•„ÅåÊù•„Çã„Åæ„Åß„ÄÅ
Ëã±ÈõÑ„Åü„Å°„ÅÆ‰ºùË™¨„ÅØË™û„ÇäÁ∂ô„Åå„Çå„Å¶„ÅÑ„Åè„Å†„Çç„ÅÜ„ÄÇ`
      };

      // v15.1: „Ç™„Éº„Éó„Éã„É≥„Ç∞Áî®useEffectÔºà„Éà„ÉÉ„Éó„É¨„Éô„É´„ÅßÂÆöÁæ©Ôºâ
      useEffect(() => {
        if (screen !== 'opening') return;
        setOpeningLines([]);
        setOpeningDone(false);
        STORY.opening.forEach((line, idx) => {
          setTimeout(() => {
            setOpeningLines(prev => [...prev, line.text]);
            if (idx === STORY.opening.length - 1) {
              setTimeout(() => setOpeningDone(true), 3000);
            }
          }, line.delay);
        });
      }, [screen]);

      // v14.4: „Ç™„Éº„Éó„Éã„É≥„Ç∞ÁîªÈù¢
      if (screen === 'opening') {
        const skipOpening = () => {
          setScreen('main');
          soundEngine.startBGM('town');
        };
        
        return (
          <div className="opening-container flex items-center justify-center">
            <div className="max-w-2xl text-center px-8">
              <h1 className="opening-title text-4xl mb-12" style={{color: '#c4a060', fontWeight: 700, letterSpacing: '0.15em'}}>WIZARDRY SCHEMA</h1>
              <div className="space-y-3">
                {openingLines.map((line, i) => (
                  <p key={i} className="text-lg" style={{color: line ? '#b8a880' : 'transparent', animation: line ? 'fadeIn 1s ease-out' : 'none', minHeight: '1.5em'}}>
                    {line || '\u00A0'}
                  </p>
                ))}
              </div>
              {openingDone && (
                <button onClick={skipOpening} className="mt-12 btn-fantasy px-8 py-3 text-lg" style={{animation: 'fadeIn 1s ease-out'}}>
                  ÂÜíÈô∫„ÇíÂßã„ÇÅ„Çã
                </button>
              )}
            </div>
            <button onClick={skipOpening} className="skip-btn btn-fantasy px-4 py-2 text-sm">
              SKIP ‚ñ∂
            </button>
          </div>
        );
      }

      if (screen === 'title') {
        const isCleared = clearedDungeons['trebor'];
        const hasSave = party.length > 0;
        return (
          <div className="min-h-screen flex flex-col items-center justify-center p-4">
            <div className="retro-border p-8 text-center max-w-lg">
              <h1 className="text-3xl mb-3" style={{color: '#c4a060', fontWeight: 700, letterSpacing: '0.1em', textShadow: '0 2px 8px rgba(0,0,0,0.5)'}}>WIZARDRY SCHEMA</h1>
              <p className="text-sm mb-6" style={{color: '#6a5a4a'}}>„Äú Ê∑±Ê∑µ„ÅÆÈ≠îÂ∞éÊõ∏ „Äú</p>
              <div className="text-left mb-6 p-4" style={{background: 'rgba(0,0,0,0.3)', borderRadius: '4px'}}>
                <p className="text-sm leading-relaxed whitespace-pre-line" style={{color: '#9a8a70'}}>
                  {isCleared ? STORY.cleared : STORY.prologue}
                </p>
              </div>
              <div className="space-y-3">
                {hasSave ? (
                  <>
                    <button onClick={() => {setScreen('main'); initSound();}} className="block w-full btn-fantasy px-6 py-3 text-lg">CONTINUE</button>
                    <button onClick={() => {if(!confirm('„Çª„Éº„Éñ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Å¶ÊúÄÂàù„Åã„ÇâÂßã„ÇÅ„Åæ„Åô„ÅãÔºü')) return; localStorage.removeItem('wizardrySchemaV15'); setParty([]); setGold(100); setMaxFloors({}); setClearedDungeons({}); setBestiary({}); setInventory([]); setScreen('opening'); initSound();}} className="block w-full btn-fantasy px-6 py-2 text-sm" style={{color: '#888'}}>NEW GAME</button>
                    <button onClick={exportSave} className="block w-full btn-fantasy px-6 py-2 text-sm" style={{color: '#6ab0ff'}}>EXPORT</button>
                  </>
                ) : (
                  <button onClick={() => {setScreen('opening'); initSound();}} className="block w-full btn-fantasy px-6 py-3 text-lg">NEW GAME</button>
                )}
              </div>
              <p className="text-xs mt-4" style={{color: '#4a4035'}}>v17.0</p>
            </div>
          </div>
        );
      }

      if (exploring) {
        return (
          <div className="min-h-screen p-2">
            <BossConfirmModal />
            <DialogueModal />
            <StoryEventModal />
            <EndingScreen />
            <div className="max-w-6xl mx-auto">
              <div className="retro-border p-3 mb-2 flex justify-between items-center">
                <div className="flex items-center gap-4">
                  <span className="gold-text text-xl">üè∞ {DUNGEONS.find(d=>d.id===dungeon)?.name}</span>
                  <span className="text-3xl blink">B{floor}F</span>
                  {paused && <span className="text-yellow-400">„Äê‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠„Äë</span>}
                </div>
                <div className="flex gap-4 items-center text-base">
                  <span className="gold-text">üí∞{gold.toLocaleString()}G</span>
                  {prestige.count > 0 && <span className="text-cyan-400 ml-4">üåÄËª¢Áîü{prestige.count} (+{prestige.count * 10}%)</span>}
                  <span className="purple-text">üì¶{inventory.length}</span>
                  <button onClick={() => {setExploring(false); setFloor(1); setPaused(false); setBossConfirm(null); setParty(p => p.map(c => ({...c, currentHp: c.maxHp, currentMp: c.maxMp}))); addLog('Â∏∞ÈÇÑ„Åó„Åü','heal'); soundEngine.startBGM('town');}} className="retro-border px-4 py-2 hover:bg-red-900 text-red-400">Â∏∞ÈÇÑ</button>
                </div>
              </div>
              <div className="text-sm text-gray-500 mb-2 px-1">{getFloorDesc(dungeon, floor)}</div>
              <div className="grid lg:grid-cols-4 gap-2">
                <div className="lg:col-span-3 retro-border p-3">
                  <h2 className="text-base mb-2 border-b border-green-800 pb-1">„Äê ÂÜíÈô∫Ë®òÈå≤ „Äë</h2>
                  <div ref={logRef} className="h-96 overflow-y-auto bg-black p-2 text-sm log-scroll">
                    {logs.map((l,i) => <p key={i} className={`${l.c} mb-1`}>{l.msg || ' '}</p>)}
                  </div>
                </div>
                <div className="retro-border p-2">
                  <h2 className="text-base mb-2 border-b border-green-800 pb-1">„Äê „Éë„Éº„ÉÜ„Ç£ „Äë</h2>
                  <div className="space-y-2">
                    {party.map(char => (
                      <div key={char.id} className={`text-sm p-2 bg-gray-900 ${char.currentHp === 0 ? 'opacity-50' : ''}`}>
                        <div className="flex justify-between mb-1">
                          <span className="font-bold">{char.name}</span>
                          <span className="text-gray-500 text-xs">Lv.{char.level} {char.job}</span>
                        </div>
                        <div className="flex gap-2 text-xs">
                          <span className="red-text">HP:{char.currentHp}/{char.maxHp}</span>
                          <span className="blue-text">MP:{char.currentMp}/{char.maxMp}</span>
                        </div>
                        <div className="w-full bg-gray-700 h-2 mt-1 rounded">
                          <div className="bg-red-500 h-2 rounded" style={{width:`${(char.currentHp/char.maxHp)*100}%`}}/>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // v14.0: ÊñΩË®≠„É°„Éã„É•„ÉºÁîªÈù¢
      if (!currentFacility) {
        return (
          <div className="min-h-screen p-4">
            {showJobChange && <JobModal char={showJobChange} onClose={() => setShowJobChange(null)} />}
            <DialogueModal />
            <StoryEventModal />
            <div className="max-w-4xl mx-auto">
              {/* v14.2: NildaÈ¢®„Éò„ÉÉ„ÉÄ„Éº */}
              <div className="text-center mb-6 pt-4">
                <h1 className="text-2xl mb-2" style={{color: '#c4a060', fontWeight: 700, letterSpacing: '0.15em', textShadow: '0 2px 4px rgba(0,0,0,0.5)'}}>WIZARDRY SCHEMA</h1>
                <p className="text-sm" style={{color: '#6a5a4a'}}>„Äú „É™„É´„Ç¨„Éü„É≥„ÅÆË°ó „Äú</p>
                <div className="flex justify-center gap-6 mt-4 text-sm" style={{color: '#6a5a4a'}}>
                  <span className="gold-text">{gold.toLocaleString()} G</span>
                  <span>ÊâÄÊåÅÂìÅ {inventory.length}</span>
                  <span>‰∏ÄË°å {party.length}/6</span>
                </div>
              </div>
              {/* NPC„Ç¨„Ç§„Éâ - „Çπ„Éà„Éº„É™„ÉºÈÄ£Âãï */}
              <div className="retro-border p-4 mb-5">
                <p className="text-sm font-bold mb-2" style={{color: '#c4a060'}}>„ÇÆ„É´„Éâ„ÅÆÂèó‰ªò</p>
                <p className="text-sm" style={{color: '#a09080', lineHeight: '1.6'}}>
                  {clearedDungeons['trebor'] ? '„Äå‰ºùË™¨„ÅÆËã±ÈõÑ„Åü„Å°„Çà„ÄÇ„ÉØ„Éº„Éâ„Éä„ÇíÂÄí„Åó„Å¶„Åè„Çå„Åü„ÅÆ„Åò„ÇÉ„Å™„ÄÇ„Åì„ÅÆ‰∏ñÁïå„ÅØ„Åù„Å™„Åü„Å´ÊÑüË¨ù„Åó„Å¶„Åä„Çã„ÄÇ„Äç' :
                   party.length === 0 ? '„Äå„Çà„ÅÜ„Åì„Åù„ÄÅÂÜíÈô∫ËÄÖ„Çà„ÄÇÊ∑±Ê∑µ„ÅÆÈ≠îÂ∞éÊõ∏„Äå„Çπ„Ç≠„Éº„Éû„Äç„ÇíÂ∞ÅÂç∞„Åô„Çã„Åü„ÇÅ„Å´„ÄÅ„Åæ„Åö„ÅØ‰ª≤Èñì„ÅåÂøÖË¶Å„Åò„ÇÉ„ÄÇ„Äç' :
                   party.length < 3 ? `„Äå${party[0]?.name}„Åü„Å°„Çà„ÄÇÊ∑±Ê∑µ„ÅØÂç±Èô∫„Åò„ÇÉ„ÄÇ„ÇÇ„ÅÜÂ∞ë„Åó‰ª≤Èñì„ÇíÈõÜ„ÇÅ„Çã„ÅÆ„Åò„ÇÉ„ÄÇ„Äç` :
                   clearedDungeons['dragon'] ? '„Äå„ÅÑ„Çà„ÅÑ„ÇàÊúÄÂæå„ÅÆË©¶Á∑¥Â†¥„Åò„ÇÉ„ÄÇ„ÉØ„Éº„Éâ„Éä„ÅåÂæÖ„Å£„Å¶„Åä„Çã„ÄÇ„Äå„Çπ„Ç≠„Éº„Éû„Äç„ÇíÂ∞ÅÂç∞„Åõ„ÇàÔºÅ„Äç' :
                   clearedDungeons['kaoka'] ? '„ÄåÂè§‰ª£Èæç„ÅÆÁ•ûÊÆø„ÅåË¶ã„Å§„Åã„Å£„Åü„Åù„ÅÜ„Åò„ÇÉ„Å™„ÄÇ‰ºùË™¨„ÅÆÁ´ú„ÅåÂ∞ÅÂç∞„ÅÆÈçµ„ÇíÂÆà„Å£„Å¶„Åä„Çã„ÄÇ„Äç' :
                   clearedDungeons['sewer'] ? '„ÄåÈÅ•„Åã„Å™„ÇãÈÅ∫Ë∑°„ÅåÊµÆ‰∏ä„Åó„Åü„Åù„ÅÜ„Åò„ÇÉ„ÄÇ„Äå„Çπ„Ç≠„Éº„Éû„Äç„ÅÆÊâã„Åå„Åã„Çä„Åå„ÅÇ„Çã„ÇÑ„ÇÇ„Åó„Çå„Çì„ÄÇ„Äç' :
                   clearedDungeons['thieves'] ? '„Äå‰∏ãÊ∞¥ÈÅì„Å´Âè§„ÅÑÊÇ™„ÅåÊΩú„Çì„Åß„Åä„Çã„Åù„ÅÜ„Åò„ÇÉ„ÄÇÊ∞ó„Çí„Å§„Åë„Çã„ÅÆ„Åò„ÇÉ„Åû„ÄÇ„Äç' :
                   clearedDungeons['kobold'] ? '„ÄåÁõóË≥ä„Å©„ÇÇ„ÅåÂè§„ÅÑÈÅ∫Áâ©„ÇíÈö†„ÅóÊåÅ„Å£„Å¶„Åä„Çã„Å®„ÅÑ„ÅÜÂôÇ„ÇÇ„ÅÇ„Çã„ÅÆ„ÅÜ„ÄÇ„Äç' :
                   clearedDungeons['slime'] ? '„ÄåÊ¨°„ÅØ„Ç≥„Éú„É´„Éâ„ÅÆÂ∑£„Åò„ÇÉ„Å™„ÄÇÂ•áÂ¶ô„Å™È≠îÂäõ„ÅÆÊ≥¢Âãï„ÅåÊÑü„Åò„Çâ„Çå„Çã„ÄÇ„Äç' :
                   '„Äå„Åæ„Åö„ÅØ„Çπ„É©„Ç§„É†„ÅÆÁ©¥„ÅßËÖïË©¶„Åó„Åò„ÇÉ„ÄÇÊ∑±Ê∑µ„Å∏„ÅÆÈÅì„ÅØÈï∑„ÅÑ„Åû„ÄÇ„Äç'}
                </p>
              </div>
              {/* v14.2: ÊñΩË®≠„É°„Éã„É•„ÉºÔºàNildaÈ¢®2Âàó„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ */}
              <div className="grid grid-cols-2 gap-4 mb-5">
                {FACILITIES.filter(f => f.id !== 'gate').map(f => (
                  <div key={f.id} onClick={() => setCurrentFacility(f.id)} 
                    className="facility-card p-5" style={{background: `linear-gradient(180deg, ${f.color} 0%, #1a1512 100%)`}}>
                    <h3 className="text-base font-bold mb-2" style={{color: '#e0d0b0'}}>{f.name}</h3>
                    <p className="text-xs" style={{color: '#6a5a4a'}}>{f.desc}</p>
                  </div>
                ))}
              </div>
              {/* Âá∫Áô∫„Ç≤„Éº„ÉàÔºàÂ§ß„Åç„ÅèÁõÆÁ´ã„Åü„Åõ„ÇãÔºâ */}
              <div onClick={() => setCurrentFacility('gate')} className="gate-card facility-card p-6 cursor-pointer mb-5">
                <h3 className="text-xl font-bold gold-text mb-2">Âá∫Áô∫„Ç≤„Éº„Éà</h3>
                <p className="text-sm" style={{color: '#a08050'}}>„ÉÄ„É≥„Ç∏„Éß„É≥„Å∏Âá∫Áô∫</p>
              </div>
              {/* „Éë„Éº„ÉÜ„Ç£„Çµ„Éû„É™„Éº */}
              {party.length > 0 && (
                <div className="retro-border p-4 mb-5">
                  <h3 className="section-title text-sm mb-3 pb-2" style={{borderColor: '#3a3020'}}>„Éë„Éº„ÉÜ„Ç£</h3>
                  <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                    {party.map(c => (
                      <div key={c.id} className="char-card p-3 text-center">
                        <div className="font-bold truncate text-sm" style={{color: '#e0d0b0'}}>{c.name}</div>
                        <div className="text-xs mt-1" style={{color: '#6a5a4a'}}>Lv.{c.level} {c.job}</div>
                        <div className="mt-2 h-1 rounded" style={{background: '#1a1510', border: '1px solid #3a2a1a'}}>
                          <div className="h-full rounded" style={{width: `${(c.currentHp/c.maxHp)*100}%`, background: 'linear-gradient(90deg, #8b3535, #a04545)'}} />
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              {/* „Éï„ÉÉ„Çø„Éº */}
              <div className="flex justify-between items-center text-sm" style={{color: '#5a4a3a'}}>
                <button onClick={() => setShowSettings(!showSettings)} className="hover:opacity-80" style={{color: '#8a7a5a'}}>‚öôÔ∏è Ë®≠ÂÆö</button>
                <button onClick={() => setScreen('title')} className="hover:opacity-80" style={{color: '#8a7a5a'}}>„Çø„Ç§„Éà„É´„Å∏</button>
              </div>
              {showSettings && (
                <div className="retro-border p-4 mt-4 text-sm">
                  <div className="grid md:grid-cols-2 gap-4">
                    <div><label className="flex items-center gap-2 mb-2" style={{color: '#a09080'}}><input type="checkbox" checked={settings.bgm} onChange={e => setSettings(p => ({...p, bgm: e.target.checked}))} /> BGM</label>
                    <input type="range" min="0" max="100" value={settings.bgmVol} onChange={e => setSettings(p => ({...p, bgmVol: +e.target.value}))} className="w-full" style={{accentColor: '#8a7050'}} /></div>
                    <div><label className="flex items-center gap-2 mb-2" style={{color: '#a09080'}}><input type="checkbox" checked={settings.sfx} onChange={e => {setSettings(p => ({...p, sfx: e.target.checked})); soundEngine.sfxEnabled = e.target.checked;}} /> ÂäπÊûúÈü≥</label>
                    <input type="range" min="0" max="100" value={settings.sfxVol} onChange={e => setSettings(p => ({...p, sfxVol: +e.target.value}))} className="w-full" style={{accentColor: '#8a7050'}} /></div>
                  </div>
                  <div className="mt-3 pt-3" style={{borderTop: '1px solid #3a3020'}}>
                    <label className="flex items-center gap-2 mb-2" style={{color: '#a09080'}}><input type="checkbox" checked={autoPotion} onChange={e => setAutoPotion(e.target.checked)} /> üíä Ëá™Âãï„Éù„Éº„Ç∑„Éß„É≥‰ΩøÁî®</label>
                    {isAutoResumeUnlocked ? (
                      <label className="flex items-center gap-2 mb-2" style={{color: '#a09080'}}><input type="checkbox" checked={autoResume} onChange={e => setAutoResume(e.target.checked)} /> üîÑ Ëá™ÂãïÊé¢Á¥¢ÂÜçÈñãÔºàÊí§ÈÄÄÂæå3Áßí„ÅßÂÜçÂá∫Áô∫Ôºâ</label>
                    ) : (
                      <p className="text-xs mb-2" style={{color: '#5a4a3a'}}>üîí Ëá™ÂãïÊé¢Á¥¢ÂÜçÈñã: Ëª¢Áîü1Âõû„ÅßËß£Êîæ</p>
                    )}
                    {isAutoSellUnlocked ? (
                      <label className="flex items-center gap-2" style={{color: '#a09080'}}><input type="checkbox" checked={autoSell} onChange={e => setAutoSell(e.target.checked)} /> üí∞ Ëá™ÂãïÂ£≤Âç¥ÔºàCommonË£ÖÂÇô„ÇíÂç≥Â£≤Âç¥Ôºâ</label>
                    ) : (
                      <p className="text-xs" style={{color: '#5a4a3a'}}>üîí Ëá™ÂãïÂ£≤Âç¥: Ëª¢Áîü3Âõû„ÅßËß£Êîæ</p>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      }

      // v14.0: ÊñΩË®≠Ë©≥Á¥∞ÁîªÈù¢
      const facilityInfo = FACILITIES.find(f => f.id === currentFacility);
      return (
        <div className="min-h-screen p-2">
          {showJobChange && <JobModal char={showJobChange} onClose={() => setShowJobChange(null)} />}
          <div className="max-w-5xl mx-auto">
            {/* ÊñΩË®≠„Éò„ÉÉ„ÉÄ„Éº */}
            <div className="retro-border p-3 mb-3 flex justify-between items-center flex-wrap gap-2">
              <div className="flex items-center gap-3">
                <button onClick={() => setCurrentFacility(null)} className="text-lg hover:opacity-70 transition-opacity" style={{color: '#8a7a5a'}}>‚óÄ Êàª„Çã</button>
                <h1 className="text-xl gold-text">{facilityInfo?.name}</h1>
              </div>
              <div className="flex gap-4 text-sm items-center" style={{color: '#8a7a5a'}}>
                <span className="gold-text">{gold.toLocaleString()} G</span>
                <span>ÊâÄÊåÅÂìÅ {inventory.length}</span>
              </div>
            </div>
            <div className="retro-border p-4">
              {currentFacility === 'gate' && (<>
                <h2 className="text-xl mb-3 border-b border-green-800 pb-2">„Äê Ëø∑ÂÆÆÂÖ•Âè£ „Äë</h2>
                <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-2 mb-4">
                  {DUNGEONS.map((d, idx) => {
                    const avgLv = party.length > 0 ? Math.floor(party.reduce((a,c) => a+c.level, 0)/party.length) : 0;
                    const isCleared = clearedDungeons[d.id];
                    // v13.2: Ââç„ÅÆ„ÉÄ„É≥„Ç∏„Éß„É≥Ë∏èÁ†¥„ÅßÊ¨°„ÇíËß£Êîæ
                    const prevDungeon = idx > 0 ? DUNGEONS[idx - 1] : null;
                    const prevCleared = prevDungeon ? clearedDungeons[prevDungeon.id] : true;
                    const isUnlocked = idx === 0 || prevCleared;
                    const meetsLevel = avgLv >= d.minLv;
                    const canEnter = isUnlocked && meetsLevel && party.length > 0;
                    // ÂÖ•„Çå„Å™„ÅÑÁêÜÁî±„ÇíÂà§ÂÆö
                    let lockReason = '';
                    if (party.length === 0) lockReason = '„Éë„Éº„ÉÜ„Ç£„Å™„Åó';
                    else if (!isUnlocked) lockReason = `üîí ${prevDungeon?.name}Ë∏èÁ†¥„ÅßËß£Êîæ`;
                    else if (!meetsLevel) lockReason = `Lv‰∏çË∂≥ (Âπ≥ÂùáLv.${avgLv})`;
                    return (<button key={d.id} onClick={() => {if (!canEnter) return; setExploring(true); setFloor(1); setLogs([]); setLastDungeon(d.id); addLog(`‚îÅ‚îÅ‚îÅ ${d.name}„Å∏ ‚îÅ‚îÅ‚îÅ`,'level'); addLog(getFloorDesc(d.id, 1),'explore'); setDungeon(d.id); soundEngine.startBGM(d.id);}} disabled={!canEnter}
                      className={`text-left p-3 text-sm bg-gray-900 ${canEnter?'hover:bg-green-800 cursor-pointer':'opacity-50'} ${isCleared?'border-l-4 border-yellow-500':''}`}>
                      <div className="font-bold flex items-center gap-1">{isCleared && 'üèÜ'}{d.name}</div>
                      <div className="text-gray-500">B{d.floors}F / Lv.{d.minLv}+</div>
                      {maxFloors[d.id] && <div className="text-green-600">ÊúÄÊ∑±B{maxFloors[d.id]}F</div>}
                      {!canEnter && lockReason && <div className="text-red-400 text-xs mt-1">{lockReason}</div>}
                    </button>);
                  })}
                </div>
                <div className="p-2 bg-gray-900 text-sm inline-block"><span>Èõ¢ËÑ±HP: {retreatHP}%</span><input type="range" min="10" max="50" value={retreatHP} onChange={e => setRetreatHP(+e.target.value)} className="ml-2 w-32" /></div>
              </>)}
              {currentFacility === 'guild' && (<>
                <h2 className="text-xl mb-3 border-b border-green-800 pb-2">„Äê ÂÜíÈô∫ËÄÖÁôªÈå≤ „Äë</h2>
                {/* v15.0: „Çª„É©„Éï„Ç£„ÉäNPC */}
                <div className="p-4 mb-4" style={{background: 'rgba(80,60,40,0.3)', borderRadius: '8px', border: '1px solid #5a4a3a'}}>
                  <div className="flex items-center gap-4">
                    <span className="text-4xl">üë©‚Äçüî¨</span>
                    <div className="flex-1">
                      <h3 className="text-base" style={{color: '#c4a060'}}>„Çª„É©„Éï„Ç£„Éä <span className="text-xs" style={{color: '#6a5a4a'}}>Âè§‰ª£Âè≤Á†îÁ©∂ËÄÖ</span></h3>
                      <p className="text-xs mt-1" style={{color: '#8a7a6a'}}>
                        {storyFlags.documents.includes('doc3') ? '„ÄåÁúüÂÆü„ÇíÁü•„Å£„Åü‰ªä„ÄÅ‰Ωï„ÇíÊÄù„ÅÑ„Åæ„Åô„ÅãÔºü„Äç' :
                         storyFlags.documents.length > 0 ? '„Äå‰Ωï„ÅãÊñ∞„Åó„ÅÑÁô∫Ë¶ã„ÅØ„ÅÇ„Çä„Åæ„Åó„Åü„ÅãÔºü„Äç' :
                         storyFlags.metSeraphina ? '„Äå„ÉÄ„É≥„Ç∏„Éß„É≥„ÅßË¶ã„Å§„Åë„ÅüÁâ©„Åå„ÅÇ„Çå„Å∞„ÄÅË¶ã„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ„Äç' :
                         '„Äå„ÅÇ„Å™„Åü„Å´Ë©±„Åó„Åü„ÅÑ„Åì„Å®„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„Äç'}
                      </p>
                    </div>
                    <button onClick={talkToSeraphina} className="btn-fantasy px-4 py-2 text-sm">Ë©±„Åô</button>
                  </div>
                </div>
                <p className="text-gray-400 mb-4">Êñ∞„Åü„Å™ÂÜíÈô∫ËÄÖ„Çí„ÇÆ„É´„Éâ„Å´ÁôªÈå≤„Åó„Åæ„Åô„ÄÇ</p>
                <div className="p-4 bg-gray-900 rounded mb-4">
                  <div className="text-center mb-4">
                    <span className="text-6xl">üë§</span>
                    <p className="text-lg mt-2">ÁôªÈå≤Ê∏à„Åø: <span className="gold-text">{party.length}</span> / 6</p>
                  </div>
                  <button onClick={createChar} disabled={party.length>=6} 
                    className="w-full retro-border px-6 py-3 text-lg hover:bg-green-900 disabled:opacity-50">
                    Ôºã Êñ∞Ë¶èÂÜíÈô∫ËÄÖ„ÇíÁôªÈå≤
                  </button>
                  {party.length >= 6 && <p className="text-center text-yellow-400 mt-2">ÁôªÈå≤‰∏äÈôê„Å´ÈÅî„Åó„Å¶„ÅÑ„Åæ„Åô</p>}
                </div>
                {party.length > 0 && (
                  <div className="text-sm text-gray-500">
                    <p className="mb-2">ÊúÄËøëÁôªÈå≤„Åó„ÅüÂÜíÈô∫ËÄÖ:</p>
                    <div className="p-2 bg-gray-900 rounded">
                      <span className="font-bold">{party[party.length-1].name}</span>
                      <span className="text-gray-400 ml-2">{party[party.length-1].race} {party[party.length-1].job}</span>
                    </div>
                  </div>
                )}
              </>)}
              {currentFacility === 'tavern' && (<>
                <h2 className="text-xl mb-3 border-b border-green-800 pb-2">„Äê „Éë„Éº„ÉÜ„Ç£ÁÆ°ÁêÜ „Äë({party.length}/6)</h2>
                {party.length === 0 ? (
                  <div className="text-center py-8">
                    <p className="text-gray-500 mb-4">„Éë„Éº„ÉÜ„Ç£„Å´Ë™∞„ÇÇ„ÅÑ„Åæ„Åõ„Çì</p>
                    <button onClick={() => setCurrentFacility('guild')} className="retro-border px-4 py-2 hover:bg-amber-900">‚öîÔ∏è „ÇÆ„É´„Éâ„ÅßÂÜíÈô∫ËÄÖ„ÇíÁôªÈå≤</button>
                  </div>
                ) : (<>
                  <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3 mb-3">
                    {party.map(char => {
                      const trait = getRaceTrait(char.raceKey);
                      return (
                      <div key={char.id} className="p-3 bg-gray-900 text-sm">
                        <div className="flex justify-between"><span className="font-bold text-base">{char.name}</span><span className={ALIGNMENTS[char.alignKey]?.color}>{char.alignment}</span></div>
                        <div className="text-gray-400">Lv.{char.level} {char.race} {char.job}</div>
                        {trait.desc && <div className="text-xs text-cyan-400 mt-1">‚ú® {trait.desc}</div>}
                        <div className="mt-2 grid grid-cols-2 gap-1"><span className="red-text">HP:{char.currentHp}/{char.maxHp}</span><span className="blue-text">MP:{char.currentMp}/{char.maxMp}</span><span>ATK:{char.atk}</span><span>DEF:{char.def}</span></div>
                        <div className="w-full bg-gray-700 h-1 mt-1"><div className="bg-red-500 h-1" style={{width:`${(char.currentHp/char.maxHp)*100}%`}}/></div>
                        <div className="mt-1 text-gray-500 text-xs">EXP: {char.exp}/{char.level * 100}</div>
                        <div className="mt-1 text-gray-600 text-xs">‚öîÔ∏è{char.equipment?.weapon?.name||'-'} üõ°Ô∏è{char.equipment?.armor?.name||'-'} üíç{char.equipment?.accessory?.name||'-'}</div>
                        <div className="mt-2 flex gap-2">
                          {char.level >= 10 && <button onClick={() => setShowJobChange(char)} className="text-xs text-cyan-400 hover:underline">üîÑËª¢ËÅ∑</button>}
                          <button onClick={() => setParty(p => p.filter(c => c.id !== char.id))} className="text-xs text-red-400 hover:underline">‚ùåËß£Èõá</button>
                        </div>
                      </div>
                    )})}
                  </div>
                </>)}
              </>)}
              {currentFacility === 'shop' && (<>
                <h2 className="text-xl mb-3 border-b border-green-800 pb-2">„Äê „Éú„É´„Çø„ÉÉ„ÇØÂïÜÂ∫ó „Äë</h2>
                <div className="flex gap-1 mb-3">{['weapons','armors','accessories','consumables'].map(cat => (<button key={cat} onClick={() => setShopCat(cat)} className={`px-3 py-2 text-sm ${shopCat===cat?'bg-green-900 retro-border':'bg-gray-900'}`}>{{weapons:'‚öîÔ∏èÊ≠¶Âô®',armors:'üõ°Ô∏èÈò≤ÂÖ∑',accessories:'üíçË£ÖÈ£æ',consumables:'üß™Ê∂àËÄó'}[cat]}</button>))}</div>
                <div className="space-y-1 max-h-72 overflow-y-auto">{ITEMS[shopCat].map((item,i) => { const canBuy = gold >= item.price; return (<div key={i} className={`p-2 text-sm flex justify-between ${canBuy?'bg-gray-900':'bg-gray-900 opacity-50'}`}><div><span className={`rarity-${item.rarity}`}>{item.name}</span><span className="text-gray-500 ml-2">{item.atk?`ATK+${item.atk}`:''}{item.def?`DEF+${item.def}`:''}{item.heal?`ÂõûÂæ©${item.heal}`:''}</span></div><button onClick={() => {if (!canBuy) return; setGold(p => p-item.price); setInventory(p => [...p, {...item, uid: Date.now()}]); soundEngine.playGold();}} disabled={!canBuy} className="gold-text hover:underline disabled:opacity-50">{item.price}G</button></div>);})}</div>
              </>)}
              {currentFacility === 'storage' && (<>
                <h2 className="text-xl mb-3 border-b border-green-800 pb-2">„Äê ÊâÄÊåÅÂìÅ „Äë({inventory.length})</h2>
                <div className="mb-3"><span className="text-sm text-gray-400">Ë£ÖÂÇôÂÖà: </span>{party.map(char => (<button key={char.id} onClick={() => setSelChar(char.id)} className={`px-2 py-1 text-sm mx-1 ${selChar===char.id?'bg-green-900 retro-border':'bg-gray-900'}`}>{char.name}</button>))}</div>
                <div className="space-y-1 max-h-72 overflow-y-auto">{inventory.map(item => (<div key={item.uid} className="p-2 text-sm bg-gray-900 flex justify-between"><div><span className={`rarity-${item.rarity}`}>{item.name}</span><span className="text-gray-500 ml-2">{item.atk?`ATK+${item.atk}`:''}{item.def?`DEF+${item.def}`:''}{item.heal?`ÂõûÂæ©${item.heal}`:''}</span></div><div className="flex gap-2">{selChar && !item.heal && <button onClick={() => equipItem(selChar, item)} className="text-blue-400 hover:underline">Ë£ÖÂÇô</button>}<button onClick={() => {setGold(p => p + Math.floor((item.price||10)/2)); setInventory(p => p.filter(i => i.uid !== item.uid));}} className="text-yellow-400 hover:underline">Â£≤Âç¥</button></div></div>))}{inventory.length === 0 && <p className="text-gray-600 text-center py-4">„Ç¢„Ç§„ÉÜ„É†„Å™„Åó</p>}</div>
              </>)}
              {currentFacility === 'bestiary' && (<>
                <h2 className="text-xl mb-3 border-b border-green-800 pb-2">„Äê „É¢„É≥„Çπ„Çø„ÉºÂõ≥Èëë „Äë</h2>
                <div className="grid md:grid-cols-3 lg:grid-cols-4 gap-2">{Object.entries(bestiary).map(([name, d]) => (<div key={name} className="p-2 bg-gray-900 text-sm"><div className="flex justify-between"><span className="font-bold">{d.boss?'üëë':''}{name}</span><span className="text-gray-500">√ó{d.cnt}</span></div><div className="text-gray-400">HP:{d.hp} ATK:{d.atk}</div></div>))}</div>
              </>)}
              {currentFacility === 'temple' && (<>
                <h2 className="text-xl mb-3 border-b border-green-800 pb-2">„Äê „Ç´„É≥„ÉàÂØ∫Èô¢ „Äë</h2>
                <p className="text-gray-400 mb-4">Á•û„ÅÆÂä†Ë≠∑„Åå„ÅÇ„Å™„Åü„ÇíÁôí„Åô„Åß„Åó„Çá„ÅÜ„ÄÇ</p>
                <div className="space-y-3">
                  <div className="p-4 bg-gray-900 rounded">
                    <h3 className="text-lg mb-2 blue-text">‚ú® ÂÖ®Âì°ÂõûÂæ©</h3>
                    <p className="text-sm text-gray-400 mb-3">„Éë„Éº„ÉÜ„Ç£ÂÖ®Âì°„ÅÆHP/MP„ÇíÂÆåÂÖ®ÂõûÂæ©„Åó„Åæ„Åô„ÄÇ</p>
                    <button onClick={() => { setParty(p => p.map(c => ({...c, currentHp: c.maxHp, currentMp: c.maxMp}))); soundEngine.playHeal(); }} 
                      className="retro-border px-4 py-2 hover:bg-blue-900"
                      disabled={party.length === 0 || party.every(c => c.currentHp === c.maxHp && c.currentMp === c.maxMp)}>
                      üíñ ÂõûÂæ©„Åô„ÇãÔºàÁÑ°ÊñôÔºâ
                    </button>
                  </div>
                  <div className="mt-4">
                    <h3 className="text-sm mb-2">„Éë„Éº„ÉÜ„Ç£Áä∂ÊÖã:</h3>
                    <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-2">
                      {party.map(c => (
                        <div key={c.id} className="p-2 bg-gray-900 text-sm">
                          <div className="font-bold">{c.name}</div>
                          <div className="flex gap-2 mt-1">
                            <span className={c.currentHp < c.maxHp ? 'red-text' : ''}>HP:{c.currentHp}/{c.maxHp}</span>
                            <span className={c.currentMp < c.maxMp ? 'blue-text' : ''}>MP:{c.currentMp}/{c.maxMp}</span>
                          </div>
                          <div className="w-full bg-gray-700 h-1 mt-1"><div className="bg-green-500 h-1" style={{width:`${(c.currentHp/c.maxHp)*100}%`}}/></div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </>)}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
