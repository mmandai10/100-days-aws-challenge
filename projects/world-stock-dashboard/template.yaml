AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: World Stock Dashboard API

Globals:
  Function:
    Timeout: 60
    MemorySize: 1024
    Runtime: python3.12

Resources:
  StockApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: world-stock-api
      CodeUri: lambda/
      Handler: lambda_function.lambda_handler
      Description: yfinance stock API
      Events:
        GetStocks:
          Type: Api
          Properties:
            Path: /stocks
            Method: get
            RestApiId: !Ref StockApi
        OptionsStocks:
          Type: Api
          Properties:
            Path: /stocks
            Method: options
            RestApiId: !Ref StockApi

  StockApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: world-stock-api
      StageName: prod
      Cors:
        AllowMethods: "'GET,OPTIONS'"
        AllowHeaders: "'Content-Type'"
        AllowOrigin: "'*'"

  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "world-stock-dashboard-${AWS::AccountId}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false
      WebsiteConfiguration:
        IndexDocument: index.html

  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: PublicRead
            Effect: Allow
            Principal: '*'
            Action: s3:GetObject
            Resource: !Sub "${FrontendBucket.Arn}/*"

Outputs:
  ApiUrl:
    Description: API Gateway URL
    Value: !Sub "https://${StockApi}.execute-api.${AWS::Region}.amazonaws.com/prod/stocks"
  
  WebsiteUrl:
    Description: Frontend Website URL
    Value: !GetAtt FrontendBucket.WebsiteURL
  
  BucketName:
    Description: S3 Bucket Name
    Value: !Ref FrontendBucket