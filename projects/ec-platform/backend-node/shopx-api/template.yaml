AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: ShopX Product Catalog API

Globals:
  Function:
    Runtime: nodejs20.x
    Timeout: 10
    Environment:
      Variables:
        PRODUCTS_TABLE: !Ref ProductsTable

Resources:
  # ==========================================
  # API Gateway（Cognito Authorizer 付き）
  # ==========================================

  ApiGatewayApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization'"
        AllowOrigin: "'*'"
      Auth:
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn: !GetAtt UserPool.Arn

  # ==========================================
  # 商品 API（認証不要）
  # ==========================================

  GetProductsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/getProducts/
      Handler: app.handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ProductsTable
      Events:
        GetProducts:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /products
            Method: GET

  GetProductByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/getProductById/
      Handler: app.handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ProductsTable
      Events:
        GetProductById:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /products/{id}
            Method: GET

  GetCategoriesFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/getCategories/
      Handler: app.handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ProductsTable
      Events:
        GetCategories:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /categories
            Method: GET

  # ==========================================
  # カート API（認証必須）
  # ==========================================

  GetCartFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/getCart/
      Handler: app.handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ProductsTable
      Events:
        GetCart:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /cart
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  UpdateCartFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/updateCart/
      Handler: app.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ProductsTable
      Events:
        UpdateCart:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /cart
            Method: PUT
            Auth:
              Authorizer: CognitoAuthorizer

  # ==========================================
  # 注文 API（認証必須）
  # ==========================================

  CreateOrderFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/createOrder/
      Handler: app.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ProductsTable
      Events:
        CreateOrder:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /orders
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  GetOrdersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/getOrders/
      Handler: app.handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ProductsTable
      Events:
        GetOrders:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /orders
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  # ==========================================
  # 管理者 API（認証必須 + admin グループ）
  # ==========================================

  CreateProductFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/createProduct/
      Handler: app.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ProductsTable
      Events:
        CreateProduct:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /admin/products
            Method: POST
            Auth:
              Authorizer: CognitoAuthorizer

  UpdateProductFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/updateProduct/
      Handler: app.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ProductsTable
      Events:
        UpdateProduct:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /admin/products/{id}
            Method: PUT
            Auth:
              Authorizer: CognitoAuthorizer

  DeleteProductFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/deleteProduct/
      Handler: app.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ProductsTable
      Events:
        DeleteProduct:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /admin/products/{id}
            Method: DELETE
            Auth:
              Authorizer: CognitoAuthorizer

  GetAllOrdersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/getAllOrders/
      Handler: app.handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ProductsTable
      Events:
        GetAllOrders:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /admin/orders
            Method: GET
            Auth:
              Authorizer: CognitoAuthorizer

  UpdateOrderFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/handlers/updateOrder/
      Handler: app.handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ProductsTable
      Events:
        UpdateOrder:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGatewayApi
            Path: /admin/orders/{orderId}
            Method: PUT
            Auth:
              Authorizer: CognitoAuthorizer

  # ==========================================
  # DynamoDB テーブル
  # ==========================================

  ProductsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub "${AWS::StackName}-products"
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: SK
              KeyType: HASH
            - AttributeName: PK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL

  # ==========================================
  # Cognito 認証
  # ==========================================

  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub "${AWS::StackName}-users"
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireUppercase: true
          RequireNumbers: true
          RequireSymbols: false
      Schema:
        - Name: email
          Required: true
          Mutable: true

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub "${AWS::StackName}-web-client"
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_USER_SRP_AUTH
      PreventUserExistenceErrors: ENABLED

  # 管理者グループ
  AdminGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      GroupName: admin
      UserPoolId: !Ref UserPool
      Description: Administrator group with product management permissions

Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL
    Value: !Sub "https://${ApiGatewayApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
  ProductsTableName:
    Description: DynamoDB table name
    Value: !Ref ProductsTable
  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool
  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient